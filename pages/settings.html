<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Settings - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="../css/shared-styles.css">

<!-- Load shared navbar -->
<script src="../js/navbar-helper.js"></script>
<script src="../js/navbar-loader.js"></script>
<script src="../js/settings-dropdown.js"></script>
<script src="../js/navbar-auth.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/currency.js"></script>

<style>
  
  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, .4);
  }
  
  /* Settings Page Specific Styles */
  .settings-container-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 60px 80px;
  }

  .page-header {
    text-align: center;
    margin-bottom: 48px;
  }

  .page-title {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 12px;
  }

  .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-subtitle {
    color: var(--text-muted);
    font-size: 18px;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
  }

  .settings-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    transition: transform .3s, box-shadow .3s, border-color .3s;
  }

  .settings-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(168, 85, 247, .2);
    border-color: var(--purple);
  }

  .settings-card-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .settings-card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .settings-card-title {
    flex: 1;
  }

  .settings-card-title h3 {
    font-size: 20px;
    margin-bottom: 4px;
  }

  .settings-card-title p {
    font-size: 13px;
    color: var(--text-muted);
  }

  .settings-item {
    margin-bottom: 24px;
  }

  .settings-item:last-child {
    margin-bottom: 0;
  }

  .settings-item label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
  }

  .settings-item input,
  .settings-item select,
  .settings-item textarea {
    width: 100%;
    padding: 12px 16px;
    background: var(--darker-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    transition: all 0.3s ease;
  }

  .settings-item input:focus,
  .settings-item select:focus,
  .settings-item textarea:focus {
    outline: none;
    border-color: var(--purple);
  }

  .settings-item textarea {
    resize: vertical;
    min-height: 100px;
  }

  .settings-item-description {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .settings-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: rgba(168, 85, 247, 0.05);
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .settings-toggle-info h4 {
    font-size: 14px;
    margin-bottom: 4px;
  }

  .settings-toggle-info p {
    font-size: 12px;
    color: var(--text-muted);
  }

  .toggle-switch {
    position: relative;
    width: 48px;
    height: 24px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .toggle-switch.active {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
  }

  .toggle-switch-knob {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .toggle-switch.active .toggle-switch-knob {
    transform: translateX(24px);
  }

  .user-avatar-large {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    margin: 0 auto 20px;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .status-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }

  .status-badge.admin {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    color: white;
    border: 1px solid rgba(168, 85, 247, 0.3);
  }

  .status-badge.free {
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));
    color: #9CA3AF;
    border: 1px solid rgba(107, 114, 128, 0.3);
  }

  .status-badge.starter {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
    color: #60A5FA;
    border: 1px solid rgba(59, 130, 246, 0.3);
  }

  .status-badge.scaling {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(139, 92, 246, 0.15));
    color: #C084FC;
    border: 1px solid rgba(139, 92, 246, 0.4);
    box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
  }

  .status-badge.business {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(245, 158, 11, 0.15));
    color: #FCD34D;
    border: 1px solid rgba(245, 158, 11, 0.4);
    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
  }

  .tier-badge-icon {
    font-size: 16px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  .success-message {
    display: none; /* Hidden, we'll use popups instead */
  }

  /* Popup Notification */
  .notification-popup {
    position: fixed;
    top: 80px;
    right: 20px;
    padding: 16px 24px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 12px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    z-index: 10000;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .notification-popup.show {
    opacity: 1;
    transform: translateX(0);
  }

  .notification-popup.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
  }

  .notification-icon {
    font-size: 20px;
  }

  /* Confirmation Modal */
  .confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 10001;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .confirm-modal.show {
    display: flex;
  }

  .confirm-modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    max-width: 480px;
    width: 90%;
    box-shadow: 0 12px 48px rgba(168, 85, 247, 0.2);
  }

  .confirm-modal-content h3 {
    margin: 0 0 16px 0;
    color: var(--text);
    font-size: 24px;
  }

  .confirm-modal-content p {
    margin: 0 0 24px 0;
    color: var(--text-muted);
    font-size: 15px;
    line-height: 1.6;
  }

  .confirm-modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .confirm-modal-buttons .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .confirm-modal-buttons .btn-ghost:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: var(--purple);
  }

  .confirm-modal-buttons .btn-primary {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .confirm-modal-buttons .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
  }

  .confirm-modal-buttons .btn-primary.danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
  }

  .confirm-modal-buttons .btn-primary.danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }

  /* Tab Styles */
  .tabs-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .tabs-nav {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
    padding-bottom: 4px;
    border-bottom: 2px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
    justify-content: center;
  }

  .tabs-nav::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }

  .tab-button {
    padding: 12px 4px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-muted);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    position: relative;
    margin-bottom: -6px;
  }

  .tab-button:hover {
    color: var(--text);
  }

  .tab-button.active {
    color: var(--purple-light);
    border-bottom-color: var(--purple-light);
  }

  .tabs-content {
    position: relative;
    min-height: 400px;
  }

  .tab-panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .tab-panel.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .settings-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 768px) {
    nav {
      padding: 20px 24px;
    }
    
    .nav-links {
      display: none;
    }
    
    .settings-container-page {
      padding: 40px 24px;
    }

    .page-title {
      font-size: 36px;
    }
  }
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--dark-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s ease;
  ">
    <div style="
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Loading settings...</p>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>

  <!-- Navbar will be loaded here dynamically -->
  <div id="navbar-container"></div>

  <!-- Notification Popup -->
  <div id="notificationPopup" class="notification-popup">
    <span class="notification-icon" id="notificationIcon"></span>
    <span id="notificationMessage">Success!</span>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
      <h3 id="confirmTitle">Confirm Action</h3>
      <p id="confirmMessage">Are you sure?</p>
      <div class="confirm-modal-buttons">
        <button class="btn-ghost" id="confirmCancel">Cancel</button>
        <button class="btn-primary danger" id="confirmOk">Confirm</button>
      </div>
    </div>
  </div>

  <div class="settings-container-page">
    <div class="page-header">
      <h1 class="page-title">
        <span class="highlight">Settings</span>
      </h1>
      <p class="page-subtitle">Manage your account, preferences, and notifications</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button class="tab-button active" data-tab="account">
          Account
        </button>
        <button class="tab-button" data-tab="currency">
          Currency
        </button>
        <button class="tab-button" data-tab="security">
          Security
        </button>
        <button class="tab-button" data-tab="preferences">
          Preferences
        </button>
        <button class="tab-button" data-tab="danger">
          Danger Zone
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tabs-content">
        <!-- Account Tab -->
        <div class="tab-panel active" id="account-tab">
          <div class="settings-card">
            <div style="text-align: center; margin-bottom: 32px;">
              <div class="user-avatar-large" id="userAvatarLarge">U</div>
              <h3 id="displayUsername" style="margin-bottom: 4px;">Username</h3>
              <p id="displayEmail" style="color: var(--text-muted); font-size: 14px; margin-bottom: 8px;">email@example.com</p>
              <span class="status-badge member" id="userRoleBadge">Member</span>
            </div>

            <div class="settings-item">
              <label>Display Name</label>
              <input type="text" id="displayNameInput" placeholder="Your display name">
              <p class="settings-item-description">This is how your name will appear across the site</p>
              <p id="usernameAvailability" style="font-size: 13px; margin-top: 8px; display: none;"></p>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btnUpdateProfile">
              Update Profile
            </button>
            <div class="success-message" id="profileSuccessMsg">Profile updated successfully!</div>
          </div>
        </div>

        <!-- Currency Tab -->
        <div class="tab-panel" id="currency-tab">
          <div class="settings-card">
            <div class="settings-item">
              <label>Default Currency</label>
              <select id="currencySelectPage">
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (€)</option>
            <option value="GBP">GBP (£)</option>
            <option value="JPY">JPY (¥)</option>
            <option value="CNY">CNY (¥)</option>
            <option value="CAD">CAD ($)</option>
            <option value="AUD">AUD ($)</option>
            <option value="CHF">CHF (Fr)</option>
            <option value="INR">INR (₹)</option>
            <option value="MXN">MXN ($)</option>
            <option value="BRL">BRL (R$)</option>
            <option value="ZAR">ZAR (R)</option>
            <option value="KRW">KRW (₩)</option>
            <option value="SGD">SGD ($)</option>
            <option value="NZD">NZD ($)</option>
            <option value="SEK">SEK (kr)</option>
            <option value="NOK">NOK (kr)</option>
            <option value="DKK">DKK (kr)</option>
            <option value="PLN">PLN (zł)</option>
            <option value="THB">THB (฿)</option>
            <option value="IDR">IDR (Rp)</option>
            <option value="HUF">HUF (Ft)</option>
            <option value="CZK">CZK (Kč)</option>
            <option value="ILS">ILS (₪)</option>
            <option value="CLP">CLP ($)</option>
            <option value="PHP">PHP (₱)</option>
            <option value="AED">AED (د.إ)</option>
            <option value="SAR">SAR (﷼)</option>
            <option value="MYR">MYR (RM)</option>
            <option value="RON">RON (lei)</option>
          </select>
              <p class="settings-item-description">This currency will be used in the calculator by default</p>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btnSaveCurrencyPage">
              Save Currency
            </button>
            <div class="success-message" id="currencySuccessMsg">Currency preference saved!</div>
          </div>
        </div>

        <!-- Security Tab -->
        <div class="tab-panel" id="security-tab">
          <div class="settings-card">
            <div class="settings-item">
              <label>Current Password</label>
              <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>

            <div class="settings-item">
              <label>New Password</label>
              <input type="password" id="newPassword" placeholder="Enter new password">
              <p class="settings-item-description">Must be at least 6 characters long</p>
            </div>

            <div class="settings-item">
              <label>Confirm New Password</label>
              <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btnChangePassword">
              Change Password
            </button>
            <div class="success-message" id="passwordSuccessMsg">Password changed successfully!</div>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div class="tab-panel" id="preferences-tab">
          <div class="settings-card">
            <div class="settings-toggle" id="toggleNotifications">
              <div class="settings-toggle-info">
                <h4>Email Notifications</h4>
                <p>Receive updates about your account</p>
              </div>
              <div class="toggle-switch" data-setting="notifications">
                <div class="toggle-switch-knob"></div>
              </div>
            </div>

            <div class="settings-toggle" id="toggleAutoSave">
              <div class="settings-toggle-info">
                <h4>Auto-Save Calculations</h4>
                <p>Automatically save your calculations to cloud</p>
              </div>
              <div class="toggle-switch active" data-setting="autoSave">
                <div class="toggle-switch-knob"></div>
              </div>
            </div>

            <div class="settings-toggle" id="toggleDarkMode">
              <div class="settings-toggle-info">
                <h4>Dark Mode</h4>
                <p>Currently enabled (default theme)</p>
              </div>
              <div class="toggle-switch active" data-setting="darkMode">
                <div class="toggle-switch-knob"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Danger Zone Tab -->
        <div class="tab-panel" id="danger-tab">
          <div class="settings-card">
            <div style="padding: 24px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; margin-bottom: 24px;">
              <h3 style="color: #ef4444; margin-bottom: 8px;">Warning</h3>
              <p style="color: var(--text-muted); font-size: 14px;">These actions are irreversible and will affect your account permanently.</p>
            </div>

            <div style="display: flex; flex-direction: column; gap: 16px;">
              <button class="btn btn-danger" id="btnSignOut" style="width: 100%;">
                Sign Out
              </button>
              <button class="btn btn-ghost" id="btnDeleteAccount" style="width: 100%; color: #ef4444; border: 1px solid #ef4444;">
                Delete Account Permanently
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* Firebase, auth, db, and currentUser are already initialized by auth.js loaded in head */
  
  // Enable auth persistence (if not already set)
  if (firebase.auth && firebase.auth()) {
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }

  // currentUser is already declared globally by auth.js
  let isAdmin = false;

  // Check if user is admin
  async function checkAdminStatus(user) {
    if (!user) return false;
    try {
      const snapshot = await db.ref(`users/${user.uid}/role`).once('value');
      const role = snapshot.val();
      return role === 'admin' || role === 'administrator';
    } catch (error) {
      console.error('Error checking admin status:', error);
      return false;
    }
  }

  // Initialize navbar handlers
  function initializeNavbarHandlers() {
    const btnSettings = document.getElementById('btnSettings');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const btnLoginSettings = document.getElementById('btnLoginSettings');
    const btnLogoutSettings = document.getElementById('btnLogoutSettings');
    const userInfoDisplay = document.getElementById('userInfoDisplay');
    const settingsUsername = document.getElementById('settingsUsername');
    const settingsRole = document.getElementById('settingsRole');
    const userAvatar = document.getElementById('userAvatar');
    const btnLoginNav = document.getElementById('btnLoginNav');

    if (!btnSettings || !settingsDropdown) {
      console.error('Navbar elements not found');
      return;
    }

    // Dropdown toggle functionality is now handled by settings-dropdown.js

    // Login button
    if (btnLoginNav) {
      btnLoginNav.addEventListener('click', () => {
        window.location.href = '../index.html?login=true';
      });
    }

    // Login button in settings dropdown
    if (btnLoginSettings) {
      btnLoginSettings.addEventListener('click', () => {
        window.location.href = '../index.html?login=true';
      });
    }

    // Logout button in dropdown
    if (btnLogoutSettings) {
      btnLogoutSettings.addEventListener('click', () => {
        showConfirm('Logout', 'Are you sure you want to log out?', false, 'Logout').then((confirmed) => {
          if (confirmed) {
            auth.signOut().then(() => {
              showNotification('You have been logged out successfully.', false);
              // Reload page to clear all user data
              window.location.reload();
            });
          }
        });
      });
    }

    return {
      btnLoginSettings,
      btnLogoutSettings,
      userInfoDisplay,
      settingsUsername,
      settingsRole,
      userAvatar,
      btnLoginNav
    };
  }

  let navbarElements = null;
  document.addEventListener('navbarLoaded', function() {
    console.log('Navbar loaded, initializing handlers...');
    navbarElements = initializeNavbarHandlers();
    
    // Setup currency save for navbar dropdown
    const currencySelect = document.getElementById('currencySelect');
    const btnSaveCurrency = document.getElementById('btnSaveCurrency');
    
    if (currencySelect && btnSaveCurrency) {
      // Track last saved currency
      window.lastSavedCurrency = 'USD';
      
      // Update save button state
      function updateSaveButton() {
        if (currencySelect.value !== window.lastSavedCurrency) {
          btnSaveCurrency.disabled = false;
          btnSaveCurrency.style.opacity = '1';
        } else {
          btnSaveCurrency.disabled = true;
          btnSaveCurrency.style.opacity = '0.5';
        }
      }
      
      // Update save button when currency changes
      currencySelect.addEventListener('change', updateSaveButton);
      
      // Save currency to Firebase
      btnSaveCurrency.addEventListener('click', () => {
        const user = auth.currentUser;
        if (!user) {
          console.log('No user logged in');
          return;
        }
        
        const selectedCurrency = currencySelect.value;
        
        // Save to Firebase
        db.ref('users/' + user.uid + '/currency').set(selectedCurrency)
          .then(() => {
            console.log('Currency saved to Firebase:', selectedCurrency);
            window.lastSavedCurrency = selectedCurrency;
            
            // Show success feedback
            const originalText = btnSaveCurrency.textContent;
            btnSaveCurrency.textContent = 'Saved';
            btnSaveCurrency.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            
            // Reset button after 2 seconds
            setTimeout(() => {
              btnSaveCurrency.textContent = originalText;
              btnSaveCurrency.style.background = '';
              updateSaveButton();
            }, 2000);
          })
          .catch(error => {
            console.error('Error saving currency:', error);
            showNotification('Failed to save currency. Please try again.', true);
          });
      });
      
      // Load saved currency when user is logged in
      auth.onAuthStateChanged(user => {
        if (user) {
          db.ref('users/' + user.uid + '/currency').on('value', snapshot => {
            const savedCurrency = snapshot.val();
            if (savedCurrency && currencySelect) {
              currencySelect.value = savedCurrency;
              window.lastSavedCurrency = savedCurrency;
              updateSaveButton();
              console.log('Currency loaded from Firebase:', savedCurrency);
            }
          });
        }
      });
    }
  });

  // Auth state listener
  auth.onAuthStateChanged(async user => {
    currentUser = user;

    if (user) {
      isAdmin = await checkAdminStatus(user);
      
      // Update page UI
      const email = user.email || 'user@example.com';
      const username = user.displayName || email.split('@')[0];
      
      document.getElementById('displayUsername').textContent = username;
      document.getElementById('displayEmail').textContent = email;
      document.getElementById('userAvatarLarge').textContent = username.charAt(0).toUpperCase();
      document.getElementById('displayNameInput').value = username;
      
      // Get membership tier
      let tierDisplay = 'Free';
      let tierClass = 'free';
      let tierIcon = '🆓';
      try {
        const tierSnapshot = await db.ref(`users/${user.uid}/membership/tier`).once('value');
        const tier = tierSnapshot.val() || 'free';
        const tierInfo = typeof TIER_INFO !== 'undefined' ? TIER_INFO[tier] : null;
        if (tierInfo) {
          tierDisplay = tierInfo.name;
          tierIcon = tierInfo.badge;
          tierClass = tier.toLowerCase();
        } else {
          tierDisplay = tier.charAt(0).toUpperCase() + tier.slice(1);
          tierClass = tier.toLowerCase();
        }
      } catch (error) {
        console.error('Error fetching membership tier:', error);
      }
      
      // Set role badge without icon
      const roleBadge = document.getElementById('userRoleBadge');
      if (isAdmin) {
        roleBadge.textContent = 'Administrator';
        roleBadge.className = 'status-badge admin';
      } else {
        roleBadge.textContent = tierDisplay;
        roleBadge.className = `status-badge ${tierClass}`;
      }

      // Load currency preference
      db.ref('users/' + user.uid + '/currency').once('value').then(snapshot => {
        const savedCurrency = snapshot.val();
        if (savedCurrency) {
          document.getElementById('currencySelectPage').value = savedCurrency;
        }
        
        // Hide loading overlay after data is loaded
        hideLoadingOverlay();
      });

      // Update navbar
      if (navbarElements) {
        const { btnLoginSettings, btnLogoutSettings, userInfoDisplay, settingsUsername, settingsRole, userAvatar, btnLoginNav } = navbarElements;
        
        if (btnLoginNav) btnLoginNav.style.display = 'none';
        if (btnLoginSettings) btnLoginSettings.style.display = 'none';
        if (btnLogoutSettings) btnLogoutSettings.style.display = 'block';
        if (userInfoDisplay) userInfoDisplay.style.display = 'block';
        if (settingsUsername) settingsUsername.textContent = username;
        if (userAvatar) userAvatar.textContent = username.charAt(0).toUpperCase();
        if (settingsRole) settingsRole.textContent = isAdmin ? 'Administrator' : tierDisplay;
      }
    } else {
      // Redirect to home if not logged in
      window.location.href = '../index.html';
    }
  });

  // Hide loading overlay function
  function hideLoadingOverlay() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
      }, 300);
    }
  }

  // Fallback: Hide loading overlay after max 5 seconds
  setTimeout(() => {
    hideLoadingOverlay();
  }, 5000);

  // Show notification popup
  function showNotification(message, isError = false) {
    const popup = document.getElementById('notificationPopup');
    const icon = document.getElementById('notificationIcon');
    const messageEl = document.getElementById('notificationMessage');
    
    messageEl.textContent = message;
    icon.textContent = isError ? 'X' : '';
    
    if (isError) {
      popup.classList.add('error');
    } else {
      popup.classList.remove('error');
    }
    
    popup.classList.add('show');
    
    setTimeout(() => {
      popup.classList.remove('show');
    }, 3000);
  }

  // Confirmation modal function
  function showConfirm(title, message, isDangerous = false, buttonText = 'Confirm') {
    return new Promise((resolve) => {
      const modal = document.getElementById('confirmModal');
      const titleEl = document.getElementById('confirmTitle');
      const messageEl = document.getElementById('confirmMessage');
      const okBtn = document.getElementById('confirmOk');
      const cancelBtn = document.getElementById('confirmCancel');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      okBtn.textContent = buttonText;
      
      if (isDangerous) {
        okBtn.classList.add('danger');
      } else {
        okBtn.classList.remove('danger');
      }
      
      modal.classList.add('show');
      
      const handleOk = () => {
        modal.classList.remove('show');
        okBtn.removeEventListener('click', handleOk);
        cancelBtn.removeEventListener('click', handleCancel);
        resolve(true);
      };
      
      const handleCancel = () => {
        modal.classList.remove('show');
        okBtn.removeEventListener('click', handleOk);
        cancelBtn.removeEventListener('click', handleCancel);
        resolve(false);
      };
      
      okBtn.addEventListener('click', handleOk);
      cancelBtn.addEventListener('click', handleCancel);
    });
  }

  // Real-time username availability checker
  let usernameCheckTimeout;
  const displayNameInput = document.getElementById('displayNameInput');
  const usernameAvailability = document.getElementById('usernameAvailability');

  displayNameInput.addEventListener('input', () => {
    const newUsername = displayNameInput.value.trim();
    
    // Clear previous timeout
    clearTimeout(usernameCheckTimeout);
    
    // Hide message if empty
    if (!newUsername) {
      usernameAvailability.style.display = 'none';
      return;
    }

    // Basic validation
    if (newUsername.length < 3) {
      usernameAvailability.textContent = '⚠️ Username must be at least 3 characters';
      usernameAvailability.style.color = '#f59e0b';
      usernameAvailability.style.display = 'block';
      return;
    }

    if (newUsername.length > 20) {
      usernameAvailability.textContent = '⚠️ Username must be 20 characters or less';
      usernameAvailability.style.color = '#f59e0b';
      usernameAvailability.style.display = 'block';
      return;
    }

    const usernameRegex = /^[a-zA-Z0-9_-]+$/;
    if (!usernameRegex.test(newUsername)) {
      usernameAvailability.textContent = '⚠️ Only letters, numbers, hyphens, and underscores allowed';
      usernameAvailability.style.color = '#f59e0b';
      usernameAvailability.style.display = 'block';
      return;
    }

    // Check if same as current username
    if (currentUser && newUsername.toLowerCase() === (currentUser.displayName || '').toLowerCase()) {
      usernameAvailability.textContent = 'ℹ️ This is your current username';
      usernameAvailability.style.color = '#6b7280';
      usernameAvailability.style.display = 'block';
      return;
    }

    // Show checking message
    usernameAvailability.textContent = '🔍 Checking availability...';
    usernameAvailability.style.color = '#6b7280';
    usernameAvailability.style.display = 'block';

    // Debounce the database check
    usernameCheckTimeout = setTimeout(async () => {
      if (!currentUser) return;

      try {
        const usernamesSnapshot = await db.ref('usernames').once('value');
        const usernames = usernamesSnapshot.val() || {};
        
        // Check if username exists and belongs to a different user
        let isTaken = false;
        for (const [uid, username] of Object.entries(usernames)) {
          if (username.toLowerCase() === newUsername.toLowerCase() && uid !== currentUser.uid) {
            isTaken = true;
            break;
          }
        }

        if (isTaken) {
          usernameAvailability.textContent = '❌ Username is already in use';
          usernameAvailability.style.color = '#ef4444';
        } else {
          usernameAvailability.textContent = '✓ Username is available';
          usernameAvailability.style.color = '#10b981';
        }
        usernameAvailability.style.display = 'block';
      } catch (error) {
        console.error('Error checking username:', error);
        usernameAvailability.textContent = '⚠️ Error checking availability';
        usernameAvailability.style.color = '#f59e0b';
        usernameAvailability.style.display = 'block';
      }
    }, 500); // Wait 500ms after user stops typing
  });

    // Update Profile
  document.getElementById('btnUpdateProfile').addEventListener('click', async () => {
    const newDisplayName = document.getElementById('displayNameInput').value.trim();
    
    if (!newDisplayName) {
      showNotification('Please enter a display name', true);
      return;
    }

    // Validate username format
    if (newDisplayName.length < 3) {
      showNotification('Username must be at least 3 characters long', true);
      return;
    }

    if (newDisplayName.length > 20) {
      showNotification('Username must be 20 characters or less', true);
      return;
    }

    // Check if username contains only valid characters
    const usernameRegex = /^[a-zA-Z0-9_-]+$/;
    if (!usernameRegex.test(newDisplayName)) {
      showNotification('Username can only contain letters, numbers, hyphens, and underscores', true);
      return;
    }

    if (currentUser) {
      try {
        // Check if the username is the same as current
        const currentDisplayName = currentUser.displayName || '';
        if (newDisplayName.toLowerCase() === currentDisplayName.toLowerCase()) {
          showNotification('This is already your username', true);
          return;
        }

        // Check if username is already taken by someone else
        const usernamesSnapshot = await db.ref('usernames').once('value');
        const usernames = usernamesSnapshot.val() || {};
        
        // Check if username exists and belongs to a different user
        for (const [uid, username] of Object.entries(usernames)) {
          if (username.toLowerCase() === newDisplayName.toLowerCase() && uid !== currentUser.uid) {
            showNotification('Username is already in use. Please choose a different one.', true);
            return;
          }
        }

        // Update Firebase Auth profile
        await currentUser.updateProfile({
          displayName: newDisplayName
        });

        // Update username in users node
        await db.ref('users/' + currentUser.uid + '/username').set(newDisplayName);

        // Update username in usernames lookup table
        await db.ref('usernames/' + currentUser.uid).set(newDisplayName);

        // Update UI
        document.getElementById('displayUsername').textContent = newDisplayName;
        
        // Update navbar if elements exist
        if (navbarElements && navbarElements.settingsUsername) {
          navbarElements.settingsUsername.textContent = newDisplayName;
        }
        if (navbarElements && navbarElements.userAvatar) {
          navbarElements.userAvatar.textContent = newDisplayName.charAt(0).toUpperCase();
        }
        
        showNotification('Profile updated successfully!', false);
      } catch (error) {
        console.error('Error updating profile:', error);
        showNotification('Error updating profile: ' + error.message, true);
      }
    }
  });

  // Save Currency
  document.getElementById('btnSaveCurrencyPage').addEventListener('click', () => {
    const currency = document.getElementById('currencySelectPage').value;
    
    if (currentUser) {
      db.ref('users/' + currentUser.uid + '/currency').set(currency)
        .then(() => {
          showNotification('Currency preference saved! Reloading page...', false);
          // Reload page after 1 second to show new currency
          setTimeout(() => {
            location.reload();
          }, 1000);
        })
        .catch(error => {
          showNotification('Error saving currency: ' + error.message, true);
        });
    }
  });

  // Change Password
  document.getElementById('btnChangePassword').addEventListener('click', () => {
    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if (!currentPass || !newPass || !confirmPass) {
      showNotification('Please fill in all password fields', true);
      return;
    }

    if (newPass.length < 6) {
      showNotification('New password must be at least 6 characters long', true);
      return;
    }

    if (newPass !== confirmPass) {
      showNotification('New passwords do not match', true);
      return;
    }

    if (currentUser) {
      const credential = firebase.auth.EmailAuthProvider.credential(
        currentUser.email,
        currentPass
      );

      currentUser.reauthenticateWithCredential(credential)
        .then(() => {
          return currentUser.updatePassword(newPass);
        })
        .then(() => {
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          
          showNotification('Password changed successfully!', false);
        })
        .catch(error => {
          if (error.code === 'auth/wrong-password') {
            showNotification('Current password is incorrect', true);
          } else {
            showNotification('Error changing password: ' + error.message, true);
          }
        });
    }
  });

  // Toggle switches
  document.querySelectorAll('.toggle-switch').forEach(toggle => {
    toggle.addEventListener('click', () => {
      toggle.classList.toggle('active');
      const setting = toggle.dataset.setting;
      const isActive = toggle.classList.contains('active');
      
      // Save preference to Firebase
      if (currentUser) {
        db.ref('users/' + currentUser.uid + '/preferences/' + setting).set(isActive);
      }
    });
  });

  // Sign Out
  document.getElementById('btnSignOut').addEventListener('click', async () => {
    showConfirm('Sign Out', 'Are you sure you want to sign out?', false, 'Sign Out').then((confirmed) => {
      if (confirmed) {
        auth.signOut().then(() => {
          showNotification('Signed out successfully!', false);
          // Reload page to clear all user data
          window.location.reload();
        });
      }
    });
  });

  // Delete Account
  document.getElementById('btnDeleteAccount').addEventListener('click', async () => {
    const firstConfirm = await showConfirm(
      'Delete Account',
      'WARNING: This will permanently delete your account and all data. This action cannot be undone. Are you absolutely sure?',
      true
    );
    
    if (firstConfirm) {
      const finalConfirm = await showConfirm(
        'Final Confirmation',
        'Delete your account permanently? This cannot be undone.',
        true
      );
      
      if (finalConfirm) {
        if (currentUser) {
          // Delete user data from database
          db.ref('users/' + currentUser.uid).remove()
            .then(() => {
              // Delete the user account
              return currentUser.delete();
            })
            .then(() => {
              showNotification('Your account has been deleted', false);
              window.location.href = '../index.html';
            })
            .catch(error => {
              if (error.code === 'auth/requires-recent-login') {
                showNotification('For security reasons, please sign out and sign in again before deleting your account', true);
              } else {
                showNotification('Error deleting account: ' + error.message, true);
              }
            });
        }
      }
    }
  });

  // Tab Switching
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      const tabId = button.dataset.tab;
      
      // Remove active class from all buttons and panels
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
      
      // Add active class to clicked button and corresponding panel
      button.classList.add('active');
      document.getElementById(`${tabId}-tab`).classList.add('active');
    });
  });
</script>

</body>
</html>
