<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Settings - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared navbar -->
<script src="../js/navbar-loader.js"></script>

<style>
  :root{
    --dark-bg: #1a1625;
    --darker-bg: #0f0b16;
    --card-bg: #241d35;
    --purple: #a855f7;
    --purple-hover: #9333ea;
    --purple-light: #c084fc;
    --text: #f0e9ff;
    --text-muted: #9ca3af;
    --border: rgba(168, 85, 247, .15);
  }
  
  * {margin:0; padding:0; box-sizing:border-box}
  
  html {
    scroll-behavior: smooth;
    background: linear-gradient(135deg, #1a1625 0%, #0f0b16 50%, #1d1530 100%);
    overscroll-behavior-y: none;
  }
  
  body {
    font-family: 'Inter', sans-serif;
    background: 
      radial-gradient(ellipse at 20% 30%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 70%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 50%, rgba(192, 132, 252, 0.1) 0%, transparent 50%),
      linear-gradient(135deg, #1a1625 0%, #0f0b16 50%, #1d1530 100%);
    color: var(--text);
    overflow-x: hidden;
    min-height: 100vh;
    overscroll-behavior-y: none;
  }
  
  /* Navigation - Reuse from other pages */
  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 60px;
    position: relative;
    z-index: 100;
  }
  
  .logo-section {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    flex: 1;
  }
  
  .logo-section img {
    height: 120px;
    width: auto;
    object-fit: contain;
    margin-top: 20px;
    margin-left: 0px;
  }
  
  .nav-links {
    display: flex;
    gap: 40px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }
  
  .nav-links a {
    color: var(--text-muted);
    text-decoration: none;
    font-weight: 500;
    transition: color .3s;
  }
  
  .nav-links a:hover, .nav-links a.active {
    color: var(--text);
  }
  
  .nav-buttons {
    display: flex;
    gap: 12px;
    flex: 1;
    justify-content: flex-end;
    align-items: center;
  }
  
  /* Settings Dropdown */
  .settings-container {
    position: relative;
  }

  .btn-settings {
    padding: 8px;
    background: transparent;
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 32px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-settings:hover {
    color: var(--purple-light);
    transform: scale(1.1);
  }

  .btn-settings.active {
    color: var(--purple-light);
  }

  .settings-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    min-width: 280px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    display: none;
    z-index: 1000;
    animation: slideDown 0.2s ease;
  }

  .settings-dropdown.active {
    display: block;
  }

  .settings-section {
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }

  .settings-section:last-child {
    border-bottom: none;
  }

  .settings-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--purple-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: block;
  }

  .settings-user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    background: rgba(168, 85, 247, 0.05);
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .settings-user-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
  }

  .settings-user-details {
    flex: 1;
  }

  .settings-username {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }

  .settings-role {
    font-size: 11px;
    color: var(--text-muted);
  }

  .settings-currency-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .settings-dropdown .currency-select {
    flex: 1;
    min-width: 0;
    padding: 8px 12px;
    background: rgba(168, 85, 247, 0.1);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 13px;
    font-family: 'Inter', sans-serif;
  }

  .settings-dropdown .btn-save-currency {
    display: inline-block;
    padding: 8px 12px;
    font-size: 11px;
  }
  
  .btn {
    padding: 12px 28px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all .3s;
    cursor: pointer;
    border: none;
    font-size: 15px;
  }
  
  .btn-ghost {
    background: transparent;
    color: var(--text);
  }
  
  .btn-ghost:hover {
    background: rgba(168, 85, 247, .1);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    color: white;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, var(--purple-hover), var(--purple));
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, .4);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, .4);
  }
  
  /* Settings Page Specific Styles */
  .settings-container-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 60px 80px;
  }

  .page-header {
    text-align: center;
    margin-bottom: 48px;
  }

  .page-title {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 12px;
  }

  .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-subtitle {
    color: var(--text-muted);
    font-size: 18px;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
  }

  .settings-card {
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    transition: transform .3s, box-shadow .3s, border-color .3s;
  }

  .settings-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(168, 85, 247, .2);
    border-color: var(--purple);
  }

  .settings-card-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .settings-card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .settings-card-title {
    flex: 1;
  }

  .settings-card-title h3 {
    font-size: 20px;
    margin-bottom: 4px;
  }

  .settings-card-title p {
    font-size: 13px;
    color: var(--text-muted);
  }

  .settings-item {
    margin-bottom: 24px;
  }

  .settings-item:last-child {
    margin-bottom: 0;
  }

  .settings-item label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
  }

  .settings-item input,
  .settings-item select,
  .settings-item textarea {
    width: 100%;
    padding: 12px 16px;
    background: rgba(15, 11, 22, 0.6);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: 'Inter', sans-serif;
  }

  .settings-item input:focus,
  .settings-item select:focus,
  .settings-item textarea:focus {
    outline: none;
    border-color: var(--purple);
  }

  .settings-item textarea {
    resize: vertical;
    min-height: 100px;
  }

  .settings-item-description {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .settings-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: rgba(168, 85, 247, 0.05);
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .settings-toggle-info h4 {
    font-size: 14px;
    margin-bottom: 4px;
  }

  .settings-toggle-info p {
    font-size: 12px;
    color: var(--text-muted);
  }

  .toggle-switch {
    position: relative;
    width: 48px;
    height: 24px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .toggle-switch.active {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
  }

  .toggle-switch-knob {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .toggle-switch.active .toggle-switch-knob {
    transform: translateX(24px);
  }

  .user-avatar-large {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    margin: 0 auto 20px;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-badge.admin {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    color: white;
  }

  .status-badge.member {
    background: rgba(168, 85, 247, 0.2);
    color: var(--purple-light);
  }

  .success-message {
    padding: 12px 16px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 8px;
    color: #4ade80;
    font-size: 14px;
    margin-top: 16px;
    display: none;
  }

  .success-message.show {
    display: block;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .settings-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 768px) {
    nav {
      padding: 20px 24px;
    }
    
    .nav-links {
      display: none;
    }
    
    .settings-container-page {
      padding: 40px 24px;
    }

    .page-title {
      font-size: 36px;
    }
  }
</style>
</head>
<body>
  <!-- Navbar will be loaded here dynamically -->
  <div id="navbar-container"></div>

  <div class="settings-container-page">
    <div class="page-header">
      <h1 class="page-title">
        <span class="highlight">Settings</span>
      </h1>
      <p class="page-subtitle">Manage your account, preferences, and notifications</p>
    </div>

    <div class="settings-grid">
      <!-- Account Settings -->
      <div class="settings-card">
        <div class="settings-card-header">
          <div class="settings-card-icon">üë§</div>
          <div class="settings-card-title">
            <h3>Account</h3>
            <p>Manage your account information</p>
          </div>
        </div>

        <div style="text-align: center; margin-bottom: 24px;">
          <div class="user-avatar-large" id="userAvatarLarge">U</div>
          <h3 id="displayUsername" style="margin-bottom: 4px;">Username</h3>
          <p id="displayEmail" style="color: var(--text-muted); font-size: 14px; margin-bottom: 8px;">email@example.com</p>
          <span class="status-badge member" id="userRoleBadge">Member</span>
        </div>

        <div class="settings-item">
          <label>Display Name</label>
          <input type="text" id="displayNameInput" placeholder="Your display name">
          <p class="settings-item-description">This is how your name will appear across the site</p>
        </div>

        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btnUpdateProfile">
          Update Profile
        </button>
        <div class="success-message" id="profileSuccessMsg">‚úì Profile updated successfully!</div>
      </div>

      <!-- Currency Preferences -->
      <div class="settings-card">
        <div class="settings-card-header">
          <div class="settings-card-icon">üí±</div>
          <div class="settings-card-title">
            <h3>Currency</h3>
            <p>Set your preferred currency for calculations</p>
          </div>
        </div>

        <div class="settings-item">
          <label>Default Currency</label>
          <select id="currencySelectPage">
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="GBP">GBP (¬£)</option>
            <option value="JPY">JPY (¬•)</option>
            <option value="CNY">CNY (¬•)</option>
            <option value="CAD">CAD ($)</option>
            <option value="AUD">AUD ($)</option>
            <option value="CHF">CHF (Fr)</option>
            <option value="INR">INR (‚Çπ)</option>
            <option value="MXN">MXN ($)</option>
            <option value="BRL">BRL (R$)</option>
            <option value="ZAR">ZAR (R)</option>
            <option value="KRW">KRW (‚Ç©)</option>
            <option value="SGD">SGD ($)</option>
            <option value="NZD">NZD ($)</option>
            <option value="SEK">SEK (kr)</option>
            <option value="NOK">NOK (kr)</option>
            <option value="DKK">DKK (kr)</option>
            <option value="PLN">PLN (z≈Ç)</option>
            <option value="THB">THB (‡∏ø)</option>
            <option value="IDR">IDR (Rp)</option>
            <option value="HUF">HUF (Ft)</option>
            <option value="CZK">CZK (Kƒç)</option>
            <option value="ILS">ILS (‚Ç™)</option>
            <option value="CLP">CLP ($)</option>
            <option value="PHP">PHP (‚Ç±)</option>
            <option value="AED">AED (ÿØ.ÿ•)</option>
            <option value="SAR">SAR (Ô∑º)</option>
            <option value="MYR">MYR (RM)</option>
            <option value="RON">RON (lei)</option>
          </select>
          <p class="settings-item-description">This currency will be used in the calculator by default</p>
        </div>

        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btnSaveCurrencyPage">
          Save Currency
        </button>
        <div class="success-message" id="currencySuccessMsg">‚úì Currency preference saved!</div>
      </div>

      <!-- Security Settings -->
      <div class="settings-card">
        <div class="settings-card-header">
          <div class="settings-card-icon">üîí</div>
          <div class="settings-card-title">
            <h3>Security</h3>
            <p>Manage your password and security settings</p>
          </div>
        </div>

        <div class="settings-item">
          <label>Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password">
        </div>

        <div class="settings-item">
          <label>New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password">
          <p class="settings-item-description">Must be at least 6 characters long</p>
        </div>

        <div class="settings-item">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm new password">
        </div>

        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="btnChangePassword">
          Change Password
        </button>
        <div class="success-message" id="passwordSuccessMsg">‚úì Password changed successfully!</div>
      </div>

      <!-- Preferences -->
      <div class="settings-card">
        <div class="settings-card-header">
          <div class="settings-card-icon">‚öôÔ∏è</div>
          <div class="settings-card-title">
            <h3>Preferences</h3>
            <p>Customize your experience</p>
          </div>
        </div>

        <div class="settings-toggle" id="toggleNotifications">
          <div class="settings-toggle-info">
            <h4>Email Notifications</h4>
            <p>Receive updates about your account</p>
          </div>
          <div class="toggle-switch" data-setting="notifications">
            <div class="toggle-switch-knob"></div>
          </div>
        </div>

        <div class="settings-toggle" id="toggleAutoSave">
          <div class="settings-toggle-info">
            <h4>Auto-Save Calculations</h4>
            <p>Automatically save your calculations to cloud</p>
          </div>
          <div class="toggle-switch active" data-setting="autoSave">
            <div class="toggle-switch-knob"></div>
          </div>
        </div>

        <div class="settings-toggle" id="toggleDarkMode">
          <div class="settings-toggle-info">
            <h4>Dark Mode</h4>
            <p>Currently enabled (default theme)</p>
          </div>
          <div class="toggle-switch active" data-setting="darkMode">
            <div class="toggle-switch-knob"></div>
          </div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="settings-card" style="grid-column: 1 / -1;">
        <div class="settings-card-header">
          <div class="settings-card-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">‚ö†Ô∏è</div>
          <div class="settings-card-title">
            <h3>Danger Zone</h3>
            <p>Irreversible and destructive actions</p>
          </div>
        </div>

        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
          <button class="btn btn-danger" id="btnSignOut">
            Sign Out
          </button>
          <button class="btn btn-ghost" id="btnDeleteAccount" style="color: #ef4444; border: 1px solid #ef4444;">
            Delete Account
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  /* Firebase Config */
  const firebaseConfig = {
    apiKey: "AIzaSyDwEDp5SfrxeEntOJg_XzbiBoGc9ADbX5g",
    authDomain: "vixvvowebsite.firebaseapp.com",
    projectId: "vixvvowebsite",
    storageBucket: "vixvvowebsite.appspot.com",
    messagingSenderId: "862620702799",
    appId: "1:862620702799:web:d06c0ec4e7b0f3010d323a",
    measurementId: "G-VX36JF6PTT",
    databaseURL: "https://vixvvowebsite-default-rtdb.firebaseio.com"
  };
  
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  
  const auth = firebase.auth();
  const db = firebase.database();

  // Enable auth persistence
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  let currentUser = null;
  let isAdmin = false;

  // Check if user is admin
  async function checkAdminStatus(user) {
    if (!user) return false;
    try {
      const snapshot = await db.ref(`users/${user.uid}/role`).once('value');
      const role = snapshot.val();
      return role === 'admin' || role === 'administrator';
    } catch (error) {
      console.error('Error checking admin status:', error);
      return false;
    }
  }

  // Initialize navbar handlers
  function initializeNavbarHandlers() {
    const btnSettings = document.getElementById('btnSettings');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const btnLoginSettings = document.getElementById('btnLoginSettings');
    const btnLogoutSettings = document.getElementById('btnLogoutSettings');
    const userInfoDisplay = document.getElementById('userInfoDisplay');
    const settingsUsername = document.getElementById('settingsUsername');
    const settingsRole = document.getElementById('settingsRole');
    const userAvatar = document.getElementById('userAvatar');
    const btnLoginNav = document.getElementById('btnLoginNav');

    if (!btnSettings || !settingsDropdown) {
      console.error('Navbar elements not found');
      return;
    }

    // Toggle settings dropdown
    btnSettings.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsDropdown.classList.toggle('active');
      btnSettings.classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!settingsDropdown.contains(e.target) && e.target !== btnSettings) {
        settingsDropdown.classList.remove('active');
        btnSettings.classList.remove('active');
      }
    });

    settingsDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Login button
    if (btnLoginNav) {
      btnLoginNav.addEventListener('click', () => {
        window.location.href = '../index.html';
      });
    }

    // Logout button in dropdown
    if (btnLogoutSettings) {
      btnLogoutSettings.addEventListener('click', () => {
        auth.signOut();
      });
    }

    return {
      btnLoginSettings,
      btnLogoutSettings,
      userInfoDisplay,
      settingsUsername,
      settingsRole,
      userAvatar,
      btnLoginNav
    };
  }

  let navbarElements = null;
  document.addEventListener('navbarLoaded', function() {
    console.log('Navbar loaded, initializing handlers...');
    navbarElements = initializeNavbarHandlers();
  });

  // Auth state listener
  auth.onAuthStateChanged(async user => {
    currentUser = user;

    if (user) {
      isAdmin = await checkAdminStatus(user);
      
      // Update page UI
      const email = user.email || 'user@example.com';
      const username = user.displayName || email.split('@')[0];
      
      document.getElementById('displayUsername').textContent = username;
      document.getElementById('displayEmail').textContent = email;
      document.getElementById('userAvatarLarge').textContent = username.charAt(0).toUpperCase();
      document.getElementById('displayNameInput').value = username;
      
      // Set role badge
      const roleBadge = document.getElementById('userRoleBadge');
      if (isAdmin) {
        roleBadge.textContent = 'Administrator';
        roleBadge.className = 'status-badge admin';
      } else {
        roleBadge.textContent = 'Member';
        roleBadge.className = 'status-badge member';
      }

      // Load currency preference
      db.ref('users/' + user.uid + '/currency').once('value').then(snapshot => {
        const savedCurrency = snapshot.val();
        if (savedCurrency) {
          document.getElementById('currencySelectPage').value = savedCurrency;
        }
      });

      // Update navbar
      if (navbarElements) {
        const { btnLoginSettings, btnLogoutSettings, userInfoDisplay, settingsUsername, settingsRole, userAvatar, btnLoginNav } = navbarElements;
        
        if (btnLoginNav) btnLoginNav.style.display = 'none';
        if (btnLoginSettings) btnLoginSettings.style.display = 'none';
        if (btnLogoutSettings) btnLogoutSettings.style.display = 'block';
        if (userInfoDisplay) userInfoDisplay.style.display = 'block';
        if (settingsUsername) settingsUsername.textContent = username;
        if (userAvatar) userAvatar.textContent = username.charAt(0).toUpperCase();
        if (settingsRole) settingsRole.textContent = isAdmin ? 'Administrator' : 'Member';
      }
    } else {
      // Redirect to home if not logged in
      window.location.href = '../index.html';
    }
  });

  // Update Profile
  document.getElementById('btnUpdateProfile').addEventListener('click', () => {
    const displayName = document.getElementById('displayNameInput').value.trim();
    
    if (!displayName) {
      alert('Please enter a display name');
      return;
    }

    if (currentUser) {
      currentUser.updateProfile({
        displayName: displayName
      }).then(() => {
        // Also save to database
        return db.ref('users/' + currentUser.uid).update({
          username: displayName
        });
      }).then(() => {
        document.getElementById('displayUsername').textContent = displayName;
        document.getElementById('userAvatarLarge').textContent = displayName.charAt(0).toUpperCase();
        
        const msg = document.getElementById('profileSuccessMsg');
        msg.classList.add('show');
        setTimeout(() => msg.classList.remove('show'), 3000);
      }).catch(error => {
        alert('Error updating profile: ' + error.message);
      });
    }
  });

  // Save Currency
  document.getElementById('btnSaveCurrencyPage').addEventListener('click', () => {
    const currency = document.getElementById('currencySelectPage').value;
    
    if (currentUser) {
      db.ref('users/' + currentUser.uid + '/currency').set(currency)
        .then(() => {
          const msg = document.getElementById('currencySuccessMsg');
          msg.classList.add('show');
          setTimeout(() => msg.classList.remove('show'), 3000);
        })
        .catch(error => {
          alert('Error saving currency: ' + error.message);
        });
    }
  });

  // Change Password
  document.getElementById('btnChangePassword').addEventListener('click', () => {
    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;

    if (!currentPass || !newPass || !confirmPass) {
      alert('Please fill in all password fields');
      return;
    }

    if (newPass.length < 6) {
      alert('New password must be at least 6 characters long');
      return;
    }

    if (newPass !== confirmPass) {
      alert('New passwords do not match');
      return;
    }

    if (currentUser) {
      const credential = firebase.auth.EmailAuthProvider.credential(
        currentUser.email,
        currentPass
      );

      currentUser.reauthenticateWithCredential(credential)
        .then(() => {
          return currentUser.updatePassword(newPass);
        })
        .then(() => {
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          
          const msg = document.getElementById('passwordSuccessMsg');
          msg.classList.add('show');
          setTimeout(() => msg.classList.remove('show'), 3000);
        })
        .catch(error => {
          if (error.code === 'auth/wrong-password') {
            alert('Current password is incorrect');
          } else {
            alert('Error changing password: ' + error.message);
          }
        });
    }
  });

  // Toggle switches
  document.querySelectorAll('.toggle-switch').forEach(toggle => {
    toggle.addEventListener('click', () => {
      toggle.classList.toggle('active');
      const setting = toggle.dataset.setting;
      const isActive = toggle.classList.contains('active');
      
      // Save preference to Firebase
      if (currentUser) {
        db.ref('users/' + currentUser.uid + '/preferences/' + setting).set(isActive);
      }
    });
  });

  // Sign Out
  document.getElementById('btnSignOut').addEventListener('click', () => {
    if (confirm('Are you sure you want to sign out?')) {
      auth.signOut().then(() => {
        window.location.href = '../index.html';
      });
    }
  });

  // Delete Account
  document.getElementById('btnDeleteAccount').addEventListener('click', () => {
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete your account and all data. This action cannot be undone. Are you absolutely sure?')) {
      if (confirm('Final confirmation: Delete your account permanently?')) {
        if (currentUser) {
          // Delete user data from database
          db.ref('users/' + currentUser.uid).remove()
            .then(() => {
              // Delete the user account
              return currentUser.delete();
            })
            .then(() => {
              alert('Your account has been deleted');
              window.location.href = '../index.html';
            })
            .catch(error => {
              if (error.code === 'auth/requires-recent-login') {
                alert('For security reasons, please sign out and sign in again before deleting your account');
              } else {
                alert('Error deleting account: ' + error.message);
              }
            });
        }
      }
    }
  });
</script>

</body>
</html>
