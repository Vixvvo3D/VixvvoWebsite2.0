<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Upload Model - Vixvvo Tools</title>

<!-- ========================================
     FIREBASE SDKs - REQUIRED
     These must be loaded first
     ======================================== -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<!-- ========================================
     FONTS
     ======================================== -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- ========================================
     SHARED STYLES - REQUIRED
     ======================================== -->
<link rel="stylesheet" href="../css/shared-styles.css">

<!-- ========================================
     NAVBAR SYSTEM - REQUIRED FOR FULL FUNCTIONALITY
     ======================================== -->
<script src="../js/navbar-helper.js"></script>
<script src="../js/navbar-loader.js"></script>
<script src="../js/settings-dropdown.js"></script>
<script src="../js/navbar-auth.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/currency.js"></script>

<style>
  /* ========================================
     PAGE-SPECIFIC STYLES
     ======================================== */
  
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 60px;
  }
  
  .page-header {
    text-align: center;
    margin-bottom: 48px;
  }
  
  .page-title {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 16px;
  }
  
  .page-title .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .page-subtitle {
    color: var(--text-muted);
    font-size: 18px;
  }

  /* Upload Section */
  .upload-section {
    background: linear-gradient(135deg, #1d1530, #241d35);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  .upload-area {
    border: 2px dashed var(--purple);
    border-radius: 12px;
    padding: 48px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 24px;
  }

  .upload-area:hover {
    border-color: var(--purple-light);
    background: rgba(168, 85, 247, 0.05);
  }

  .upload-area.drag-over {
    border-color: var(--purple-light);
    background: rgba(168, 85, 247, 0.1);
    transform: scale(1.02);
  }

  .upload-icon {
    font-size: 64px;
    margin-bottom: 16px;
  }

  .upload-text {
    font-size: 18px;
    color: var(--text);
    margin-bottom: 8px;
  }

  .upload-subtext {
    font-size: 14px;
    color: var(--text-muted);
  }

  #fileInput {
    display: none;
  }

  .model-name-input {
    width: 100%;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid var(--purple);
    border-radius: 12px;
    color: var(--text);
    font-size: 16px;
    font-family: 'Inter', sans-serif;
    margin-bottom: 16px;
    transition: all 0.3s ease;
  }

  .model-name-input:focus {
    outline: none;
    border-color: var(--purple-light);
    background: rgba(255, 255, 255, 0.08);
  }

  .upload-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
  }

  .upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.4);
  }

  .upload-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 16px;
    display: none;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--purple), var(--purple-light));
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Models List */
  .models-section {
    background: linear-gradient(135deg, #1d1530, #241d35);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  .section-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 24px;
    color: var(--text);
  }

  .models-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
  }

  .model-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(168, 85, 247, 0.3);
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
  }

  .model-card:hover {
    border-color: var(--purple);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3);
  }

  .model-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 12px;
    word-break: break-word;
  }

  .model-info {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .model-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }

  /* Model action buttons - scoped to avoid overriding navbar buttons */
  .model-actions .btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
  }

  .model-actions .btn-download {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    color: white;
  }

  .model-actions .btn-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
  }

  .model-actions .btn-delete {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid #ef4444;
  }

  .model-actions .btn-delete:hover {
    background: rgba(239, 68, 68, 0.3);
  }

  .empty-state {
    text-align: center;
    padding: 48px;
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Loading Spinner */
  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ========================================
     NOTIFICATION & CONFIRM DIALOG STYLES
     REQUIRED FOR DIALOGS TO WORK
     ======================================== */
  
  .notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 400px;
    width: 90%;
    text-align: center;
    display: block;
  }

  .notification.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .notification-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
  }

  .notification-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }

  .notification-message {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.5;
  }

  .notification-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .notification-buttons .btn {
    padding: 12px 32px;
  }

  .confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 400px;
    width: 90%;
    text-align: center;
  }

  .confirm-dialog.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 300;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(8px);
  }

  .overlay.show {
    opacity: 1;
    pointer-events: auto;
  }

  @media (max-width: 768px) {
    .page-container {
      padding: 30px 20px;
    }

    .page-title {
      font-size: 36px;
    }

    .models-grid {
      grid-template-columns: 1fr;
    }

    .upload-area {
      padding: 32px 16px;
    }
  }
</style>
</head>
<body>
<!-- ========================================
     LOADING OVERLAY
     ======================================== -->
<div id="loadingOverlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--dark-bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  transition: opacity 0.3s ease;
">
  <div style="
    width: 60px;
    height: 60px;
    border: 4px solid var(--border);
    border-top: 4px solid var(--purple);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  "></div>
  <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Loading upload manager...</p>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</div>

<!-- ========================================
     NAVBAR CONTAINER
     This gets automatically populated
     ======================================== -->
<div id="navbar-container"></div>

<!-- ========================================
     MAIN CONTENT
     ======================================== -->
<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Upload <span class="highlight">Model</span></h1>
    <p class="page-subtitle">Upload and manage your 3D models</p>
  </div>

  <!-- Upload Section -->
  <div class="upload-section">
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">📦</div>
      <div class="upload-text">Click to upload or drag and drop</div>
      <div class="upload-subtext">Supports: .obj, .fbx, .gltf, .glb, .blend, .stl, .dae and more</div>
      <input type="file" id="fileInput" accept=".obj,.fbx,.gltf,.glb,.blend,.stl,.dae,.3ds,.max,.ma,.mb">
    </div>

    <div id="selectedFileInfo" style="display: none; margin-bottom: 16px; padding: 16px; background: rgba(168, 85, 247, 0.1); border-radius: 8px;">
      <div style="color: var(--text); font-size: 14px; margin-bottom: 8px;">
        <strong>Selected File:</strong> <span id="fileName"></span>
      </div>
      <div style="color: var(--text-muted); font-size: 14px;">
        <strong>Size:</strong> <span id="fileSize"></span>
      </div>
    </div>

    <input 
      type="text" 
      class="model-name-input" 
      id="modelName" 
      placeholder="Enter model name (optional)"
    >

    <button class="upload-btn" id="uploadBtn" disabled>
      Upload Model
    </button>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Models List -->
  <div class="models-section">
    <h2 class="section-title">Your Models</h2>
    <div class="models-grid" id="modelsGrid">
      <div class="empty-state">
        <div class="empty-state-icon">📦</div>
        <div>No models uploaded yet</div>
      </div>
    </div>
  </div>
</div>

<!-- ========================================
     OVERLAY FOR DIALOGS
     ======================================== -->
<div class="overlay" id="overlay"></div>

<!-- ========================================
     NOTIFICATION DIALOG
     ======================================== -->
<div class="notification" id="notification">
  <div class="notification-icon" id="notificationIcon">✅</div>
  <div class="notification-title" id="notificationTitle">Success</div>
  <div class="notification-message" id="notificationMessage">Action completed!</div>
  <div class="notification-buttons">
    <button class="btn btn-download" onclick="closeNotification()">OK</button>
  </div>
</div>

<!-- ========================================
     CONFIRM DIALOG
     ======================================== -->
<div class="confirm-dialog" id="confirmDialog">
  <div class="notification-icon" id="confirmIcon">⚠️</div>
  <div class="notification-title" id="confirmTitle">Confirm Action</div>
  <div class="notification-message" id="confirmMessage">Are you sure?</div>
  <div class="notification-buttons">
    <button class="btn btn-delete" onclick="closeConfirm()">Cancel</button>
    <button class="btn btn-download" id="confirmBtn">Confirm</button>
  </div>
</div>

<!-- ========================================
     PAGE SCRIPTS
     Firebase is already initialized by navbar-loader.js
     ======================================== -->
<script>
  // ========================================
  // NOTIFICATION SYSTEM
  // ========================================
  function showNotification(message, type = 'success', title = '') {
    const notification = document.getElementById('notification');
    const overlay = document.getElementById('overlay');
    const icon = document.getElementById('notificationIcon');
    const titleEl = document.getElementById('notificationTitle');
    const messageEl = document.getElementById('notificationMessage');

    const icons = {
      success: '✅',
      error: '❌',
      warning: '⚠️',
      info: 'ℹ️'
    };

    const titles = {
      success: title || 'Success',
      error: title || 'Error',
      warning: title || 'Warning',
      info: title || 'Info'
    };

    icon.textContent = icons[type] || icons.info;
    titleEl.textContent = titles[type];
    messageEl.textContent = message;

    overlay.classList.add('show');
    notification.classList.add('show');
  }

  function closeNotification() {
    document.getElementById('notification').classList.remove('show');
    document.getElementById('overlay').classList.remove('show');
  }

  function showConfirm(message, title, onConfirm, cancelText = 'Cancel') {
    return new Promise((resolve) => {
      const confirmDialog = document.getElementById('confirmDialog');
      const overlay = document.getElementById('overlay');
      const titleEl = document.getElementById('confirmTitle');
      const messageEl = document.getElementById('confirmMessage');
      const confirmBtn = document.getElementById('confirmBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      titleEl.textContent = title;
      messageEl.textContent = message;

      overlay.classList.add('show');
      confirmDialog.classList.add('show');

      // Confirm button handler
      const handleConfirm = () => {
        closeConfirm();
        if (typeof onConfirm === 'function') {
          onConfirm();
        }
        resolve(true);
        cleanup();
      };

      // Cancel button handler
      const handleCancel = () => {
        closeConfirm();
        resolve(false);
        cleanup();
      };

      // Cleanup function to remove event listeners
      function cleanup() {
        confirmBtn.removeEventListener('click', handleConfirm);
        if (cancelBtn) cancelBtn.removeEventListener('click', handleCancel);
      }

      confirmBtn.addEventListener('click', handleConfirm);
      if (cancelBtn) {
        cancelBtn.addEventListener('click', handleCancel);
      }
    });
  }

  function closeConfirm() {
    document.getElementById('confirmDialog').classList.remove('show');
    document.getElementById('overlay').classList.remove('show');
  }

  // Close dialogs when clicking overlay
  document.getElementById('overlay').addEventListener('click', () => {
    closeNotification();
    closeConfirm();
  });

  // ========================================
  // GLOBAL VARIABLES
  // ========================================
  let selectedFile = null;
  // Note: currentUser is declared globally in auth.js

  // ========================================
  // FIREBASE AUTH STATE
  // ========================================
  // Auth state is handled in the loading overlay section below

  // ========================================
  // FILE UPLOAD HANDLING
  // ========================================
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const modelNameInput = document.getElementById('modelName');
  const selectedFileInfo = document.getElementById('selectedFileInfo');
  const fileNameEl = document.getElementById('fileName');
  const fileSizeEl = document.getElementById('fileSize');

  // Click to upload
  uploadArea.addEventListener('click', () => {
    fileInput.click();
  });

  // File selected
  fileInput.addEventListener('change', (e) => {
    handleFileSelect(e.target.files[0]);
  });

  // Drag and drop
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    handleFileSelect(e.dataTransfer.files[0]);
  });

  function handleFileSelect(file) {
    if (!file) return;

    selectedFile = file;
    uploadBtn.disabled = false;

    // Display file info
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = formatFileSize(file.size);
    selectedFileInfo.style.display = 'block';

    // Auto-fill model name if empty
    if (!modelNameInput.value) {
      modelNameInput.value = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
    }
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Upload button
  uploadBtn.addEventListener('click', uploadModel);

  async function uploadModel() {
    if (!currentUser) {
      showNotification('Please login to upload models', 'warning', 'Login Required');
      return;
    }

    if (!selectedFile) {
      showNotification('Please select a file to upload', 'warning');
      return;
    }

    const modelName = modelNameInput.value.trim() || selectedFile.name.replace(/\.[^/.]+$/, '');
    
    // Disable button and show progress
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner"></span> Uploading...';
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    progressBar.style.display = 'block';

    try {
      // Create storage reference
      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child(`models/${currentUser.uid}/${Date.now()}_${selectedFile.name}`);

      // Upload file with progress tracking
      const uploadTask = fileRef.put(selectedFile);

      uploadTask.on('state_changed',
        (snapshot) => {
          // Progress
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressFill.style.width = progress + '%';
        },
        (error) => {
          // Error
          console.error('Upload error:', error);
          showNotification('Failed to upload file: ' + error.message, 'error', 'Upload Failed');
          resetUploadForm();
        },
        async () => {
          // Success
          try {
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            
            // Save metadata to database
            const modelData = {
              name: modelName,
              fileName: selectedFile.name,
              fileSize: selectedFile.size,
              fileType: selectedFile.type || 'application/octet-stream',
              downloadURL: downloadURL,
              storagePath: uploadTask.snapshot.ref.fullPath,
              uploadedAt: firebase.database.ServerValue.TIMESTAMP,
              userId: currentUser.uid
            };

            await firebase.database().ref(`models/${currentUser.uid}`).push(modelData);

            showNotification('Model uploaded successfully!', 'success', 'Upload Complete');
            resetUploadForm();
            loadUserModels();
          } catch (error) {
            console.error('Error saving metadata:', error);
            showNotification('File uploaded but failed to save metadata', 'error');
            resetUploadForm();
          }
        }
      );
    } catch (error) {
      console.error('Upload error:', error);
      showNotification('Failed to upload file: ' + error.message, 'error', 'Upload Failed');
      resetUploadForm();
    }
  }

  function resetUploadForm() {
    selectedFile = null;
    fileInput.value = '';
    modelNameInput.value = '';
    selectedFileInfo.style.display = 'none';
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Upload Model';
    document.getElementById('progressBar').style.display = 'none';
    document.getElementById('progressFill').style.width = '0%';
  }

  // ========================================
  // LOAD MODELS
  // ========================================
  async function loadUserModels() {
    if (!currentUser) return;

    const modelsGrid = document.getElementById('modelsGrid');
    modelsGrid.innerHTML = '<div class="empty-state"><div class="spinner"></div><div>Loading models...</div></div>';

    try {
      const snapshot = await firebase.database().ref(`models/${currentUser.uid}`).once('value');
      const models = [];

      snapshot.forEach((childSnapshot) => {
        models.push({
          id: childSnapshot.key,
          ...childSnapshot.val()
        });
      });

      if (models.length === 0) {
        modelsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📦</div>
            <div>No models uploaded yet</div>
          </div>
        `;
        return;
      }

      // Sort by upload date (newest first)
      models.sort((a, b) => (b.uploadedAt || 0) - (a.uploadedAt || 0));

      // Display models
      modelsGrid.innerHTML = models.map(model => `
        <div class="model-card">
          <div class="model-name">${escapeHtml(model.name)}</div>
          <div class="model-info"><strong>File:</strong> ${escapeHtml(model.fileName)}</div>
          <div class="model-info"><strong>Size:</strong> ${formatFileSize(model.fileSize)}</div>
          <div class="model-info"><strong>Uploaded:</strong> ${formatDate(model.uploadedAt)}</div>
          <div class="model-actions">
            <button class="btn btn-download" onclick="downloadModel('${model.id}', '${escapeHtml(model.downloadURL)}', '${escapeHtml(model.fileName)}')">
              📥 Download
            </button>
            <button class="btn btn-delete" onclick="deleteModel('${model.id}', '${escapeHtml(model.storagePath)}')">
              🗑️ Delete
            </button>
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading models:', error);
      modelsGrid.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">❌</div>
          <div>Error loading models</div>
        </div>
      `;
    }
  }

  // ========================================
  // DOWNLOAD MODEL
  // ========================================
  function downloadModel(modelId, downloadURL, fileName) {
    try {
      const link = document.createElement('a');
      link.href = downloadURL;
      link.download = fileName;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification('Model download started!', 'success');
    } catch (error) {
      console.error('Download error:', error);
      showNotification('Failed to download model', 'error');
    }
  }

  // ========================================
  // DELETE MODEL
  // ========================================
  async function deleteModel(modelId, storagePath) {
    const confirmed = await showConfirm(
      'Are you sure you want to delete this model? This action cannot be undone.',
      'Delete Model'
    );
    
    if (confirmed) {
      try {
        // Delete from storage
        const storageRef = firebase.storage().ref(storagePath);
        await storageRef.delete();

        // Delete from database
        await firebase.database().ref(`models/${currentUser.uid}/${modelId}`).remove();

        showNotification('Model deleted successfully!', 'success');
        loadUserModels();
      } catch (error) {
        console.error('Delete error:', error);
        showNotification('Failed to delete model: ' + error.message, 'error');
      }
    }
  }

  // ========================================
  // UTILITY FUNCTIONS
  // ========================================
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
  }

  function formatDate(timestamp) {
    if (!timestamp) return 'Unknown';
    const date = new Date(timestamp);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // ========================================
  // CURRENCY HANDLING
  // ========================================
  window.currentCurrency = 'USD';
  window.lastSavedCurrency = 'USD';

  // Function to update the save button state
  function updateSaveButton() {
    const user = firebase.auth().currentUser;
    const currencySelect = document.getElementById('currencySelect');
    const btnSaveCurrency = document.getElementById('btnSaveCurrency');
    
    if (!currencySelect || !btnSaveCurrency) return;
    
    if (user) {
      // Show button only if logged in
      btnSaveCurrency.style.display = 'block';
      
      // Check if current currency is different from saved
      if (currencySelect.value !== window.lastSavedCurrency) {
        btnSaveCurrency.textContent = 'Save';
        btnSaveCurrency.disabled = false;
        btnSaveCurrency.style.opacity = '1';
      } else {
        btnSaveCurrency.textContent = 'Saved';
        btnSaveCurrency.disabled = true;
        btnSaveCurrency.style.opacity = '0.5';
      }
    } else {
      // Hide button if not logged in
      btnSaveCurrency.style.display = 'none';
    }
  }

  // Save currency preference to Firebase
  function saveCurrencyPreference() {
    const user = firebase.auth().currentUser;
    const currencySelect = document.getElementById('currencySelect');
    const btnSaveCurrency = document.getElementById('btnSaveCurrency');
    
    if (!user) {
      console.log('⚠️ Not logged in, currency not saved');
      showNotification('Please login to save your currency preference', 'warning', 'Login Required');
      return;
    }
    
    window.currentCurrency = currencySelect.value;
    console.log('Saving currency preference:', window.currentCurrency);
    
    btnSaveCurrency.disabled = true;
    btnSaveCurrency.textContent = 'Saving...';
    
    // Save to Firebase
    firebase.database().ref('users/' + user.uid + '/currency').set(window.currentCurrency)
      .then(() => {
        console.log('Currency saved to Firebase:', window.currentCurrency);
        window.lastSavedCurrency = window.currentCurrency;
        btnSaveCurrency.textContent = 'Saved';
        showNotification('Currency preference saved!', 'success');
        
        // Update button state after short delay
        setTimeout(() => {
          updateSaveButton();
        }, 2000);
      })
      .catch(error => {
        console.error('Error saving currency:', error);
        btnSaveCurrency.textContent = 'Error';
        showNotification('Failed to save currency. Please try again.', 'error');
        
        setTimeout(() => {
          updateSaveButton();
        }, 3000);
      });
  }

  // Load saved currency from Firebase
  function loadSavedCurrency(user) {
    if (!user) return Promise.resolve();
    
    return firebase.database().ref('users/' + user.uid + '/currency').once('value')
      .then(snapshot => {
        const savedCurrency = snapshot.val();
        if (savedCurrency) {
          console.log('Loaded saved currency:', savedCurrency);
          window.currentCurrency = savedCurrency;
          window.lastSavedCurrency = savedCurrency;
          
          const currencySelect = document.getElementById('currencySelect');
          if (currencySelect) {
            currencySelect.value = savedCurrency;
          }
          updateSaveButton();
        }
      })
      .catch(error => {
        console.error('Error loading currency:', error);
      });
  }

  // ========================================
  // NAVBAR BUTTON HANDLERS
  // ========================================
  document.addEventListener('navbarLoaded', function() {
    const btnLoginNav = document.getElementById('btnLoginNav');
    const btnLoginSettings = document.getElementById('btnLoginSettings');
    const btnLogoutSettings = document.getElementById('btnLogoutSettings');
    const btnSettingsPage = document.getElementById('btnSettingsPage');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const btnSettings = document.getElementById('btnSettings');
    const currencySelect = document.getElementById('currencySelect');
    const btnSaveCurrency = document.getElementById('btnSaveCurrency');

    // Login button in nav (visible when logged out)
    if (btnLoginNav) {
      btnLoginNav.addEventListener('click', () => {
        window.location.href = '../index.html?login=true';
      });
    }

    // Login button in settings dropdown
    if (btnLoginSettings) {
      btnLoginSettings.addEventListener('click', () => {
        window.location.href = '../index.html?login=true';
      });
    }

    // Logout button in settings dropdown
    if (btnLogoutSettings) {
      btnLogoutSettings.addEventListener('click', () => {
        showConfirm('Are you sure you want to log out?', '', 'Logout', 'Logout').then((confirmed) => {
          if (confirmed) {
            if (settingsDropdown) settingsDropdown.classList.remove('active');
            if (btnSettings) btnSettings.classList.remove('active');
            
            firebase.auth().signOut().then(() => {
              console.log('User logged out');
              showNotification('You have been logged out successfully.', 'success', 'Goodbye!');
              // Reload page to clear all user data
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            }).catch((error) => {
              console.error('Logout error:', error);
              showNotification('Logout failed. Please try again.', 'error');
            });
          }
        });
      });
    }

    // Settings page button
    if (btnSettingsPage) {
      btnSettingsPage.addEventListener('click', () => {
        window.location.href = 'settings.html';
      });
    }

    // Currency select handler
    if (currencySelect) {
      currencySelect.addEventListener('change', function() {
        window.currentCurrency = this.value;
        console.log('Currency changed to:', window.currentCurrency);
        updateSaveButton();
      });
    }

    // Currency save button handler
    if (btnSaveCurrency) {
      btnSaveCurrency.addEventListener('click', saveCurrencyPreference);
    }

    // Load saved currency when user is logged in
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        loadSavedCurrency(user);
      } else {
        // Reset to USD when logged out
        window.currentCurrency = 'USD';
        window.lastSavedCurrency = 'USD';
        if (currencySelect) {
          currencySelect.value = 'USD';
        }
        updateSaveButton();
      }
    });
  });

  // ========================================
  // LOADING OVERLAY
  // ========================================
  function hideLoadingOverlay() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
      }, 300);
    }
  }

  // Track initialization
  let authInitialized = false;
  let firebaseConnected = false;

  function checkInitComplete() {
    if (authInitialized && firebaseConnected) {
      hideLoadingOverlay();
    }
  }

  // Initialize Firebase tracking
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
      // Check Firebase connection
      firebase.database().ref('.info/connected').on('value', snapshot => {
        if (snapshot.val() === true) {
          console.log('✅ Connected to Firebase');
          firebaseConnected = true;
          checkInitComplete();
        }
      });

      // Auth state handler
      firebase.auth().onAuthStateChanged((user) => {
        console.log('Upload Model: Auth state changed:', user ? 'Logged in' : 'Logged out');
        currentUser = user;
        authInitialized = true;
        checkInitComplete();
        
        // Load models or show login prompt
        if (user) {
          loadUserModels();
        } else {
          const modelsGrid = document.getElementById('modelsGrid');
          if (modelsGrid) {
            modelsGrid.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">🔒</div>
                <div>Please login to view your models</div>
              </div>
            `;
          }
        }
      });
    }
  });

  // Fallback: Hide loading overlay after max 5 seconds
  setTimeout(() => {
    hideLoadingOverlay();
  }, 5000);
</script>
</body>
</html>
