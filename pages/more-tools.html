<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>More Tools - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="../css/shared-styles.css">

<!-- Load shared navbar helper and loader -->
<script src="../js/navbar-helper.js"></script>
<script src="../js/navbar-loader.js"></script>
<script src="../js/settings-dropdown.js"></script>
<script src="../js/navbar-auth.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/currency.js"></script>

<style>
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .main-container {
    display: flex;
    flex: 1;
  }

  /* Sidebar Navigation */
  .sidebar {
    width: 260px;
    background: transparent;
    padding: 32px 20px;
    position: relative;
    z-index: 100;
  }

  .sidebar::-webkit-scrollbar {
    width: 4px;
  }

  .sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  .sidebar::-webkit-scrollbar-thumb {
    background: rgba(168, 85, 247, 0.2);
    border-radius: 2px;
  }

  .sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(168, 85, 247, 0.4);
  }

  .sidebar-header {
    padding: 0 12px 16px;
    margin-bottom: 8px;
  }

  .sidebar-header h2 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding: 0;
  }

  .sidebar-nav a {
    display: block;
    padding: 16px 20px;
    color: var(--text-muted);
    text-decoration: none;
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 15px;
    position: relative;
    border-bottom: 2px solid transparent;
    text-align: left;
  }

  .sidebar-nav a:hover {
    color: var(--text);
  }

  .sidebar-nav a.active {
    color: var(--purple-light);
    border-bottom: 2px solid var(--purple);
  }

  /* Main Content Area */
  .content-area {
    margin-left: 280px;
    flex: 1;
    padding: 60px;
    min-height: calc(100vh - 160px);
  }

  .page-header {
    margin-bottom: 32px;
  }

  .page-title {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 16px;
  }

  .page-title .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-subtitle {
    color: var(--text-muted);
    font-size: 18px;
  }

  /* Tool Content Iframe */
  #toolFrame {
    width: 100%;
    height: calc(100vh - 320px);
    border: 1px solid var(--border);
    border-radius: 12px;
    background: linear-gradient(135deg, #241d35, #1d1530);
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .sidebar {
      width: 240px;
    }

    .content-area {
      margin-left: 240px;
      padding: 40px;
    }
  }

  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      left: -280px;
      transition: left 0.3s ease;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
    }

    .sidebar.active {
      left: 0;
    }

    .content-area {
      margin-left: 0;
      padding: 20px;
    }

    .mobile-menu-toggle {
      display: block;
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7, #c084fc);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
      z-index: 101;
    }
  }

  .mobile-menu-toggle {
    display: none;
  }

  /* Custom Notification Modal */
  .notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 400px;
    width: 90%;
    text-align: center;
    display: block;
  }

  .notification.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .notification-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
  }

  .notification-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }

  .notification-message {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.5;
  }

  .notification-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .notification-buttons .btn {
    padding: 12px 32px;
  }

  /* Confirmation Dialog Styles */
  .confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 420px;
    width: 90%;
    display: block;
  }

  .confirm-dialog.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .confirm-icon {
    font-size: 56px;
    text-align: center;
    margin-bottom: 16px;
    display: block;
  }

  .confirm-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
    text-align: center;
  }

  .confirm-message {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.6;
    text-align: center;
  }

  .confirm-buttons {
    display: flex;
    gap: 12px;
  }

  .confirm-buttons .btn {
    flex: 1;
    padding: 14px;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, .4);
  }
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--dark-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s ease;
  ">
    <div style="
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Loading tools...</p>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>

  <!-- Navigation will be loaded by navbar-loader.js -->
  <div id="navbar-container"></div>
  
  <div class="main-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>More Tools</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="orders.html" data-tool="orders" class="tool-link active">Orders</a>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="content-area">
      <div class="page-header">
        <h1 class="page-title">More <span class="highlight">Tools</span></h1>
        <p class="page-subtitle">Additional tools to help you manage your workflow</p>
      </div>
      
      <iframe id="toolFrame" src="orders.html" frameborder="0"></iframe>
    </main>
  </div>

  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>

  <!-- Overlay for modals and notifications -->
  <div id="overlay"></div>

  <!-- Custom Notification -->
  <div id="customNotification" class="notification">
    <div class="notification-icon"></div>
    <div class="notification-title">Success!</div>
    <div class="notification-message"></div>
    <div class="notification-buttons">
      <button class="btn btn-primary" onclick="hideNotification()">Got it!</button>
    </div>
  </div>

  <!-- Custom Confirm Dialog -->
  <div id="customConfirm" class="confirm-dialog">
    <div class="confirm-icon"></div>
    <div class="confirm-title">Are you sure?</div>
    <div class="confirm-message"></div>
    <div class="confirm-buttons">
      <button id="confirmYes" class="btn btn-danger">Confirm</button>
      <button id="confirmNo" class="btn btn-ghost">Cancel</button>
    </div>
  </div>

  <script>
    // Firebase is initialized by auth.js

    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const sidebar = document.getElementById('sidebar');

    if (mobileMenuToggle) {
      mobileMenuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });
    }

    // Handle tool navigation in iframe
    const toolLinks = document.querySelectorAll('.tool-link');
    const toolFrame = document.getElementById('toolFrame');

    toolLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all links
        toolLinks.forEach(l => l.classList.remove('active'));
        
        // Add active class to clicked link
        link.classList.add('active');
        
        // Load the tool in iframe
        const toolUrl = link.getAttribute('href');
        toolFrame.src = toolUrl;
        
        // Close mobile menu if open
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('active');
        }
      });
    });

    // Hide loading overlay
    function hideLoadingOverlay() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 300);
      }
    }

    // Track initialization
    let authInitialized = false;
    let firebaseConnected = false;

    function checkInitComplete() {
      if (authInitialized && firebaseConnected) {
        hideLoadingOverlay();
      }
    }

    // Initialize Firebase Auth
    document.addEventListener('DOMContentLoaded', () => {
      // Firebase config will be loaded by navbar-loader.js
      if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
        // Check Firebase connection
        firebase.database().ref('.info/connected').on('value', snapshot => {
          if (snapshot.val() === true) {
            console.log('✅ Connected to Firebase');
            firebaseConnected = true;
            checkInitComplete();
          }
        });

        firebase.auth().onAuthStateChanged((user) => {
          console.log('Auth state changed:', user ? 'Logged in' : 'Logged out');
          authInitialized = true;
          checkInitComplete();
        });
      }
    });

    // Fallback: Hide loading overlay after max 5 seconds
    setTimeout(() => {
      hideLoadingOverlay();
    }, 5000);

    // Dropdown functionality is now handled by settings-dropdown.js

    /* Custom Notification System */
    function showNotification(message, icon = '', title = 'Success!') {
      const notification = document.getElementById('customNotification');
      const overlay = document.getElementById('overlay');
      
      notification.querySelector('.notification-icon').textContent = icon;
      notification.querySelector('.notification-title').textContent = title;
      notification.querySelector('.notification-message').textContent = message;
      
      overlay.style.display = 'block';
      notification.classList.add('show');
    }

    function hideNotification() {
      const notification = document.getElementById('customNotification');
      const overlay = document.getElementById('overlay');
      
      notification.classList.remove('show');
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    }

    /* Custom Confirm Dialog */
    function showConfirm(message, icon = '', title = 'Are you sure?', buttonText = 'Confirm') {
      return new Promise((resolve) => {
        const confirmDialog = document.getElementById('customConfirm');
        const overlay = document.getElementById('overlay');
        const yesBtn = document.getElementById('confirmYes');
        const noBtn = document.getElementById('confirmNo');
        
        confirmDialog.querySelector('.confirm-icon').textContent = icon;
        confirmDialog.querySelector('.confirm-title').textContent = title;
        confirmDialog.querySelector('.confirm-message').textContent = message;
        yesBtn.textContent = buttonText;
        
        overlay.style.display = 'block';
        confirmDialog.classList.add('show');
        
        const cleanup = () => {
          confirmDialog.classList.remove('show');
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 300);
        };
        
        yesBtn.onclick = () => {
          cleanup();
          resolve(true);
        };
        
        noBtn.onclick = () => {
          cleanup();
          resolve(false);
        };
      });
    }

    // Currency handling variables
    window.currentCurrency = 'USD';
    window.lastSavedCurrency = 'USD';

    // Function to update the save button state
    function updateSaveButton() {
      const user = firebase.auth().currentUser;
      const currencySelect = document.getElementById('currencySelect');
      const btnSaveCurrency = document.getElementById('btnSaveCurrency');
      
      if (!currencySelect || !btnSaveCurrency) return;
      
      if (user) {
        // Show button only if logged in
        btnSaveCurrency.style.display = 'block';
        
        // Check if current currency is different from saved
        if (currencySelect.value !== window.lastSavedCurrency) {
          btnSaveCurrency.textContent = 'Save';
          btnSaveCurrency.disabled = false;
          btnSaveCurrency.style.opacity = '1';
        } else {
          btnSaveCurrency.textContent = 'Saved';
          btnSaveCurrency.disabled = true;
          btnSaveCurrency.style.opacity = '0.5';
        }
      } else {
        // Hide button if not logged in
        btnSaveCurrency.style.display = 'none';
      }
    }

    // Save currency preference to Firebase
    function saveCurrencyPreference() {
      const user = firebase.auth().currentUser;
      const currencySelect = document.getElementById('currencySelect');
      const btnSaveCurrency = document.getElementById('btnSaveCurrency');
      
      if (!user) {
        console.log('⚠️ Not logged in, currency not saved');
        showNotification('Please login to save your currency preference', '', 'Login Required');
        return;
      }
      
      window.currentCurrency = currencySelect.value;
      console.log('Saving currency preference:', window.currentCurrency);
      
      btnSaveCurrency.disabled = true;
      btnSaveCurrency.textContent = 'Saving...';
      
      // Save to Firebase
      firebase.database().ref('users/' + user.uid + '/currency').set(window.currentCurrency)
        .then(() => {
          console.log('✅ Currency saved to Firebase:', window.currentCurrency);
          window.lastSavedCurrency = window.currentCurrency;
          btnSaveCurrency.textContent = 'Saved';
          showNotification('Currency preference saved!', '✓', 'Success');
          
          // Reload page after 1 second to show new currency
          setTimeout(() => {
            location.reload();
          }, 1000);
        })
        .catch(error => {
          console.error('❌ Error saving currency:', error);
          btnSaveCurrency.textContent = 'Error';
          showNotification('Failed to save currency. Please try again.', '', 'Error');
          
          setTimeout(() => {
            updateSaveButton();
          }, 3000);
        });
    }

    // Load saved currency from Firebase
    function loadSavedCurrency(user) {
      if (!user) return;
      
      firebase.database().ref('users/' + user.uid + '/currency').once('value')
        .then(snapshot => {
          const savedCurrency = snapshot.val();
          if (savedCurrency) {
            console.log('✅ Loaded saved currency:', savedCurrency);
            window.currentCurrency = savedCurrency;
            window.lastSavedCurrency = savedCurrency;
            
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect) {
              currencySelect.value = savedCurrency;
            }
            updateSaveButton();
          }
        })
        .catch(error => {
          console.error('Error loading currency:', error);
        });
    }

    // Initialize button handlers after navbar loads
    document.addEventListener('navbarLoaded', function() {
      const btnLoginNav = document.getElementById('btnLoginNav');
      const btnLoginSettings = document.getElementById('btnLoginSettings');
      const btnLogoutSettings = document.getElementById('btnLogoutSettings');
      const btnSettingsPage = document.getElementById('btnSettingsPage');
      const settingsDropdown = document.getElementById('settingsDropdown');
      const btnSettings = document.getElementById('btnSettings');
      const currencySelect = document.getElementById('currencySelect');
      const btnSaveCurrency = document.getElementById('btnSaveCurrency');

      // Login button in nav (visible when logged out)
      if (btnLoginNav) {
        btnLoginNav.addEventListener('click', () => {
          window.location.href = '../index.html?login=true';
        });
      }

      // Login button in settings dropdown
      if (btnLoginSettings) {
        btnLoginSettings.addEventListener('click', () => {
          window.location.href = '../index.html?login=true';
        });
      }

      // Logout button in settings dropdown
      if (btnLogoutSettings) {
        btnLogoutSettings.addEventListener('click', () => {
          showConfirm('Are you sure you want to log out?', '', 'Logout', 'Logout').then((confirmed) => {
            if (confirmed) {
              if (settingsDropdown) settingsDropdown.classList.remove('active');
              if (btnSettings) btnSettings.classList.remove('active');
              
              firebase.auth().signOut().then(() => {
                console.log('User logged out');
                showNotification('You have been logged out successfully.', '', 'Goodbye!');
                // Reload page to clear all user data
                setTimeout(() => {
                  window.location.reload();
                }, 1500);
              }).catch((error) => {
                console.error('Logout error:', error);
                showNotification('Logout failed. Please try again.', '', 'Error');
              });
            }
          });
        });
      }

      // Settings page button
      if (btnSettingsPage) {
        btnSettingsPage.addEventListener('click', () => {
          window.location.href = 'settings.html';
        });
      }

      // Currency select handler
      if (currencySelect) {
        currencySelect.addEventListener('change', function() {
          window.currentCurrency = this.value;
          console.log('Currency changed to:', window.currentCurrency);
          updateSaveButton();
        });
      }

      // Currency save button handler
      if (btnSaveCurrency) {
        btnSaveCurrency.addEventListener('click', saveCurrencyPreference);
      }

      // Load saved currency when user is logged in
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          loadSavedCurrency(user);
        } else {
          // Reset to USD when logged out
          window.currentCurrency = 'USD';
          window.lastSavedCurrency = 'USD';
          if (currencySelect) {
            currencySelect.value = 'USD';
          }
        }
        updateSaveButton();
      });
    });
  </script>
</body>
</html>
