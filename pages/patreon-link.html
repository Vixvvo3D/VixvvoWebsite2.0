<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Patreon Integration - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="../css/shared-styles.css">

<!-- Load shared navbar -->
<script src="../js/navbar-helper.js"></script>
<script src="../js/navbar-loader.js"></script>
<script src="../js/settings-dropdown.js"></script>
<script src="../js/navbar-auth.js"></script>
<script src="../js/auth.js"></script>

<style>
  /* Patreon Page Specific Styles */
  * {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    min-height: 100vh;
  }

  .patreon-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px 40px 80px;
  }

  .page-header {
    text-align: center;
    margin-bottom: 60px;
    padding-top: 60px;
  }

  .page-title {
    font-size: 64px;
    font-weight: 900;
    margin-bottom: 20px;
    letter-spacing: -1px;
    line-height: 1.1;
  }

  .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc, #e879f9);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-subtitle {
    color: var(--text-muted);
    font-size: 18px;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.7;
  }

  .patreon-card {
    background: #241d35;
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
    transition: transform .3s, box-shadow .3s, border-color .3s;
  }

  .patreon-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(168, 85, 247, .2);
    border-color: var(--purple);
  }

  .status-card {
    background: rgba(168, 85, 247, .08);
    border: 1px solid rgba(168, 85, 247, 0.25);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .status-label {
    font-size: 13px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .status-value {
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .membership-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    margin-top: 8px;
  }

  .patreon-container .btn,
  .patreon-card .btn {
    width: 100%;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all .3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .btn-patreon {
    background: #FF424D;
    color: white;
  }

  .btn-patreon:hover {
    background: #e03840;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 66, 77, .3);
  }

  .btn-sync {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    color: white;
  }

  .btn-sync:hover {
    background: linear-gradient(135deg, var(--purple-light), #d8b4fe);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, .4);
  }

  .btn-unlink {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
  }

  .btn-unlink:hover {
    border-color: var(--error);
    color: var(--error);
    background: rgba(239, 68, 68, .05);
  }

  .patreon-container .btn:disabled,
  .patreon-card .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .info-box {
    background: rgba(168, 85, 247, .1);
    border: 1px solid rgba(168, 85, 247, .3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    font-size: 14px;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .info-box::before {
    content: "ðŸ’¡";
    margin-right: 8px;
  }

  .loading {
    display: none;
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .loading.active {
    display: block;
  }

  .spinner {
    border: 3px solid rgba(168, 85, 247, .2);
    border-top: 3px solid var(--purple);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .alert {
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: none;
    animation: slideIn .3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert.active {
    display: block;
  }

  .error {
    background: rgba(239, 68, 68, .1);
    border: 1px solid rgba(239, 68, 68, .3);
    color: var(--error);
  }

  .success {
    background: rgba(16, 185, 129, .1);
    border: 1px solid rgba(16, 185, 129, .3);
    color: var(--success);
  }

  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }

  .button-group .btn {
    flex: 1;
  }

  @media (max-width: 768px) {
    .patreon-container {
      padding: 20px 20px 40px;
    }

    .page-title {
      font-size: 36px;
    }

    .button-group {
      flex-direction: column;
    }
  }
  /* Notification Styles */
  .notification {
    position: fixed;
    top: 24px;
    right: 24px;
    transform: translateX(400px);
    background: #1e172e;
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 12px;
    padding: 20px 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(168, 85, 247, 0.1);
    z-index: 9999;
    min-width: 320px;
    max-width: 420px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .notification.show {
    opacity: 1;
    transform: translateX(0);
    pointer-events: all;
  }

  .notification-icon {
    font-size: 28px;
    min-width: 28px;
    text-align: center;
    filter: drop-shadow(0 0 8px currentColor);
  }

  .notification-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .notification-title {
    font-size: 16px;
    font-weight: 600;
    color: #f3f4f6;
    line-height: 1.3;
  }

  .notification-message {
    font-size: 14px;
    color: #9ca3af;
    line-height: 1.4;
  }

  .notification-close {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    line-height: 1;
    opacity: 0.6;
  }

  .notification-close:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #f3f4f6;
    opacity: 1;
  }

  /* Success variant */
  .notification.success {
    border-color: rgba(16, 185, 129, 0.4);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.success .notification-icon {
    color: #10b981;
  }

  /* Error variant */
  .notification.error {
    border-color: rgba(239, 68, 68, 0.4);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.error .notification-icon {
    color: #ef4444;
  }

  /* Warning variant */
  .notification.warning {
    border-color: rgba(245, 158, 11, 0.4);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.warning .notification-icon {
    color: #f59e0b;
  }

  /* Progress bar animation */
  .notification::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, #a855f7, #c084fc);
    border-radius: 0 0 12px 12px;
    animation: notificationProgress 3s linear forwards;
  }

  .notification.success::after {
    background: linear-gradient(90deg, #10b981, #34d399);
  }

  .notification.error::after {
    background: linear-gradient(90deg, #ef4444, #f87171);
  }

  .notification.warning::after {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
  }

  @keyframes notificationProgress {
    from {
      width: 100%;
    }
    to {
      width: 0%;
    }
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .notification {
      top: 12px;
      right: 12px;
      left: 12px;
      min-width: auto;
      max-width: none;
    }
  }

  /* Confirm Dialog Styles */

  .confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 420px;
    width: 90%;
    display: block;
  }

  .confirm-dialog.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .confirm-icon {
    font-size: 56px;
    text-align: center;
    margin-bottom: 16px;
    display: block;
  }

  .confirm-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
    text-align: center;
  }

  .confirm-message {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.6;
    text-align: center;
  }

  .confirm-buttons {
    display: flex;
    gap: 12px;
  }

  .confirm-buttons .btn {
    flex: 1;
    padding: 14px;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, .4);
  }
  </style>
</head>
<body>
  <!-- Navbar Container -->
  <div id="navbar-container"></div>
  
  <div class="patreon-container">
    <div class="page-header">
      <h1 class="page-title">
        <span class="highlight">Patreon</span> Integration
      </h1>
      <p class="page-subtitle">Connect your Patreon account to unlock premium features</p>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Loading your membership status...</p>
    </div>

    <div class="error alert" id="error"></div>
    <div class="success alert" id="success"></div>

    <div id="content" style="display: none;">
      <div class="patreon-card">
        <div class="status-card">
          <div class="status-label">Current Membership</div>
          <div class="status-value" id="membershipTier">Free</div>
        </div>

        <div class="status-card">
          <div class="status-label">Patreon Status</div>
          <div class="status-value" id="patreonStatus">Not Connected</div>
        </div>

        <div class="info-box" id="infoBox">
          Connect your Patreon account to automatically sync your membership tier. 
          When you subscribe or change tiers on Patreon, your website access will update automatically!
        </div>

        <div id="notConnected" style="display: none;">
          <button class="btn btn-patreon" onclick="connectPatreon()">
            <svg width="20" height="20" viewBox="0 0 569 546" fill="currentColor">
              <circle cx="362.589996" cy="204.589996" r="204.589996"/>
              <rect width="100" height="545.799988" x="0" y="0"/>
            </svg>
            Connect with Patreon
          </button>
        </div>

        <div id="connected" style="display: none;">
          <button class="btn btn-sync" onclick="syncMembership()">
            Sync Membership
          </button>
          <button class="btn btn-unlink" onclick="unlinkPatreon()">
            Unlink Patreon Account
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay for dialogs -->
  <div id="overlay"></div>

  <!-- Notification Dialog -->
  <div id="customNotification" class="notification">
    <div class="notification-icon">âœ“</div>
    <div class="notification-content">
      <div class="notification-title">Success!</div>
      <div class="notification-message"></div>
    </div>
    <button class="notification-close" onclick="hideNotification()">Ã—</button>
  </div>

  <!-- Confirm Dialog -->
  <div id="customConfirm" class="confirm-dialog">
    <div class="confirm-icon"></div>
    <div class="confirm-title">Are you sure?</div>
    <div class="confirm-message"></div>
    <div class="confirm-buttons">
      <button id="confirmYes" class="btn btn-danger">Confirm</button>
      <button id="confirmNo" class="btn btn-ghost">Cancel</button>
    </div>
  </div>

  <script src="../js/membership.js"></script>
  <script src="../js/patreon-config.js"></script>
  <script>
    // ========================================
    // NOTIFICATION SYSTEM
    // ========================================
    function showNotification(message, type = 'success', title = '') {
      const notification = document.getElementById('customNotification');
      
      // Remove previous type classes
      notification.classList.remove('success', 'error', 'warning');
      
      // Set icon and title based on type
      let icon = 'âœ“';
      let notificationTitle = title || 'Success!';
      
      if (type === 'error') {
        icon = 'âœ•';
        notificationTitle = title || 'Error';
      } else if (type === 'warning') {
        icon = 'âš ';
        notificationTitle = title || 'Warning';
      }
      
      // Update content
      notification.querySelector('.notification-icon').textContent = icon;
      notification.querySelector('.notification-title').textContent = notificationTitle;
      notification.querySelector('.notification-message').textContent = message;
      
      // Add type class and show
      notification.classList.add(type);
      notification.classList.add('show');
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        hideNotification();
      }, 3000);
    }

    function hideNotification() {
      const notification = document.getElementById('customNotification');
      notification.classList.remove('show');
    }

    // ========================================
    // CONFIRM DIALOG SYSTEM
    // ========================================
    function showConfirm(message, icon = '', title = 'Are you sure?', buttonText = 'Confirm') {
      return new Promise((resolve) => {
        const confirmDialog = document.getElementById('customConfirm');
        const overlay = document.getElementById('overlay');
        const yesBtn = document.getElementById('confirmYes');
        const noBtn = document.getElementById('confirmNo');
        
        confirmDialog.querySelector('.confirm-icon').textContent = icon;
        confirmDialog.querySelector('.confirm-title').textContent = title;
        confirmDialog.querySelector('.confirm-message').textContent = message;
        yesBtn.textContent = buttonText;
        
        overlay.style.display = 'block';
        confirmDialog.classList.add('show');
        
        const handleYes = () => {
          confirmDialog.classList.remove('show');
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 300);
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          resolve(true);
        };
        
        const handleNo = () => {
          confirmDialog.classList.remove('show');
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 300);
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          resolve(false);
        };
        
        yesBtn.addEventListener('click', handleYes);
        noBtn.addEventListener('click', handleNo);
      });
    }

    // ========================================
    // CURRENCY HANDLING
    // ========================================
    window.currentCurrency = 'USD';
    window.lastSavedCurrency = 'USD';

    function updateSaveButton() {
      const user = firebase.auth().currentUser;
      const currencySelect = document.getElementById('currencySelect');
      const btnSaveCurrency = document.getElementById('btnSaveCurrency');
      
      if (!currencySelect || !btnSaveCurrency) return;
      
      if (user) {
        btnSaveCurrency.style.display = 'block';
        
        if (currencySelect.value !== window.lastSavedCurrency) {
          btnSaveCurrency.textContent = 'Save';
          btnSaveCurrency.disabled = false;
          btnSaveCurrency.style.opacity = '1';
        } else {
          btnSaveCurrency.textContent = 'Saved';
          btnSaveCurrency.disabled = true;
          btnSaveCurrency.style.opacity = '0.5';
        }
      } else {
        btnSaveCurrency.style.display = 'none';
      }
    }

    function saveCurrencyPreference() {
      const user = firebase.auth().currentUser;
      const currencySelect = document.getElementById('currencySelect');
      const btnSaveCurrency = document.getElementById('btnSaveCurrency');
      
      if (!user) {
        console.log('âš ï¸ Not logged in, currency not saved');
        showNotification('Please login to save your currency preference', 'warning', 'Login Required');
        return;
      }
      
      window.currentCurrency = currencySelect.value;
      console.log('Saving currency preference:', window.currentCurrency);
      
      btnSaveCurrency.disabled = true;
      btnSaveCurrency.textContent = 'Saving...';
      
      firebase.database().ref('users/' + user.uid + '/currency').set(window.currentCurrency)
        .then(() => {
          console.log('âœ… Currency saved to Firebase:', window.currentCurrency);
          window.lastSavedCurrency = window.currentCurrency;
          btnSaveCurrency.textContent = 'Saved';
          showNotification('Currency preference saved! Reloading page...', 'success');
          
          // Reload page after 1 second
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        })
        .catch(error => {
          console.error('âŒ Error saving currency:', error);
          btnSaveCurrency.textContent = 'Error';
          showNotification('Failed to save currency. Please try again.', 'error', 'Error');
          
          setTimeout(() => {
            updateSaveButton();
          }, 3000);
        });
    }

    function loadSavedCurrency(user) {
      if (!user) return;
      
      firebase.database().ref('users/' + user.uid + '/currency').once('value')
        .then(snapshot => {
          const savedCurrency = snapshot.val();
          if (savedCurrency) {
            console.log('âœ… Loaded saved currency:', savedCurrency);
            window.currentCurrency = savedCurrency;
            window.lastSavedCurrency = savedCurrency;
            
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect) {
              currencySelect.value = savedCurrency;
            }
            updateSaveButton();
          }
        })
        .catch(error => {
          console.error('Error loading currency:', error);
        });
    }

    // ========================================
    // NAVBAR INITIALIZATION
    // ========================================
    document.addEventListener('navbarLoaded', function() {
      console.log('âœ… Navbar loaded, initializing handlers...');
      
      const btnLoginNav = document.getElementById('btnLoginNav');
      const btnLoginSettings = document.getElementById('btnLoginSettings');
      const btnLogoutSettings = document.getElementById('btnLogoutSettings');
      const btnSettingsPage = document.getElementById('btnSettingsPage');
      const settingsDropdown = document.getElementById('settingsDropdown');
      const btnSettings = document.getElementById('btnSettings');
      const currencySelect = document.getElementById('currencySelect');
      const btnSaveCurrency = document.getElementById('btnSaveCurrency');

      // Login button in nav
      if (btnLoginNav) {
        btnLoginNav.addEventListener('click', () => {
          window.location.href = '../index.html?login=true';
        });
      }

      // Login button in settings dropdown
      if (btnLoginSettings) {
        btnLoginSettings.addEventListener('click', () => {
          window.location.href = '../index.html?login=true';
        });
      }

      // Logout button
      if (btnLogoutSettings) {
        btnLogoutSettings.addEventListener('click', () => {
          showConfirm('Are you sure you want to log out?', 'ðŸ‘‹', 'Logout', 'Logout').then((confirmed) => {
            if (confirmed) {
              if (settingsDropdown) settingsDropdown.classList.remove('active');
              if (btnSettings) btnSettings.classList.remove('active');
              
              firebase.auth().signOut().then(() => {
                console.log('User logged out');
                showNotification('You have been logged out successfully.', 'success', 'Goodbye!');
                setTimeout(() => {
                  window.location.reload();
                }, 1500);
              }).catch((error) => {
                console.error('Logout error:', error);
                showNotification('Logout failed. Please try again.', 'error', 'Error');
              });
            }
          });
        });
      }

      // Settings page button
      if (btnSettingsPage) {
        btnSettingsPage.addEventListener('click', () => {
          window.location.href = 'settings.html';
        });
      }

      // Currency select handler
      if (currencySelect) {
        currencySelect.addEventListener('change', function() {
          window.currentCurrency = this.value;
          console.log('Currency changed to:', window.currentCurrency);
          updateSaveButton();
        });
      }

      // Currency save button
      if (btnSaveCurrency) {
        btnSaveCurrency.addEventListener('click', saveCurrencyPreference);
      }

      // Load saved currency
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          loadSavedCurrency(user);
        } else {
          window.currentCurrency = 'USD';
          window.lastSavedCurrency = 'USD';
          if (currencySelect) {
            currencySelect.value = 'USD';
          }
        }
        updateSaveButton();
      });
    });

    // ========================================
    // PATREON INTEGRATION LOGIC
    // ========================================
    // currentUser is already declared in auth.js
    
    // Check if returning from Patreon OAuth
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const error = urlParams.get('error');
    
    // Initialize - wait for Firebase to be ready
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '../index.html';
        return;
      }

      currentUser = user;
      
      // Handle OAuth callback if code is present
      if (code) {
        await handleOAuthCallback(code);
      } else if (error) {
        showError('Patreon authorization was cancelled or failed.');
        document.getElementById('loading').classList.remove('active');
        document.getElementById('content').style.display = 'block';
      } else {
        await loadMembershipStatus();
      }
    });

    async function loadMembershipStatus() {
      document.getElementById('loading').classList.add('active');

      try {
        // Get membership tier
        const tier = await getUserMembershipTier(currentUser.uid);
        displayMembership(tier);

        // Check Patreon connection
        const patreonConnection = await getPatreonConnection(currentUser.uid);
        
        if (patreonConnection && patreonConnection.patronId) {
          document.getElementById('patreonStatus').innerHTML = 
            '<span style="color: var(--success)">Connected</span>';
          document.getElementById('connected').style.display = 'block';
          document.getElementById('notConnected').style.display = 'none';
          document.getElementById('infoBox').innerHTML = 
            'Your Patreon account is connected! Your membership tier will automatically sync when your Patreon subscription changes.';
        } else {
          document.getElementById('patreonStatus').innerHTML = 
            '<span style="color: var(--error)">Not Connected</span>';
          document.getElementById('connected').style.display = 'none';
          document.getElementById('notConnected').style.display = 'block';
        }

        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading membership:', error);
        showError('Failed to load membership status');
      } finally {
        document.getElementById('loading').classList.remove('active');
      }
    }

    function displayMembership(tier) {
      const tierInfo = TIER_INFO[tier];
      const container = document.getElementById('membershipTier');
      
      container.innerHTML = `
        <div class="membership-badge" style="
          background: linear-gradient(135deg, ${tierInfo.color}22, ${tierInfo.color}11);
          border: 1px solid ${tierInfo.color}88;
          color: ${tierInfo.color};
        ">
          ${tierInfo.name}
          ${tier !== 'bronze' ? `<span style="opacity: 0.7">($${tierInfo.price}/mo)</span>` : ''}
        </div>
      `;
    }

    function connectPatreon() {
      // Check if Patreon is configured
      if (!validatePatreonConfig()) {
        showNotification('Patreon integration not configured yet. Please contact the administrator.', 'warning', 'Not Configured');
        console.error('Patreon Client ID missing in js/patreon-config.js');
        return;
      }
      
      console.log('ðŸŽ¨ Redirecting to Patreon OAuth...');
      console.log('Redirect URI:', PATREON_CONFIG.redirectUri);
      
      // Redirect to Patreon authorization page
      window.location.href = PATREON_CONFIG.authUrl;
    }

    async function handleOAuthCallback(code) {
      document.getElementById('loading').classList.add('active');
      document.getElementById('content').style.display = 'none';

      try {
        const patreonOAuthCallback = firebase.functions().httpsCallable('patreonOAuthCallback');
        const result = await patreonOAuthCallback({
          code: code,
          userId: currentUser.uid
        });

        showNotification(`Successfully linked Patreon account! You are now on the ${result.data.tier} tier.`, 'success', 'Success!');
        
        // Remove query params from URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Reload status
        setTimeout(() => {
          hideNotification();
          loadMembershipStatus();
        }, 2500);

      } catch (error) {
        console.error('Error linking Patreon:', error);
        showNotification('Failed to link Patreon account: ' + error.message, 'error', 'Error');
        
        // Remove query params and reload to show connect button
        window.history.replaceState({}, document.title, window.location.pathname);
        document.getElementById('loading').classList.remove('active');
        await loadMembershipStatus();
      }
    }

    async function syncMembership() {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = 'Syncing...';

      try {
        const syncPatreonMembership = firebase.functions().httpsCallable('syncPatreonMembership');
        const result = await syncPatreonMembership({
          userId: currentUser.uid
        });

        showNotification(`Membership synced! Your current tier is ${result.data.tier}.`, 'success', 'Synced!');
        await loadMembershipStatus();

      } catch (error) {
        console.error('Error syncing membership:', error);
        showNotification('Failed to sync membership: ' + error.message, 'error', 'Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Sync Membership';
      }
    }

    async function unlinkPatreon() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Unlinking...';

      try {
        await unlinkPatreonAccount(currentUser.uid);
        showNotification('Patreon account unlinked successfully.', 'success', 'Unlinked');
        await loadMembershipStatus();
        btn.textContent = 'Unlink Patreon Account';

      } catch (error) {
        console.error('Error unlinking Patreon:', error);
        showNotification('Failed to unlink Patreon account: ' + error.message, 'error', 'Error');
        btn.textContent = 'Unlink Patreon Account';
      } finally {
        btn.disabled = false;
      }
    }

    function showError(message) {
      showNotification(message, 'error', 'Error');
    }

    function showSuccess(message) {
      showNotification(message, 'success', 'Success!');
    }
  </script>
</body>
</html>
