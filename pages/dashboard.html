<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<!-- Initialize Firebase and Google Maps - must load immediately after Firebase SDKs -->
<script src="../js/dashboard.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="../css/shared-styles.css">
<link rel="stylesheet" href="../css/dashboard.css">
<link rel="stylesheet" href="../css/upload-model.css">

<!-- Load shared navbar components -->
<script src="../js/navbar-helper.js" defer></script>
<script src="../js/navbar-loader.js" defer></script>
<script src="../js/settings-dropdown.js" defer></script>
<script src="../js/navbar-auth.js" defer></script>
<script src="../js/auth.js" defer></script>
<script src="../js/currency.js" defer></script>
<script src="../js/orders.js" defer></script>

<!-- Google Places API (New) for Address Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwEDp5SfrxeEntOJg_XzbiBoGc9ADbX5g&libraries=places&callback=initGoogleMaps&loading=async" async defer></script>
<script>
  (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
    key: "AIzaSyDwEDp5SfrxeEntOJg_XzbiBoGc9ADbX5g",
    v: "beta"
  });
</script>
</head>
<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <span class="sidebar-brand">VIXVVO</span>
      </div>
      <span class="sidebar-subtitle">TOOLS</span>
    </div>

    <ul class="sidebar-menu">
      <li>
        <a href="#" class="nav-link active" data-page="dashboard">
          <span class="sidebar-icon"><img src="../images/Icons/House.svg" alt="Dashboard"></span>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="calculator">
          <span class="sidebar-icon"><img src="../images/Icons/Calculator.svg" alt="Calculator"></span>
          <span>Calculator</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="orders">
          <span class="sidebar-icon"><img src="../images/Icons/ShoppingCart.svg" alt="Orders"></span>
          <span>Orders</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="upload-model">
          <span class="sidebar-icon"><img src="../images/Icons/Upload.svg" alt="Upload"></span>
          <span>Upload Model</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="clients">
          <span class="sidebar-icon"><img src="../images/Icons/Users.svg" alt="Clients"></span>
          <span>Clients</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="tools">
          <span class="sidebar-icon"><img src="../images/Icons/Toolbox.svg" alt="Tools"></span>
          <span>Tools</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="activity">
          <span class="sidebar-icon"><img src="../images/Icons/Clock.svg" alt="Activity"></span>
          <span>Activity</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="settings">
          <span class="sidebar-icon"><img src="../images/Icons/GearSix.svg" alt="Settings"></span>
          <span>Settings</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Dashboard -->
  <div class="dashboard-wrapper">
    <!-- Dashboard Content -->
    <main class="dashboard-content">
      <div class="content-container">
        <!-- Header -->
        <header class="dashboard-header">
          <div class="header-left">
            <h1 id="greeting">Loading...</h1>
            <p class="header-date" id="current-date">Loading...</p>
          </div>
          <div class="header-right">
            <button class="header-icon-btn" title="Search">
              <img src="../images/Icons/MagnifyingGlass.svg" alt="Search">
            </button>
            
            <!-- Currency Selector -->
            <div class="currency-selector-wrapper">
              <select id="currencySelector" class="currency-selector" title="Select Currency">
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="GBP">GBP (£)</option>
                <option value="JPY">JPY (¥)</option>
                <option value="CNY">CNY (¥)</option>
                <option value="CAD">CAD ($)</option>
                <option value="AUD">AUD ($)</option>
                <option value="CHF">CHF (Fr)</option>
                <option value="INR">INR (₹)</option>
                <option value="MXN">MXN ($)</option>
                <option value="BRL">BRL (R$)</option>
                <option value="ZAR">ZAR (R)</option>
                <option value="KRW">KRW (₩)</option>
                <option value="SGD">SGD ($)</option>
                <option value="NZD">NZD ($)</option>
                <option value="SEK">SEK (kr)</option>
                <option value="NOK">NOK (kr)</option>
                <option value="DKK">DKK (kr)</option>
                <option value="PLN">PLN (zł)</option>
                <option value="THB">THB (฿)</option>
                <option value="IDR">IDR (Rp)</option>
                <option value="HUF">HUF (Ft)</option>
                <option value="CZK">CZK (Kč)</option>
                <option value="ILS">ILS (₪)</option>
                <option value="CLP">CLP ($)</option>
                <option value="PHP">PHP (₱)</option>
                <option value="AED">AED (د.إ)</option>
                <option value="SAR">SAR (﷼)</option>
                <option value="MYR">MYR (RM)</option>
                <option value="RON">RON (lei)</option>
              </select>
              <button id="saveCurrencyBtn" class="header-icon-btn" title="Save Currency Preference" style="margin-left: 8px;">
                <img src="../images/Icons/Check.svg" alt="Save">
              </button>
            </div>
            
            <button class="header-icon-btn" title="Notifications">
              <img src="../images/Icons/Bell.svg" alt="Notifications">
            </button>
            <div class="user-avatar" id="user-avatar">?</div>
          </div>
        </header>

        <!-- Page Content Container - Dynamically changes based on sidebar selection -->
        <div id="page-content-wrapper">
          <!-- DASHBOARD SECTION -->
          <div class="page-section active" id="dashboard-section">
            <!-- Stats Cards -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon"><img src="../images/Icons/Ruler.svg" alt="Calculations"></div>
                <div class="stat-value" id="total-calculations">0</div>
                <div class="stat-label">Total Calculations</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><img src="../images/Icons/Cube.svg" alt="Models"></div>
                <div class="stat-value" id="models-uploaded">0</div>
                <div class="stat-label">Models Uploaded</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><img src="../images/Icons/Package.svg" alt="Orders"></div>
                <div class="stat-value" id="active-orders">0</div>
                <div class="stat-label">Active Orders</div>
              </div>
              <div class="stat-card add-new" id="add-metric">
                <div class="add-icon">+</div>
                <div class="add-text">Add New</div>
                <div class="add-subtext">Track more metrics</div>
              </div>
            </div>      <!-- Main Grid -->
      <div class="main-grid">
        <!-- Chart Card -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Activity Overview</h3>
            <div class="time-filter">
              <span>Last month</span>
              <span>▼</span>
            </div>
          </div>
          <div class="chart-area">
            <div class="chart-placeholder">
              <div class="chart-line"></div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-card">
          <div class="chart-header">
            <h3 class="chart-title">Quick Actions</h3>
          </div>
          <ul class="action-list">
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/Calculator.svg" alt="Calculator"></div>
                <div class="action-details">
                  <h4>Price Calculator</h4>
                  <p>Calculate print costs</p>
                </div>
              </div>
              <button class="action-btn" onclick="window.location.href='calculator.html'">Start</button>
            </li>
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/Upload.svg" alt="Upload"></div>
                <div class="action-details">
                  <h4>Upload Model</h4>
                  <p>Add new 3D model</p>
                </div>
              </div>
              <button class="action-btn" onclick="window.location.href='upload-model.html'">Upload</button>
            </li>
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/ShoppingCart.svg" alt="Orders"></div>
                <div class="action-details">
                  <h4>View Orders</h4>
                  <p>Check order status</p>
                </div>
              </div>
              <button class="action-btn" onclick="switchTab('orders')">View</button>
            </li>
          </ul>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="activity-section">
        <div class="section-header">
          <h2 class="section-title">Recent Activity</h2>
          <a href="#" class="view-all">View all →</a>
        </div>
        <div class="activity-list" id="activity-list">
          <div class="activity-item">
            <div style="display: flex; align-items: center;">
              <div class="activity-icon"><img src="../images/Icons/Calculator.svg" alt="Calculation"></div>
              <div class="activity-content">
                <h4>Price calculation completed</h4>
                <p>Standard PLA print calculation</p>
              </div>
            </div>
            <span class="activity-time">2 hours ago</span>
          </div>
        </div>
      </div>
          </div>
          <!-- END DASHBOARD SECTION -->

          <!-- CALCULATOR SECTION -->
          <div class="page-section" id="calculator-section">
            <div class="calculator-container">
              <div class="calculator-header">
                <h2 class="calculator-title">
                  3D Printing <span class="highlight">Cost Calculator</span>
                </h2>
                <p class="calculator-subtitle">Calculate accurate costs for your 3D printing projects</p>
              </div>

              <!-- Tabs -->
              <div class="calc-tabs">
                <button class="calc-tab active" onclick="switchCalcTab('calculator')">
                  <img src="../images/Icons/Calculator.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Calculator
                </button>
                <button class="calc-tab" onclick="switchCalcTab('printers')">
                  <img src="../images/Icons/Printer.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Printer Presets
                </button>
                <button class="calc-tab" onclick="switchCalcTab('filaments')">
                  <img src="../images/Icons/Yarn.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Filament Presets
                </button>
                <button class="calc-tab" onclick="switchCalcTab('userPresets')">
                  <img src="../images/Icons/User.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Your Presets
                </button>
              </div>

              <!-- Calculator Tab -->
              <div id="calculatorTab" class="calc-tab-content active">
                <div class="calculator-grid">
                  <!-- Left Column - Input Categories -->
                  <div class="calc-inputs-wrapper">
                    
                    <!-- Printer & Filament Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Printer.svg" alt="">
                        Printer & Filament
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Select Printer</label>
                          <select id="printerSelect">
                            <option value="">Choose a printer...</option>
                          </select>
                        </div>
                        <div class="form-group">
                          <label>Select Filament</label>
                          <select id="filamentSelect">
                            <option value="">Choose filament...</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group" id="printerCostBox" style="display: none;">
                          <label>Printer Cost</label>
                          <div id="printerCostInfo" style="padding: 12px; background: #0a0a0a; border-radius: 8px; color: #ffffff; font-size: 14px; border: 1px solid #2a2a2a;">-</div>
                        </div>
                        <div class="form-group" id="filamentCostBox" style="display: none;">
                          <label>Filament Cost</label>
                          <div id="filamentCostInfo" style="padding: 12px; background: #0a0a0a; border-radius: 8px; color: #ffffff; font-size: 14px; border: 1px solid #2a2a2a;">-</div>
                        </div>
                      </div>
                      <div class="form-group" style="display: flex; align-items: center; gap: 10px; flex-direction: row;">
                        <input type="checkbox" id="includePrinterDepreciation" checked style="width: auto; cursor: pointer;">
                        <label for="includePrinterDepreciation" style="cursor: pointer; margin: 0;">Include Printer Depreciation in Cost</label>
                      </div>
                    </div>

                    <!-- Print Parameters Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Ruler.svg" alt="">
                        Print Parameters
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Print Time (hours)</label>
                          <input type="number" id="printTime" placeholder="0" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                          <label>Filament Weight (g)</label>
                          <input type="number" id="weight" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Time to Print (duplicate)</label>
                          <input type="number" id="printTimeDuplicate" placeholder="0" min="0" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                          <label>Electricity Cost (<span data-currency-label>USD ($)</span>/kWh)</label>
                          <input type="number" id="elec" placeholder="0.12" min="0" step="0.01" value="0.12">
                        </div>
                      </div>
                    </div>

                    <!-- Post-Processing Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Scissors.svg" alt="">
                        Post-Processing
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Job Removal (min)</label>
                          <input type="number" id="jobRemoval" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                          <label>Support Removal (min)</label>
                          <input type="number" id="supportRemoval" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Additional Work (min)</label>
                        <input type="number" id="additionalWork" placeholder="0" min="0" step="0.1" value="0">
                      </div>
                      <div class="form-group">
                        <label>Labor Rate (<span data-currency-label>USD ($)</span>/h)</label>
                        <input type="number" id="postProcessingRate" placeholder="20" min="0" step="0.5" value="20">
                      </div>
                    </div>

                    <!-- Preparation Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Wrench.svg" alt="">
                        Preparation
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Model Prep (min)</label>
                          <input type="number" id="modelPrep" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                          <label>Slicing (min)</label>
                          <input type="number" id="slicing" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Material Change (min)</label>
                          <input type="number" id="materialChange" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                          <label>Transfer & Start (min)</label>
                          <input type="number" id="transferStart" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Labor Rate (<span data-currency-label>USD ($)</span>/h)</label>
                        <input type="number" id="preparationRate" placeholder="20" min="0" step="0.5" value="20">
                      </div>
                    </div>

                    <!-- Markups & Failures Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Percent.svg" alt="">
                        Markups & Failures
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Filament Markup (×)</label>
                          <input type="number" id="filamentMarkup" placeholder="2.7" min="1" step="0.1" value="2.7">
                        </div>
                        <div class="form-group">
                          <label>General Markup (%)</label>
                          <input type="number" id="generalMarkup" placeholder="50" min="0" step="1" value="50">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Failure Rate (%)</label>
                        <input type="number" id="failureRate" placeholder="10" min="0" max="100" step="1" value="10">
                      </div>
                    </div>

                    <!-- Calculate Button Card -->
                    <div class="calc-card" style="text-align: center;">
                      <button id="btnCalculate" class="btn-calc" style="width: 100%; padding: 16px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="../../images/Icons/Calculator.svg" alt="" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
                        Calculate Cost
                      </button>
                      <div id="calculationLimitInfo" style="text-align: center; margin-top: 12px; font-size: 12px; color: #6b7280;">
                        <!-- Will show calculation usage for tier limits -->
                      </div>
                    </div>

                  </div>

                  <!-- Right Column - Presets and Results -->
                  <div class="calc-right-wrapper">
                    <!-- Presets Card -->
                    <div class="calc-card">
                      <div class="calc-card-header">
                        <h3>
                          <img src="../images/Icons/Faders.svg" alt="">
                          Print Detail Presets
                        </h3>
                        <button id="btnResetCalculator" class="btn-calc-ghost btn-small">Reset</button>
                      </div>
                      <span id="presetLimitInfo" style="font-size: 13px; color: #9ca3af; display: block; margin-bottom: 16px; font-weight: 500;"></span>
                      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button id="btnSavePreset" class="btn-calc" style="flex: 1;">Save Current Settings</button>
                        <button id="btnManagePresets" class="btn-calc-ghost" style="flex: 1;">Manage Presets</button>
                      </div>
                      <div id="presetQuickAccess" style="display: none;">
                        <label style="font-size: 12px; color: #6b7280; margin-bottom: 8px; display: block;">Quick Load:</label>
                        <div id="presetButtons" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                      </div>
                    </div>

                    <!-- Results Card -->
                    <div class="calc-card results-card">
                      <h3>
                        <img src="../images/Icons/ChartPie.svg" alt="">
                        Cost Breakdown
                      </h3>
                    <div id="resultsContent">
                      <div class="result-item">
                        <span class="result-label">Printer Depreciation</span>
                        <span class="result-value" id="printerCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <div>
                          <div class="result-label">Filament Cost</div>
                          <div class="result-sublabel" id="filamentDetails"></div>
                        </div>
                        <span class="result-value" id="filamentCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <div>
                          <div class="result-label">Electricity Cost</div>
                          <div class="result-sublabel" id="electricityDetails"></div>
                        </div>
                        <span class="result-value" id="electricityCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <div>
                          <div class="result-label">Labor Cost</div>
                          <div class="result-sublabel" id="laborDetails"></div>
                        </div>
                        <span class="result-value" id="laborCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">Subtotal (before markup)</span>
                        <span class="result-value" id="subtotal">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">General Markup Applied</span>
                        <span class="result-value" id="markupAmount">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">Failure Rate Adjustment</span>
                        <span class="result-value" id="failureCostDisplay">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">Total Price</span>
                        <span class="result-value" id="totalCost">$0.00</span>
                      </div>
                    </div>
                    <p class="calc-note" id="handTimeNote">Unbilled hand time: 0.00 hours</p>
                  </div>
                </div>
              </div>
              </div>

              <!-- Printers Tab -->
              <div id="printersTab" class="calc-tab-content">
                <div class="calc-card">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">Printers Library</h3>
                    <button id="btnAddGlobalPrinter" class="btn-calc btn-small" style="display: none;">+ Add Global Printer</button>
                  </div>
                  <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                    Browse available printer presets with their depreciation costs.
                  </p>
                  <div id="printersList">
                    <div class="empty-state">
                      <div class="empty-state-icon">
                        <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
                      </div>
                      <p>Loading printers...</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Filaments Tab -->
              <div id="filamentsTab" class="calc-tab-content">
                <div class="calc-card">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">Filaments Library</h3>
                    <button id="btnAddGlobalFilament" class="btn-calc btn-small" style="display: none;">+ Add Global Filament</button>
                  </div>
                  <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                    Browse available filament presets with pricing information.
                  </p>
                  <div id="filamentsList">
                    <div class="empty-state">
                      <div class="empty-state-icon">
                        <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
                      </div>
                      <p>Loading filaments...</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- User Presets Tab -->
              <div id="userPresetsTab" class="calc-tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                  
                  <!-- Your Printers Section -->
                  <div class="calc-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                      <h3 style="margin: 0;">Your Printers Library</h3>
                      <div style="display: flex; gap: 8px;">
                        <button id="btnToggleUserPrinterMassDelete" class="btn-calc-ghost btn-small" style="display:none;">Mass Delete</button>
                        <button id="btnAddUserPrinter" class="btn-calc btn-small" style="display:none;">+ Add Printer</button>
                      </div>
                    </div>
                    <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                      Your personal printers library. These are only visible to you and can be customized for your specific needs.
                    </p>
                    
                    <!-- Mass Delete Controls -->
                    <div id="userPrinterMassDeleteControls" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                          <input type="checkbox" id="selectAllUserPrinters" style="width: auto; cursor: pointer;">
                          <label for="selectAllUserPrinters" style="cursor: pointer; margin: 0; font-weight: 600;">Select All</label>
                          <span id="userPrinterSelectedCount" style="color: #6b7280; font-size: 13px;">0 selected</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                          <button id="btnDeleteSelectedUserPrinters" class="btn-calc-ghost" style="border-color: #ef4444; color: #ef4444; padding: 8px 16px; font-size: 13px;">Delete Selected</button>
                          <button id="btnCancelUserPrinterMassDelete" class="btn-calc-ghost" style="padding: 8px 16px; font-size: 13px;">Cancel</button>
                        </div>
                      </div>
                    </div>
                    
                    <div id="userPrintersListContainer" style="display: none;">
                      <div id="userPrintersMassDeleteList"></div>
                    </div>
                    <div id="userPrintersList">
                      <div class="empty-state">
                        <div class="empty-state-icon">
                          <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
                        </div>
                        <p>Login to manage your personal printers</p>
                      </div>
                    </div>
                  </div>

                  <!-- Your Filaments Section -->
                  <div class="calc-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                      <h3 style="margin: 0;">Your Filaments Library</h3>
                      <div style="display: flex; gap: 8px;">
                        <button id="btnToggleUserFilamentMassDelete" class="btn-calc-ghost btn-small" style="display:none;">Mass Delete</button>
                        <button id="btnAddUserFilament" class="btn-calc btn-small" style="display:none;">+ Add Filament</button>
                      </div>
                    </div>
                    <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                      Your personal filaments library. These are only visible to you and can be customized for your specific needs.
                    </p>
                    
                    <!-- Mass Delete Controls -->
                    <div id="userFilamentMassDeleteControls" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                          <input type="checkbox" id="selectAllUserFilaments" style="width: auto; cursor: pointer;">
                          <label for="selectAllUserFilaments" style="cursor: pointer; margin: 0; font-weight: 600;">Select All</label>
                          <span id="userFilamentSelectedCount" style="color: #6b7280; font-size: 13px;">0 selected</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                          <button id="btnDeleteSelectedUserFilaments" class="btn-calc-ghost" style="border-color: #ef4444; color: #ef4444; padding: 8px 16px; font-size: 13px;">Delete Selected</button>
                          <button id="btnCancelUserFilamentMassDelete" class="btn-calc-ghost" style="padding: 8px 16px; font-size: 13px;">Cancel</button>
                        </div>
                      </div>
                    </div>
                    
                    <div id="userFilamentsListContainer" style="display: none;">
                      <div id="userFilamentsMassDeleteList"></div>
                    </div>
                    <div id="userFilamentsList">
                      <div class="empty-state">
                        <div class="empty-state-icon">
                          <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
                        </div>
                        <p>Login to manage your personal filaments</p>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

          <!-- Save Preset Modal -->
          <div id="savePresetModal" style="display: none;">
            <div class="modal-card">
              <h3>Save Preset</h3>
              <p class="modal-subtitle">Save your current print settings for quick access later.</p>
              
              <label>Preset Name</label>
              <input id="presetName" type="text" placeholder="e.g., Standard Mini Print" maxlength="30">
              <div id="presetSaveErr" class="err" style="display: none;"></div>
              <div id="presetSaveInfo" class="modal-hint"></div>
              
              <div class="modal-buttons">
                <button id="doSavePreset" class="btn btn-primary">Save Preset</button>
                <button id="closeSavePreset" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Manage Presets Modal -->
          <div id="managePresetsModal" style="display: none;">
            <div class="modal-card" style="max-width: 600px;">
              <h3>Manage Presets</h3>
              <p class="modal-subtitle">Load or delete your saved print settings.</p>
              
              <div id="presetsList" style="max-height: 400px; overflow-y: auto; margin: 16px 0;"></div>
              <div id="noPresetsMessage" style="text-align: center; padding: 32px; color: rgba(255, 255, 255, 0.4); display: none;">
                <p style="font-size: 16px; margin-bottom: 8px;">No presets saved yet</p>
                <p style="font-size: 13px;">Save your first preset to quickly load print settings!</p>
              </div>
              
              <div class="modal-buttons">
                <button id="closeManagePresets" class="btn btn-ghost">Close</button>
              </div>
            </div>
          </div>

          <!-- Add Printer Modal -->
          <div id="printerModal" style="display: none;">
            <div class="modal-card modal-wide">
              <button class="modal-close" id="closePrinterX">×</button>
              
              <h3 id="printerModalTitle">Add Your Printer</h3>
              <p class="modal-subtitle">Add a printer to your personal library.</p>
              
              <div class="modal-two-column">
                <!-- Left Column: Manual Input -->
                <div class="modal-column">
                  <label>Printer Name</label>
                  <input id="printerName" type="text" placeholder="e.g., i3 MK3">
                  
                  <label>Brand</label>
                  <input id="printerBrand" type="text" placeholder="e.g., Prusa">
                  
                  <label>Printer Price ($)</label>
                  <input id="printerPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
                  
                  <label>Expected Lifespan (hours)</label>
                  <input id="printerLifespan" type="number" placeholder="e.g., 5000" min="1" step="1" value="5000">
                  
                  <div class="modal-hint">
                    Depreciation will be calculated as: Price ÷ Lifespan
                  </div>
                </div>
                
                <!-- Right Column: Batch Add -->
                <div class="modal-column">
                  <label>Batch Add (paste multiple)</label>
                  <textarea id="printerQuickAdd" 
                    placeholder='["X-Smart 1", "QIDI", 299, 5000]; ["X-Smart 2", "QIDI", 299, 5000]'
                    style="flex: 1; min-height: 200px;"></textarea>
                  
                  <button id="btnParseQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; margin-bottom: 8px;">
                    Add All Printers
                  </button>
                  
                  <div class="modal-format-hint">
                    <strong>Format:</strong> ["Name", "Brand", Price, Lifespan]<br>
                    <strong>Example:</strong> ["i3 MK3S+", "Prusa", 1099, 5000]; ["Ender 3", "Creality", 259, 3000]
                  </div>
                </div>
              </div>
              
              <div id="printerErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="savePrinter" class="btn btn-primary">Save Printer</button>
                <button id="closePrinter" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Filament Modal -->
          <div id="filamentModal" style="display: none;">
            <div class="modal-card modal-wide">
              <button class="modal-close" id="closeFilamentX">×</button>
              
              <h3 id="filamentModalTitle">Add Your Filament</h3>
              <p class="modal-subtitle">Add a filament to your personal library.</p>
              
              <div class="modal-two-column">
                <!-- Left Column: Manual Input -->
                <div class="modal-column">
                  <label>Filament Type</label>
                  <input id="filamentType" type="text" placeholder="e.g., PLA">
                  
                  <label>Brand</label>
                  <input id="filamentBrand" type="text" placeholder="e.g., Hatchbox">
                  
                  <label>Spool Weight (g)</label>
                  <input id="spoolWeight" type="number" placeholder="1000" min="1" step="1" value="1000">
                  
                  <label>Cost Per Spool ($)</label>
                  <input id="spoolCost" type="number" placeholder="20.00" min="0" step="0.01">
                  
                  <div class="modal-hint">
                    Cost per gram will be calculated as: Spool Cost ÷ Spool Weight
                  </div>
                </div>
                
                <!-- Right Column: Batch Add -->
                <div class="modal-column">
                  <label>Batch Add (paste multiple)</label>
                  <textarea id="filamentQuickAdd" 
                    placeholder='["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]'
                    style="flex: 1; min-height: 200px;"></textarea>
                  
                  <button id="btnParseFilamentQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; margin-bottom: 8px;">
                    Add All Filaments
                  </button>
                  
                  <div class="modal-format-hint">
                    <strong>Format:</strong> ["Type", "Brand", Weight, Cost]<br>
                    <strong>Example:</strong> ["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]
                  </div>
                </div>
              </div>
              
              <div id="filamentErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveFilament" class="btn btn-primary">Save Filament</button>
                <button id="closeFilament" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Edit Global Printer Modal (Admin Only) -->
          <div id="editGlobalPrinterModal" style="display: none;">
            <div class="modal-card">
              <button class="modal-close" id="closeEditGlobalPrinterX">×</button>
              
              <h3 id="editGlobalPrinterTitle">Edit Global Printer</h3>
              <p class="modal-subtitle">Edit this printer preset (admin only).</p>
              
              <input type="hidden" id="editGlobalPrinterOriginalName">
              
              <label>Printer Name</label>
              <input id="editGlobalPrinterName" type="text" placeholder="e.g., i3 MK3">
              
              <label>Brand</label>
              <input id="editGlobalPrinterBrand" type="text" placeholder="e.g., Prusa">
              
              <label>Printer Price ($)</label>
              <input id="editGlobalPrinterPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
              
              <label>Expected Lifespan (hours)</label>
              <input id="editGlobalPrinterLifespan" type="number" placeholder="e.g., 5000" min="1" step="1">
              
              <div class="modal-hint">
                Depreciation: Price ÷ Lifespan = <span id="editGlobalPrinterDepreciation">-</span>/hr
              </div>
              
              <div id="editGlobalPrinterErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveEditGlobalPrinter" class="btn btn-primary">Save Changes</button>
                <button id="closeEditGlobalPrinter" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Edit Global Filament Modal (Admin Only) -->
          <div id="editGlobalFilamentModal" style="display: none;">
            <div class="modal-card">
              <button class="modal-close" id="closeEditGlobalFilamentX">×</button>
              
              <h3 id="editGlobalFilamentTitle">Edit Global Filament</h3>
              <p class="modal-subtitle">Edit this filament preset (admin only).</p>
              
              <input type="hidden" id="editGlobalFilamentOriginalType">
              
              <label>Filament Type</label>
              <input id="editGlobalFilamentType" type="text" placeholder="e.g., PLA">
              
              <label>Brand</label>
              <input id="editGlobalFilamentBrand" type="text" placeholder="e.g., Hatchbox">
              
              <label>Spool Weight (g)</label>
              <input id="editGlobalFilamentWeight" type="number" placeholder="1000" min="1" step="1">
              
              <label>Cost Per Spool ($)</label>
              <input id="editGlobalFilamentCost" type="number" placeholder="20.00" min="0" step="0.01">
              
              <div class="modal-hint">
                Cost per gram: <span id="editGlobalFilamentCostPerG">-</span>
              </div>
              
              <div id="editGlobalFilamentErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveEditGlobalFilament" class="btn btn-primary">Save Changes</button>
                <button id="closeEditGlobalFilament" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Global Printer Modal (Admin Only) -->
          <div id="addGlobalPrinterModal" style="display: none;">
            <div class="modal-card modal-wide">
              <button class="modal-close" id="closeAddGlobalPrinterX">×</button>
              
              <h3>Add Global Printer</h3>
              <p class="modal-subtitle">Add a new printer preset to the global library (admin only).</p>
              
              <div class="modal-two-column">
                <!-- Left Column: Manual Input -->
                <div class="modal-column">
                  <label>Printer Name</label>
                  <input id="addGlobalPrinterName" type="text" placeholder="e.g., i3 MK3">
                  
                  <label>Brand</label>
                  <input id="addGlobalPrinterBrand" type="text" placeholder="e.g., Prusa">
                  
                  <label>Printer Price ($)</label>
                  <input id="addGlobalPrinterPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
                  
                  <label>Expected Lifespan (hours)</label>
                  <input id="addGlobalPrinterLifespan" type="number" placeholder="e.g., 5000" min="1" step="1" value="5000">
                  
                  <div class="modal-hint">
                    Depreciation: <span id="addGlobalPrinterDepreciation">-</span>/hr
                  </div>
                </div>
                
                <!-- Right Column: Batch Add -->
                <div class="modal-column">
                  <label>Batch Add (paste multiple)</label>
                  <textarea id="globalPrinterQuickAdd" 
                    placeholder='["X-Smart 1", "QIDI", 299, 5000]; ["X-Smart 2", "QIDI", 299, 5000]'
                    style="flex: 1; min-height: 200px;"></textarea>
                  
                  <button id="btnParseGlobalPrinterQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; margin-bottom: 8px;">
                    Add All Printers
                  </button>
                  
                  <div class="modal-format-hint">
                    <strong>Format:</strong> ["Name", "Brand", Price, Lifespan]<br>
                    <strong>Example:</strong> ["i3 MK3S+", "Prusa", 1099, 5000]; ["Ender 3", "Creality", 259, 3000]
                  </div>
                </div>
              </div>
              
              <div id="addGlobalPrinterErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveAddGlobalPrinter" class="btn btn-primary">Add Printer</button>
                <button id="closeAddGlobalPrinter" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Global Filament Modal (Admin Only) -->
          <div id="addGlobalFilamentModal" style="display: none;">
            <div class="modal-card modal-wide">
              <button class="modal-close" id="closeAddGlobalFilamentX">×</button>
              
              <h3>Add Global Filament</h3>
              <p class="modal-subtitle">Add a new filament preset to the global library (admin only).</p>
              
              <div class="modal-two-column">
                <!-- Left Column: Manual Input -->
                <div class="modal-column">
                  <label>Filament Type</label>
                  <input id="addGlobalFilamentType" type="text" placeholder="e.g., PLA">
                  
                  <label>Brand</label>
                  <input id="addGlobalFilamentBrand" type="text" placeholder="e.g., Hatchbox">
                  
                  <label>Spool Weight (g)</label>
                  <input id="addGlobalFilamentWeight" type="number" placeholder="1000" min="1" step="1" value="1000">
                  
                  <label>Cost Per Spool ($)</label>
                  <input id="addGlobalFilamentCost" type="number" placeholder="20.00" min="0" step="0.01">
                  
                  <div class="modal-hint">
                    Cost per gram: <span id="addGlobalFilamentCostPerG">-</span>
                  </div>
                </div>
                
                <!-- Right Column: Batch Add -->
                <div class="modal-column">
                  <label>Batch Add (paste multiple)</label>
                  <textarea id="globalFilamentQuickAdd" 
                    placeholder='["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]'
                    style="flex: 1; min-height: 200px;"></textarea>
                  
                  <button id="btnParseGlobalFilamentQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; margin-bottom: 8px;">
                    Add All Filaments
                  </button>
                  
                  <div class="modal-format-hint">
                    <strong>Format:</strong> ["Type", "Brand", Weight, Cost]<br>
                    <strong>Example:</strong> ["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]
                  </div>
                </div>
              </div>
              
              <div id="addGlobalFilamentErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveAddGlobalFilament" class="btn btn-primary">Add Filament</button>
                <button id="closeAddGlobalFilament" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- OLD MODAL NOTIFICATIONS REMOVED - NOW USING TOAST NOTIFICATIONS -->

          <!-- SETTINGS SECTION -->
          <div class="page-section" id="settings-section">
            </div>
          </div>

          <!-- UPLOAD MODEL SECTION -->
          <div class="page-section" id="upload-model-section">
            <div class="calculator-container">
              <div class="calculator-header">
                <h2 class="calculator-title">
                  Model <span class="highlight">Management</span>
                </h2>
                <p class="calculator-subtitle">Upload and manage your 3D model inventory</p>
              </div>

              <!-- Action Bar -->
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="position: relative; flex: 1; max-width: 400px;">
                  <img src="../images/Icons/MagnifyingGlass.svg" alt="" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0.5; filter: brightness(0) invert(1);">
                  <input type="text" id="searchModels" placeholder="Search models..." style="width: 100%; padding: 10px 10px 10px 38px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 12px;">
                  <button type="button" class="btn btn-ghost" id="btnManageSupplies" style="white-space: nowrap;">
                    <img src="../images/Icons/Package.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                    Supplies
                  </button>
                  <button type="button" class="btn btn-primary" id="btnShowAddModel" style="white-space: nowrap;">
                    <img src="../images/Icons/Plus.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                    Add Model
                  </button>
                </div>
              </div>

              <!-- Models List -->
              <div id="modelsList">
                <!-- Models will be loaded here -->
              </div>
            </div>
          </div>

          <!-- ORDERS SECTION -->
          <div class="page-section" id="orders-section">
            <div class="calculator-container">
              <div class="calculator-header">
                <h2 class="calculator-title">
                  Orders <span class="highlight">Management</span>
                </h2>
                <p class="calculator-subtitle">Track and manage your customer orders</p>
              </div>

              <!-- Action Bar -->
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; gap: 12px; flex: 1; max-width: 600px;">
                  <div style="position: relative; flex: 1;">
                    <img src="../images/Icons/MagnifyingGlass.svg" alt="" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0.5; filter: brightness(0) invert(1);">
                    <input type="text" id="ordersSearchInput" placeholder="Search orders..." style="width: 100%; padding: 10px 10px 10px 38px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 14px;">
                  </div>
                  <div style="position: relative;">
                    <img src="../images/Icons/Funnel.svg" alt="" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0.5; filter: brightness(0) invert(1); pointer-events: none; z-index: 1;">
                    <select id="ordersStatusFilter" style="padding: 10px 10px 10px 38px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 14px; cursor: pointer; appearance: none; padding-right: 32px;">
                      <option value="all">All Orders</option>
                      <optgroup label="Order Status">
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                      </optgroup>
                      <optgroup label="Payment Status">
                        <option value="paid">Paid</option>
                        <option value="partially">Partially</option>
                        <option value="unpaid">Unpaid</option>
                      </optgroup>
                    </select>
                    <img src="../images/Icons/CaretDown.svg" alt="" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; opacity: 0.5; filter: brightness(0) invert(1); pointer-events: none;">
                  </div>
                </div>
                <div style="display: flex; gap: 12px;">
                  <button type="button" class="btn btn-ghost" id="btnManageColors" style="white-space: nowrap;">
                    <img src="../images/Icons/Palette.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                    Manage Colors
                  </button>
                  <button type="button" class="btn btn-primary" id="btnNewOrder" style="white-space: nowrap;">
                    <img src="../images/Icons/Plus.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                    New Order
                  </button>
                </div>
              </div>

              <!-- Orders Content -->
              <div id="ordersContent">
                <!-- Orders will be loaded here -->
              </div>
            </div>
          </div>

          <!-- CLIENTS SECTION -->
          <div class="page-section" id="clients-section">
            <div class="calculator-container">
              <div class="calculator-header">
                <h2 class="calculator-title">
                  Client <span class="highlight">Management</span>
                </h2>
                <p class="calculator-subtitle">Manage your customer relationships and contacts</p>
              </div>

              <!-- Action Bar -->
              <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="position: relative; flex: 1; max-width: 400px;">
                  <img src="../images/Icons/MagnifyingGlass.svg" alt="" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0.5; filter: brightness(0) invert(1);">
                  <input type="text" id="searchClients" placeholder="Search clients..." style="width: 100%; padding: 10px 10px 10px 38px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 12px;">
                  <button type="button" class="btn btn-primary" id="btnAddClient" style="white-space: nowrap;">
                    <img src="../images/Icons/Plus.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                    Add Client
                  </button>
                </div>
              </div>

              <!-- Clients Content -->
              <div id="clientsContent">
                <!-- Empty state -->
                <div style="text-align: center; padding: 60px 20px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
                  <img src="../images/Icons/Users.svg" alt="" style="width: 64px; height: 64px; opacity: 0.3; margin: 0 auto 16px; filter: brightness(0) invert(1);">
                  <h3 style="font-size: 18px; margin-bottom: 8px; color: #fff; font-weight: 600;">No clients yet</h3>
                  <p style="font-size: 14px; color: rgba(255, 255, 255, 0.5); margin-bottom: 24px;">Add your first client to get started</p>
                  <button type="button" class="btn btn-primary" onclick="document.getElementById('btnAddClient').click()">
                    <img src="../images/Icons/Plus.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                    Add Your First Client
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- TOOLS SECTION -->
          <div class="page-section" id="tools-section">
            
          </div>

          <!-- ACTIVITY SECTION -->
          <div class="page-section" id="activity-section">
            
          </div>

          <!-- SETTINGS SECTION -->
          <div class="page-section" id="settings-section">
            <div class="settings-container">
              <div class="settings-group">
                <h3>Account Actions</h3>
                <button class="logout-btn" onclick="handleLogout()">
                  <svg class="logout-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Color Modal -->
  <div id="addColorModal" class="modal-overlay" style="display: none; z-index: 10001;">
    <div class="modal-card" style="max-width: 1000px; width: 95%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h3 id="addColorModalTitle" style="color: #ffffff; margin: 0 0 4px 0; font-size: 24px; font-weight: 600;">Add Your Color</h3>
          <p id="addColorModalSubtitle" style="font-size: 14px; color: #9ca3af; margin: 0;">Add a color to your personal library.</p>
        </div>
        <button class="modal-close" onclick="closeAddColorModal()">×</button>
      </div>
      
      <input type="hidden" id="addColorMode" value="user">
      <input type="hidden" id="editColorId" value="">

      <!-- Two Column Layout -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        
        <!-- Left Column - Single Color Input -->
        <div>
          <div class="form-group">
            <label for="singleColorName">Color Name</label>
            <input type="text" id="singleColorName" placeholder="e.g., Sky Blue">
          </div>
          <div class="form-group">
            <label for="singleColorBrand">Brand</label>
            <input type="text" id="singleColorBrand" placeholder="e.g., Hatchbox">
          </div>
          <div class="form-group">
            <label for="singleColorHex">Hex Code</label>
            <input type="text" id="singleColorHex" placeholder="#FF5733" pattern="^#[0-9A-Fa-f]{6}$">
          </div>

          <button class="btn-calc" onclick="saveSingleColor()" style="width: 100%; margin-top: 16px;">Save Color</button>
          <button class="btn-calc-ghost" onclick="closeAddColorModal()" style="width: 100%; margin-top: 12px;">Cancel</button>
        </div>

        <!-- Right Column - Batch Add -->
        <div>
          <label style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.7); font-size: 14px; font-weight: 500;">Batch Add (paste multiple)</label>
          <textarea id="bulkColorInput" rows="10" placeholder='["Red", "Acme", "#FF0000"];
["Blue", "XYZ", "#0000FF"]' style="width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 12px; color: #fff; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; min-height: 200px;"></textarea>
          
          <button class="btn-calc" onclick="saveBulkColors()" style="width: 100%; margin-top: 16px; background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);">Add All Colors</button>
          
          <div style="margin-top: 16px; padding: 12px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border: 1px solid rgba(168, 85, 247, 0.2);">
            <p style="margin: 0 0 8px 0; font-size: 13px; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Format:</p>
            <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 8px; border-radius: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.8); font-family: 'Courier New', monospace;">["Name", "Brand", "Hex"];</code>
            <p style="margin: 8px 0 0 0; font-size: 13px; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Example:</p>
            <code style="display: block; background: rgba(0, 0, 0, 0.3); padding: 8px; border-radius: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.8); font-family: 'Courier New', monospace;">["Red", "Hatchbox", "#FF0000"];<br>["PETG", "eSUN", "#0000FF"]</code>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Color Management Modal -->
  <div id="colorManagementModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="max-width: 1400px; width: 95%; max-height: 92vh; overflow-y: auto;">
      <!-- Modal Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h3 style="color: #ffffff; margin: 0 0 4px 0; font-size: 24px; font-weight: 600;">Color Management</h3>
          <p style="font-size: 14px; color: #9ca3af; margin: 0;">Manage your global and personal color libraries</p>
        </div>
        <button class="modal-close" onclick="closeColorManagementModal()">×</button>
      </div>
      
      <!-- Tabs -->
      <div class="preset-tabs" style="margin-bottom: 24px;">
        <button class="preset-tab active" data-tab="globalColors">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <circle cx="8" cy="8" r="6"/>
          </svg>
          Global Colors
        </button>
        <button class="preset-tab" data-tab="userColors">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M8 3c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4z"/>
            <path d="M8 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z"/>
          </svg>
          Your Colors
        </button>
      </div>

      <!-- Global Colors Tab -->
      <div id="globalColors" class="tab-content active">
        <div class="tab-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #2d2e3a;">
          <h4 style="color: #ffffff; margin: 0; font-size: 16px; font-weight: 500;">Global Color Library</h4>
          <div style="display: flex; gap: 8px;">
            <button class="btn-calc-ghost btn-small" id="btnCancelGlobalSelection" style="display: none;" onclick="cancelGlobalSelection()">Cancel</button>
            <button class="btn-calc btn-small" id="btnMassDeleteGlobalColors" style="display: none; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);" onclick="massDeleteGlobalColors()">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M3 3l8 8M11 3l-8 8"/>
              </svg>
              Select & Delete
            </button>
            <button class="btn-calc btn-small" id="btnAddGlobalColor" style="display: none;">+ Add Global Color</button>
          </div>
        </div>
        <div id="globalColorsGrid" class="colors-grid">
          <!-- Global colors will be rendered here -->
        </div>
      </div>

      <!-- User Colors Tab -->
      <div id="userColors" class="tab-content" style="display: none;">
        <div class="tab-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #2d2e3a;">
          <h4 style="color: #ffffff; margin: 0; font-size: 16px; font-weight: 500;">Your Personal Colors</h4>
          <div style="display: flex; gap: 8px;">
            <button class="btn-calc-ghost btn-small" id="btnCancelUserSelection" style="display: none;" onclick="cancelUserSelection()">Cancel</button>
            <button class="btn-calc btn-small" id="btnMassDeleteUserColors" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);" onclick="massDeleteUserColors()">
              <span>
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                  <path d="M3 3l8 8M11 3l-8 8"/>
                </svg>
                Select & Delete
              </span>
            </button>
            <button class="btn-calc btn-small" id="btnAddUserColor">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M8 3v10M3 8h10"/>
              </svg>
              Add Color
            </button>
          </div>
        </div>
        <div id="userColorsGrid" class="colors-grid">
          <!-- User colors will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- New Order Modal -->
  <div id="newOrderModal" style="display: none;">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; max-height: 95vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeNewOrderModal()">×</button>
      
      <div class="modal-header-centered">
        <h3 class="modal-title-large">
          Create New <span class="gradient-highlight">Order</span>
        </h3>
        <p class="modal-subtitle-large">Fill in the order details below</p>
      </div>

      <form id="newOrderForm">
      <!-- Order Title Header -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <label for="orderTitle" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Order Title *</label>
        <input type="text" id="orderTitle" name="orderTitle" required placeholder="Enter order title" 
          style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 16px; font-weight: 600;">
      </div>

      <!-- Three Column Grid Layout -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">

      <!-- Client Information -->
        <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
          <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Client Information</h5>
          <div style="display: grid; gap: 14px;">
            <div>
              <label for="orderClientName" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Client Name *</label>
              <input type="text" id="orderClientName" name="orderClientName" required placeholder="Enter client name" autocomplete="name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderClientEmail" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Email</label>
              <input type="email" id="orderClientEmail" name="orderClientEmail" placeholder="client@example.com" autocomplete="email" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderClientPhone" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Phone</label>
              <input type="tel" id="orderClientPhone" name="orderClientPhone" placeholder="+1 (555) 123-4567" autocomplete="tel" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderMessagingApp" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Messaging Platform</label>
              <select id="orderMessagingApp" name="orderMessagingApp" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="">Select messaging app or platform...</option>
                <optgroup label="Messaging Apps">
                  <option value="WhatsApp">WhatsApp</option>
                  <option value="Facebook Messenger">Facebook Messenger</option>
                  <option value="Instagram DM">Instagram Direct Message</option>
                  <option value="Telegram">Telegram</option>
                  <option value="Discord">Discord</option>
                  <option value="WeChat">WeChat</option>
                  <option value="Line">LINE</option>
                  <option value="Viber">Viber</option>
                  <option value="Snapchat">Snapchat</option>
                  <option value="iMessage">iMessage</option>
                  <option value="SMS">SMS/Text Message</option>
                  <option value="Signal">Signal</option>
                  <option value="Kakao Talk">Kakao Talk</option>
                </optgroup>
                <optgroup label="E-Commerce Marketplaces">
                  <option value="Etsy">Etsy</option>
                  <option value="eBay">eBay</option>
                  <option value="Amazon">Amazon</option>
                  <option value="Shopify">Shopify</option>
                  <option value="Facebook Marketplace">Facebook Marketplace</option>
                  <option value="Mercari">Mercari</option>
                  <option value="Poshmark">Poshmark</option>
                  <option value="Depop">Depop</option>
                  <option value="Vinted">Vinted</option>
                  <option value="Craigslist">Craigslist</option>
                  <option value="OfferUp">OfferUp</option>
                  <option value="Letgo">Letgo</option>
                  <option value="AliExpress">AliExpress</option>
                  <option value="Alibaba">Alibaba</option>
                  <option value="Walmart Marketplace">Walmart Marketplace</option>
                  <option value="Target Plus">Target Plus</option>
                  <option value="Wish">Wish</option>
                  <option value="Temu">Temu</option>
                  <option value="Shein">Shein</option>
                </optgroup>
                <optgroup label="Social & Professional">
                  <option value="Twitter DM">Twitter/X Direct Message</option>
                  <option value="LinkedIn Messages">LinkedIn Messages</option>
                  <option value="TikTok">TikTok Shop</option>
                  <option value="Pinterest">Pinterest</option>
                </optgroup>
                <optgroup label="Traditional">
                  <option value="Email">Email</option>
                  <option value="Phone Call">Phone Call</option>
                  <option value="In Person">In Person</option>
                  <option value="Skype">Skype</option>
                  <option value="Slack">Slack</option>
                  <option value="Teams">Microsoft Teams</option>
                </optgroup>
                <optgroup label="Other">
                  <option value="Other">Other</option>
                </optgroup>
              </select>
            </div>
            <div style="padding-top: 8px; border-top: 1px solid rgba(168, 85, 247, 0.2); margin-top: 4px;">
              <label for="orderAddressAutocomplete" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Address Search</label>
              <input type="text" id="orderAddressAutocomplete" name="orderAddressAutocomplete" placeholder="Start typing address..." autocomplete="off" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderStreet" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Street Address</label>
              <input type="text" id="orderStreet" name="orderStreet" placeholder="123 Main St" autocomplete="street-address" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderCity" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">City</label>
              <input type="text" id="orderCity" name="orderCity" placeholder="City" autocomplete="address-level2" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderState" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">State/Province</label>
              <input type="text" id="orderState" name="orderState" placeholder="State/Province" autocomplete="address-level1" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderPostalCode" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Postal Code</label>
              <input type="text" id="orderPostalCode" name="orderPostalCode" placeholder="12345" autocomplete="postal-code" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="orderCountry" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Country</label>
              <input type="text" id="orderCountry" name="orderCountry" placeholder="Country" autocomplete="country-name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
          </div>
        </div>

      <!-- Product Information -->
        <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
          <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Product Information</h5>
          <div style="display: grid; gap: 14px;">
            <div>
              <label for="productName" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Product Name *</label>
              <input type="text" id="productName" name="productName" required placeholder="Enter product name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="quantity" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Quantity *</label>
              <input type="number" id="quantity" name="quantity" required min="1" value="1" placeholder="1" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="material" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Material</label>
              <select id="material" name="material" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="">Select material</option>
                <!-- Options will be populated dynamically from Firebase -->
              </select>
            </div>
            <div>
              <label for="finish" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Finish</label>
              <select id="finish" name="finish" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="">Select finish</option>
                <option value="Matte">Matte</option>
                <option value="Glossy">Glossy</option>
                <option value="Textured">Textured</option>
                <option value="Smooth">Smooth</option>
              </select>
            </div>
            <div>
              <label for="scale" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Scale (%)</label>
              <input type="number" id="scale" name="scale" placeholder="100" min="1" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
          </div>
        </div>

      <!-- Payment Information -->
        <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
          <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Payment Information</h5>
          <div style="display: grid; gap: 14px;">
            <div>
              <label for="orderTotal" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Total Price</label>
              <input type="number" id="orderTotal" name="orderTotal" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div>
              <label for="amountPaid" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Amount Paid</label>
              <input type="number" id="amountPaid" name="amountPaid" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
            <div style="padding-top: 8px; border-top: 1px solid rgba(168, 85, 247, 0.2);">
              <label for="paymentMethod" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Payment Method</label>
              <select id="paymentMethod" name="paymentMethod" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="">Not specified</option>
                <optgroup label="Digital Payments">
                  <option value="PayPal">PayPal</option>
                  <option value="Card">Credit/Debit Card</option>
                  <option value="Wire Transfer">Wire Transfer</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                  <option value="Venmo">Venmo</option>
                  <option value="Zelle">Zelle</option>
                  <option value="Apple Pay">Apple Pay</option>
                  <option value="Google Pay">Google Pay</option>
                  <option value="Stripe">Stripe</option>
                  <option value="Square">Square</option>
                </optgroup>
                <optgroup label="Traditional">
                  <option value="Cash">Cash</option>
                  <option value="Cheque">Cheque</option>
                  <option value="Money Order">Money Order</option>
                </optgroup>
                <optgroup label="Cryptocurrency">
                  <option value="Bitcoin">Bitcoin</option>
                  <option value="Ethereum">Ethereum</option>
                  <option value="Crypto">Other Cryptocurrency</option>
                </optgroup>
                <optgroup label="Other">
                  <option value="Trade/Barter">Trade/Barter</option>
                  <option value="Store Credit">Store Credit</option>
                  <option value="Other">Other</option>
                </optgroup>
              </select>
            </div>
            <div>
              <label for="paymentStatus" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Payment Status</label>
              <select id="paymentStatus" name="paymentStatus" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="unpaid">Unpaid</option>
                <option value="partially">Partially</option>
                <option value="paid">Paid</option>
              </select>
            </div>
            <div>
              <label for="orderStatus" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Order Status</label>
              <select id="orderStatus" name="orderStatus" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
        </div>

      </div> <!-- Close grid -->

      <!-- Color Selection - Full Width -->
      <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Color Selection (Up to 4)</h5>
        <input type="text" id="colorSearchInput" placeholder="Search colors by name..." 
          style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; margin-bottom: 12px;">
        <div id="colorSelectionGrid" class="color-selection-grid">
          <!-- Colors will be populated here -->
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center; padding: 12px; background: rgba(36, 29, 53, 0.3); border-radius: 8px; border: 1px solid #2d2e3a;">
          <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Selected:</span>
          <div id="selectedColorsPreview" style="display: flex; gap: 8px; flex: 1;">
            <!-- Selected colors will appear here -->
          </div>
        </div>
        <input type="hidden" id="color1" value="">
        <input type="hidden" id="color2" value="">
        <input type="hidden" id="color3" value="">
        <input type="hidden" id="color4" value="">
      </div>

      <!-- Additional Notes -->
      <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Additional Notes</h5>
        <label for="extraNotes" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Extra Notes</label>
        <textarea id="extraNotes" name="extraNotes" placeholder="Add any special instructions or notes..." style="width: 100%; min-height: 100px; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; resize: vertical;"></textarea>
      </div>

      <!-- Modal Actions -->
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 1px solid #2d2e3a;">
        <button type="button" class="btn-calc-ghost" onclick="closeNewOrderModal()">Cancel</button>
        <button type="submit" class="btn-calc">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M3 8l3 3 6-6"/>
          </svg>
          Create Order
        </button>
      </div>
      </form>
    </div>
  </div>

  <!-- View Order Modal -->
  <div id="viewOrderModal" style="display: none;">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; max-height: 95vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeViewOrderModal()">×</button>
      
      <div class="modal-header-centered">
        <h3 class="modal-title-large">
          Order <span class="gradient-highlight">Details</span>
        </h3>
        <p class="modal-subtitle-large">View and manage order information</p>
        <p id="viewOrderNumberDisplay" class="modal-id-display">Order <span class="id-value">Loading...</span></p>
      </div>

      <div id="viewOrderContent">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="editOrderModal" style="display: none;">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; max-height: 95vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeEditOrderModal()">×</button>
      
      <div class="modal-header-centered">
        <h3 class="modal-title-large">
          Edit <span class="gradient-highlight">Order</span>
        </h3>
        <p class="modal-subtitle-large">Update order information</p>
        <p id="editOrderNumberDisplay" class="modal-id-display">Order <span class="id-value">Loading...</span></p>
      </div>

      <form id="editOrderForm">
        <input type="hidden" id="editOrderId">
        
        <!-- Order Title Header -->
        <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
          <label for="editOrderTitle">Order Title *</label>
          <input type="text" id="editOrderTitle" name="orderTitle" required placeholder="Enter order title" 
            style="font-size: 16px; font-weight: 600;">
        </div>

        <!-- Three Column Grid Layout -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">

        <!-- Client Information -->
          <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
            <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Client Information</h5>
            <div style="display: grid; gap: 14px;">
              <div>
                <label for="editClientName" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Client Name *</label>
                <input type="text" id="editClientName" name="clientName" required placeholder="Enter client name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientEmail" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Email</label>
                <input type="email" id="editClientEmail" name="clientEmail" placeholder="client@example.com" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientPhone" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Phone</label>
                <input type="tel" id="editClientPhone" name="clientPhone" placeholder="+1 (555) 123-4567" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editMessagingApp" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Messaging Platform</label>
                <select id="editMessagingApp" name="messaging_app" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="">Select messaging app or platform...</option>
                <optgroup label="Messaging Apps">
                  <option value="WhatsApp">WhatsApp</option>
                  <option value="Facebook Messenger">Facebook Messenger</option>
                  <option value="Instagram DM">Instagram Direct Message</option>
                  <option value="Telegram">Telegram</option>
                  <option value="Discord">Discord</option>
                  <option value="WeChat">WeChat</option>
                  <option value="Line">LINE</option>
                  <option value="Viber">Viber</option>
                  <option value="Snapchat">Snapchat</option>
                  <option value="iMessage">iMessage</option>
                  <option value="SMS">SMS/Text Message</option>
                  <option value="Signal">Signal</option>
                  <option value="Kakao Talk">Kakao Talk</option>
                </optgroup>
                <optgroup label="E-Commerce Marketplaces">
                  <option value="Etsy">Etsy</option>
                  <option value="eBay">eBay</option>
                  <option value="Amazon">Amazon</option>
                  <option value="Shopify">Shopify</option>
                  <option value="Facebook Marketplace">Facebook Marketplace</option>
                  <option value="Mercari">Mercari</option>
                  <option value="Poshmark">Poshmark</option>
                  <option value="Depop">Depop</option>
                  <option value="Vinted">Vinted</option>
                  <option value="Craigslist">Craigslist</option>
                  <option value="OfferUp">OfferUp</option>
                  <option value="Letgo">Letgo</option>
                  <option value="AliExpress">AliExpress</option>
                  <option value="Alibaba">Alibaba</option>
                  <option value="Walmart Marketplace">Walmart Marketplace</option>
                  <option value="Target Plus">Target Plus</option>
                  <option value="Wish">Wish</option>
                  <option value="Temu">Temu</option>
                  <option value="Shein">Shein</option>
                </optgroup>
                <optgroup label="Social & Professional">
                  <option value="Twitter DM">Twitter/X Direct Message</option>
                  <option value="LinkedIn Messages">LinkedIn Messages</option>
                  <option value="TikTok">TikTok Shop</option>
                  <option value="Pinterest">Pinterest</option>
                </optgroup>
                <optgroup label="Traditional">
                  <option value="Email">Email</option>
                  <option value="Phone Call">Phone Call</option>
                  <option value="In Person">In Person</option>
                  <option value="Skype">Skype</option>
                  <option value="Slack">Slack</option>
                  <option value="Teams">Microsoft Teams</option>
                </optgroup>
                <optgroup label="Other">
                  <option value="Other">Other</option>
                </optgroup>
              </select>
              </div>
              <div style="padding-top: 8px; border-top: 1px solid rgba(168, 85, 247, 0.2); margin-top: 4px;">
                <label for="editAddressAutocomplete" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Address Search</label>
                <input type="text" id="editAddressAutocomplete" name="addressAutocomplete" placeholder="Start typing address..." style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientStreet" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Street Address</label>
                <input type="text" id="editClientStreet" name="clientStreet" placeholder="123 Main St" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientCity" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">City</label>
                <input type="text" id="editClientCity" name="clientCity" placeholder="City" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientState" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">State/Province</label>
                <input type="text" id="editClientState" name="clientState" placeholder="State/Province" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientPostalCode" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Postal Code</label>
                <input type="text" id="editClientPostalCode" name="clientPostalCode" placeholder="12345" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editClientCountry" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Country</label>
                <input type="text" id="editClientCountry" name="clientCountry" placeholder="Country" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
            </div>
          </div>

        <!-- Product Information -->
          <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
            <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Product Information</h5>
            <div style="display: grid; gap: 14px;">
              <div>
                <label for="editProductName" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Product Name *</label>
                <input type="text" id="editProductName" name="productName" required placeholder="Enter product name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editQuantity" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Quantity *</label>
                <input type="number" id="editQuantity" name="quantity" required min="1" value="1" placeholder="1" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editMaterial" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Material</label>
                <select id="editMaterial" name="material" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                  <option value="">Select material</option>
                  <!-- Options will be populated dynamically from Firebase -->
                </select>
              </div>
              <div>
                <label for="editFinish" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Finish</label>
                <select id="editFinish" name="finish" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                  <option value="">Select finish</option>
                  <option value="Matte">Matte</option>
                  <option value="Glossy">Glossy</option>
                  <option value="Textured">Textured</option>
                  <option value="Smooth">Smooth</option>
                </select>
              </div>
              <div>
                <label for="editScale" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Scale (%)</label>
                <input type="number" id="editScale" name="scale" placeholder="100" min="1" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
            </div>
          </div>

        <!-- Payment Information -->
          <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
            <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Payment Information</h5>
            <div style="display: grid; gap: 14px;">
              <div>
                <label for="editOrderTotal" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Total Price</label>
                <input type="number" id="editOrderTotal" name="orderTotal" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label for="editAmountPaid" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Amount Paid</label>
                <input type="number" id="editAmountPaid" name="amountPaid" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div style="padding-top: 8px; border-top: 1px solid rgba(168, 85, 247, 0.2);">
                <label for="editPaymentMethod" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Payment Method</label>
                <select id="editPaymentMethod" name="paymentMethod" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                  <option value="">Not specified</option>
                  <optgroup label="Digital Payments">
                    <option value="PayPal">PayPal</option>
                    <option value="Card">Credit/Debit Card</option>
                    <option value="Wire Transfer">Wire Transfer</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Venmo">Venmo</option>
                    <option value="Zelle">Zelle</option>
                    <option value="Apple Pay">Apple Pay</option>
                    <option value="Google Pay">Google Pay</option>
                    <option value="Stripe">Stripe</option>
                    <option value="Square">Square</option>
                  </optgroup>
                  <optgroup label="Traditional">
                    <option value="Cash">Cash</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Money Order">Money Order</option>
                  </optgroup>
                  <optgroup label="Cryptocurrency">
                    <option value="Bitcoin">Bitcoin</option>
                    <option value="Ethereum">Ethereum</option>
                    <option value="Crypto">Other Cryptocurrency</option>
                  </optgroup>
                  <optgroup label="Other">
                    <option value="Trade/Barter">Trade/Barter</option>
                    <option value="Store Credit">Store Credit</option>
                    <option value="Other">Other</option>
                  </optgroup>
                </select>
              </div>
              <div>
                <label for="editPaymentStatus" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Payment Status</label>
                <select id="editPaymentStatus" name="paymentStatus" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                  <option value="unpaid">Unpaid</option>
                  <option value="partially">Partially</option>
                  <option value="paid">Paid</option>
                </select>
              </div>
              <div>
                <label for="editOrderStatus" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Order Status</label>
                <select id="editOrderStatus" name="orderStatus" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                  <option value="pending">Pending</option>
                  <option value="processing">Processing</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>
          </div>

        </div> <!-- Close grid -->

        <!-- Color Selection - Full Width -->
        <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
          <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Color Selection (Up to 4)</h5>
          <input type="text" id="editColorSearchInput" placeholder="Search colors by name..." 
            style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; margin-bottom: 12px;">
          <div id="editColorSelectionGrid" class="color-selection-grid">
            <!-- Colors will be populated here -->
          </div>
          <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center; padding: 12px; background: rgba(36, 29, 53, 0.3); border-radius: 8px; border: 1px solid #2d2e3a;">
            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Selected:</span>
            <div id="editSelectedColorsPreview" style="display: flex; gap: 8px; flex: 1;">
              <!-- Selected colors will appear here -->
            </div>
          </div>
          <input type="hidden" id="editColor1" value="">
          <input type="hidden" id="editColor2" value="">
          <input type="hidden" id="editColor3" value="">
          <input type="hidden" id="editColor4" value="">
        </div>

        <!-- Additional Notes -->
        <div style="padding: 20px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
          <h5 style="color: #a855f7; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Additional Notes</h5>
          <label for="editExtraNotes" style="display: block; color: #9ca3af; margin: 0 0 6px 0; font-size: 12px; font-weight: 500;">Extra Notes</label>
          <textarea id="editExtraNotes" name="extraNotes" placeholder="Add any special instructions or notes..." style="width: 100%; min-height: 100px; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; resize: vertical;"></textarea>
        </div>

        <!-- Modal Actions -->
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 1px solid #2d2e3a;">
          <button type="button" class="btn-calc-ghost" onclick="closeEditOrderModal()">Cancel</button>
          <button type="submit" class="btn-calc">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
              <path d="M3 8l3 3 6-6"/>
            </svg>
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Suppress ONLY classifier.js errors (from GitHub Copilot extension)
    // This will NOT suppress errors from your actual code
    window.addEventListener('error', function(e) {
      const errorMsg = e.message || '';
      const errorFile = e.filename || '';
      const errorStack = (e.error && e.error.stack) || '';
      
      // Check if this is the classifier.js uuid error
      if ((errorFile.includes('classifier.js') || errorStack.includes('classifier.js')) && 
          errorMsg.includes('uuid')) {
        console.warn('[Suppressed] External extension error from classifier.js');
        e.stopPropagation();
        e.preventDefault();
        return true;
      }
      
      // Suppress only ad blocker CSP test errors (gen_204), not actual Google Maps errors
      if (errorMsg.includes('ERR_BLOCKED_BY_CLIENT') && errorFile.includes('gen_204')) {
        e.stopPropagation();
        e.preventDefault();
        return true;
      }
      
      // Let all other errors through normally (including Google Maps API errors so you can see them)
    }, true);

    // Suppress unhandled promise rejections from classifier.js
    window.addEventListener('unhandledrejection', function(e) {
      const reason = e.reason || {};
      const stack = reason.stack || '';
      const message = reason.message || '';
      
      // Check if this is from classifier.js
      if (stack.includes('classifier.js') || message.includes('uuid')) {
        console.warn('[Suppressed] External extension promise rejection from classifier.js');
        e.preventDefault();
        return true;
      }
      // Let all other rejections through normally
    });

    // Use existing Firebase instance from auth.js
    // auth and db are already declared in the global scope by auth.js
    
    // Page Navigation System
    function switchPage(pageName) {
      // Hide all page sections
      const sections = document.querySelectorAll('.page-section');
      sections.forEach(section => section.classList.remove('active'));
      
      // Show the selected page section
      const targetSection = document.getElementById(pageName + '-section');
      if (targetSection) {
        targetSection.classList.add('active');
      }
      
      // Update active state in sidebar
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => link.classList.remove('active'));
      
      const activeLink = document.querySelector(`[data-page="${pageName}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
      
      // Load data when switching to orders page
      if (pageName === 'orders' && currentUser) {
        loadOrders();
        loadColors(currentUser);
      }
      
      // Load data when switching to clients page
      if (pageName === 'clients' && currentUser) {
        loadClients();
      }
      
      // Update page title and header
      updatePageTitle(pageName);
    }

    function updatePageTitle(pageName) {
      const titles = {
        'dashboard': 'Dashboard',
        'calculator': 'Calculator',
        'orders': 'Orders',
        'clients': 'Clients',
        'upload-model': 'Upload Model',
        'tools': 'Tools',
        'activity': 'Activity',
        'settings': 'Settings'
      };
      
      const descriptions = {
        'dashboard': '', // Will show date
        'calculator': 'Calculate 3D printing costs and pricing',
        'orders': 'View and track your print orders',
        'clients': 'Manage your customer relationships',
        'upload-model': 'Upload and manage your 3D models',
        'tools': 'Explore additional tools and features',
        'activity': 'View your recent activity and history',
        'settings': 'Manage your account and preferences'
      };
      
      document.title = (titles[pageName] || 'Vixvvo') + ' - Vixvvo Tools';
      
      // Update the header greeting/title
      const greetingElement = document.getElementById('greeting');
      const dateElement = document.getElementById('current-date');
      
      if (pageName === 'dashboard') {
        // On dashboard, restore the greeting
        const user = firebase.auth().currentUser;
        if (user) {
          updateGreeting(user);
        }
        updateDate(); // Update with current date
        dateElement.style.display = 'block';
      } else {
        // On other pages, show the page title and description
        greetingElement.textContent = titles[pageName] || 'Vixvvo';
        dateElement.textContent = descriptions[pageName] || '';
        dateElement.style.display = 'block';
      }
    }

    // Initialize Dashboard
    function initializeDashboard() {
      // Update date
      updateDate();
      
      // Setup navigation
      setupNavigation();
      
      // Check authentication - wait for Firebase to be ready
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          updateGreeting(user);
          loadUserStats(user.uid);
          loadRecentActivity(user.uid);
        } else {
          // Double-check: Wait a moment for auth to fully initialize
          // This prevents false redirects when the page first loads
          setTimeout(() => {
            const stillNoUser = firebase.auth().currentUser;
            if (!stillNoUser) {
              // Redirect to home if not logged in
              window.location.href = '../index.html';
            }
          }, 500);
        }
      });
    }

    // Setup navigation event listeners
    function setupNavigation() {
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const pageName = this.getAttribute('data-page');
          switchPage(pageName);
        });
      });
    }

    // Update current date
    function updateDate() {
      const now = new Date();
      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      const dateString = now.toLocaleDateString('en-US', options);
      document.getElementById('current-date').textContent = dateString;
    }

    // Update greeting with user name
    function updateGreeting(user) {
      const hour = new Date().getHours();
      let greeting = 'Hey';
      
      if (hour < 12) greeting = 'Good morning';
      else if (hour < 18) greeting = 'Good afternoon';
      else greeting = 'Good evening';

      // Try to get username from database first, then displayName, then email
      firebase.database().ref(`users/${user.uid}/username`).once('value', (snapshot) => {
        let displayName;
        if (snapshot.exists()) {
          displayName = snapshot.val();
        } else {
          displayName = user.displayName || user.email.split('@')[0];
        }
        
        document.getElementById('greeting').textContent = `${greeting}, ${displayName}!`;
        
        // Update avatar
        const initial = displayName.charAt(0).toUpperCase();
        document.getElementById('user-avatar').textContent = initial;
      });
    }

    // Load user statistics
    function loadUserStats(userId) {
      // Load calculations count
      firebase.database().ref(`users/${userId}/calculations`).once('value', (snapshot) => {
        const count = snapshot.exists() ? snapshot.numChildren() : 0;
        document.getElementById('total-calculations').textContent = count;
      });

      // Load models count
      firebase.database().ref(`users/${userId}/models`).once('value', (snapshot) => {
        const count = snapshot.exists() ? snapshot.numChildren() : 0;
        document.getElementById('models-uploaded').textContent = count;
      });

      // Load orders count (only pending and processing orders)
      firebase.database().ref(`orders/${userId}`).once('value', (snapshot) => {
        let activeCount = 0;
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const order = childSnapshot.val();
            // Count orders with "pending" or "processing" status as active
            if (order.orderStatus === 'pending' || order.orderStatus === 'processing') {
              activeCount++;
            }
          });
        }
        document.getElementById('active-orders').textContent = activeCount;
      });
    }

    // Load recent activity
    function loadRecentActivity(userId) {
      const activityList = document.getElementById('activity-list');
      
      firebase.database().ref(`users/${userId}/activity`).limitToLast(5).once('value', (snapshot) => {
        if (snapshot.exists()) {
          activityList.innerHTML = '';
          snapshot.forEach((childSnapshot) => {
            const activity = childSnapshot.val();
            const item = createActivityItem(activity);
            activityList.appendChild(item);
          });
        }
      });
    }

    // Create activity item element
    function createActivityItem(activity) {
      const item = document.createElement('div');
      item.className = 'activity-item';
      
      const icon = getActivityIcon(activity.type);
      const timeAgo = getTimeAgo(activity.timestamp);
      
      item.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div class="activity-icon">${icon}</div>
          <div class="activity-content">
            <h4>${activity.title}</h4>
            <p>${activity.description}</p>
          </div>
        </div>
        <span class="activity-time">${timeAgo}</span>
      `;
      
      return item;
    }

    // Get icon based on activity type
    function getActivityIcon(type) {
      const icons = {
        calculation: 'Calculator.svg',
        upload: 'Upload.svg',
        order: 'ShoppingCart.svg',
        settings: 'GearSix.svg',
        default: 'File.svg'
      };
      return `<img src="../images/Icons/${icons[type] || icons.default}" alt="${type}">`;
    }

    // Calculate time ago
    function getTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
      if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
      if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
      return 'Just now';
    }

    // Handle logout
    function handleLogout() {
      // Show confirmation toast
      if (window.confirm('Are you sure you want to logout?')) {
        firebase.auth().signOut().then(() => {
          showNotification('Logged out successfully', 'success', 'Goodbye!');
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 1000);
        }).catch((error) => {
          console.error('Logout error:', error);
          showNotification('Error logging out. Please try again.', 'error');
        });
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializeDashboard);

    // ===============================================
    // CURRENCY SELECTOR FUNCTIONALITY
    // ===============================================
    
    // Load user's currency preference from Firebase
    async function loadUserCurrency() {
      const user = firebase.auth().currentUser;
      if (!user) {
        window.currentCurrency = 'USD';
        return;
      }
      
      try {
        const snapshot = await firebase.database().ref(`users/${user.uid}/preferences/currency`).once('value');
        const savedCurrency = snapshot.val();
        
        if (savedCurrency) {
          window.currentCurrency = savedCurrency;
          console.log('Loaded currency from Firebase:', savedCurrency);
        } else {
          window.currentCurrency = 'USD';
        }
      } catch (error) {
        console.error('Error loading currency preference:', error);
        window.currentCurrency = 'USD';
      }
    }
    
    // Save user's currency preference to Firebase
    async function saveUserCurrency(currency) {
      const user = firebase.auth().currentUser;
      if (!user) {
        console.warn('No user logged in, cannot save currency preference');
        return false;
      }
      
      try {
        const ref = firebase.database().ref(`users/${user.uid}/preferences/currency`);
        console.log('Attempting to save currency to:', `users/${user.uid}/preferences/currency`);
        console.log('Currency value:', currency);
        
        await ref.set(currency);
        
        console.log('✅ Currency preference saved to Firebase:', currency);
        
        // Verify it was saved
        const verification = await ref.once('value');
        console.log('Verification - saved value:', verification.val());
        
        showNotification('Currency preference saved successfully', 'success');
        return true;
      } catch (error) {
        console.error('❌ Error saving currency preference:', error);
        showNotification('Failed to save currency: ' + error.message, 'error');
        return false;
      }
    }
    
    // Initialize currency selector
    async function initializeCurrencySelector() {
      const currencySelector = document.getElementById('currencySelector');
      const saveCurrencyBtn = document.getElementById('saveCurrencyBtn');
      
      if (!currencySelector) {
        console.warn('Currency selector not found in DOM');
        return;
      }
      
      console.log('Initializing currency selector...');
      
      // Load saved currency from Firebase
      await loadUserCurrency();
      currencySelector.value = window.currentCurrency || 'USD';
      
      // Update labels on initial load
      updateAllPriceDisplays();
      
      // Listen for currency changes - AUTO-SAVE and update live
      currencySelector.addEventListener('change', async function() {
        const newCurrency = this.value;
        const oldCurrency = window.currentCurrency;
        window.currentCurrency = newCurrency;
        
        console.log('Currency changed from', oldCurrency, 'to', newCurrency);
        
        // Save to Firebase immediately (auto-save)
        const saved = await saveUserCurrency(newCurrency);
        
        if (saved) {
          // Update all displays live
          updateAllPriceDisplays();
          
          // Re-calculate if there's existing calculation results
          const printerSelect = document.getElementById('printerSelect');
          const filamentSelect = document.getElementById('filamentSelect');
          const totalCostElement = document.getElementById('totalCost');
          
          // If user has selected printer/filament and there are results, recalculate
          if (printerSelect?.value && filamentSelect?.value && totalCostElement) {
            // Check if calculation has been run (totalCost is not the default $0.00)
            const currentTotal = totalCostElement.textContent;
            if (currentTotal !== '$0.00' && currentTotal !== 'USD ($0.00)') {
              calculateCost();
            }
          }
          
          console.log('✅ Currency updated and saved:', newCurrency);
        } else {
          // Revert if save failed
          console.error('❌ Failed to save currency, reverting to:', oldCurrency);
          window.currentCurrency = oldCurrency;
          currencySelector.value = oldCurrency;
        }
      });
      
      // Hide save button since we're auto-saving now
      if (saveCurrencyBtn) {
        saveCurrencyBtn.style.display = 'none';
      }
    }
    
    // Update all price displays when currency changes
    function updateAllPriceDisplays() {
      // Update currency labels in calculator form
      const currencyLabels = document.querySelectorAll('[data-currency-label]');
      currencyLabels.forEach(label => {
        label.textContent = getCurrencyLabel(window.currentCurrency);
      });
      
      // Refresh printer and filament lists with new currency
      if (typeof renderPrintersList === 'function') {
        renderPrintersList();
      }
      if (typeof renderFilamentsList === 'function') {
        renderFilamentsList();
      }
      
      // Refresh dropdowns (these already display updated prices in the options)
      if (typeof renderPrinterSelect === 'function') {
        renderPrinterSelect();
      }
      if (typeof renderFilamentSelect === 'function') {
        renderFilamentSelect();
      }
      
      // Update price info boxes (selected printer/filament costs)
      if (typeof updatePriceInfo === 'function') {
        updatePriceInfo();
      }
      
      // Refresh calculator UI if the external function exists
      if (typeof window.refreshCalculatorCurrency === 'function') {
        window.refreshCalculatorCurrency();
      }
    }
    
    // Initialize currency selector on page load (after auth state is known)
    firebase.auth().onAuthStateChanged((user) => {
      console.log('Auth state changed. User:', user ? user.uid : 'null');
      if (user) {
        console.log('User is logged in, initializing currency selector...');
        initializeCurrencySelector();
      } else {
        console.log('No user logged in, skipping currency selector initialization');
      }
    });

    // ===============================================
    // CALCULATOR FUNCTIONALITY
    // ===============================================
    
    // Calculator State
    let printersData = {};
    let filamentsData = {};
    let userPrintersData = {};
    let userFilamentsData = {};
    let dataLoaded = false;
    let currentUserTier = 'free';
    let calculationsThisMonth = 0;

    // Tier Limits for calculations
    const TIER_CALCULATION_LIMITS = {
      free: 10,
      basic: 50,
      premium: 200,
      professional: 1000,
      admin: Infinity
    };

    // Firebase refs for calculator
    const printersRef = firebase.database().ref('printers');
    const filamentsRef = firebase.database().ref('filaments');
    let userPrintersRef = null;
    let userFilamentsRef = null;

    // Helper functions
    function money(n) {
      // Use formatCurrency if available (from currency.js)
      if (typeof window.formatCurrency === 'function' && window.currentCurrency) {
        return window.formatCurrency(n, window.currentCurrency);
      }
      
      // Fallback if formatCurrency is not loaded yet
      const currency = window.currentCurrency || 'USD';
      const symbol = getCurrencySymbol(currency);
      const amount = (Math.round(n * 100) / 100).toFixed(2);
      return `${currency} ${symbol}${amount}`;
    }

    // Tab switching for calculator
    function switchCalcTab(tabName) {
      document.querySelectorAll('.calc-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.calc-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      if (tabName === 'calculator') {
        document.getElementById('calculatorTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(1)').classList.add('active');
      } else if (tabName === 'printers') {
        document.getElementById('printersTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(2)').classList.add('active');
        renderPrintersList();
      } else if (tabName === 'filaments') {
        document.getElementById('filamentsTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(3)').classList.add('active');
        renderFilamentsList();
      } else if (tabName === 'userPresets') {
        document.getElementById('userPresetsTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(4)').classList.add('active');
      }
    }

    /* Presets System */
    const savePresetModal = document.getElementById('savePresetModal');
    const managePresetsModal = document.getElementById('managePresetsModal');
    const printerModal = document.getElementById('printerModal');
    const filamentModal = document.getElementById('filamentModal');
    const btnSavePreset = document.getElementById('btnSavePreset');
    const btnManagePresets = document.getElementById('btnManagePresets');
    const btnCloseSavePreset = document.getElementById('closeSavePreset');
    const btnCloseManagePresets = document.getElementById('closeManagePresets');
    const btnDoSavePreset = document.getElementById('doSavePreset');
    const presetNameInput = document.getElementById('presetName');
    const presetSaveErr = document.getElementById('presetSaveErr');
    const presetSaveInfo = document.getElementById('presetSaveInfo');
    const presetsList = document.getElementById('presetsList');
    const noPresetsMessage = document.getElementById('noPresetsMessage');
    const presetLimitInfo = document.getElementById('presetLimitInfo');
    const presetQuickAccess = document.getElementById('presetQuickAccess');
    const presetButtons = document.getElementById('presetButtons');

    let userPresets = [];
    const MAX_PRESETS_FREE = 2;
    const MAX_PRESETS_PREMIUM = 10;

    // Modal helper functions
    function showModal(modal) {
      if (modal) modal.style.display = 'grid';
    }

    function hideModal(modal) {
      if (modal) modal.style.display = 'none';
    }

    // Get current form data for saving as preset
    function getCurrentPrintDetails() {
      const getValueSafe = (id) => {
        const elem = document.getElementById(id);
        return elem ? elem.value : '';
      };
      
      const getCheckedSafe = (id) => {
        const elem = document.getElementById(id);
        return elem ? elem.checked : true;
      };
      
      return {
        selectedPrinter: getValueSafe('printerSelect'),
        selectedFilament: getValueSafe('filamentSelect'),
        filamentMarkup: getValueSafe('filamentMarkup'),
        generalMarkup: getValueSafe('generalMarkup'),
        failureRate: getValueSafe('failureRate'),
        postProcessingRate: getValueSafe('postProcessingRate'),
        preparationRate: getValueSafe('preparationRate'),
        jobRemoval: getValueSafe('jobRemoval'),
        supportRemoval: getValueSafe('supportRemoval'),
        additionalWork: getValueSafe('additionalWork'),
        modelPrep: getValueSafe('modelPrep'),
        slicing: getValueSafe('slicing'),
        materialChange: getValueSafe('materialChange'),
        transferStart: getValueSafe('transferStart'),
        includePrinterDepreciation: getCheckedSafe('includePrinterDepreciation')
      };
    }

    // Load preset data into form
    function loadPresetData(preset) {
      const setValueSafe = (id, value, defaultValue) => {
        const elem = document.getElementById(id);
        if (elem) {
          elem.value = value || defaultValue;
        }
      };
      
      if (preset.selectedPrinter) {
        setValueSafe('printerSelect', preset.selectedPrinter, '');
      }
      if (preset.selectedFilament) {
        setValueSafe('filamentSelect', preset.selectedFilament, '');
      }
      setValueSafe('filamentMarkup', preset.filamentMarkup, 0);
      setValueSafe('generalMarkup', preset.generalMarkup, 50);
      setValueSafe('failureRate', preset.failureRate, 10);
      setValueSafe('postProcessingRate', preset.postProcessingRate, 20);
      setValueSafe('preparationRate', preset.preparationRate, 20);
      setValueSafe('jobRemoval', preset.jobRemoval, 0);
      setValueSafe('supportRemoval', preset.supportRemoval, 0);
      setValueSafe('additionalWork', preset.additionalWork, 0);
      setValueSafe('modelPrep', preset.modelPrep, 0);
      setValueSafe('slicing', preset.slicing, 0);
      setValueSafe('materialChange', preset.materialChange, 0);
      setValueSafe('transferStart', preset.transferStart, 0);
      
      const includePrinterDepreciation = preset.includePrinterDepreciation !== undefined ? preset.includePrinterDepreciation : true;
      const depreciationCheckbox = document.getElementById('includePrinterDepreciation');
      if (depreciationCheckbox) {
        depreciationCheckbox.checked = includePrinterDepreciation;
      }
      
      updatePriceInfo();
    }

    // Save preset button
    if (btnSavePreset) {
      btnSavePreset.addEventListener('click', () => {
        const user = firebase.auth().currentUser;
        if (!user) {
          showNotification('Please login to save presets', 'warning', 'Login Required');
          return;
        }
        
        const maxPresets = currentUserTier === 'admin' || currentUserTier === 'premium' || currentUserTier === 'professional' ? MAX_PRESETS_PREMIUM : MAX_PRESETS_FREE;
        presetSaveInfo.textContent = `You have ${userPresets.length} of ${maxPresets} presets saved`;
        
        if (userPresets.length >= maxPresets) {
          presetSaveErr.textContent = `You've reached the maximum of ${maxPresets} presets. Delete one to save a new preset.`;
          presetSaveErr.style.display = 'block';
        } else {
          presetSaveErr.textContent = '';
          presetSaveErr.style.display = 'none';
        }
        
        presetNameInput.value = '';
        showModal(savePresetModal);
      });
    }

    // Close save preset modal
    if (btnCloseSavePreset) {
      btnCloseSavePreset.addEventListener('click', () => {
        hideModal(savePresetModal);
      });
    }

    // Do save preset
    if (btnDoSavePreset) {
      btnDoSavePreset.addEventListener('click', async () => {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        const name = presetNameInput.value.trim();
        if (!name) {
          presetSaveErr.textContent = 'Please enter a preset name';
          presetSaveErr.style.display = 'block';
          return;
        }
        
        const maxPresets = currentUserTier === 'admin' || currentUserTier === 'premium' || currentUserTier === 'professional' ? MAX_PRESETS_PREMIUM : MAX_PRESETS_FREE;
        if (userPresets.length >= maxPresets) {
          presetSaveErr.textContent = `Maximum ${maxPresets} presets reached`;
          presetSaveErr.style.display = 'block';
          return;
        }
        
        const presetData = getCurrentPrintDetails();
        const presetId = Date.now().toString();
        
        try {
          await firebase.database().ref(`users/${user.uid}/presets/${presetId}`).set({
            name: name,
            data: presetData,
            createdAt: Date.now()
          });
          
          console.log('Preset saved successfully');
          hideModal(savePresetModal);
          loadUserPresets();
        } catch (error) {
          console.error('Error saving preset:', error);
          presetSaveErr.textContent = 'Error saving preset. Please try again.';
          presetSaveErr.style.display = 'block';
        }
      });
    }

    // Manage presets button
    if (btnManagePresets) {
      btnManagePresets.addEventListener('click', () => {
        const user = firebase.auth().currentUser;
        if (!user) {
          showNotification('Please login to manage presets', 'warning', 'Login Required');
          return;
        }
        renderPresetsList();
        showModal(managePresetsModal);
      });
    }

    // Close manage presets modal
    if (btnCloseManagePresets) {
      btnCloseManagePresets.addEventListener('click', () => {
        hideModal(managePresetsModal);
      });
    }

    // Close printer modal
    const closePrinterBtn = document.getElementById('closePrinter');
    if (closePrinterBtn) {
      closePrinterBtn.addEventListener('click', () => {
        hideModal(printerModal);
      });
    }

    // Close filament modal
    const closeFilamentBtn = document.getElementById('closeFilament');
    if (closeFilamentBtn) {
      closeFilamentBtn.addEventListener('click', () => {
        hideModal(filamentModal);
      });
    }

    // Close printer modal (X button)
    const closePrinterX = document.getElementById('closePrinterX');
    if (closePrinterX) {
      closePrinterX.addEventListener('click', () => {
        hideModal(printerModal);
      });
    }

    // Close filament modal (X button)
    const closeFilamentX = document.getElementById('closeFilamentX');
    if (closeFilamentX) {
      closeFilamentX.addEventListener('click', () => {
        hideModal(filamentModal);
      });
    }

    // Load user presets from Firebase
    async function loadUserPresets() {
      const user = firebase.auth().currentUser;
      if (!user) {
        userPresets = [];
        updatePresetsUI();
        return;
      }
      
      try {
        const snapshot = await firebase.database().ref(`users/${user.uid}/presets`).once('value');
        const data = snapshot.val();
        
        if (data) {
          userPresets = Object.keys(data).map(id => ({
            id: id,
            ...data[id]
          }));
        } else {
          userPresets = [];
        }
        
        updatePresetsUI();
      } catch (error) {
        console.error('Error loading presets:', error);
        userPresets = [];
        updatePresetsUI();
      }
    }

    // Update presets UI
    function updatePresetsUI() {
      const maxPresets = currentUserTier === 'admin' || currentUserTier === 'premium' || currentUserTier === 'professional' ? MAX_PRESETS_PREMIUM : MAX_PRESETS_FREE;
      if (presetLimitInfo) {
        presetLimitInfo.textContent = `${userPresets.length}/${maxPresets} presets`;
      }
      
      if (userPresets.length > 0) {
        if (presetQuickAccess) presetQuickAccess.style.display = 'block';
        if (presetButtons) {
          presetButtons.innerHTML = '';
          
          userPresets.forEach(preset => {
            const btn = document.createElement('button');
            btn.className = 'btn-calc-ghost';
            btn.style.fontSize = '12px';
            btn.style.padding = '6px 12px';
            btn.textContent = preset.name;
            btn.onclick = () => loadPresetData(preset.data);
            presetButtons.appendChild(btn);
          });
        }
      } else {
        if (presetQuickAccess) presetQuickAccess.style.display = 'none';
      }
    }

    // Render presets list in manage modal
    function renderPresetsList() {
      if (userPresets.length === 0) {
        if (presetsList) presetsList.style.display = 'none';
        if (noPresetsMessage) noPresetsMessage.style.display = 'block';
        return;
      }
      
      if (presetsList) presetsList.style.display = 'block';
      if (noPresetsMessage) noPresetsMessage.style.display = 'none';
      
      if (presetsList) {
        presetsList.innerHTML = userPresets.map(preset => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid #2d2e3a; border-radius: 8px; margin-bottom: 12px;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px; color: #ffffff;">${preset.name}</div>
              <div style="font-size: 11px; color: #6b7280;">Saved ${new Date(preset.createdAt).toLocaleDateString()}</div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-calc" style="padding: 8px 16px; font-size: 13px;" onclick="loadPresetAndClose('${preset.id}')">Load</button>
              <button class="btn-calc-ghost" style="padding: 8px 16px; font-size: 13px; border-color: #ef4444; color: #ef4444;" onclick="deletePreset('${preset.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    // Load preset and close modal (global function for onclick)
    window.loadPresetAndClose = function(presetId) {
      const preset = userPresets.find(p => p.id === presetId);
      if (preset) {
        loadPresetData(preset.data);
        hideModal(managePresetsModal);
      }
    };

    // Delete preset (global function for onclick)
    window.deletePreset = async function(presetId) {
      const user = firebase.auth().currentUser;
      if (!user) return;
      
      if (!window.confirm('Are you sure you want to delete this preset?')) return;
      
      try {
        await firebase.database().ref(`users/${user.uid}/presets/${presetId}`).remove();
        console.log('Preset deleted successfully');
        showNotification('Preset deleted successfully', 'success');
        await loadUserPresets();
        renderPresetsList();
      } catch (error) {
        console.error('Error deleting preset:', error);
        showNotification('Error deleting preset. Please try again.', 'error');
      }
    };

    /* User Printers and Filaments */
    
    // Render user printers list
    function renderUserPrintersList() {
      const list = document.getElementById('userPrintersList');
      const addBtn = document.getElementById('btnAddUserPrinter');
      if (!list) return;
      
      const user = firebase.auth().currentUser;
      
      // Show/hide add button
      if (addBtn) {
        addBtn.style.display = user ? 'inline-block' : 'none';
      }
      
      if (!user) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Login to Add Your Printers</p>
            <p style="font-size: 14px; color: #6b7280; max-width: 400px; margin: 0 auto;">
              Create and manage your personal printer library, separate from the global presets.
            </p>
          </div>
        `;
        return;
      }
      
      const printerCount = Object.keys(userPrintersData).length;
      
      if (printerCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 16px; margin-bottom: 8px;">No personal printers yet</p>
            <p style="margin-top: 8px; font-size: 14px; color: #6b7280;">Click "Add Printer" above to create your first personal printer preset.</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `<div style="font-size: 14px; color: #6b7280; margin-bottom: 16px; font-weight: 600;">Total: ${printerCount} printer${printerCount !== 1 ? 's' : ''}</div>`;
      
      Object.entries(userPrintersData).forEach(([id, printer]) => {
        const printerCard = document.createElement('div');
        printerCard.style.cssText = 'padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid #2d2e3a; border-radius: 8px; margin-bottom: 12px;';
        printerCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px;">${printer.brand} ${printer.name}</div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Price:</span> ${money(printer.price)}
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Lifespan:</span> ${printer.lifespan.toLocaleString()} hrs
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Depreciation:</span> ${money(printer.price / printer.lifespan)}/hr
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editUserPrinter('${id}')" style="padding: 6px 12px; font-size: 13px;">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="deleteUserPrinter('${id}')" style="padding: 6px 12px; font-size: 13px; border-color: #ef4444; color: #ef4444;">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(printerCard);
      });
      
      // Update calculator dropdowns
      renderPrinterSelect();
    }

    // Render user filaments list
    function renderUserFilamentsList() {
      const list = document.getElementById('userFilamentsList');
      const addBtn = document.getElementById('btnAddUserFilament');
      if (!list) return;
      
      const user = firebase.auth().currentUser;
      
      // Show/hide add button
      if (addBtn) {
        addBtn.style.display = user ? 'inline-block' : 'none';
      }
      
      if (!user) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Login to Add Your Filaments</p>
            <p style="font-size: 14px; color: #6b7280; max-width: 400px; margin: 0 auto;">
              Create and manage your personal filament library, separate from the global presets.
            </p>
          </div>
        `;
        return;
      }
      
      const filamentCount = Object.keys(userFilamentsData).length;
      
      if (filamentCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 16px; margin-bottom: 8px;">No personal filaments yet</p>
            <p style="margin-top: 8px; font-size: 14px; color: #6b7280;">Click "Add Filament" above to create your first personal filament preset.</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `<div style="font-size: 14px; color: #6b7280; margin-bottom: 16px; font-weight: 600;">Total: ${filamentCount} filament${filamentCount !== 1 ? 's' : ''}</div>`;
      
      Object.entries(userFilamentsData).forEach(([id, filament]) => {
        const filamentCard = document.createElement('div');
        filamentCard.style.cssText = 'padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid #2d2e3a; border-radius: 8px; margin-bottom: 12px;';
        filamentCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px;">${filament.brand} - ${filament.type}</div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Spool Weight:</span> ${filament.spoolWeight}g
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Spool Cost:</span> $${filament.spoolCost.toFixed(2)}
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Cost per Gram:</span> $${(filament.spoolCost / filament.spoolWeight).toFixed(4)}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editUserFilament('${id}')" style="padding: 6px 12px; font-size: 13px;">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="deleteUserFilament('${id}')" style="padding: 6px 12px; font-size: 13px; border-color: #ef4444; color: #ef4444;">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(filamentCard);
      });
      
      // Update calculator dropdowns
      renderFilamentSelect();
    }

    // Load user printers from Firebase
    function loadUserPrinters() {
      const user = firebase.auth().currentUser;
      if (!user) {
        userPrintersData = {};
        renderUserPrintersList();
        return;
      }
      
      // Listen for real-time updates
      firebase.database().ref(`users/${user.uid}/printers`).on('value', snapshot => {
        userPrintersData = {};
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const printer = child.val();
            printer.id = child.key;
            userPrintersData[child.key] = printer;
          });
        }
        renderUserPrintersList();
      });
    }

    // Load user filaments from Firebase
    function loadUserFilaments() {
      const user = firebase.auth().currentUser;
      if (!user) {
        userFilamentsData = {};
        renderUserFilamentsList();
        return;
      }
      
      // Listen for real-time updates
      firebase.database().ref(`users/${user.uid}/filaments`).on('value', snapshot => {
        userFilamentsData = {};
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const filament = child.val();
            filament.id = child.key;
            userFilamentsData[child.key] = filament;
          });
        }
        renderUserFilamentsList();
      });
    }

    /* User Printers and Filaments CRUD */
    let editingUserPrinterId = null;
    let editingUserFilamentId = null;

    // Add user printer button handler
    if (document.getElementById('btnAddUserPrinter')) {
      document.getElementById('btnAddUserPrinter').onclick = () => {
        if (!firebase.auth().currentUser) {
          showNotification('Please login to add your own printers', 'warning', 'Login Required');
          return;
        }
        editingUserPrinterId = null;
        document.getElementById('printerModalTitle').textContent = 'Add Your Printer';
        document.getElementById('printerBrand').value = '';
        document.getElementById('printerName').value = '';
        document.getElementById('printerPrice').value = '';
        document.getElementById('printerLifespan').value = '5000';
        const printerErr = document.getElementById('printerErr');
        printerErr.textContent = '';
        printerErr.style.display = 'none';
        
        // Set save handler for user printer
        document.getElementById('savePrinter').onclick = saveUserPrinter;
        showModal(printerModal);
      };
    }

    // Add user filament button handler
    if (document.getElementById('btnAddUserFilament')) {
      document.getElementById('btnAddUserFilament').onclick = () => {
        if (!firebase.auth().currentUser) {
          showNotification('Please login to add your own filaments', 'warning', 'Login Required');
          return;
        }
        editingUserFilamentId = null;
        document.getElementById('filamentModalTitle').textContent = 'Add Your Filament';
        document.getElementById('filamentBrand').value = '';
        document.getElementById('filamentType').value = '';
        document.getElementById('spoolWeight').value = '1000';
        document.getElementById('spoolCost').value = '';
        const filamentErr = document.getElementById('filamentErr');
        filamentErr.textContent = '';
        filamentErr.style.display = 'none';
        
        // Set save handler for user filament
        document.getElementById('saveFilament').onclick = saveUserFilament;
        showModal(filamentModal);
      };
    }

    // Save user printer
    function saveUserPrinter() {
      if (!firebase.auth().currentUser) {
        showNotification('Please login to save your printer', 'warning', 'Login Required');
        return;
      }
      
      const brand = document.getElementById('printerBrand').value.trim();
      const name = document.getElementById('printerName').value.trim();
      const priceInput = parseFloat(document.getElementById('printerPrice').value);
      const lifespan = parseInt(document.getElementById('printerLifespan').value);
      const printerErr = document.getElementById('printerErr');
      
      if (!brand || !name || !priceInput || priceInput < 0 || !lifespan || lifespan < 1) {
        printerErr.textContent = 'Please fill all fields correctly.';
        printerErr.style.display = 'block';
        return;
      }
      
      // Convert price from current currency to USD for storage
      const currentCurrency = window.currentCurrency || 'USD';
      const priceUSD = convertToUSD(priceInput, currentCurrency);
      
      const printerData = { brand, name, price: priceUSD, lifespan };
      
      // Use Cloud Function for secure printer preset saving
      const savePrinterPresetFunc = firebase.functions().httpsCallable('savePrinterPreset');
      const wasEditing = editingUserPrinterId !== null;
      savePrinterPresetFunc({ 
        printerData: printerData,
        presetId: editingUserPrinterId 
      })
        .then((result) => {
          if (result.data.success) {
            editingUserPrinterId = null;
            hideModal(printerModal);
            // Show notification AFTER modal closes
            setTimeout(() => {
              showNotification(`"${brand} ${name}" has been ${wasEditing ? 'updated in' : 'added to'} your library!`, 'success', wasEditing ? 'Printer Updated' : 'Printer Added');
            }, 300);
          } else {
            printerErr.textContent = result.data.message || 'Error saving printer';
            printerErr.style.display = 'block';
          }
        })
        .catch((error) => {
          printerErr.textContent = 'Error saving printer: ' + error.message;
          printerErr.style.display = 'block';
        });
    }

    // Save user filament
    function saveUserFilament() {
      if (!firebase.auth().currentUser) {
        showNotification('Please login to save your filament', 'warning', 'Login Required');
        return;
      }
      
      const brand = document.getElementById('filamentBrand').value.trim();
      const type = document.getElementById('filamentType').value.trim();
      const spoolWeight = parseFloat(document.getElementById('spoolWeight').value);
      const spoolCostInput = parseFloat(document.getElementById('spoolCost').value);
      const filamentErr = document.getElementById('filamentErr');
      
      if (!brand || !type || !spoolWeight || spoolWeight <= 0 || !spoolCostInput || spoolCostInput < 0) {
        filamentErr.textContent = 'Please fill all fields correctly.';
        filamentErr.style.display = 'block';
        return;
      }
      
      // Convert cost from current currency to USD for storage
      const currentCurrency = window.currentCurrency || 'USD';
      const spoolCostUSD = convertToUSD(spoolCostInput, currentCurrency);
      
      const filamentData = { brand, type, spoolWeight, spoolCost: spoolCostUSD };
      
      // Use Cloud Function for secure filament preset saving
      const saveFilamentPresetFunc = firebase.functions().httpsCallable('saveFilamentPreset');
      const wasEditing = editingUserFilamentId !== null;
      saveFilamentPresetFunc({ 
        filamentData: filamentData,
        presetId: editingUserFilamentId 
      })
        .then((result) => {
          if (result.data.success) {
            editingUserFilamentId = null;
            hideModal(filamentModal);
            // Show notification AFTER modal closes
            setTimeout(() => {
              showNotification(`"${brand} - ${type}" has been ${wasEditing ? 'updated in' : 'added to'} your library!`, 'success', wasEditing ? 'Filament Updated' : 'Filament Added');
            }, 300);
          } else {
            filamentErr.textContent = result.data.message || 'Error saving filament';
            filamentErr.style.display = 'block';
          }
        })
        .catch((error) => {
          filamentErr.textContent = 'Error saving filament: ' + error.message;
          filamentErr.style.display = 'block';
        });
    }

    // Batch add printers functionality
    if (document.getElementById('btnParseQuickAdd')) {
      document.getElementById('btnParseQuickAdd').onclick = async function() {
        if (!firebase.auth().currentUser) {
          showNotification('Please login to add printers', 'warning', 'Login Required');
          return;
        }
        
        const quickAddText = document.getElementById('printerQuickAdd').value.trim();
        const printerErr = document.getElementById('printerErr');
        
        if (!quickAddText) {
          printerErr.textContent = 'Please enter printer data to batch add.';
          printerErr.style.display = 'block';
          return;
        }
        
        try {
          // Split by semicolon and parse each entry
          const entries = quickAddText.split(';').map(s => s.trim()).filter(s => s);
          const printers = [];
          
          const currentCurrency = window.currentCurrency || 'USD';
          
          for (const entry of entries) {
            const parsed = JSON.parse(entry);
            if (!Array.isArray(parsed) || parsed.length !== 4) {
              throw new Error('Each entry must be: ["Name", "Brand", Price, Lifespan]');
            }
            const [name, brand, priceInput, lifespan] = parsed;
            if (!name || !brand || typeof priceInput !== 'number' || typeof lifespan !== 'number') {
              throw new Error('Invalid data format');
            }
            // Convert price from current currency to USD
            const priceUSD = convertToUSD(priceInput, currentCurrency);
            printers.push({ name, brand, price: priceUSD, lifespan });
          }
          
          if (printers.length === 0) {
            throw new Error('No valid printers found');
          }
          
          // Add all printers to Firebase
          const userPrintersRef = db.ref(`users/${auth.currentUser.uid}/printers`);
          const promises = printers.map(printer => userPrintersRef.push(printer));
          await Promise.all(promises);
          
          hideModal(printerModal);
          showNotification(`Successfully added ${printers.length} printer(s) to your library!`, 'success', 'Printers Added');
          document.getElementById('printerQuickAdd').value = '';
          
        } catch (error) {
          printerErr.textContent = 'Error: ' + error.message;
          printerErr.style.display = 'block';
        }
      };
    }

    // Batch add filaments functionality
    if (document.getElementById('btnParseFilamentQuickAdd')) {
      document.getElementById('btnParseFilamentQuickAdd').onclick = async function() {
        if (!auth.currentUser) {
          showNotification('Please login to add filaments', 'warning', 'Login Required');
          return;
        }
        
        const quickAddText = document.getElementById('filamentQuickAdd').value.trim();
        const filamentErr = document.getElementById('filamentErr');
        
        if (!quickAddText) {
          filamentErr.textContent = 'Please enter filament data to batch add.';
          filamentErr.style.display = 'block';
          return;
        }
        
        try {
          // Split by semicolon and parse each entry
          const entries = quickAddText.split(';').map(s => s.trim()).filter(s => s);
          const filaments = [];
          
          const currentCurrency = window.currentCurrency || 'USD';
          
          for (const entry of entries) {
            const parsed = JSON.parse(entry);
            if (!Array.isArray(parsed) || parsed.length !== 4) {
              throw new Error('Each entry must be: ["Type", "Brand", Weight, Cost]');
            }
            const [type, brand, spoolWeight, spoolCostInput] = parsed;
            if (!type || !brand || typeof spoolWeight !== 'number' || typeof spoolCostInput !== 'number') {
              throw new Error('Invalid data format');
            }
            // Convert cost from current currency to USD
            const spoolCostUSD = convertToUSD(spoolCostInput, currentCurrency);
            filaments.push({ type, brand, spoolWeight, spoolCost: spoolCostUSD });
          }
          
          if (filaments.length === 0) {
            throw new Error('No valid filaments found');
          }
          
          // Add all filaments to Firebase
          const userFilamentsRef = db.ref(`users/${auth.currentUser.uid}/filaments`);
          const promises = filaments.map(filament => userFilamentsRef.push(filament));
          await Promise.all(promises);
          
          hideModal(filamentModal);
          showNotification(`Successfully added ${filaments.length} filament(s) to your library!`, 'success', 'Filaments Added');
          document.getElementById('filamentQuickAdd').value = '';
          
        } catch (error) {
          filamentErr.textContent = 'Error: ' + error.message;
          filamentErr.style.display = 'block';
        }
      };
    }

    // Edit user printer (global function for onclick)
    window.editUserPrinter = function(id) {
      if (!auth.currentUser) return;
      
      editingUserPrinterId = id;
      const printer = userPrintersData[id];
      if (!printer) return;
      
      document.getElementById('printerModalTitle').textContent = 'Edit Your Printer';
      document.getElementById('printerBrand').value = printer.brand;
      document.getElementById('printerName').value = printer.name;
      document.getElementById('printerPrice').value = printer.price.toFixed(2);
      document.getElementById('printerLifespan').value = printer.lifespan;
      const printerErr = document.getElementById('printerErr');
      printerErr.textContent = '';
      printerErr.style.display = 'none';
      
      // Set save handler for user printer
      document.getElementById('savePrinter').onclick = saveUserPrinter;
      showModal(printerModal);
    };

    // Delete user printer (global function for onclick)
    window.deleteUserPrinter = function(id) {
      if (!auth.currentUser) return;
      
      const printer = userPrintersData[id];
      if (!printer) return;
      
      if (!window.confirm(`Delete "${printer.brand} ${printer.name}" from your library? This action cannot be undone.`)) return;
      
      db.ref(`users/${auth.currentUser.uid}/printers/${id}`).remove()
        .then(() => {
          showNotification(`"${printer.brand} ${printer.name}" has been deleted from your library.`, 'success', 'Printer Deleted');
        })
        .catch(error => {
          showNotification('Error deleting printer: ' + error.message, 'error');
        });
    };

    // Edit user filament (global function for onclick)
    window.editUserFilament = function(id) {
      if (!auth.currentUser) return;
      
      editingUserFilamentId = id;
      const filament = userFilamentsData[id];
      if (!filament) return;
      
      document.getElementById('filamentModalTitle').textContent = 'Edit Your Filament';
      document.getElementById('filamentBrand').value = filament.brand;
      document.getElementById('filamentType').value = filament.type;
      document.getElementById('spoolWeight').value = filament.spoolWeight;
      document.getElementById('spoolCost').value = filament.spoolCost.toFixed(2);
      const filamentErr = document.getElementById('filamentErr');
      filamentErr.textContent = '';
      filamentErr.style.display = 'none';
      
      // Set save handler for user filament
      document.getElementById('saveFilament').onclick = saveUserFilament;
      showModal(filamentModal);
    };

    // Delete user filament (global function for onclick)
    window.deleteUserFilament = function(id) {
      if (!auth.currentUser) return;
      
      const filament = userFilamentsData[id];
      if (!filament) return;
      
      if (!window.confirm(`Delete "${filament.brand} - ${filament.type}" from your library? This action cannot be undone.`)) return;
      
      db.ref(`users/${auth.currentUser.uid}/filaments/${id}`).remove()
        .then(() => {
          showNotification(`"${filament.brand} - ${filament.type}" has been deleted from your library.`, 'success', 'Filament Deleted');
        })
        .catch(error => {
          showNotification('Error deleting filament: ' + error.message, 'error');
        });
    };

    // Load printers from Firebase
    function loadPrinters() {
      console.log('Loading printers from Firebase...');
      printersRef.on('value', snapshot => {
        printersData = {};
        const data = snapshot.val();
        
        if (!data) {
          renderPrinterSelect();
          renderPrintersList();
          return;
        }
        
        Object.entries(data).forEach(([key, value]) => {
          const name = value.name;
          const brand = value.brand || 'Unknown';
          const price = Number(value.price || 0);
          const lifespan = Number(value.lifespan || 5000);
          const costPerHour = price / lifespan;
          
          printersData[name] = {
            id: key,
            name: name,
            brand: brand,
            price: price,
            lifespan: lifespan,
            costPerHour: costPerHour
          };
        });
        
        dataLoaded = true;
        renderPrinterSelect();
        renderPrintersList();
        updatePriceInfo();
      });
    }

    // Load filaments from Firebase
    function loadFilaments() {
      console.log('Loading global filaments...');
      console.log('filamentsRef:', filamentsRef);
      console.log('Firebase database:', firebase.database());
      
      filamentsRef.once('value')
        .then(snapshot => {
          console.log('Firebase snapshot received');
          filamentsData = {};
          const data = snapshot.val();
          
          console.log('Global filaments data:', data);
          
          if (!data) {
            console.log('No global filaments found in database');
            renderFilamentSelect();
            renderFilamentsList();
            return;
          }
          
          Object.entries(data).forEach(([key, value]) => {
            const type = value.type;
            const spoolWeight = Number(value.spoolWeight || 1000);
            const spoolCost = Number(value.spoolCost || 0);
            const costPerG = spoolCost / spoolWeight;
            
            filamentsData[type] = {
              id: key,
              type: type,
              brand: value.brand,
              spoolWeight: spoolWeight,
              spoolCost: spoolCost,
              costPerG: costPerG
            };
          });
          
          console.log('Loaded global filaments:', filamentsData);
          renderFilamentSelect();
          renderFilamentsList();
          updatePriceInfo();
        })
        .catch(error => {
          console.error('Error loading filaments from Firebase:', error);
        });
    }

    // Render printer select dropdown
    function renderPrinterSelect() {
      const select = document.getElementById('printerSelect');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">Choose a printer...</option>';
      
      // Add user printers first (if any)
      if (Object.keys(userPrintersData).length > 0) {
        // Add user printers header
        const userHeader = document.createElement('option');
        userHeader.disabled = true;
        userHeader.textContent = '── My Printers ──';
        userHeader.style.fontWeight = 'bold';
        userHeader.style.textAlign = 'center';
        userHeader.style.color = '#8b5cf6';
        select.appendChild(userHeader);
        
        // Group user printers by brand
        const userBrandGroups = {};
        Object.entries(userPrintersData).forEach(([id, printer]) => {
          const brand = printer.brand || 'Unknown Brand';
          if (!userBrandGroups[brand]) {
            userBrandGroups[brand] = [];
          }
          userBrandGroups[brand].push({ id, ...printer });
        });
        
        // Sort brands and add each as optgroup
        const sortedUserBrands = Object.keys(userBrandGroups).sort();
        sortedUserBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          userBrandGroups[brand].sort((a, b) => a.name.localeCompare(b.name)).forEach(printer => {
            const option = document.createElement('option');
            option.value = `user:${printer.id}`;
            option.textContent = printer.name;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      // Add global printers
      if (Object.keys(printersData).length > 0) {
        // Add global printers header
        const globalHeader = document.createElement('option');
        globalHeader.disabled = true;
        globalHeader.textContent = '── Global Printers ──';
        globalHeader.style.fontWeight = 'bold';
        globalHeader.style.textAlign = 'center';
        globalHeader.style.color = '#8b5cf6';
        select.appendChild(globalHeader);
        
        // Group global printers by brand
        const brandGroups = {};
        Object.entries(printersData).forEach(([name, printer]) => {
          const brand = printer.brand || 'Unknown Brand';
          if (!brandGroups[brand]) {
            brandGroups[brand] = [];
          }
          brandGroups[brand].push({ name, ...printer });
        });
        
        // Sort brands and add each as optgroup
        const sortedBrands = Object.keys(brandGroups).sort();
        sortedBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          brandGroups[brand].sort((a, b) => a.name.localeCompare(b.name)).forEach(printer => {
            const option = document.createElement('option');
            option.value = `global:${printer.name}`;
            option.textContent = printer.name;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      if (currentValue) {
        select.value = currentValue;
      }
      
      updatePriceInfo();
    }

    // Render filament select dropdown
    function renderFilamentSelect() {
      const select = document.getElementById('filamentSelect');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">Choose filament...</option>';
      
      // Add user filaments first (if any)
      if (Object.keys(userFilamentsData).length > 0) {
        // Add user filaments header
        const userHeader = document.createElement('option');
        userHeader.disabled = true;
        userHeader.textContent = '── My Filaments ──';
        userHeader.style.fontWeight = 'bold';
        userHeader.style.textAlign = 'center';
        userHeader.style.color = '#8b5cf6';
        select.appendChild(userHeader);
        
        // Group user filaments by brand
        const userBrandGroups = {};
        Object.entries(userFilamentsData).forEach(([id, filament]) => {
          const brand = filament.brand || 'Unknown Brand';
          if (!userBrandGroups[brand]) {
            userBrandGroups[brand] = [];
          }
          userBrandGroups[brand].push({ id, ...filament });
        });
        
        // Sort brands and add each as optgroup
        const sortedUserBrands = Object.keys(userBrandGroups).sort();
        sortedUserBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          userBrandGroups[brand].sort((a, b) => a.type.localeCompare(b.type)).forEach(filament => {
            const option = document.createElement('option');
            option.value = `user:${filament.id}`;
            option.textContent = filament.type;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      // Add global filaments
      if (Object.keys(filamentsData).length > 0) {
        // Add global filaments header
        const globalHeader = document.createElement('option');
        globalHeader.disabled = true;
        globalHeader.textContent = '── Global Filaments ──';
        globalHeader.style.fontWeight = 'bold';
        globalHeader.style.textAlign = 'center';
        globalHeader.style.color = '#8b5cf6';
        select.appendChild(globalHeader);
        
        // Group global filaments by brand
        const brandGroups = {};
        Object.entries(filamentsData).forEach(([type, filament]) => {
          const brand = filament.brand || 'Unknown Brand';
          if (!brandGroups[brand]) {
            brandGroups[brand] = [];
          }
          brandGroups[brand].push({ type, ...filament });
        });
        
        // Sort brands and add each as optgroup
        const sortedBrands = Object.keys(brandGroups).sort();
        sortedBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          brandGroups[brand].sort((a, b) => a.type.localeCompare(b.type)).forEach(filament => {
            const option = document.createElement('option');
            option.value = `global:${filament.type}`;
            option.textContent = filament.type;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      if (currentValue) {
        select.value = currentValue;
      }
      
      updatePriceInfo();
    }

    // Render printers list
    function renderPrintersList() {
      const list = document.getElementById('printersList');
      if (!list) return;
      
      list.innerHTML = '';
      
      const printerCount = Object.keys(printersData).length;
      const isAdmin = currentUserTier === 'admin';
      
      if (printerCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p>No printers available yet.</p>
          </div>
        `;
        return;
      }

      // Group by brand
      const brandGroups = {};
      Object.entries(printersData).forEach(([name, printer]) => {
        const brand = printer.brand || 'Unknown';
        if (!brandGroups[brand]) {
          brandGroups[brand] = [];
        }
        brandGroups[brand].push(printer);
      });
      
      const sortedBrands = Object.keys(brandGroups).sort();
      
      sortedBrands.forEach(brand => {
        const printers = brandGroups[brand].sort((a, b) => a.name.localeCompare(b.name));
        
        const brandSection = document.createElement('div');
        brandSection.style.marginBottom = '24px';
        brandSection.innerHTML = `
          <h4 style="color: #8b5cf6; font-size: 16px; font-weight: 700; margin-bottom: 16px;">${brand}</h4>
        `;
        
        printers.forEach(printer => {
          const item = document.createElement('div');
          item.className = 'list-item';
          
          // Admin action buttons
          const adminButtons = isAdmin ? `
            <div class="btn-actions" style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editGlobalPrinter('${printer.name}')">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="duplicateGlobalPrinter('${printer.name}')">Duplicate</button>
              <button class="btn-delete btn-small" onclick="deleteGlobalPrinter('${printer.name}')">Delete</button>
            </div>
          ` : '';
          
          item.innerHTML = `
            <div class="item-info">
              <div class="item-name">${printer.name}</div>
              <div class="item-details">
                Price: ${money(printer.price)} | Lifespan: ${printer.lifespan.toLocaleString()} hrs | Depreciation: ${money(printer.costPerHour)}/hr
              </div>
            </div>
            ${adminButtons}
          `;
          brandSection.appendChild(item);
        });
        
        list.appendChild(brandSection);
      });
    }

    // Render filaments list
    function renderFilamentsList() {
      console.log('renderFilamentsList called');
      const list = document.getElementById('filamentsList');
      console.log('filamentsList element:', list);
      if (!list) {
        console.error('filamentsList element not found!');
        return;
      }
      
      list.innerHTML = '';
      
      const filamentCount = Object.keys(filamentsData).length;
      console.log('Filament count:', filamentCount);
      console.log('filamentsData:', filamentsData);
      const isAdmin = currentUserTier === 'admin';
      
      if (filamentCount === 0) {
        console.log('No filaments - showing empty state');
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p>No filaments available yet.</p>
          </div>
        `;
        return;
      }

      console.log('Rendering filaments...');
      // Group by brand
      const brandGroups = {};
      Object.entries(filamentsData).forEach(([type, filament]) => {
        const brand = filament.brand || 'Unknown';
        if (!brandGroups[brand]) {
          brandGroups[brand] = [];
        }
        brandGroups[brand].push(filament);
      });
      
      const sortedBrands = Object.keys(brandGroups).sort();
      console.log('Brands found:', sortedBrands);
      
      sortedBrands.forEach(brand => {
        const filaments = brandGroups[brand].sort((a, b) => a.type.localeCompare(b.type));
        
        const brandSection = document.createElement('div');
        brandSection.style.marginBottom = '24px';
        brandSection.innerHTML = `
          <h4 style="color: #8b5cf6; font-size: 16px; font-weight: 700; margin-bottom: 16px;">${brand}</h4>
        `;
        
        filaments.forEach(filament => {
          const item = document.createElement('div');
          item.className = 'list-item';
          const perKg = filament.costPerG * 1000;
          
          // Admin action buttons
          const adminButtons = isAdmin ? `
            <div class="btn-actions" style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editGlobalFilament('${filament.type.replace(/'/g, "\\'")}')">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="duplicateGlobalFilament('${filament.type.replace(/'/g, "\\'")}')">Duplicate</button>
              <button class="btn-delete btn-small" onclick="deleteGlobalFilament('${filament.type.replace(/'/g, "\\'")}')">Delete</button>
            </div>
          ` : '';
          
          item.innerHTML = `
            <div class="item-info">
              <div class="item-name">${filament.type}</div>
              <div class="item-details">
                Spool: ${money(filament.spoolCost)} (${filament.spoolWeight}g) | Per kg: ${money(perKg)} | Per g: ${money(filament.costPerG)}
              </div>
            </div>
            ${adminButtons}
          `;
          brandSection.appendChild(item);
        });
        
        list.appendChild(brandSection);
      });
    }

    // Update price info boxes
    function updatePriceInfo() {
      const printerValue = document.getElementById('printerSelect')?.value;
      const filamentValue = document.getElementById('filamentSelect')?.value;
      const printerCostBox = document.getElementById('printerCostBox');
      const filamentCostBox = document.getElementById('filamentCostBox');
      const printerCostInfo = document.getElementById('printerCostInfo');
      const filamentCostInfo = document.getElementById('filamentCostInfo');
      
      if (!printerCostBox || !filamentCostBox) return;
      
      // Get printer data
      let printer = null;
      if (printerValue) {
        if (printerValue.startsWith('user:')) {
          const id = printerValue.substring(5);
          printer = userPrintersData[id];
          if (printer) {
            // Calculate cost per hour for user printer
            printer = {
              ...printer,
              costPerHour: printer.price / printer.lifespan
            };
          }
        } else if (printerValue.startsWith('global:')) {
          const name = printerValue.substring(7);
          printer = printersData[name];
        }
      }
      
      if (printer) {
        printerCostInfo.textContent = `${money(printer.costPerHour)}/h`;
        printerCostBox.style.display = 'block';
      } else {
        printerCostBox.style.display = 'none';
      }
      
      // Get filament data
      let filament = null;
      if (filamentValue) {
        if (filamentValue.startsWith('user:')) {
          const id = filamentValue.substring(5);
          filament = userFilamentsData[id];
          if (filament) {
            // Calculate cost per gram for user filament
            filament = {
              ...filament,
              costPerG: filament.spoolCost / filament.spoolWeight
            };
          }
        } else if (filamentValue.startsWith('global:')) {
          const type = filamentValue.substring(7);
          filament = filamentsData[type];
        }
      }
      
      if (filament) {
        const perKg = filament.costPerG * 1000;
        filamentCostInfo.textContent = `${money(perKg)}/kg`;
        filamentCostBox.style.display = 'block';
      } else {
        filamentCostBox.style.display = 'none';
      }
    }

    // ===============================================
    // NOTIFICATION MODAL FUNCTIONS (Available for all users)
    // Replacements for alert/confirm/prompt with custom styling
    // ===============================================
    
    // OLD showNotificationModal REMOVED - Now using toast notifications at bottom of page
    
    // Show confirmation modal (replaces confirm)
    window.showConfirm = function(message, title = 'Confirm Action') {
      return new Promise((resolve) => {
        const modal = document.getElementById('adminConfirmModal');
        const titleEl = document.getElementById('adminConfirmTitle');
        const messageEl = document.getElementById('adminConfirmMessage');
        const cancelBtn = document.getElementById('adminConfirmCancel');
        const okBtn = document.getElementById('adminConfirmOk');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.style.display = 'grid';
        
        const handleCancel = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(false);
        };
        
        const handleOk = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(true);
        };
        
        const cleanup = () => {
          cancelBtn.removeEventListener('click', handleCancel);
          okBtn.removeEventListener('click', handleOk);
        };
        
        cancelBtn.addEventListener('click', handleCancel);
        okBtn.addEventListener('click', handleOk);
      });
    }
    
    // Show prompt modal (replaces prompt)
    window.showPrompt = function(message, defaultValue = '', title = 'Enter Value') {
      return new Promise((resolve) => {
        const modal = document.getElementById('adminPromptModal');
        const titleEl = document.getElementById('adminPromptTitle');
        const messageEl = document.getElementById('adminPromptMessage');
        const inputEl = document.getElementById('adminPromptInput');
        const cancelBtn = document.getElementById('adminPromptCancel');
        const okBtn = document.getElementById('adminPromptOk');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.value = defaultValue;
        modal.style.display = 'grid';
        
        // Focus input
        setTimeout(() => inputEl.focus(), 100);
        
        const handleCancel = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(null);
        };
        
        const handleOk = () => {
          const value = inputEl.value.trim();
          modal.style.display = 'none';
          cleanup();
          resolve(value || null);
        };
        
        const handleKeyPress = (e) => {
          if (e.key === 'Enter') handleOk();
          if (e.key === 'Escape') handleCancel();
        };
        
        const cleanup = () => {
          cancelBtn.removeEventListener('click', handleCancel);
          okBtn.removeEventListener('click', handleOk);
          inputEl.removeEventListener('keypress', handleKeyPress);
        };
        
        cancelBtn.addEventListener('click', handleCancel);
        okBtn.addEventListener('click', handleOk);
        inputEl.addEventListener('keypress', handleKeyPress);
      });
    }

    // ===============================================
    // ADMIN FUNCTIONS FOR GLOBAL PRINTERS & FILAMENTS
    // ===============================================
    
    // Edit Global Printer (Admin Only)
    window.editGlobalPrinter = async function(printerName) {
      console.log('editGlobalPrinter called with:', printerName);
      console.log('Current user tier:', currentUserTier);
      console.log('Available printers:', Object.keys(printersData));
      
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to edit global printers.', 'warning', 'Access Denied');
        return;
      }
      
      const printer = printersData[printerName];
      if (!printer) {
        console.error('Printer not found:', printerName);
        showNotification('Printer not found in the database.', 'error', 'Error');
        return;
      }
      
      console.log('Opening edit modal for printer:', printer);
      
      // Populate modal
      document.getElementById('editGlobalPrinterOriginalName').value = printerName;
      document.getElementById('editGlobalPrinterName').value = printer.name;
      document.getElementById('editGlobalPrinterBrand').value = printer.brand || '';
      document.getElementById('editGlobalPrinterPrice').value = printer.price;
      document.getElementById('editGlobalPrinterLifespan').value = printer.lifespan;
      
      // Update depreciation display
      updateGlobalPrinterDepreciation();
      
      // Show modal
      const modal = document.getElementById('editGlobalPrinterModal');
      console.log('Modal element:', modal);
      if (modal) {
        modal.style.display = 'grid';
        console.log('Modal should now be visible');
      } else {
        console.error('Modal element not found!');
      }
    };
    
    // Delete Global Printer (Admin Only)
    window.deleteGlobalPrinter = async function(printerName) {
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to delete global printers.', 'warning', 'Access Denied');
        return;
      }
      
      const confirmed = await showConfirm(
        `Delete global printer "${printerName}"? This will affect all users and cannot be undone.`,
        'Delete Printer?'
      );
      
      if (!confirmed) return;
      
      // Find and delete from Firebase
      printersRef.orderByChild('name').equalTo(printerName).once('value', snapshot => {
        snapshot.forEach(child => {
          child.ref.remove()
            .then(async () => {
              showNotification(`Printer "${printerName}" has been deleted successfully.`, 'success', 'Success');
              renderPrintersList();
            })
            .catch(async (error) => {
              showNotification(`Error deleting printer: ${error.message}`, 'error', 'Error');
            });
        });
      });
    };
    
    // Duplicate Global Printer (Admin Only)
    window.duplicateGlobalPrinter = async function(printerName) {
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to duplicate global printers.', 'warning', 'Access Denied');
        return;
      }
      
      const printer = printersData[printerName];
      if (!printer) {
        showNotification('Printer not found in the database.', 'error', 'Error');
        return;
      }
      
      const newName = await showPrompt(
        'Enter name for the duplicated printer:',
        printer.name + ' (Copy)',
        'Duplicate Printer'
      );
      
      if (!newName) return;
      
      // Create duplicate with new name
      const newPrinter = {
        name: newName,
        brand: printer.brand,
        price: printer.price,
        lifespan: printer.lifespan,
        costPerHour: printer.costPerHour
      };
      
      printersRef.push(newPrinter)
        .then(async () => {
          showNotification(`Printer "${newName}" has been duplicated successfully.`, 'success', 'Success');
          renderPrintersList();
        })
        .catch(async (error) => {
          showNotification(`Error duplicating printer: ${error.message}`, 'error', 'Error');
        });
    };
    
    // Edit Global Filament (Admin Only)
    window.editGlobalFilament = async function(filamentType) {
      console.log('editGlobalFilament called with:', filamentType);
      console.log('Current user tier:', currentUserTier);
      console.log('Available filaments:', Object.keys(filamentsData));
      
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to edit global filaments.', 'warning', 'Access Denied');
        return;
      }
      
      const filament = filamentsData[filamentType];
      if (!filament) {
        console.error('Filament not found:', filamentType);
        showNotification('Filament not found in the database.', 'error', 'Error');
        return;
      }
      
      console.log('Opening edit modal for filament:', filament);
      
      // Populate modal
      document.getElementById('editGlobalFilamentOriginalType').value = filamentType;
      document.getElementById('editGlobalFilamentType').value = filament.type;
      document.getElementById('editGlobalFilamentBrand').value = filament.brand || '';
      document.getElementById('editGlobalFilamentWeight').value = filament.spoolWeight;
      document.getElementById('editGlobalFilamentCost').value = filament.spoolCost;
      
      // Update cost per gram display
      updateGlobalFilamentCostPerG();
      
      // Show modal
      const modal = document.getElementById('editGlobalFilamentModal');
      console.log('Modal element:', modal);
      if (modal) {
        modal.style.display = 'grid';
        console.log('Modal should now be visible');
      } else {
        console.error('Modal element not found!');
      }
    };
    
    // Delete Global Filament (Admin Only)
    window.deleteGlobalFilament = async function(filamentType) {
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to delete global filaments.', 'warning', 'Access Denied');
        return;
      }
      
      const confirmed = await showConfirm(
        `Delete global filament "${filamentType}"? This will affect all users and cannot be undone.`,
        'Delete Filament?'
      );
      
      if (!confirmed) return;
      
      // Find and delete from Firebase
      filamentsRef.orderByChild('type').equalTo(filamentType).once('value', snapshot => {
        snapshot.forEach(child => {
          child.ref.remove()
            .then(async () => {
              showNotification(`Filament "${filamentType}" has been deleted successfully.`, 'success', 'Success');
              renderFilamentsList();
            })
            .catch(async (error) => {
              showNotification(`Error deleting filament: ${error.message}`, 'error', 'Error');
            });
        });
      });
    };
    
    // Duplicate Global Filament (Admin Only)
    window.duplicateGlobalFilament = async function(filamentType) {
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to duplicate global filaments.', 'warning', 'Access Denied');
        return;
      }
      
      const filament = filamentsData[filamentType];
      if (!filament) {
        showNotification('Filament not found in the database.', 'error', 'Error');
        return;
      }
      
      const newType = await showPrompt(
        'Enter type for the duplicated filament:',
        filament.type + ' (Copy)',
        'Duplicate Filament'
      );
      
      if (!newType) return;
      
      // Create duplicate with new type
      const newFilament = {
        type: newType,
        brand: filament.brand,
        spoolWeight: filament.spoolWeight,
        spoolCost: filament.spoolCost,
        costPerG: filament.costPerG
      };
      
      filamentsRef.push(newFilament)
        .then(async () => {
          showNotification(`Filament "${newType}" has been duplicated successfully.`, 'success', 'Success');
          renderFilamentsList();
        })
        .catch(async (error) => {
          showNotification(`Error duplicating filament: ${error.message}`, 'error', 'Error');
        });
    };
    
    // Update depreciation display for global printer editing
    function updateGlobalPrinterDepreciation() {
      const price = parseFloat(document.getElementById('editGlobalPrinterPrice').value) || 0;
      const lifespan = parseFloat(document.getElementById('editGlobalPrinterLifespan').value) || 1;
      const depreciation = price / lifespan;
      document.getElementById('editGlobalPrinterDepreciation').textContent = money(depreciation);
    }
    
    // Update cost per gram display for global filament editing
    function updateGlobalFilamentCostPerG() {
      const cost = parseFloat(document.getElementById('editGlobalFilamentCost').value) || 0;
      const weight = parseFloat(document.getElementById('editGlobalFilamentWeight').value) || 1;
      const costPerG = cost / weight;
      document.getElementById('editGlobalFilamentCostPerG').textContent = money(costPerG);
    }
    
    // Update depreciation display for adding global printer
    function updateAddGlobalPrinterDepreciation() {
      const price = parseFloat(document.getElementById('addGlobalPrinterPrice').value) || 0;
      const lifespan = parseFloat(document.getElementById('addGlobalPrinterLifespan').value) || 1;
      const depreciation = price / lifespan;
      document.getElementById('addGlobalPrinterDepreciation').textContent = money(depreciation);
    }
    
    // Update cost per gram display for adding global filament
    function updateAddGlobalFilamentCostPerG() {
      const cost = parseFloat(document.getElementById('addGlobalFilamentCost').value) || 0;
      const weight = parseFloat(document.getElementById('addGlobalFilamentWeight').value) || 1;
      const costPerG = cost / weight;
      document.getElementById('addGlobalFilamentCostPerG').textContent = money(costPerG);
    }
    
    // Show/hide admin buttons based on user tier
    function updateAdminButtonsVisibility() {
      const btnAddGlobalPrinter = document.getElementById('btnAddGlobalPrinter');
      const btnAddGlobalFilament = document.getElementById('btnAddGlobalFilament');
      
      if (currentUserTier === 'admin') {
        if (btnAddGlobalPrinter) btnAddGlobalPrinter.style.display = 'inline-block';
        if (btnAddGlobalFilament) btnAddGlobalFilament.style.display = 'inline-block';
      } else {
        if (btnAddGlobalPrinter) btnAddGlobalPrinter.style.display = 'none';
        if (btnAddGlobalFilament) btnAddGlobalFilament.style.display = 'none';
      }
    }
    
    // Setup modal event listeners for global editing
    document.addEventListener('DOMContentLoaded', function() {
      // Global Printer Modal
      const editGlobalPrinterModal = document.getElementById('editGlobalPrinterModal');
      const closeEditGlobalPrinterX = document.getElementById('closeEditGlobalPrinterX');
      const closeEditGlobalPrinter = document.getElementById('closeEditGlobalPrinter');
      const saveEditGlobalPrinter = document.getElementById('saveEditGlobalPrinter');
      
      if (closeEditGlobalPrinterX) {
        closeEditGlobalPrinterX.addEventListener('click', () => {
          editGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (closeEditGlobalPrinter) {
        closeEditGlobalPrinter.addEventListener('click', () => {
          editGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (saveEditGlobalPrinter) {
        saveEditGlobalPrinter.addEventListener('click', async () => {
          const originalName = document.getElementById('editGlobalPrinterOriginalName').value;
          const newName = document.getElementById('editGlobalPrinterName').value.trim();
          const brand = document.getElementById('editGlobalPrinterBrand').value.trim();
          const price = parseFloat(document.getElementById('editGlobalPrinterPrice').value);
          const lifespan = parseFloat(document.getElementById('editGlobalPrinterLifespan').value);
          
          if (!newName || !brand || !price || !lifespan) {
            showNotification('Please fill in all fields.', 'warning', 'Missing Information');
            return;
          }
          
          const updatedPrinter = {
            name: newName,
            brand: brand,
            price: price,
            lifespan: lifespan,
            costPerHour: price / lifespan
          };
          
          // Find and update in Firebase
          printersRef.orderByChild('name').equalTo(originalName).once('value', snapshot => {
            snapshot.forEach(child => {
              child.ref.update(updatedPrinter)
                .then(async () => {
                  showNotification(`Printer "${newName}" has been updated successfully.`, 'success', 'Success');
                  editGlobalPrinterModal.style.display = 'none';
                  renderPrintersList();
                })
                .catch(async (error) => {
                  showNotification(`Error updating printer: ${error.message}`, 'error', 'Error');
                });
            });
          });
        });
      }
      
      // Update depreciation on input change
      const priceInput = document.getElementById('editGlobalPrinterPrice');
      const lifespanInput = document.getElementById('editGlobalPrinterLifespan');
      if (priceInput) priceInput.addEventListener('input', updateGlobalPrinterDepreciation);
      if (lifespanInput) lifespanInput.addEventListener('input', updateGlobalPrinterDepreciation);
      
      // Global Filament Modal
      const editGlobalFilamentModal = document.getElementById('editGlobalFilamentModal');
      const closeEditGlobalFilamentX = document.getElementById('closeEditGlobalFilamentX');
      const closeEditGlobalFilament = document.getElementById('closeEditGlobalFilament');
      const saveEditGlobalFilament = document.getElementById('saveEditGlobalFilament');
      
      if (closeEditGlobalFilamentX) {
        closeEditGlobalFilamentX.addEventListener('click', () => {
          editGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (closeEditGlobalFilament) {
        closeEditGlobalFilament.addEventListener('click', () => {
          editGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (saveEditGlobalFilament) {
        saveEditGlobalFilament.addEventListener('click', async () => {
          const originalType = document.getElementById('editGlobalFilamentOriginalType').value;
          const newType = document.getElementById('editGlobalFilamentType').value.trim();
          const brand = document.getElementById('editGlobalFilamentBrand').value.trim();
          const weight = parseFloat(document.getElementById('editGlobalFilamentWeight').value);
          const cost = parseFloat(document.getElementById('editGlobalFilamentCost').value);
          
          if (!newType || !brand || !weight || !cost) {
            showNotification('Please fill in all fields.', 'warning', 'Missing Information');
            return;
          }
          
          const updatedFilament = {
            type: newType,
            brand: brand,
            spoolWeight: weight,
            spoolCost: cost,
            costPerG: cost / weight
          };
          
          // Find and update in Firebase
          filamentsRef.orderByChild('type').equalTo(originalType).once('value', snapshot => {
            snapshot.forEach(child => {
              child.ref.update(updatedFilament)
                .then(async () => {
                  showNotification(`Filament "${newType}" has been updated successfully.`, 'success', 'Success');
                  editGlobalFilamentModal.style.display = 'none';
                  renderFilamentsList();
                })
                .catch(async (error) => {
                  showNotification(`Error updating filament: ${error.message}`, 'error', 'Error');
                });
            });
          });
        });
      }
      
      // Update cost per gram on input change
      const costInput = document.getElementById('editGlobalFilamentCost');
      const weightInput = document.getElementById('editGlobalFilamentWeight');
      if (costInput) costInput.addEventListener('input', updateGlobalFilamentCostPerG);
      if (weightInput) weightInput.addEventListener('input', updateGlobalFilamentCostPerG);
      
      // Add Global Printer Modal
      const addGlobalPrinterModal = document.getElementById('addGlobalPrinterModal');
      const btnAddGlobalPrinter = document.getElementById('btnAddGlobalPrinter');
      const closeAddGlobalPrinterX = document.getElementById('closeAddGlobalPrinterX');
      const closeAddGlobalPrinter = document.getElementById('closeAddGlobalPrinter');
      const saveAddGlobalPrinter = document.getElementById('saveAddGlobalPrinter');
      
      if (btnAddGlobalPrinter) {
        btnAddGlobalPrinter.addEventListener('click', async () => {
          if (currentUserTier !== 'admin') {
            showNotification('You need admin access to add global printers.', 'warning', 'Access Denied');
            return;
          }
          // Clear form
          document.getElementById('addGlobalPrinterName').value = '';
          document.getElementById('addGlobalPrinterBrand').value = '';
          document.getElementById('addGlobalPrinterPrice').value = '';
          document.getElementById('addGlobalPrinterLifespan').value = '5000';
          document.getElementById('addGlobalPrinterDepreciation').textContent = '-';
          document.getElementById('globalPrinterQuickAdd').value = '';
          document.getElementById('addGlobalPrinterErr').style.display = 'none';
          addGlobalPrinterModal.style.display = 'grid';
        });
      }
      
      if (closeAddGlobalPrinterX) {
        closeAddGlobalPrinterX.addEventListener('click', () => {
          addGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (closeAddGlobalPrinter) {
        closeAddGlobalPrinter.addEventListener('click', () => {
          addGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (saveAddGlobalPrinter) {
        saveAddGlobalPrinter.addEventListener('click', async () => {
          const name = document.getElementById('addGlobalPrinterName').value.trim();
          const brand = document.getElementById('addGlobalPrinterBrand').value.trim();
          const priceInput = parseFloat(document.getElementById('addGlobalPrinterPrice').value);
          const lifespan = parseFloat(document.getElementById('addGlobalPrinterLifespan').value);
          
          if (!name || !brand || !priceInput || !lifespan) {
            showNotification('Please fill in all fields.', 'warning', 'Missing Information');
            return;
          }
          
          // Convert price from current currency to USD for storage
          const currentCurrency = window.currentCurrency || 'USD';
          const priceUSD = convertToUSD(priceInput, currentCurrency);
          
          const newPrinter = {
            name: name,
            brand: brand,
            price: priceUSD,
            lifespan: lifespan,
            costPerHour: priceUSD / lifespan
          };
          
          printersRef.push(newPrinter)
            .then(async () => {
              showNotification(`Global printer "${name}" has been added successfully.`, 'success', 'Success');
              addGlobalPrinterModal.style.display = 'none';
              renderPrintersList();
            })
            .catch(async (error) => {
              showNotification(`Error adding printer: ${error.message}`, 'error', 'Error');
            });
        });
      }
      
      // Update depreciation on input change for add modal
      const addPriceInput = document.getElementById('addGlobalPrinterPrice');
      const addLifespanInput = document.getElementById('addGlobalPrinterLifespan');
      if (addPriceInput) addPriceInput.addEventListener('input', updateAddGlobalPrinterDepreciation);
      if (addLifespanInput) addLifespanInput.addEventListener('input', updateAddGlobalPrinterDepreciation);
      
      // Bulk add global printers functionality
      const btnParseGlobalPrinterQuickAdd = document.getElementById('btnParseGlobalPrinterQuickAdd');
      if (btnParseGlobalPrinterQuickAdd) {
        btnParseGlobalPrinterQuickAdd.addEventListener('click', async () => {
          if (currentUserTier !== 'admin') {
            showNotification('You need admin access to add global printers.', 'warning', 'Access Denied');
            return;
          }
          
          const quickAddText = document.getElementById('globalPrinterQuickAdd').value.trim();
          const errDiv = document.getElementById('addGlobalPrinterErr');
          
          if (!quickAddText) {
            errDiv.textContent = 'Please enter printer data to batch add.';
            errDiv.style.display = 'block';
            return;
          }
          
          try {
            // Split by semicolon and parse each entry
            const entries = quickAddText.split(';').map(s => s.trim()).filter(s => s);
            const printers = [];
            const currentCurrency = window.currentCurrency || 'USD';
            
            for (const entry of entries) {
              const parsed = JSON.parse(entry);
              if (!Array.isArray(parsed) || parsed.length !== 4) {
                throw new Error('Each entry must be: ["Name", "Brand", Price, Lifespan]');
              }
              const [name, brand, priceInput, lifespan] = parsed;
              if (!name || !brand || typeof priceInput !== 'number' || typeof lifespan !== 'number') {
                throw new Error('Invalid data format');
              }
              // Convert price from current currency to USD
              const priceUSD = convertToUSD(priceInput, currentCurrency);
              printers.push({ 
                name, 
                brand, 
                price: priceUSD, 
                lifespan,
                costPerHour: priceUSD / lifespan
              });
            }
            
            if (printers.length === 0) {
              throw new Error('No valid printers found');
            }
            
            // Add all printers to Firebase
            const promises = printers.map(printer => printersRef.push(printer));
            await Promise.all(promises);
            
            showNotification(`Successfully added ${printers.length} global printer(s)!`, 'success', 'Success');
            addGlobalPrinterModal.style.display = 'none';
            document.getElementById('globalPrinterQuickAdd').value = '';
            renderPrintersList();
            
          } catch (error) {
            errDiv.textContent = 'Error: ' + error.message;
            errDiv.style.display = 'block';
          }
        });
      }
      
      // Add Global Filament Modal
      const addGlobalFilamentModal = document.getElementById('addGlobalFilamentModal');
      const btnAddGlobalFilament = document.getElementById('btnAddGlobalFilament');
      const closeAddGlobalFilamentX = document.getElementById('closeAddGlobalFilamentX');
      const closeAddGlobalFilament = document.getElementById('closeAddGlobalFilament');
      const saveAddGlobalFilament = document.getElementById('saveAddGlobalFilament');
      
      if (btnAddGlobalFilament) {
        btnAddGlobalFilament.addEventListener('click', async () => {
          if (currentUserTier !== 'admin') {
            showNotification('You need admin access to add global filaments.', 'warning', 'Access Denied');
            return;
          }
          // Clear form
          document.getElementById('addGlobalFilamentType').value = '';
          document.getElementById('addGlobalFilamentBrand').value = '';
          document.getElementById('addGlobalFilamentWeight').value = '1000';
          document.getElementById('addGlobalFilamentCost').value = '';
          document.getElementById('addGlobalFilamentCostPerG').textContent = '-';
          document.getElementById('globalFilamentQuickAdd').value = '';
          document.getElementById('addGlobalFilamentErr').style.display = 'none';
          addGlobalFilamentModal.style.display = 'grid';
        });
      }
      
      if (closeAddGlobalFilamentX) {
        closeAddGlobalFilamentX.addEventListener('click', () => {
          addGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (closeAddGlobalFilament) {
        closeAddGlobalFilament.addEventListener('click', () => {
          addGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (saveAddGlobalFilament) {
        saveAddGlobalFilament.addEventListener('click', async () => {
          const type = document.getElementById('addGlobalFilamentType').value.trim();
          const brand = document.getElementById('addGlobalFilamentBrand').value.trim();
          const weight = parseFloat(document.getElementById('addGlobalFilamentWeight').value);
          const costInput = parseFloat(document.getElementById('addGlobalFilamentCost').value);
          
          if (!type || !brand || !weight || !costInput) {
            showNotification('Please fill in all fields.', 'warning', 'Missing Information');
            return;
          }
          
          // Convert cost from current currency to USD for storage
          const currentCurrency = window.currentCurrency || 'USD';
          const costUSD = convertToUSD(costInput, currentCurrency);
          
          const newFilament = {
            type: type,
            brand: brand,
            spoolWeight: weight,
            spoolCost: costUSD,
            costPerG: costUSD / weight
          };
          
          filamentsRef.push(newFilament)
            .then(async () => {
              showNotification(`Global filament "${type}" has been added successfully.`, 'success', 'Success');
              addGlobalFilamentModal.style.display = 'none';
              renderFilamentsList();
            })
            .catch(async (error) => {
              showNotification(`Error adding filament: ${error.message}`, 'error', 'Error');
            });
        });
      }
      
      // Update cost per gram on input change for add modal
      const addCostInput = document.getElementById('addGlobalFilamentCost');
      const addWeightInput = document.getElementById('addGlobalFilamentWeight');
      if (addCostInput) addCostInput.addEventListener('input', updateAddGlobalFilamentCostPerG);
      if (addWeightInput) addWeightInput.addEventListener('input', updateAddGlobalFilamentCostPerG);
      
      // Bulk add global filaments functionality
      const btnParseGlobalFilamentQuickAdd = document.getElementById('btnParseGlobalFilamentQuickAdd');
      if (btnParseGlobalFilamentQuickAdd) {
        btnParseGlobalFilamentQuickAdd.addEventListener('click', async () => {
          if (currentUserTier !== 'admin') {
            showNotification('You need admin access to add global filaments.', 'warning', 'Access Denied');
            return;
          }
          
          const quickAddText = document.getElementById('globalFilamentQuickAdd').value.trim();
          const errDiv = document.getElementById('addGlobalFilamentErr');
          
          if (!quickAddText) {
            errDiv.textContent = 'Please enter filament data to batch add.';
            errDiv.style.display = 'block';
            return;
          }
          
          try {
            // Split by semicolon and parse each entry
            const entries = quickAddText.split(';').map(s => s.trim()).filter(s => s);
            const filaments = [];
            const currentCurrency = window.currentCurrency || 'USD';
            
            for (const entry of entries) {
              const parsed = JSON.parse(entry);
              if (!Array.isArray(parsed) || parsed.length !== 4) {
                throw new Error('Each entry must be: ["Type", "Brand", Weight, Cost]');
              }
              const [type, brand, spoolWeight, spoolCostInput] = parsed;
              if (!type || !brand || typeof spoolWeight !== 'number' || typeof spoolCostInput !== 'number') {
                throw new Error('Invalid data format');
              }
              // Convert cost from current currency to USD
              const spoolCostUSD = convertToUSD(spoolCostInput, currentCurrency);
              filaments.push({ 
                type, 
                brand, 
                spoolWeight, 
                spoolCost: spoolCostUSD,
                costPerG: spoolCostUSD / spoolWeight
              });
            }
            
            if (filaments.length === 0) {
              throw new Error('No valid filaments found');
            }
            
            // Add all filaments to Firebase
            const promises = filaments.map(filament => filamentsRef.push(filament));
            await Promise.all(promises);
            
            showNotification(`Successfully added ${filaments.length} global filament(s)!`, 'success', 'Success');
            addGlobalFilamentModal.style.display = 'none';
            document.getElementById('globalFilamentQuickAdd').value = '';
            renderFilamentsList();
            
          } catch (error) {
            errDiv.textContent = 'Error: ' + error.message;
            errDiv.style.display = 'block';
          }
        });
      }
    });

    // Check if user can perform calculation (tier limit)
    async function checkCalculationLimit() {
      const user = firebase.auth().currentUser;
      if (!user) {
        // Not logged in - allow limited calculations
        return { allowed: true, tier: 'free', used: 0, limit: TIER_CALCULATION_LIMITS.free };
      }

      try {
        // Get user's tier
        const tierSnapshot = await firebase.database().ref(`users/${user.uid}/membership/tier`).once('value');
        const tier = tierSnapshot.val() || 'free';
        currentUserTier = tier;

        // Get user's role (admin override)
        const roleSnapshot = await firebase.database().ref(`users/${user.uid}/role`).once('value');
        const role = roleSnapshot.val();
        
        if (role === 'admin') {
          currentUserTier = 'admin';
        }
        
        // Update admin button visibility
        updateAdminButtonsVisibility();

        // Get current month's calculation count
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const calcSnapshot = await firebase.database().ref(`users/${user.uid}/calculationHistory/${monthKey}`).once('value');
        const calculations = calcSnapshot.val() || {};
        calculationsThisMonth = Object.keys(calculations).length;

        const limit = TIER_CALCULATION_LIMITS[currentUserTier] || TIER_CALCULATION_LIMITS.free;
        const allowed = calculationsThisMonth < limit;

        return { allowed, tier: currentUserTier, used: calculationsThisMonth, limit };
      } catch (error) {
        console.error('Error checking calculation limit:', error);
        return { allowed: true, tier: 'free', used: 0, limit: TIER_CALCULATION_LIMITS.free };
      }
    }

    // Update calculation limit display
    function updateCalculationLimitDisplay() {
      const infoDiv = document.getElementById('calculationLimitInfo');
      if (!infoDiv) return;

      const limit = TIER_CALCULATION_LIMITS[currentUserTier] || TIER_CALCULATION_LIMITS.free;
      
      if (currentUserTier === 'admin') {
        infoDiv.innerHTML = `<span style="color: #8b5cf6;">✨ Unlimited calculations (Admin)</span>`;
      } else {
        const remaining = limit - calculationsThisMonth;
        const percentage = (calculationsThisMonth / limit) * 100;
        
        let color = '#10b981'; // green
        if (percentage >= 90) color = '#ef4444'; // red
        else if (percentage >= 70) color = '#f59e0b'; // orange
        
        infoDiv.innerHTML = `
          <span style="color: ${color};">
            ${calculationsThisMonth} / ${limit} calculations used this month
            ${remaining > 0 ? `(${remaining} remaining)` : '(Limit reached)'}
          </span>
        `;
      }
    }

    // Save calculation to history
    async function saveCalculationToHistory(calculationData) {
      const user = firebase.auth().currentUser;
      if (!user) return;

      try {
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const timestamp = now.getTime();
        
        await firebase.database().ref(`users/${user.uid}/calculationHistory/${monthKey}/${timestamp}`).set({
          ...calculationData,
          timestamp: timestamp,
          date: now.toISOString()
        });

        console.log('Calculation saved to history');
      } catch (error) {
        console.error('Error saving calculation:', error);
      }
    }

    // Calculate cost (now only called when Calculate button is pressed)
    async function calculateCost() {
      const printerValue = document.getElementById('printerSelect')?.value;
      const filamentValue = document.getElementById('filamentSelect')?.value;
      
      if (!printerValue || !filamentValue) {
        alert('Please select both a printer and filament before calculating.');
        return;
      }

      // Check calculation limit
      const limitCheck = await checkCalculationLimit();
      
      if (!limitCheck.allowed) {
        alert(`You've reached your calculation limit for this month (${limitCheck.limit} calculations for ${limitCheck.tier} tier).\n\nUpgrade your membership to get more calculations!`);
        return;
      }

      // Get printer data
      let printer = null;
      if (printerValue.startsWith('user:')) {
        const id = printerValue.substring(5);
        printer = userPrintersData[id];
        if (printer) {
          // Calculate cost per hour for user printer
          printer = {
            ...printer,
            costPerHour: printer.price / printer.lifespan
          };
        }
      } else if (printerValue.startsWith('global:')) {
        const name = printerValue.substring(7);
        printer = printersData[name];
      }
      
      // Get filament data
      let filament = null;
      if (filamentValue.startsWith('user:')) {
        const id = filamentValue.substring(5);
        filament = userFilamentsData[id];
        if (filament) {
          // Calculate cost per gram for user filament
          filament = {
            ...filament,
            costPerG: filament.spoolCost / filament.spoolWeight
          };
        }
      } else if (filamentValue.startsWith('global:')) {
        const type = filamentValue.substring(7);
        filament = filamentsData[type];
      }
      
      if (!printer || !filament) {
        alert('Error loading printer or filament data. Please try again.');
        return;
      }

      // Get all values
      const pt = parseFloat(document.getElementById('printTime').value) || 0;
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const electricityPrice = parseFloat(document.getElementById('elec').value) || 0.12;
      const electricityUsagePerHour = 0.1; // kWh/h

      // Post-processing (minutes to hours)
      const jobRemoval = (parseFloat(document.getElementById('jobRemoval').value) || 0) / 60;
      const supportRemoval = (parseFloat(document.getElementById('supportRemoval').value) || 0) / 60;
      const additionalWork = (parseFloat(document.getElementById('additionalWork').value) || 0) / 60;
      const postProcessingTime = jobRemoval + supportRemoval + additionalWork;

      // Preparation (minutes to hours)
      const modelPrep = (parseFloat(document.getElementById('modelPrep').value) || 0) / 60;
      const slicing = (parseFloat(document.getElementById('slicing').value) || 0) / 60;
      const materialChange = (parseFloat(document.getElementById('materialChange').value) || 0) / 60;
      const transferStart = (parseFloat(document.getElementById('transferStart').value) || 0) / 60;
      const preparationTime = modelPrep + slicing + materialChange + transferStart;

      const totalHandTime = postProcessingTime + preparationTime;

      // Labor rates (convert from user's currency to USD for calculation)
      const postProcessingRateInput = parseFloat(document.getElementById('postProcessingRate').value) || 0;
      const preparationRateInput = parseFloat(document.getElementById('preparationRate').value) || 0;
      const postProcessingRate = convertToUSD(postProcessingRateInput, window.currentCurrency || 'USD');
      const preparationRate = convertToUSD(preparationRateInput, window.currentCurrency || 'USD');

      // Electricity price (convert from user's currency to USD)
      const electricityPriceUSD = convertToUSD(electricityPrice, window.currentCurrency || 'USD');

      // Markups
      const filamentMarkup = parseFloat(document.getElementById('filamentMarkup').value) || 1;
      const generalMarkup = (parseFloat(document.getElementById('generalMarkup').value) || 0) / 100;
      const failureRate = (parseFloat(document.getElementById('failureRate').value) || 0) / 100;
      const includePrinterDepreciation = document.getElementById('includePrinterDepreciation').checked;

      // Printer and filament costs are already in USD from Firebase
      const printerCostPerHourUSD = printer.costPerHour;
      const filamentCostPerGUSD = filament.costPerG;

      // Calculate costs (all in USD)
      const costPrinter = includePrinterDepreciation ? (printerCostPerHourUSD * pt) : 0;
      const costElectric = pt * electricityUsagePerHour * electricityPriceUSD;
      const costFilament = filamentCostPerGUSD * weight * filamentMarkup;
      const costPostProcessing = postProcessingTime * postProcessingRate;
      const costPreparation = preparationTime * preparationRate;
      const costLabor = costPostProcessing + costPreparation;
      
      // Subtotal WITHOUT labor
      const subtotalBeforeLabor = costPrinter + costFilament + costElectric;
      const subtotalWithMarkup = subtotalBeforeLabor * (1 + generalMarkup);
      const priceAfterFailureRate = subtotalWithMarkup / (1 - failureRate);
      
      // Add labor AFTER markup and failure rate
      const finalPrice = priceAfterFailureRate + costLabor;
      
      const subtotal = subtotalBeforeLabor;
      const markupApplied = subtotalWithMarkup - subtotalBeforeLabor;
      const failureAdjustment = priceAfterFailureRate - subtotalWithMarkup;

      // Update UI (money() function converts from USD to current currency)
      document.getElementById('printerCost').textContent = money(costPrinter);
      document.getElementById('filamentCost').textContent = money(costFilament);
      document.getElementById('filamentDetails').textContent = `${weight.toFixed(0)} g @ ${money(filamentCostPerGUSD)}/g × ${filamentMarkup.toFixed(2)}`;
      document.getElementById('electricityCost').textContent = money(costElectric);
      document.getElementById('electricityDetails').textContent = `${electricityUsagePerHour} kWh/h`;
      
      document.getElementById('laborCost').textContent = money(costLabor);
      // Display the rates in user's current currency (the input values they entered)
      const currencySymbol = getCurrencySymbol(window.currentCurrency || 'USD');
      const postProcText = postProcessingTime > 0 ? `Post-Proc: ${postProcessingTime.toFixed(2)}h @ ${currencySymbol}${postProcessingRateInput.toFixed(2)}/h` : '';
      const prepText = preparationTime > 0 ? `Prep: ${preparationTime.toFixed(2)}h @ ${currencySymbol}${preparationRateInput.toFixed(2)}/h` : '';
      const separator = postProcText && prepText ? ' | ' : '';
      document.getElementById('laborDetails').textContent = postProcText + separator + prepText || 'No labor time';
      
      document.getElementById('subtotal').textContent = money(subtotal);
      document.getElementById('markupAmount').textContent = money(markupApplied);
      document.getElementById('failureCostDisplay').textContent = money(failureAdjustment);
      document.getElementById('totalCost').textContent = money(finalPrice);
      
      const hasLabor = (postProcessingRate > 0 && postProcessingTime > 0) || (preparationRate > 0 && preparationTime > 0);
      document.getElementById('handTimeNote').textContent = hasLabor ? `Total labor: ${totalHandTime.toFixed(2)} hours` : `Hand time: ${totalHandTime.toFixed(2)} hours (set labor rates to bill)`;

      // Save calculation to history (costs are already in USD)
      const currentCurrency = window.currentCurrency || 'USD';
      
      const calculationData = {
        printer: printer.name,
        printerBrand: printer.brand,
        filament: filament.type,
        filamentBrand: filament.brand,
        printTime: pt,
        weight: weight,
        totalCost: finalPrice, // Already in USD
        calculatedInCurrency: currentCurrency, // Track what currency was displayed during calculation
        breakdown: {
          printerCost: costPrinter,
          filamentCost: costFilament,
          electricityCost: costElectric,
          laborCost: costLabor,
          subtotal: subtotal,
          markup: markupApplied,
          failureAdjustment: failureAdjustment
        },
        parameters: {
          electricityPrice: electricityPriceUSD,
          filamentMarkup,
          generalMarkup: generalMarkup * 100,
          failureRate: failureRate * 100,
          postProcessingRate: postProcessingRate,
          preparationRate: preparationRate,
          includePrinterDepreciation
        }
      };

      await saveCalculationToHistory(calculationData);
      
      // Update the count and display
      calculationsThisMonth++;
      updateCalculationLimitDisplay();

      // Show success feedback
      const btnCalculate = document.getElementById('btnCalculate');
      const originalText = btnCalculate.innerHTML;
      btnCalculate.innerHTML = '✅ Calculated!';
      btnCalculate.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      setTimeout(() => {
        btnCalculate.innerHTML = originalText;
        btnCalculate.style.background = '';
      }, 2000);
    }

    // Reset results display
    function resetResults() {
      document.getElementById('printerCost').textContent = money(0);
      document.getElementById('filamentCost').textContent = money(0);
      document.getElementById('electricityCost').textContent = money(0);
      document.getElementById('laborCost').textContent = money(0);
      document.getElementById('subtotal').textContent = money(0);
      document.getElementById('markupAmount').textContent = money(0);
      document.getElementById('failureCostDisplay').textContent = money(0);
      document.getElementById('totalCost').textContent = money(0);
      document.getElementById('filamentDetails').textContent = '';
      document.getElementById('electricityDetails').textContent = '';
      document.getElementById('laborDetails').textContent = '';
      document.getElementById('handTimeNote').textContent = 'Unbilled hand time: 0.00 hours';
    }

    // Sync print time fields
    const printTimeInput = document.getElementById('printTime');
    const printTimeDuplicate = document.getElementById('printTimeDuplicate');
    
    if (printTimeInput && printTimeDuplicate) {
      printTimeInput.addEventListener('input', () => {
        printTimeDuplicate.value = printTimeInput.value || 0;
      });
    }

    // Calculate button click handler
    const btnCalculate = document.getElementById('btnCalculate');
    if (btnCalculate) {
      btnCalculate.addEventListener('click', calculateCost);
    }

    // Printer select change - only update price info, don't calculate
    const printerSelect = document.getElementById('printerSelect');
    if (printerSelect) {
      printerSelect.addEventListener('change', updatePriceInfo);
    }

    // Filament select change - only update price info, don't calculate
    const filamentSelect = document.getElementById('filamentSelect');
    if (filamentSelect) {
      filamentSelect.addEventListener('change', updatePriceInfo);
    }

    // Reset calculator button
    const btnResetCalculator = document.getElementById('btnResetCalculator');
    if (btnResetCalculator) {
      btnResetCalculator.addEventListener('click', () => {
        if (confirm('Reset all fields to default values?')) {
          // Define defaults
          const defaults = {
            'printerSelect': '',
            'filamentSelect': '',
            'printTime': '0',
            'weight': '0',
            'printTimeDuplicate': '',
            'elec': '0.12',
            'jobRemoval': '0',
            'supportRemoval': '0',
            'additionalWork': '0',
            'postProcessingRate': '20',
            'modelPrep': '0',
            'slicing': '0',
            'materialChange': '0',
            'transferStart': '0',
            'preparationRate': '20',
            'filamentMarkup': '2.7',
            'generalMarkup': '50',
            'failureRate': '10'
          };
          
          // Reset all fields
          for (const [id, defaultValue] of Object.entries(defaults)) {
            const elem = document.getElementById(id);
            if (elem) {
              elem.value = defaultValue;
            }
          }
          
          updatePriceInfo();
          resetResults();
        }
      });
    }

    // Initialize calculator when page loads
    async function initializeCalculator() {
      console.log('Initializing calculator...');
      loadPrinters();
      loadFilaments();
      
      // Load user's calculation count and tier
      const user = firebase.auth().currentUser;
      if (user) {
        const limitCheck = await checkCalculationLimit();
        updateCalculationLimitDisplay();
      } else {
        // Show info for non-logged in users
        const infoDiv = document.getElementById('calculationLimitInfo');
        if (infoDiv) {
          infoDiv.innerHTML = `<span style="color: #6b7280;">Login to track your calculations and access tier benefits</span>`;
        }
      }
      
      // Restore the last active tab after currency change reload
      const savedTab = localStorage.getItem('activeCalculatorTab');
      if (savedTab) {
        localStorage.removeItem('activeCalculatorTab'); // Clear it after using
        // Valid tab names: 'calculator', 'printers', 'filaments', 'userPresets'
        if (['calculator', 'printers', 'filaments', 'userPresets'].includes(savedTab)) {
          switchCalcTab(savedTab);
        }
      }
    }

    // Update calculation limits when user logs in/out
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        const limitCheck = await checkCalculationLimit();
        updateCalculationLimitDisplay();
        loadUserPresets(); // Load presets when user logs in
        loadUserPrinters(); // Load user printers
        loadUserFilaments(); // Load user filaments
      } else {
        currentUserTier = 'free';
        calculationsThisMonth = 0;
        const infoDiv = document.getElementById('calculationLimitInfo');
        if (infoDiv) {
          infoDiv.innerHTML = `<span style="color: #6b7280;">Login to track your calculations and access tier benefits</span>`;
        }
        userPresets = []; // Clear presets when user logs out
        updatePresetsUI();
        userPrintersData = {}; // Clear user printers
        userFilamentsData = {}; // Clear user filaments
        renderUserPrintersList();
        renderUserFilamentsList();
      }
    });

    // Call initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCalculator);
    } else {
      initializeCalculator();
    }

    // ==================== ORDERS FUNCTIONALITY ====================
    
    // Currency helper functions (wrappers for currency.js)
    function getCurrencySymbol(currencyCode) {
      const currencySymbols = {
        'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥', 'CNY': '¥',
        'CAD': '$', 'AUD': '$', 'CHF': 'Fr', 'INR': '₹', 'MXN': '$',
        'BRL': 'R$', 'ZAR': 'R', 'KRW': '₩', 'SGD': '$', 'NZD': '$',
        'SEK': 'kr', 'NOK': 'kr', 'DKK': 'kr', 'PLN': 'zł', 'THB': '฿',
        'IDR': 'Rp', 'HUF': 'Ft', 'CZK': 'Kč', 'ILS': '₪', 'CLP': '$',
        'PHP': '₱', 'AED': 'د.إ', 'SAR': '﷼', 'MYR': 'RM', 'RON': 'lei'
      };
      return currencySymbols[currencyCode] || '$';
    }

    function getCurrencyLabel(currencyCode) {
      const currency = currencyCode || window.currentCurrency || 'USD';
      const symbol = getCurrencySymbol(currency);
      
      // Consistent format for all currencies: "CAD ($)" or "EUR (€)"
      return `${currency} (${symbol})`;
    }

    function convertToUSD(amount, sourceCurrency) {
      const exchangeRates = {
        'USD': 1.00, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 149.50, 'CNY': 7.24,
        'CAD': 1.36, 'AUD': 1.53, 'CHF': 0.88, 'INR': 83.12, 'MXN': 17.05,
        'BRL': 4.98, 'ZAR': 18.35, 'KRW': 1342.50, 'SGD': 1.34, 'NZD': 1.65,
        'SEK': 10.58, 'NOK': 10.72, 'DKK': 6.85, 'PLN': 3.96, 'THB': 35.48,
        'IDR': 15420.00, 'HUF': 355.20, 'CZK': 22.95, 'ILS': 3.75, 'CLP': 945.50,
        'PHP': 56.25, 'AED': 3.67, 'SAR': 3.75, 'MYR': 4.68, 'RON': 4.56
      };
      const rate = exchangeRates[sourceCurrency] || 1;
      return amount / rate;
    }

    function convertFromUSD(amountUSD, targetCurrency) {
      const exchangeRates = {
        'USD': 1.00, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 149.50, 'CNY': 7.24,
        'CAD': 1.36, 'AUD': 1.53, 'CHF': 0.88, 'INR': 83.12, 'MXN': 17.05,
        'BRL': 4.98, 'ZAR': 18.35, 'KRW': 1342.50, 'SGD': 1.34, 'NZD': 1.65,
        'SEK': 10.58, 'NOK': 10.72, 'DKK': 6.85, 'PLN': 3.96, 'THB': 35.48,
        'IDR': 15420.00, 'HUF': 355.20, 'CZK': 22.95, 'ILS': 3.75, 'CLP': 945.50,
        'PHP': 56.25, 'AED': 3.67, 'SAR': 3.75, 'MYR': 4.68, 'RON': 4.56
      };
      const rate = exchangeRates[targetCurrency] || 1;
      return amountUSD * rate;
    }

    function getCurrencySymbolLocal() {
      return getCurrencySymbol(window.currentCurrency || 'USD');
    }

    function formatCurrencyLocal(amount) {
      const currency = window.currentCurrency || 'USD';
      // Format based on currency
      if (currency === 'JPY' || currency === 'KRW' || currency === 'IDR') {
        return Math.round(amount).toLocaleString();
      }
      return amount.toFixed(2);
    }

    function loadSavedCurrency(user) {
      return new Promise((resolve) => {
        if (!user) {
          window.currentCurrency = 'USD';
          resolve();
          return;
        }
        
        firebase.database().ref(`users/${user.uid}/currency`).once('value', (snapshot) => {
          window.currentCurrency = snapshot.val() || 'USD';
          console.log('Loaded currency:', window.currentCurrency);
          resolve();
        });
      });
    }
    
    // Google Maps initialization for address autocomplete
    let autocomplete, editAutocomplete;
    window.initGoogleMaps = function() {
      console.log('Google Maps API loaded');
    };

    // Orders data storage
    let ordersData = [];
    let selectedColors = [];
    let currentViewingOrderId = null;
    
    // Color data - expose to window for access by orders.js
    window.globalColorsData = {};
    window.userColorsData = {};

    // Initialize orders when user is authenticated
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadSavedCurrency(user);
        loadOrders();
        loadClients();
        loadColors(user);
        
        // Load filaments for material dropdown (reuse existing filaments data from calculator)
        populateMaterialDropdowns();
      }
    });

    // Add event listeners for orders buttons
    const btnManageColors = document.getElementById('btnManageColors');
    if (btnManageColors) {
      btnManageColors.addEventListener('click', openColorManagementModal);
    }

    const btnNewOrder = document.getElementById('btnNewOrder');
    console.log('btnNewOrder element:', btnNewOrder);
    if (btnNewOrder) {
      btnNewOrder.addEventListener('click', () => {
        console.log('New Order button clicked!');
        if (!currentUser) {
          alert('Please login to create an order');
          return;
        }
        openNewOrderModal();
      });
      console.log('New Order button click handler attached');
    }

    // Add Client button event listener
    const btnAddClient = document.getElementById('btnAddClient');
    if (btnAddClient) {
      btnAddClient.addEventListener('click', () => {
        if (!currentUser) {
          alert('Please login to add a client');
          return;
        }
        openAddClientModal();
      });
    }

    // Add event listener for Add User Color button
    const btnAddUserColor = document.getElementById('btnAddUserColor');
    if (btnAddUserColor) {
      btnAddUserColor.addEventListener('click', addUserColor);
    }

    // Add event listener for Add Global Color button
    const btnAddGlobalColor = document.getElementById('btnAddGlobalColor');
    if (btnAddGlobalColor) {
      btnAddGlobalColor.addEventListener('click', addGlobalColor);
    }

    // Search and filter functionality
    const searchInput = document.getElementById('ordersSearchInput');
    const statusFilter = document.getElementById('ordersStatusFilter');
    
    if (searchInput) {
      searchInput.addEventListener('input', () => renderOrdersTable());
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', () => renderOrdersTable());
    }

    // Color Management Modal Functions
    function openColorManagementModal() {
      const modal = document.getElementById('colorManagementModal');
      if (modal) {
        modal.style.display = 'grid';
        
        // Show/hide admin buttons based on user tier
        const isAdmin = currentUserTier === 'admin';
        const btnAddGlobal = document.getElementById('btnAddGlobalColor');
        const btnMassDeleteGlobal = document.getElementById('btnMassDeleteGlobalColors');
        
        if (btnAddGlobal) {
          btnAddGlobal.style.display = isAdmin ? 'inline-flex' : 'none';
        }
        if (btnMassDeleteGlobal) {
          btnMassDeleteGlobal.style.display = isAdmin ? 'inline-flex' : 'none';
        }
        
        // Re-render colors when modal opens to ensure they're visible
        renderGlobalColors();
        renderUserColors();
      }
    }

    function closeColorManagementModal() {
      const modal = document.getElementById('colorManagementModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Tab switching for color management
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('preset-tab')) {
        const tabName = e.target.getAttribute('data-tab');
        
        // Update tabs
        document.querySelectorAll('.preset-tab').forEach(tab => tab.classList.remove('active'));
        e.target.classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
        const targetContent = document.getElementById(tabName);
        if (targetContent) {
          targetContent.style.display = 'block';
        }
      }
    });

    // Load colors from Firebase
    function loadColors(user) {
      console.log('Loading colors for user:', user ? user.uid : 'no user');
      
      // Load global colors (using 'colors' path like orders.html)
      const globalColorsRef = firebase.database().ref('colors');
      globalColorsRef.on('value', snapshot => {
        window.globalColorsData = {};
        const data = snapshot.val();
        
        if (data) {
          Object.entries(data).forEach(([key, value]) => {
            window.globalColorsData[key] = {
              id: key,
              name: value.name,
              hex: value.hex,
              brand: value.brand || ''
            };
          });
        }
        
        console.log('Global colors loaded:', Object.keys(window.globalColorsData).length, 'colors');
        renderGlobalColors();
      });
      
      // Load user colors if authenticated (using 'userColors' path like orders.html)
      if (user) {
        const userColorsRef = firebase.database().ref(`userColors/${user.uid}`);
        userColorsRef.on('value', snapshot => {
          window.userColorsData = {};
          
          if (snapshot.exists()) {
            snapshot.forEach(child => {
              const color = child.val();
              window.userColorsData[child.key] = {
                id: child.key,
                name: color.name,
                hex: color.hex,
                brand: color.brand || ''
              };
            });
          }
          
          console.log('User colors loaded:', Object.keys(window.userColorsData).length, 'colors');
          renderUserColors();
        });
      }
    }

    // Helper function to convert hex to HSL for rainbow sorting
    function hexToHSL(hex) {
      // Convert hex to RGB
      const r = parseInt(hex.slice(1, 3), 16) / 255;
      const g = parseInt(hex.slice(3, 5), 16) / 255;
      const b = parseInt(hex.slice(5, 7), 16) / 255;

      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0; // achromatic
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }

      return { h: h * 360, s: s * 100, l: l * 100 };
    }

    // Track selected colors
    let selectedGlobalColors = [];
    let selectedUserColors = [];
    let globalSelectionMode = false;
    let userSelectionMode = false;

    function renderGlobalColors() {
      const grid = document.getElementById('globalColorsGrid');
      if (!grid) {
        console.warn('Global colors grid element not found');
        return;
      }
      
      const colors = Object.entries(globalColorsData);
      console.log('Rendering global colors:', colors.length);
      const isAdmin = currentUserTier === 'admin';
      
      if (colors.length === 0) {
        grid.innerHTML = '<div class="empty-colors-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #9ca3af;"><h4 style="margin-bottom: 8px; color: #ffffff;">No global colors available</h4><p>Contact admin to add global colors</p></div>';
        return;
      }
      
      // Group colors by brand
      const colorsByBrand = {};
      colors.forEach(([id, color]) => {
        const brand = color.brand || 'No Brand';
        if (!colorsByBrand[brand]) {
          colorsByBrand[brand] = [];
        }
        colorsByBrand[brand].push([id, color]);
      });
      
      // Sort brands alphabetically
      const sortedBrands = Object.keys(colorsByBrand).sort();
      
      // Build HTML with brand categories
      let html = '';
      sortedBrands.forEach(brand => {
        // Sort colors within brand by rainbow (hue)
        const brandColors = colorsByBrand[brand].sort((a, b) => {
          const hslA = hexToHSL(a[1].hex);
          const hslB = hexToHSL(b[1].hex);
          return hslA.h - hslB.h;
        });
        
        // Add brand header
        html += `
          <div class="brand-category-header" style="grid-column: 1 / -1; padding: 16px 0 12px 0; margin-top: 24px; border-bottom: 2px solid rgba(99, 102, 241, 0.3);">
            <h3 style="color: #ffffff; font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px;">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="color: #a78bfa;">
                <rect x="3" y="3" width="14" height="14" rx="2"/>
                <path d="M7 3v14M13 3v14M3 7h14M3 13h14"/>
              </svg>
              ${brand}
              <span style="font-size: 14px; color: #9ca3af; font-weight: 400; margin-left: 8px;">(${brandColors.length} colors)</span>
            </h3>
          </div>
        `;
        
        // Add color cards for this brand
        brandColors.forEach(([id, color]) => {
          const isSelected = selectedGlobalColors.includes(id);
          const selectedClass = isSelected ? ' selected' : '';
          
          // Show checkbox in selection mode, or edit/delete buttons normally
          let actionArea = '';
          let cardClick = '';
          
          if (globalSelectionMode && isAdmin) {
            cardClick = `onclick="toggleGlobalColorSelection('${id}')" style="cursor: pointer;"`;
            actionArea = `
              <div style="position: absolute; top: 8px; right: 8px; pointer-events: none;">
                <input type="checkbox" 
                       class="color-checkbox" 
                       ${isSelected ? 'checked' : ''} 
                       style="width: 20px; height: 20px; cursor: pointer;">
              </div>
            `;
          } else if (isAdmin) {
            actionArea = `
              <div class="color-actions">
                <button class="btn-action" onclick="editGlobalColor('${id}')">Edit</button>
                <button class="btn-action" onclick="deleteGlobalColor('${id}')">Delete</button>
              </div>
            `;
          }
          
          html += `
            <div class="color-card${selectedClass}" ${cardClick} style="position: relative;">
              <div class="color-preview" style="background-color: ${color.hex};"></div>
              <div class="color-info">
                <div class="color-name">${color.name}</div>
                <div class="color-hex">${color.hex}</div>
              </div>
              ${actionArea}
            </div>
          `;
        });
      });
      
      grid.innerHTML = html;
    }

    function renderUserColors() {
      const grid = document.getElementById('userColorsGrid');
      if (!grid) {
        console.warn('User colors grid element not found');
        return;
      }
      
      const colors = Object.entries(userColorsData);
      console.log('Rendering user colors:', colors.length);
      
      if (colors.length === 0) {
        grid.innerHTML = '<div class="empty-colors-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #9ca3af;"><h4 style="margin-bottom: 8px; color: #ffffff;">No personal colors yet</h4><p>Add your first color to get started</p></div>';
        return;
      }
      
      // Group colors by brand
      const colorsByBrand = {};
      colors.forEach(([id, color]) => {
        const brand = color.brand || 'No Brand';
        if (!colorsByBrand[brand]) {
          colorsByBrand[brand] = [];
        }
        colorsByBrand[brand].push([id, color]);
      });
      
      // Sort brands alphabetically
      const sortedBrands = Object.keys(colorsByBrand).sort();
      
      // Build HTML with brand categories
      let html = '';
      sortedBrands.forEach(brand => {
        // Sort colors within brand by rainbow (hue)
        const brandColors = colorsByBrand[brand].sort((a, b) => {
          const hslA = hexToHSL(a[1].hex);
          const hslB = hexToHSL(b[1].hex);
          return hslA.h - hslB.h;
        });
        
        // Add brand header
        html += `
          <div class="brand-category-header" style="grid-column: 1 / -1; padding: 16px 0 12px 0; margin-top: 24px; border-bottom: 2px solid rgba(99, 102, 241, 0.3);">
            <h3 style="color: #ffffff; font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px;">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="color: #a78bfa;">
                <rect x="3" y="3" width="14" height="14" rx="2"/>
                <path d="M7 3v14M13 3v14M3 7h14M3 13h14"/>
              </svg>
              ${brand}
              <span style="font-size: 14px; color: #9ca3af; font-weight: 400; margin-left: 8px;">(${brandColors.length} colors)</span>
            </h3>
          </div>
        `;
        
        // Add color cards for this brand
        brandColors.forEach(([id, color]) => {
          const isSelected = selectedUserColors.includes(id);
          const selectedClass = isSelected ? ' selected' : '';
          
          // Show checkbox in selection mode, or edit/delete buttons normally
          let actionArea = '';
          let cardClick = '';
          
          if (userSelectionMode) {
            cardClick = `onclick="toggleUserColorSelection('${id}')" style="cursor: pointer;"`;
            actionArea = `
              <div style="position: absolute; top: 8px; right: 8px; pointer-events: none;">
                <input type="checkbox" 
                       class="color-checkbox" 
                       ${isSelected ? 'checked' : ''} 
                       style="width: 20px; height: 20px; cursor: pointer;">
              </div>
            `;
          } else {
            actionArea = `
              <div class="color-actions">
                <button class="btn-action" onclick="editUserColor('${id}')">Edit</button>
                <button class="btn-action" onclick="deleteUserColor('${id}')">Delete</button>
              </div>
            `;
          }
          
          html += `
            <div class="color-card${selectedClass}" ${cardClick} style="position: relative;">
              <div class="color-preview" style="background-color: ${color.hex};"></div>
              <div class="color-info">
                <div class="color-name">${color.name}</div>
                <div class="color-hex">${color.hex}</div>
              </div>
              ${actionArea}
            </div>
          `;
        });
      });
      
      grid.innerHTML = html;
    }

    // Add user color - open modal
    function addUserColor() {
      if (!currentUser) {
        alert('Please login to add colors');
        return;
      }
      
      // Set mode to user
      document.getElementById('addColorMode').value = 'user';
      document.getElementById('editColorId').value = '';
      
      // Update modal title
      document.getElementById('addColorModalTitle').textContent = 'Add Your Color';
      document.getElementById('addColorModalSubtitle').textContent = 'Add a color to your personal library.';
      
      // Clear form fields
      document.getElementById('singleColorName').value = '';
      document.getElementById('singleColorBrand').value = '';
      document.getElementById('singleColorHex').value = '';
      document.getElementById('bulkColorInput').value = '';
      
      // Open modal
      const modal = document.getElementById('addColorModal');
      if (modal) modal.style.display = 'grid';
    }

    // Close add color modal
    function closeAddColorModal() {
      const modal = document.getElementById('addColorModal');
      if (modal) modal.style.display = 'none';
    }

    // Save single color
    async function saveSingleColor() {
      const mode = document.getElementById('addColorMode').value;
      const editId = document.getElementById('editColorId').value;
      const name = document.getElementById('singleColorName').value.trim();
      const brand = document.getElementById('singleColorBrand').value.trim();
      const hex = document.getElementById('singleColorHex').value.trim();
      
      // Validation
      if (!name) {
        alert('Please enter a color name');
        return;
      }
      
      if (!hex || !hex.match(/^#[0-9A-F]{6}$/i)) {
        alert('Please enter a valid hex code (e.g., #FF5733)');
        return;
      }

      const colorData = {
        name: name,
        brand: brand || '',
        hex: hex.toUpperCase(),
        createdAt: Date.now()
      };

      try {
        if (mode === 'global') {
          // Admin check for global colors
          if (currentUserTier !== 'admin') {
            showNotification('You need admin access to add global colors.', 'warning', 'Access Denied');
            return;
          }

          if (editId) {
            // Edit existing global color
            delete colorData.createdAt; // Don't update timestamp on edit
            await firebase.database().ref(`colors/${editId}`).update(colorData);
            showNotification(`Color "${name}" has been updated successfully.`, 'success', 'Success');
          } else {
            // Add new global color
            await firebase.database().ref('colors').push(colorData);
            showNotification(`Color "${name}" has been added to global library.`, 'success', 'Success');
          }
        } else {
          // User colors
          if (!currentUser) {
            alert('Please login to add colors');
            return;
          }

          if (editId) {
            // Edit existing user color
            delete colorData.createdAt; // Don't update timestamp on edit
            await firebase.database().ref(`userColors/${currentUser.uid}/${editId}`).update(colorData);
            showNotification(`Color "${name}" has been updated successfully.`, 'success', 'Success');
          } else {
            // Add new user color
            await firebase.database().ref(`userColors/${currentUser.uid}`).push(colorData);
            showNotification(`Color "${name}" has been added to your library.`, 'success', 'Success');
          }
        }

        // Clear form
        document.getElementById('singleColorName').value = '';
        document.getElementById('singleColorBrand').value = '';
        document.getElementById('singleColorHex').value = '';
        document.getElementById('editColorId').value = '';
      } catch (error) {
        console.error('Error saving color:', error);
        alert('Error saving color: ' + error.message);
      }
    }

    // Save bulk colors
    async function saveBulkColors() {
      const mode = document.getElementById('addColorMode').value;
      const bulkInput = document.getElementById('bulkColorInput').value.trim();
      
      if (!bulkInput) {
        alert('Please enter colors to import');
        return;
      }

      // Admin check for global colors
      if (mode === 'global') {
        if (currentUserTier !== 'admin') {
          showNotification('You need admin access to add global colors.', 'warning', 'Access Denied');
          return;
        }
      } else {
        if (!currentUser) {
          alert('Please login to add colors');
          return;
        }
      }
      
      const lines = bulkInput.split('\n').filter(line => line.trim());
      let successCount = 0;
      let errorCount = 0;
      const errors = [];
      
      if (lines.length === 0) {
        alert('No valid colors to import');
        return;
      }
      
      // Determine the database path
      const dbPath = mode === 'global' 
        ? 'colors' 
        : `userColors/${currentUser.uid}`;
      
      // Process each line sequentially
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        try {
          // Remove trailing semicolon if present
          const cleanLine = line.trim().replace(/;$/, '');
          
          // Parse the array format: ["Name", "Brand", "Hex"]
          const match = cleanLine.match(/\["([^"]+)",\s*"([^"]*)",\s*"([^"]+)"\]/);
          
          if (match) {
            const name = match[1].trim();
            const brand = match[2].trim();
            const hex = match[3].trim();
            
            if (name && hex && hex.match(/^#[0-9A-F]{6}$/i)) {
              try {
                const colorRef = firebase.database().ref(dbPath).push();
                await colorRef.set({
                  name: name,
                  brand: brand,
                  hex: hex.toUpperCase(),
                  createdAt: Date.now()
                });
                successCount++;
              } catch (error) {
                errorCount++;
                errors.push(`Line ${i + 1}: ${error.message}`);
              }
            } else {
              errorCount++;
              errors.push(`Line ${i + 1}: Invalid name or hex code`);
            }
          } else {
            errorCount++;
            errors.push(`Line ${i + 1}: Invalid format`);
          }
        } catch (e) {
          errorCount++;
          errors.push(`Line ${i + 1}: ${e.message}`);
        }
      }
      
      // Show results
      const location = mode === 'global' ? 'global library' : 'your library';
      await showNotification(
        `Import complete!\n✅ Success: ${successCount}\n❌ Errors: ${errorCount}`,
        `Added to ${location}`,
        '📦'
      );
      
      if (successCount > 0) {
        document.getElementById('bulkColorInput').value = '';
      }
    }

    // Edit user color
    function editUserColor(colorId) {
      const color = userColorsData[colorId];
      if (!color) return;
      
      // Set mode to user and edit mode
      document.getElementById('addColorMode').value = 'user';
      document.getElementById('editColorId').value = colorId;
      
      // Update modal title
      document.getElementById('addColorModalTitle').textContent = 'Edit Your Color';
      document.getElementById('addColorModalSubtitle').textContent = 'Update your personal color.';
      
      // Populate form fields
      document.getElementById('singleColorName').value = color.name;
      document.getElementById('singleColorBrand').value = color.brand || '';
      document.getElementById('singleColorHex').value = color.hex;
      document.getElementById('bulkColorInput').value = '';
      
      // Open modal
      const modal = document.getElementById('addColorModal');
      if (modal) modal.style.display = 'grid';
    }

    // Delete user color
    function deleteUserColor(colorId) {
      if (!confirm('Delete this color?')) return;
      
      firebase.database().ref(`userColors/${currentUser.uid}/${colorId}`).remove()
        .then(() => alert('Color deleted'))
        .catch(error => alert('Error: ' + error.message));
    }

    // Toggle color selection
    function toggleGlobalColorSelection(colorId) {
      const index = selectedGlobalColors.indexOf(colorId);
      if (index > -1) {
        selectedGlobalColors.splice(index, 1);
      } else {
        selectedGlobalColors.push(colorId);
      }
      updateGlobalSelectionUI();
      renderGlobalColors();
    }

    function toggleUserColorSelection(colorId) {
      const index = selectedUserColors.indexOf(colorId);
      if (index > -1) {
        selectedUserColors.splice(index, 1);
      } else {
        selectedUserColors.push(colorId);
      }
      updateUserSelectionUI();
      renderUserColors();
    }

    // Update selection UI
    function updateGlobalSelectionUI() {
      const cancelBtn = document.getElementById('btnCancelGlobalSelection');
      const deleteBtn = document.getElementById('btnMassDeleteGlobalColors');
      const addBtn = document.getElementById('btnAddGlobalColor');
      
      if (globalSelectionMode) {
        if (cancelBtn) cancelBtn.style.display = 'inline-flex';
        if (deleteBtn) {
          deleteBtn.style.display = 'inline-flex';
          deleteBtn.innerHTML = `
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
              <path d="M3 3l8 8M11 3l-8 8"/>
            </svg>
            Delete Selected (${selectedGlobalColors.length})
          `;
        }
        if (addBtn) addBtn.style.display = 'none';
      } else {
        // Exit selection mode - restore initial button state
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (deleteBtn) {
          // Global delete button should be hidden for non-admins, visible with "Select & Delete" text for admins
          if (currentUserTier === 'admin') {
            deleteBtn.style.display = 'inline-flex';
            deleteBtn.innerHTML = `
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M3 3l8 8M11 3l-8 8"/>
              </svg>
              Select & Delete
            `;
          } else {
            deleteBtn.style.display = 'none';
          }
        }
        if (addBtn && currentUserTier === 'admin') addBtn.style.display = 'inline-flex';
      }
    }

    function updateUserSelectionUI() {
      const cancelBtn = document.getElementById('btnCancelUserSelection');
      const deleteBtn = document.getElementById('btnMassDeleteUserColors');
      const addBtn = document.getElementById('btnAddUserColor');
      
      if (userSelectionMode) {
        if (cancelBtn) cancelBtn.style.display = 'inline-flex';
        if (deleteBtn) {
          deleteBtn.style.display = 'inline-flex';
          const btnText = deleteBtn.querySelector('span') || deleteBtn;
          btnText.innerHTML = `
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
              <path d="M3 3l8 8M11 3l-8 8"/>
            </svg>
            Delete Selected (${selectedUserColors.length})
          `;
        }
        if (addBtn) addBtn.style.display = 'none';
      } else {
        // Exit selection mode - restore initial button state
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (deleteBtn) {
          deleteBtn.style.display = 'inline-flex'; // User delete button should always be visible
          const btnText = deleteBtn.querySelector('span') || deleteBtn;
          btnText.innerHTML = `
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
              <path d="M3 3l8 8M11 3l-8 8"/>
            </svg>
            Select & Delete
          `;
        }
        if (addBtn) addBtn.style.display = 'inline-flex';
      }
    }

    // Enter/Exit selection mode
    function enterGlobalSelectionMode() {
      globalSelectionMode = true;
      selectedGlobalColors = [];
      updateGlobalSelectionUI();
      renderGlobalColors();
    }

    function enterUserSelectionMode() {
      userSelectionMode = true;
      selectedUserColors = [];
      updateUserSelectionUI();
      renderUserColors();
    }

    function cancelGlobalSelection() {
      globalSelectionMode = false;
      selectedGlobalColors = [];
      updateGlobalSelectionUI();
      renderGlobalColors();
    }

    function cancelUserSelection() {
      userSelectionMode = false;
      selectedUserColors = [];
      updateUserSelectionUI();
      renderUserColors();
    }

    // Mass delete selected colors
    window.massDeleteUserColors = async function() {
      if (!userSelectionMode) {
        // Enter selection mode
        enterUserSelectionMode();
        return;
      }

      if (selectedUserColors.length === 0) {
        alert('Please select colors to delete');
        return;
      }

      const confirmed = await showConfirm(
        `Delete ${selectedUserColors.length} selected color${selectedUserColors.length > 1 ? 's' : ''}?`,
        'Delete Selected Colors?'
      );
      
      if (!confirmed) return;
      
      try {
        // Delete each selected color
        for (const colorId of selectedUserColors) {
          await firebase.database().ref(`userColors/${currentUser.uid}/${colorId}`).remove();
        }
        
        showNotification(`${selectedUserColors.length} color${selectedUserColors.length > 1 ? 's' : ''} deleted successfully.`, 'success', 'Success');
        
        // Exit selection mode
        cancelUserSelection();
      } catch (error) {
        console.error('Error deleting colors:', error);
        showNotification(`Error deleting colors: ${error.message}`, 'error', 'Error');
      }
    };

    window.massDeleteGlobalColors = async function() {
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to delete global colors.', 'warning', 'Access Denied');
        return;
      }

      if (!globalSelectionMode) {
        // Enter selection mode
        enterGlobalSelectionMode();
        return;
      }

      if (selectedGlobalColors.length === 0) {
        alert('Please select colors to delete');
        return;
      }

      const confirmed = await showConfirm(
        `Delete ${selectedGlobalColors.length} selected global color${selectedGlobalColors.length > 1 ? 's' : ''}? This will affect all users.`,
        'Delete Selected Colors?'
      );
      
      if (!confirmed) return;
      
      try {
        // Delete each selected color
        for (const colorId of selectedGlobalColors) {
          await firebase.database().ref(`colors/${colorId}`).remove();
        }
        
        showNotification(`${selectedGlobalColors.length} global color${selectedGlobalColors.length > 1 ? 's' : ''} deleted successfully.`, 'success', 'Success');
        
        // Exit selection mode
        cancelGlobalSelection();
      } catch (error) {
        console.error('Error deleting colors:', error);
        showNotification(`Error deleting colors: ${error.message}`, 'error', 'Error');
      }
    };

    // ===============================================
    // ADMIN FUNCTIONS FOR GLOBAL COLORS
    // ===============================================

    // Add Global Color (Admin Only)
    function addGlobalColor() {
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to add global colors.', 'warning', 'Access Denied');
        return;
      }

      // Set mode to global
      document.getElementById('addColorMode').value = 'global';
      document.getElementById('editColorId').value = '';
      
      // Update modal title
      document.getElementById('addColorModalTitle').textContent = 'Add Global Color';
      document.getElementById('addColorModalSubtitle').textContent = 'Available to all users in the global library.';
      
      // Clear form fields
      document.getElementById('singleColorName').value = '';
      document.getElementById('singleColorBrand').value = '';
      document.getElementById('singleColorHex').value = '';
      document.getElementById('bulkColorInput').value = '';

      // Show modal
      const modal = document.getElementById('addColorModal');
      if (modal) {
        modal.style.display = 'grid';
      }
    }

    // Edit Global Color (Admin Only)
    window.editGlobalColor = async function(colorId) {
      console.log('editGlobalColor called with:', colorId);
      
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to edit global colors.', 'warning', 'Access Denied');
        return;
      }

      const color = globalColorsData[colorId];
      if (!color) {
        console.error('Color not found:', colorId);
        showNotification('Color not found in the database.', 'error', 'Error');
        return;
      }

      console.log('Opening edit modal for color:', color);

      // Set mode to global and edit mode
      document.getElementById('addColorMode').value = 'global';
      document.getElementById('editColorId').value = colorId;
      
      // Update modal title
      document.getElementById('addColorModalTitle').textContent = 'Edit Global Color';
      document.getElementById('addColorModalSubtitle').textContent = 'Update color in the global library.';
      
      // Populate form fields
      document.getElementById('singleColorName').value = color.name;
      document.getElementById('singleColorBrand').value = color.brand || '';
      document.getElementById('singleColorHex').value = color.hex;
      document.getElementById('bulkColorInput').value = '';

      // Show modal
      const modal = document.getElementById('addColorModal');
      if (modal) {
        modal.style.display = 'grid';
      }
    };

    // Delete Global Color (Admin Only)
    window.deleteGlobalColor = async function(colorId) {
      console.log('deleteGlobalColor called with:', colorId);
      
      if (currentUserTier !== 'admin') {
        showNotification('You need admin access to delete global colors.', 'warning', 'Access Denied');
        return;
      }

      const color = globalColorsData[colorId];
      if (!color) {
        showNotification('Color not found in the database.', 'error', 'Error');
        return;
      }

      const confirmed = await showConfirm(
        `Delete global color "${color.name}"? This will affect all users and cannot be undone.`,
        'Delete Color?'
      );

      if (!confirmed) return;

      try {
        await firebase.database().ref(`colors/${colorId}`).remove();
        showNotification(`Color "${color.name}" has been deleted successfully.`, 'success', 'Success');
      } catch (error) {
        console.error('Error deleting color:', error);
        showNotification(`Error deleting color: ${error.message}`, 'error', 'Error');
      }
    };

    // Populate material dropdown from existing filaments data
    function populateMaterialDropdowns() {
      const materialSelect = document.getElementById('material');
      if (!materialSelect || !filamentsData) return;
      
      const brands = {};
      Object.values(filamentsData).forEach(filament => {
        if (!brands[filament.brand]) {
          brands[filament.brand] = [];
        }
        brands[filament.brand].push(filament);
      });
      
      materialSelect.innerHTML = '<option value="">Select material</option>';
      Object.keys(brands).sort().forEach(brand => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = brand;
        brands[brand].forEach(filament => {
          const option = document.createElement('option');
          option.value = filament.type;
          option.textContent = filament.type;
          optgroup.appendChild(option);
        });
        materialSelect.appendChild(optgroup);
      });
    }

    // Load orders from Firebase
    function loadOrders() {
      if (!currentUser) {
        document.getElementById('ordersContent').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">Please login to view orders</p>';
        return;
      }
      
      const ordersRef = firebase.database().ref(`orders/${currentUser.uid}`);
      ordersRef.on('value', snapshot => {
        const data = snapshot.val();
        ordersData = [];
        
        if (data) {
          Object.entries(data).forEach(([id, order]) => {
            ordersData.push({ id, ...order });
          });
        }
        
        console.log('Loaded orders:', ordersData.length);
        renderOrdersTable();
      });
    }

    // Render orders table
    function renderOrdersTable() {
      const container = document.getElementById('ordersContent');
      if (!container) return;
      
      let filteredOrders = [...ordersData];
      
      // Apply search filter
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (searchTerm) {
        filteredOrders = filteredOrders.filter(order => 
          order.orderTitle?.toLowerCase().includes(searchTerm) ||
          order.clientName?.toLowerCase().includes(searchTerm) ||
          order.productName?.toLowerCase().includes(searchTerm)
        );
      }
      
      // Apply status filter
      const statusValue = statusFilter ? statusFilter.value : 'all';
      if (statusValue !== 'all') {
        filteredOrders = filteredOrders.filter(order => 
          order.orderStatus === statusValue || order.paymentStatus === statusValue
        );
      }
      
      // Sort by date (newest first)
      filteredOrders.sort((a, b) => (b.date || 0) - (a.date || 0));
      
      if (filteredOrders.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">No orders found</p>';
        return;
      }
      
      container.innerHTML = `
        <div class="orders-table-container">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Title</th>
                <th>Client</th>
                <!-- <th>Product</th> -->
                <th>Total</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filteredOrders.map(order => `
                <tr>
                  <td>#${order.id.slice(0, 7).toUpperCase()}</td>
                  <td>${order.orderTitle || 'N/A'}</td>
                  <td>${order.clientName || 'N/A'}</td>
                  <!-- <td>${order.productName || 'N/A'}</td> -->
                  <td>${getCurrencySymbolLocal()}${formatCurrencyLocal(convertFromUSD(order.total || 0))}</td>
                  <td><span class="status-badge status-${order.orderStatus || 'pending'}">${order.orderStatus || 'pending'}</span></td>
                  <td><span class="status-badge status-${order.paymentStatus || 'unpaid'}">${order.paymentStatus || 'unpaid'}</span></td>
                  <td>${formatDate(order.date)}</td>
                  <td>
                    <div class="order-actions">
                      <button class="btn-action" onclick="viewOrder('${order.id}')">View</button>
                      <button class="btn-action" onclick="duplicateOrder('${order.id}')">Duplicate</button>
                      <button class="btn-action" onclick="deleteOrder('${order.id}')">Delete</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Format date helper
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    // New Order Modal Functions
    function openNewOrderModal() {
      const modal = document.getElementById('newOrderModal');
      const form = document.getElementById('newOrderForm');
      
      if (form) {
        form.reset();
        selectedColors = [];
      }
      
      // Populate material dropdown
      populateMaterialDropdowns();
      
      // Populate color picker
      setTimeout(() => {
        populateColorPicker();
        
        // Setup search filter
        const searchInput = document.getElementById('colorSearchInput');
        if (searchInput) {
          searchInput.value = ''; // Clear search
          // Remove old event listeners by cloning
          const newSearchInput = searchInput.cloneNode(true);
          searchInput.parentNode.replaceChild(newSearchInput, searchInput);
          // Add new event listener
          newSearchInput.addEventListener('input', (e) => {
            populateColorPicker(e.target.value);
          });
        }
      }, 100);
      
      if (modal) {
        modal.style.display = 'grid';
      }
      
      // Initialize address autocomplete for order modal
      console.log('About to call initOrderAutocomplete');
      setTimeout(() => {
        console.log('setTimeout fired, calling initOrderAutocomplete now');
        initOrderAutocomplete();
      }, 200);
    }

    function closeNewOrderModal() {
      const modal = document.getElementById('newOrderModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // ============================================
    // CLIENT MODAL FUNCTIONS
    // ============================================

    let clientAutocomplete = null;

    function openAddClientModal() {
      const modal = document.getElementById('addClientModal');
      const form = document.getElementById('addClientForm');
      
      if (form) {
        form.reset();
      }
      
      if (modal) {
        modal.style.display = 'grid';
      }
      
      // Initialize address autocomplete for client
      console.log('About to call initClientAutocomplete');
      setTimeout(() => {
        console.log('setTimeout fired, calling initClientAutocomplete now');
        initClientAutocomplete();
      }, 200);
    }

    function closeAddClientModal() {
      const modal = document.getElementById('addClientModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Initialize client address autocomplete
    async function initClientAutocomplete() {
      const container = document.getElementById('newClientAddressSearch')?.parentElement;
      console.log('initClientAutocomplete called');
      console.log('Container element:', container);
      
      if (!container) {
        console.error('Client address autocomplete container not found');
        return;
      }
      
      // Wait for Google Maps library to load
      if (!window.google?.maps?.places) {
        console.log('Waiting for Google Maps to load...');
        setTimeout(initClientAutocomplete, 500);
        return;
      }
      
      try {
        // Import the Places library
        const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
        
        // Remove the old input field
        const oldInput = document.getElementById('newClientAddressSearch');
        if (oldInput) {
          oldInput.remove();
        }
        
        // Create the new PlaceAutocompleteElement
        const autocompleteElement = new PlaceAutocompleteElement();
        autocompleteElement.id = 'newClientAddressSearch';
        
        // Apply custom styling to match your design
        const style = document.createElement('style');
        style.textContent = `
          #newClientAddressSearch {
            width: 100%;
            font-family: inherit;
          }
          #newClientAddressSearch input {
            width: 100% !important;
            padding: 12px 16px !important;
            background: rgba(36, 29, 53, 0.6) !important;
            border: 1px solid #2d2e3a !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 14px !important;
            font-family: inherit !important;
          }
          #newClientAddressSearch input:focus {
            outline: none !important;
            border-color: #a855f7 !important;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.1) !important;
          }
          #newClientAddressSearch input::placeholder {
            color: #6b7280 !important;
          }
        `;
        document.head.appendChild(style);
        
        container.appendChild(autocompleteElement);
        console.log('Client autocomplete element created and appended');
        console.log('Element type:', autocompleteElement.constructor.name);
        console.log('Element:', autocompleteElement);
        
        // Define place selection handler
        async function handlePlaceSelect(place) {
          console.log('🎯 handlePlaceSelect called!');
          console.log('Place object:', place);
          
          if (!place) {
            console.log('❌ No place object');
            return;
          }
          
          try {
            // Fetch place details with address components
            await place.fetchFields({
              fields: ['addressComponents', 'formattedAddress']
            });
            
            console.log('✅ Place details fetched');
            console.log('Address Components:', place.addressComponents);
            console.log('Formatted Address:', place.formattedAddress);
            
            if (!place.addressComponents || place.addressComponents.length === 0) {
              console.error('❌ No address components returned');
              return;
            }
            
            let street = '';
            let city = '';
            let state = '';
            let postalCode = '';
            let country = '';
            
            for (const component of place.addressComponents) {
              const types = component.types;
              console.log(`📍 Component: "${component.longText}" | Types: ${types.join(', ')}`);
              
              if (types.includes('street_number')) {
                street = component.longText;
              }
              if (types.includes('route')) {
                street += (street ? ' ' : '') + component.longText;
              }
              if (types.includes('locality')) {
                city = component.longText;
              }
              if (types.includes('administrative_area_level_1')) {
                state = component.shortText;
              }
              if (types.includes('postal_code')) {
                postalCode = component.longText;
              }
              if (types.includes('country')) {
                country = component.longText;
              }
            }
            
            console.log('📋 Parsed Address:', { street, city, state, postalCode, country });
            
            // Fill in the form fields
            const streetField = document.getElementById('newClientStreet');
            const cityField = document.getElementById('newClientCity');
            const stateField = document.getElementById('newClientState');
            const postalCodeField = document.getElementById('newClientPostalCode');
            const countryField = document.getElementById('newClientCountry');
            
            console.log('🔍 Field elements:', {
              streetField: !!streetField,
              cityField: !!cityField,
              stateField: !!stateField,
              postalCodeField: !!postalCodeField,
              countryField: !!countryField
            });
            
            if (streetField) {
              streetField.value = street;
              console.log('✅ Street set to:', street);
            }
            if (cityField) {
              cityField.value = city;
              console.log('✅ City set to:', city);
            }
            if (stateField) {
              stateField.value = state;
              console.log('✅ State set to:', state);
            }
            if (postalCodeField) {
              postalCodeField.value = postalCode;
              console.log('✅ Postal code set to:', postalCode);
            }
            if (countryField) {
              countryField.value = country;
              console.log('✅ Country set to:', country);
            }
            
            console.log('🎉 Address fields populated successfully!');
          } catch (error) {
            console.error('❌ Error fetching place details:', error);
          }
        }
        
        // Attach event listener for place selection
        autocompleteElement.addEventListener('gmp-select', async (event) => {
          console.log('🎯 gmp-select event fired!');
          console.log('Event:', event);
          
          // Use placePrediction.toPlace() to get the place object
          const place = await event.placePrediction.toPlace();
          console.log('Place from prediction:', place);
          
          await handlePlaceSelect(place);
        });
        
        console.log('✅ Event listener attached to autocomplete element');
      } catch (error) {
        console.error('❌ Error initializing client autocomplete:', error);
      }
    }

    // Handle client form submission
    window.addEventListener('DOMContentLoaded', () => {
      const addClientForm = document.getElementById('addClientForm');
      if (addClientForm) {
        addClientForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('📝 Add Client form submitted');
          console.log('Current user:', currentUser);
          
          if (!currentUser) {
            alert('Please login to add a client');
            return;
          }
          
          // Get form data
          const clientData = {
            name: document.getElementById('newClientName').value,
            email: document.getElementById('newClientEmail').value,
            phone: document.getElementById('newClientPhone').value,
            messagingPlatform: document.getElementById('newClientMessaging').value,
            company: document.getElementById('newClientCompany').value,
            tags: document.getElementById('newClientTags').value,
            address: {
              street: document.getElementById('newClientStreet').value,
              city: document.getElementById('newClientCity').value,
              state: document.getElementById('newClientState').value,
              postalCode: document.getElementById('newClientPostalCode').value,
              country: document.getElementById('newClientCountry').value
            },
            preferredLanguage: document.getElementById('newClientLanguage').value,
            notes: document.getElementById('newClientNotes').value,
            createdAt: Date.now(),
            updatedAt: Date.now()
          };
          
          console.log('Client data to save:', clientData);
          
          try {
            // Save to Firebase
            console.log('Saving to Firebase...');
            await firebase.database().ref(`users/${currentUser.uid}/clients`).push(clientData);
            
            console.log('✅ Client saved successfully');
            
            // Show success message
            showNotification('Client added successfully!', 'success', 'Client Added');
            
            // Reset form
            addClientForm.reset();
            
            // Close modal
            closeAddClientModal();
            
            // Reload clients list (if function exists)
            if (typeof loadClients === 'function') {
              loadClients();
            }
          } catch (error) {
            console.error('❌ Error adding client:', error);
            showNotification('Error adding client. Please try again.', 'error');
          }
        });
        console.log('✅ Add Client form listener attached');
      } else {
        console.error('❌ Add Client form not found');
      }
    });

    // Clients data storage
    let clientsData = [];

    // Load clients from Firebase
    function loadClients() {
      if (!currentUser) {
        console.log('No user logged in, skipping client load');
        return;
      }

      console.log('📋 Loading clients for user:', currentUser.uid);
      
      const clientsRef = firebase.database().ref(`users/${currentUser.uid}/clients`);
      
      clientsRef.on('value', snapshot => {
        clientsData = [];
        
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const client = child.val();
            clientsData.push({
              id: child.key,
              ...client
            });
          });
          console.log(`✅ Loaded ${clientsData.length} clients`);
        } else {
          console.log('No clients found');
        }
        
        renderClientsTable();
      });
    }

    // Render clients table
    function renderClientsTable() {
      const container = document.getElementById('clientsContent');
      if (!container) return;

      // Get search term
      const searchInput = document.getElementById('searchClients');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

      // Filter clients
      let filteredClients = clientsData;
      if (searchTerm) {
        filteredClients = clientsData.filter(client => {
          return (
            (client.name && client.name.toLowerCase().includes(searchTerm)) ||
            (client.email && client.email.toLowerCase().includes(searchTerm)) ||
            (client.phone && client.phone.toLowerCase().includes(searchTerm)) ||
            (client.company && client.company.toLowerCase().includes(searchTerm)) ||
            (client.tags && client.tags.toLowerCase().includes(searchTerm))
          );
        });
      }

      // Show empty state if no clients
      if (filteredClients.length === 0) {
        if (clientsData.length === 0) {
          // No clients at all
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
              <img src="../images/Icons/Users.svg" alt="" style="width: 64px; height: 64px; opacity: 0.3; margin: 0 auto 16px; filter: brightness(0) invert(1);">
              <h3 style="font-size: 18px; margin-bottom: 8px; color: #fff; font-weight: 600;">No clients yet</h3>
              <p style="font-size: 14px; color: rgba(255, 255, 255, 0.5); margin-bottom: 24px;">Add your first client to get started</p>
              <button type="button" class="btn btn-primary" onclick="document.getElementById('btnAddClient').click()">
                <img src="../images/Icons/Plus.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
                Add Your First Client
              </button>
            </div>
          `;
        } else {
          // No results from search
          container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
              <p style="color: rgba(255, 255, 255, 0.5);">No clients found matching "${searchTerm}"</p>
            </div>
          `;
        }
        return;
      }

      // Render clients table
      container.innerHTML = `
        <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden;">
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                  <th style="padding: 16px; text-align: left; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Client</th>
                  <th style="padding: 16px; text-align: left; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Contact</th>
                  <th style="padding: 16px; text-align: left; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Platform</th>
                  <th style="padding: 16px; text-align: left; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Location</th>
                  <th style="padding: 16px; text-align: left; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Language</th>
                  <th style="padding: 16px; text-align: left; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Tags</th>
                  <th style="padding: 16px; text-align: right; color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${filteredClients.map((client, index) => `
                  <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 16px;">
                      <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="color: #fff; font-weight: 600; font-size: 14px;">${client.name || 'Unnamed Client'}</span>
                        ${client.company ? `<span style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">${client.company}</span>` : ''}
                      </div>
                    </td>
                    <td style="padding: 16px;">
                      <div style="display: flex; flex-direction: column; gap: 4px;">
                        ${client.email ? `
                          <a href="mailto:${client.email}" style="color: rgba(255, 255, 255, 0.7); font-size: 13px; text-decoration: none; display: flex; align-items: center; gap: 6px;">
                            <img src="../images/Icons/EnvelopeSimple.svg" alt="" style="width: 12px; height: 12px; opacity: 0.5; filter: brightness(0) invert(1);">
                            ${client.email}
                          </a>
                        ` : '<span style="color: rgba(255, 255, 255, 0.3); font-size: 13px;">—</span>'}
                        ${client.phone ? `
                          <a href="tel:${client.phone}" style="color: rgba(255, 255, 255, 0.7); font-size: 13px; text-decoration: none; display: flex; align-items: center; gap: 6px;">
                            <img src="../images/Icons/Phone.svg" alt="" style="width: 12px; height: 12px; opacity: 0.5; filter: brightness(0) invert(1);">
                            ${client.phone}
                          </a>
                        ` : ''}
                      </div>
                    </td>
                    <td style="padding: 16px;">
                      <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px;">${client.messagingPlatform || '—'}</span>
                    </td>
                    <td style="padding: 16px;">
                      <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px;">
                        ${client.address && (client.address.city || client.address.country) 
                          ? [client.address.city, client.address.state, client.address.country].filter(Boolean).join(', ')
                          : '—'}
                      </span>
                    </td>
                    <td style="padding: 16px;">
                      <span style="color: rgba(255, 255, 255, 0.7); font-size: 13px;">${client.preferredLanguage || '—'}</span>
                    </td>
                    <td style="padding: 16px;">
                      ${client.tags ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                          ${client.tags.split(',').slice(0, 2).map(tag => `
                            <span style="font-size: 11px; padding: 3px 8px; background: rgba(168, 85, 247, 0.2); color: #a855f7; border-radius: 12px; white-space: nowrap;">${tag.trim()}</span>
                          `).join('')}
                          ${client.tags.split(',').length > 2 ? `<span style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">+${client.tags.split(',').length - 2}</span>` : ''}
                        </div>
                      ` : '<span style="color: rgba(255, 255, 255, 0.3); font-size: 13px;">—</span>'}
                    </td>
                    <td style="padding: 16px; text-align: right;">
                      <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="viewClient('${client.id}')" class="btn-calc" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">View</button>
                        <button onclick="editClient('${client.id}')" class="btn-calc" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">Edit</button>
                        <button onclick="deleteClient('${client.id}')" class="btn-calc-ghost" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">Delete</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Add search functionality for clients
    const searchClientsInput = document.getElementById('searchClients');
    if (searchClientsInput) {
      searchClientsInput.addEventListener('input', () => renderClientsTable());
    }

    // Placeholder functions for client actions
    window.viewClient = function(clientId) {
      const client = clientsData.find(c => c.id === clientId);
      if (client) {
        alert(`View client: ${client.name}\n\nThis feature is coming soon!`);
      }
    };

    window.editClient = function(clientId) {
      const client = clientsData.find(c => c.id === clientId);
      if (client) {
        alert(`Edit client: ${client.name}\n\nThis feature is coming soon!`);
      }
    };

    window.deleteClient = async function(clientId) {
      const client = clientsData.find(c => c.id === clientId);
      if (!client) return;

      if (window.confirm(`Are you sure you want to delete ${client.name}?`)) {
        try {
          await firebase.database().ref(`users/${currentUser.uid}/clients/${clientId}`).remove();
          showNotification('Client deleted successfully!', 'success', 'Client Deleted');
        } catch (error) {
          console.error('Error deleting client:', error);
          showNotification('Error deleting client. Please try again.', 'error');
        }
      }
    };

    // Initialize address autocomplete for New Order modal
    function initOrderAutocomplete() {
      const container = document.getElementById('orderAddressAutocomplete')?.parentElement;
      console.log('initOrderAutocomplete called');
      console.log('Container element:', container);
      console.log('Google Maps loaded:', !!window.google);
      console.log('Google Places loaded:', !!(window.google && window.google.maps && window.google.maps.places));
      
      if (!container) {
        console.error('Order address autocomplete container not found');
        return;
      }
      
      if (!window.google || !window.google.maps || !window.google.maps.places) {
        console.error('Google Maps Places library not loaded');
        return;
      }
      
      try {
        // Remove the old input field
        const oldInput = document.getElementById('orderAddressAutocomplete');
        if (oldInput) {
          oldInput.remove();
        }
        
        // Create the new PlaceAutocompleteElement
        const autocompleteElement = document.createElement('gmp-place-autocomplete');
        autocompleteElement.id = 'orderAddressAutocomplete';
        autocompleteElement.setAttribute('placeholder', 'Start typing address...');
        autocompleteElement.setAttribute('type', 'address');
        
        // Apply custom styling to match your design
        const style = document.createElement('style');
        style.textContent = `
          #orderAddressAutocomplete {
            width: 100%;
            font-family: inherit;
          }
          #orderAddressAutocomplete input {
            width: 100% !important;
            padding: 12px 16px !important;
            background: rgba(36, 29, 53, 0.6) !important;
            border: 1px solid #2d2e3a !important;
            border-radius: 8px !important;
            color: #ffffff !important;
            font-size: 14px !important;
            font-family: inherit !important;
          }
          #orderAddressAutocomplete input:focus {
            outline: none !important;
            border-color: #a855f7 !important;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.1) !important;
          }
          #orderAddressAutocomplete input::placeholder {
            color: #6b7280 !important;
          }
        `;
        document.head.appendChild(style);
        
        container.appendChild(autocompleteElement);
        console.log('Order autocomplete initialized successfully with new API');
        
        // Listen for place selection with new gmp-select event
        autocompleteElement.addEventListener('gmp-select', async (event) => {
          console.log('🎯 gmp-select event fired!');
          console.log('Event:', event);
          
          // Use placePrediction.toPlace() to get the place object
          const place = await event.placePrediction.toPlace();
          console.log('Place from prediction:', place);
          
          if (!place) {
            console.log('No place object');
            return;
          }
          
          try {
            // Fetch place details with address components
            await place.fetchFields({
              fields: ['addressComponents', 'formattedAddress']
            });
            
            console.log('Place addressComponents:', place.addressComponents);
            console.log('Formatted address:', place.formattedAddress);
            
            if (!place.addressComponents || place.addressComponents.length === 0) {
              console.error('No address components returned');
              return;
            }
            
            let street = '';
            let city = '';
            let state = '';
            let postalCode = '';
            let country = '';
            
            for (const component of place.addressComponents) {
              const types = component.types;
              console.log('Component:', component.longText, 'Types:', types);
              
              if (types.includes('street_number')) {
                street = component.longText;
              }
              if (types.includes('route')) {
                street += (street ? ' ' : '') + component.longText;
              }
              if (types.includes('locality')) {
                city = component.longText;
              }
              if (types.includes('administrative_area_level_1')) {
                state = component.shortText;
              }
              if (types.includes('postal_code')) {
                postalCode = component.longText;
              }
              if (types.includes('country')) {
                country = component.longText;
              }
            }
            
            console.log('Parsed address:', { street, city, state, postalCode, country });
            
            // Fill in the form fields
            const streetField = document.getElementById('orderStreet');
            const cityField = document.getElementById('orderCity');
            const stateField = document.getElementById('orderState');
            const postalCodeField = document.getElementById('orderPostalCode');
            const countryField = document.getElementById('orderCountry');
            
            if (streetField) streetField.value = street;
            if (cityField) cityField.value = city;
            if (stateField) stateField.value = state;
            if (postalCodeField) postalCodeField.value = postalCode;
            if (countryField) countryField.value = country;
            
            console.log('Order address fields populated successfully');
          } catch (error) {
            console.error('Error fetching place details:', error);
          }
        });
      } catch (error) {
        console.error('Error initializing order autocomplete:', error);
      }
    }

    // Populate color picker
    function populateColorPicker(searchTerm = '') {
      const grid = document.getElementById('colorSelectionGrid');
      if (!grid) return;
      
      // User colors first, then global colors (matching printer/filament preset order)
      const allColors = [
        ...Object.entries(userColorsData).map(([id, color]) => ({ ...color, id, source: 'user' })),
        ...Object.entries(globalColorsData).map(([id, color]) => ({ ...color, id, source: 'global' }))
      ];
      
      // Filter colors by search term
      const filteredColors = searchTerm 
        ? allColors.filter(color => color.name.toLowerCase().includes(searchTerm.toLowerCase().trim()))
        : allColors;
      
      if (filteredColors.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No colors found</p>';
        return;
      }
      
      grid.innerHTML = filteredColors.map(color => {
        const isSelected = selectedColors.some(c => c.hex === color.hex);
        const selectedClass = isSelected ? ' selected' : '';
        return `
          <div class="color-option${selectedClass} color-swatch-preserve" 
               style="background-color: ${color.hex}; border-color: ${isSelected ? 'var(--purple)' : color.hex};" 
               onclick="selectColor('${color.id}', '${color.name}', '${color.hex}')"
               title="${color.name}">
            <span class="color-option-label" style="color: ${getContrastColor(color.hex)};">
              ${color.name.substring(0, 12)}
            </span>
          </div>
        `;
      }).join('');
    }

    // Select color for order
    function selectColor(id, name, hex) {
      // Check if already selected - if so, deselect
      const existingIndex = selectedColors.findIndex(c => c.hex === hex);
      if (existingIndex > -1) {
        selectedColors.splice(existingIndex, 1);
        updateSelectedColorsPreview();
        updateColorHiddenInputs();
        // Re-render with current search term
        const searchInput = document.getElementById('colorSearchInput');
        populateColorPicker(searchInput ? searchInput.value : '');
        return;
      }
      
      if (selectedColors.length >= 4) {
        alert('Maximum 4 colors allowed');
        return;
      }
      
      selectedColors.push({ id, name, hex });
      updateSelectedColorsPreview();
      updateColorHiddenInputs();
      // Re-render with current search term
      const searchInput = document.getElementById('colorSearchInput');
      populateColorPicker(searchInput ? searchInput.value : '');
    }

    function updateSelectedColorsPreview() {
      const preview = document.getElementById('selectedColorsPreview');
      if (!preview) return;
      
      preview.innerHTML = selectedColors.map((color, index) => `
        <div class="color-swatch-preserve" style="position: relative; width: 40px; height: 40px; border-radius: 6px; background-color: ${color.hex}; border: 2px solid var(--purple); cursor: pointer;" 
             onclick="removeSelectedColor(${index})"
             title="${color.name} - Click to remove">
        </div>
      `).join('');
    }

    function removeSelectedColor(index) {
      selectedColors.splice(index, 1);
      updateSelectedColorsPreview();
      updateColorHiddenInputs();
      // Re-render with current search term
      const searchInput = document.getElementById('colorSearchInput');
      populateColorPicker(searchInput ? searchInput.value : '');
    }

    function updateColorHiddenInputs() {
      for (let i = 1; i <= 4; i++) {
        const input = document.getElementById(`color${i}`);
        if (input) {
          input.value = selectedColors[i-1] ? selectedColors[i-1].name : '';
        }
      }
    }

    // Get contrast color for text
    function getContrastColor(hexColor) {
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    // Form submission handler is in orders.js

  </script>

  <!-- ============================================ -->
  <!-- UPLOAD MODEL MODALS - START -->
  <!-- ============================================ -->

  <!-- Add Model Form Modal -->
  <div class="modal-overlay" id="addModelModal">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; max-height: 95vh; overflow-y: auto;">
      <div class="modal-header-centered">
        <h3 class="modal-title-large">Add New <span class="gradient-highlight">Model</span></h3>
        <p class="modal-subtitle-large">Fill in the model details below</p>
        <button type="button" class="modal-close" onclick="closeAddModelModal()">×</button>
      </div>

      <form id="modelForm">
      <!-- Model Information Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Model Information</h4>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div>
            <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">SKU</label>
            <input type="text" class="form-input" id="sku" placeholder="1000 | 0 for infinite" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
          </div>

          <div>
            <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Designer</label>
            <input type="text" class="form-input" id="designer" placeholder="Vixvvo3D" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
          </div>

          <div>
            <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Category</label>
            <input type="text" class="form-input" id="category" list="categoryOptions" placeholder="Enter or select category" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            <datalist id="categoryOptions">
              <!-- Populated dynamically -->
            </datalist>
          </div>

          <div>
            <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Marketplace</label>
            <input type="text" class="form-input" id="marketplace" placeholder="Marketplace" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
          </div>

          <div style="grid-column: 1 / -1;">
            <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Model Name <span style="color: #ef4444;">*</span></label>
            <input type="text" class="form-input" id="modelName" placeholder="Enter model name" required style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
          </div>

          <div style="grid-column: 1 / -1;">
            <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Print Time</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; color: #9ca3af; margin: 0 0 4px 0; font-size: 11px;">Hours</label>
                <input type="number" class="form-input" id="printHours" min="0" value="0" placeholder="0" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; color: #9ca3af; margin: 0 0 4px 0; font-size: 11px;">Minutes</label>
                <input type="number" class="form-input" id="printMinutes" min="0" max="59" value="0" placeholder="0" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Model Image Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Model Image</h4>

        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 24px; align-items: start;">
          <div class="image-preview" id="imagePreview" style="aspect-ratio: 1; background: rgba(36, 29, 53, 0.6); border: 2px dashed #2d2e3a; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
            <div class="image-preview-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; color: #9ca3af; position: absolute; top: 0; left: 0;">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.6;">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              <p style="margin: 12px 0 0 0; font-size: 13px; opacity: 0.6;">No Image</p>
            </div>
            <img id="imagePreviewImg" style="display: none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;" alt="">
          </div>
          <div style="display: flex; gap: 12px; flex-direction: column;">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <button type="button" class="btn-calc-ghost" onclick="document.getElementById('imageInput').click()" style="width: fit-content;">Choose Image</button>
            <button type="button" class="btn-calc-ghost" id="btnRemoveImage" style="display: none; width: fit-content; border-color: #ef4444; color: #ef4444;">Remove</button>
          </div>
        </div>
      </div>

      <!-- Model Files Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Model Files</h4>

        <div class="upload-area" id="uploadArea" style="padding: 40px; background: rgba(36, 29, 53, 0.6); border: 2px dashed #2d2e3a; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
          <div class="upload-icon" style="font-size: 48px; margin-bottom: 12px;">⬆</div>
          <div class="upload-text" style="color: #ffffff; font-size: 16px; margin-bottom: 4px;">Click to upload or drag and drop</div>
          <div class="upload-subtext" style="color: #9ca3af; font-size: 13px;">Supports: .stl, .3mf, .obj, .step, .zip (Max 100MB per file)</div>
          <input type="file" id="fileInput" multiple accept=".stl,.3mf,.obj,.step,.zip" style="display: none;">
        </div>

        <div class="file-list" id="fileList" style="margin-top: 16px;"></div>
      </div>

      <!-- Filament Cost Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Filament Cost</h4>

        <div style="margin-bottom: 16px;">
          <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Choose Your Filament</label>
          <select class="form-select" id="filamentSelect" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; cursor: pointer;">
            <option value="">Select filament...</option>
            <optgroup label="Global Filaments" id="globalFilamentsGroup">
              <!-- Populated dynamically -->
            </optgroup>
            <optgroup label="Your Filaments" id="userFilamentsGroup">
              <!-- Populated dynamically -->
            </optgroup>
          </select>
        </div>

        <div id="filamentDisplay" class="filament-display" style="display: none; padding: 16px; background: rgba(36, 29, 53, 0.6); border-radius: 8px; border: 1px solid #2d2e3a;">
          <div class="filament-info" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div class="filament-field">
              <div class="filament-field-label" style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">Brand</div>
              <div class="filament-field-value" id="filamentBrand" style="color: #ffffff; font-size: 14px;">-</div>
            </div>
            <div class="filament-field">
              <div class="filament-field-label" style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">Type</div>
              <div class="filament-field-value" id="filamentType" style="color: #ffffff; font-size: 14px;">-</div>
            </div>
            <div class="filament-field">
              <div class="filament-field-label" style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">Spool Weight</div>
              <div class="filament-field-value" id="filamentWeight" style="color: #ffffff; font-size: 14px;">-</div>
            </div>
            <div class="filament-field">
              <div class="filament-field-label" style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">Cost per Spool</div>
              <div class="filament-field-value" id="filamentCost" style="color: #ffffff; font-size: 14px;">-</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px; padding: 12px 16px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2);">
          <div style="color: #fbbf24; font-size: 13px; font-weight: 600; margin-bottom: 4px;">Auto-Calculator (Coming Soon)</div>
          <div style="color: #9ca3af; font-size: 13px;">Filament cost calculation based on estimated weight/length will be available soon.</div>
        </div>
      </div>

      <!-- Supplies Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Supplies</h4>

        <div class="supply-list" id="supplyList" style="margin-bottom: 16px;"></div>

        <div style="display: flex; gap: 12px;">
          <button type="button" class="btn-calc-ghost" id="btnAddSupply">
            Add Existing Supply
          </button>
          <button type="button" class="btn-calc-ghost" id="btnCreateSupply">
            Create New Supply
          </button>
        </div>
      </div>

      <!-- Sales Platform Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Sales Platform</h4>

        <div>
          <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Sales Platform Sold On?</label>
          <select class="form-select" id="salesPlatform" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; cursor: pointer;">
            <option value="">Select platform...</option>
            <option value="Etsy">Etsy</option>
            <option value="eBay">eBay</option>
            <option value="Shopify">Shopify</option>
            <option value="TikTok Shop">TikTok Shop</option>
            <option value="Facebook Marketplace">Facebook Marketplace</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <!-- Printer Section -->
      <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
        <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Printer</h4>

        <div style="margin-bottom: 12px;">
          <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Model Printed On</label>
          <select class="form-select" id="printerSelect" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; cursor: pointer;">
            <option value="">Select printer...</option>
            <optgroup label="Global Printers" id="globalPrintersGroup">
              <!-- Populated dynamically -->
            </optgroup>
            <optgroup label="Your Printers" id="userPrintersGroup">
              <!-- Populated dynamically -->
            </optgroup>
          </select>
        </div>

        <button type="button" class="btn-calc-ghost" id="btnAddPrinter">
          Add Printer
        </button>
      </div>

      <!-- Submit Section -->
      <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 8px;">
        <button type="button" class="btn-calc-ghost" onclick="closeAddModelModal()">Cancel</button>
        <button type="submit" class="btn-calc" id="btnCreateModel" disabled>
          CREATE MODEL
        </button>
      </div>
    </form>
    </div>
  </div>

  <!-- View Model Modal -->
  <div class="modal-overlay" id="viewModelModal">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; max-height: 95vh; overflow-y: auto;">
      <div class="modal-header-centered">
        <h3 class="modal-title-large">Model <span class="gradient-highlight">Details</span></h3>
        <p class="modal-subtitle-large">View model information and download files</p>
        <button type="button" class="modal-close" onclick="closeViewModelModal()">×</button>
      </div>

      <div id="viewModelContent">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>

  <!-- Add Supply Modal -->
  <div class="modal-overlay" id="addSupplyModal">
    <div class="modal-card modal-dark-theme" style="max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <button type="button" class="modal-close" onclick="closeAddSupplyModal()">×</button>
      
      <div class="modal-header-centered">
        <h2 class="modal-title-large">Add Existing <span class="gradient-highlight">Supply</span></h2>
        <p class="modal-subtitle-large">Select a supply from your inventory to add to this model</p>
      </div>

      <!-- Search Box -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Search Supplies</label>
        <input type="text" class="form-input" id="searchAddSupply" placeholder="Search by name or category..." style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
      </div>

      <!-- Supplies Grid -->
      <div id="addSupplyGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px; max-height: 50vh; overflow-y: auto; padding: 4px;">
        <!-- Populated dynamically -->
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-ghost" onclick="closeAddSupplyModal()" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Create Supply Modal -->
  <div class="modal-overlay" id="createSupplyModal">
    <div class="modal-card modal-dark-theme" style="max-width: 700px; width: 90%;">
      <button type="button" class="modal-close" onclick="closeCreateSupplyModal()">×</button>
      
      <div class="modal-header-centered">
        <h3 class="modal-title-large">Create New <span class="gradient-highlight">Supply</span></h3>
        <p class="modal-subtitle-large">Add a new supply item to your inventory</p>
      </div>

      <form id="createSupplyForm">
        <!-- Supply Information Section -->
        <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
          <h4 style="color: #ffffff; margin: 0 0 20px 0; font-size: 16px; font-weight: 600;">Supply Information</h4>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div>
              <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Category <span style="color: #ef4444;">*</span></label>
              <input type="text" class="form-input" id="newSupplyCategory" placeholder="e.g., Hardware, Paint, Tools" required style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>

            <div>
              <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Supply Name <span style="color: #ef4444;">*</span></label>
              <input type="text" class="form-input" id="newSupplyName" placeholder="e.g., M3 Screws, Acrylic Paint" required style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>

            <div>
              <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">
                Cost Per Item <span id="createSupplyCurrencyLabel"></span> <span style="color: #ef4444;">*</span>
              </label>
              <input type="number" class="form-input" id="newSupplyCost" step="0.01" min="0" placeholder="19.99" required style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>

            <div>
              <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">
                <span style="display: flex; align-items: center; gap: 6px;">
                  Supplies in Stock
                  <span style="font-size: 11px; color: #9ca3af; font-weight: 400;">(0 = 
                    <span style="color: #a855f7; font-size: 14px;">∞</span>
                  )</span>
                </span>
              </label>
              <input type="number" class="form-input" id="newSupplyStock" min="0" value="0" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>

            <div style="grid-column: 1 / -1;">
              <label style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Purchase Link</label>
              <input type="url" class="form-input" id="newSupplyLink" placeholder="https://example.com/product" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px;">
          <button type="button" class="btn btn-ghost" onclick="closeCreateSupplyModal()" style="flex: 1;">Cancel</button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            <img src="../images/Icons/Plus.svg" alt="" style="width: 14px; height: 14px; margin-right: 6px; vertical-align: middle; filter: brightness(0) invert(1);">
            Create Supply
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Supplies Modal -->
  <div class="modal-overlay" id="manageSuppliesModal">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; height: 95vh; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden;">
      <button type="button" class="modal-close" onclick="closeManageSuppliesModal()">×</button>
      
      <div class="modal-header-centered" style="flex-shrink: 0;">
        <h3 class="modal-title-large">Supply <span class="gradient-highlight">Management</span></h3>
        <p class="modal-subtitle-large">View and organize your supplies inventory</p>
      </div>

      <!-- Action Bar -->
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 20px; flex-shrink: 0;">
        <div style="position: relative; flex: 1; max-width: 400px;">
          <img src="../images/Icons/MagnifyingGlass.svg" alt="" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0.5; filter: brightness(0) invert(1); pointer-events: none;">
          <input type="text" id="searchSupplies" placeholder="Search by name or category..." style="width: 100%; padding: 12px 16px 12px 42px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; transition: all 0.2s ease;">
        </div>
        <button type="button" class="btn btn-primary" onclick="openCreateSupplyForManagement()" style="white-space: nowrap; padding: 12px 20px;">
          <img src="../images/Icons/Plus.svg" alt="" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle; filter: brightness(0) invert(1);">
          New Supply
        </button>
      </div>

      <!-- Supplies List Container -->
      <div id="manageSuppliesList" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; padding-right: 4px;">
        <!-- Will be populated dynamically -->
      </div>

      <!-- Footer -->
      <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 1px solid rgba(168, 85, 247, 0.2); flex-shrink: 0; margin-top: 20px;">
        <button type="button" class="btn btn-ghost" onclick="closeManageSuppliesModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add Printer Modal -->
  <div class="modal-overlay" id="addPrinterModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add Printer</h2>
        <button type="button" class="modal-close" onclick="closeAddPrinterModal()">×</button>
      </div>

      <div class="form-group">
        <label class="form-label">Printer Name <span class="required">*</span></label>
        <input type="text" class="form-input" id="newPrinterName" placeholder="e.g., Prusa i3 MK3S, Ender 3 Pro">
      </div>

      <div style="margin-top: 24px; display: flex; gap: 12px;">
        <button type="button" class="btn btn-ghost" onclick="closeAddPrinterModal()" style="flex: 1;">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnConfirmAddPrinter" style="flex: 1;">Add Printer</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification for Upload Model -->
  <div class="toast" id="toast">
    <div class="toast-header">
      <div class="toast-icon" id="toastIcon">✓</div>
      <div class="toast-title" id="toastTitle">Success</div>
    </div>
    <div class="toast-message" id="toastMessage">Operation completed successfully</div>
  </div>

  <!-- Image Crop Modal -->
  <div class="modal-overlay" id="cropModal">
    <div class="modal-card modal-dark-theme" style="max-width: 800px; width: 95%;">
      <div class="modal-header-centered">
        <h3 class="modal-title-large">Crop <span class="gradient-highlight">Image</span></h3>
        <p class="modal-subtitle-large">Drag the purple square to reposition the crop area</p>
        <button type="button" class="modal-close" onclick="closeCropModal()">×</button>
      </div>
      
      <div style="padding: 24px; background: rgba(0, 0, 0, 0.15); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 24px;">
        <div style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
          <canvas id="cropCanvas" style="max-width: 100%; border-radius: 8px; cursor: grab;"></canvas>
        </div>
      </div>
      
      <div style="display: flex; justify-content: flex-end; gap: 12px;">
        <button type="button" class="btn-calc-ghost" onclick="closeCropModal()">Cancel</button>
        <button type="button" class="btn-calc" onclick="applyCrop()">Apply Crop</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- UPLOAD MODEL MODALS - END -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- CLIENT MODAL -->
  <!-- ============================================ -->
  
  <!-- Add Client Modal -->
  <div class="modal-overlay" id="addClientModal">
    <div class="modal-card modal-dark-theme" style="max-width: 1800px; width: 98%; max-height: 95vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeAddClientModal()">×</button>
      
      <div class="modal-header-centered">
        <h3 class="modal-title-large">
          Add New <span class="gradient-highlight">Client</span>
        </h3>
        <p class="modal-subtitle-large">Fill in the client details below</p>
      </div>

      <form id="addClientForm">
        <!-- Two Column Layout: Client Info (Left) + Address Info (Right) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
          
          <!-- Client Information (Left Column) -->
          <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
            <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Client Information</h4>
            
            <div style="display: grid; gap: 16px;">
              <div>
                <label for="newClientName" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Client Name *</label>
                <input type="text" id="newClientName" name="clientName" required placeholder="Enter client name" autocomplete="name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>

              <div>
                <label for="newClientEmail" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Email</label>
                <input type="email" id="newClientEmail" name="email" placeholder="client@example.com" autocomplete="email" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>

              <div>
                <label for="newClientPhone" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Phone</label>
                <input type="tel" id="newClientPhone" name="phone" placeholder="+1 (555) 123-4567" autocomplete="tel" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>

              <div>
                <label for="newClientMessaging" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Messaging Platform</label>
                <select id="newClientMessaging" name="messagingPlatform" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                  <option value="">Select messaging app or platform...</option>
                  <optgroup label="Messaging Apps">
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Facebook Messenger">Facebook Messenger</option>
                    <option value="Instagram DM">Instagram Direct Message</option>
                    <option value="Telegram">Telegram</option>
                    <option value="Discord">Discord</option>
                    <option value="WeChat">WeChat</option>
                    <option value="Line">LINE</option>
                    <option value="Viber">Viber</option>
                    <option value="Snapchat">Snapchat</option>
                    <option value="iMessage">iMessage</option>
                    <option value="SMS">SMS/Text Message</option>
                    <option value="Signal">Signal</option>
                    <option value="Kakao Talk">Kakao Talk</option>
                  </optgroup>
                  <optgroup label="E-Commerce Marketplaces">
                    <option value="Etsy">Etsy</option>
                    <option value="eBay">eBay</option>
                    <option value="Amazon">Amazon</option>
                    <option value="Shopify">Shopify</option>
                    <option value="Facebook Marketplace">Facebook Marketplace</option>
                    <option value="Mercari">Mercari</option>
                    <option value="Poshmark">Poshmark</option>
                    <option value="Depop">Depop</option>
                    <option value="Vinted">Vinted</option>
                    <option value="Craigslist">Craigslist</option>
                    <option value="OfferUp">OfferUp</option>
                    <option value="Letgo">Letgo</option>
                    <option value="AliExpress">AliExpress</option>
                    <option value="Alibaba">Alibaba</option>
                    <option value="Walmart Marketplace">Walmart Marketplace</option>
                    <option value="Target Plus">Target Plus</option>
                    <option value="Wish">Wish</option>
                    <option value="Temu">Temu</option>
                    <option value="Shein">Shein</option>
                  </optgroup>
                  <optgroup label="Social & Professional">
                    <option value="Twitter DM">Twitter/X Direct Message</option>
                    <option value="LinkedIn Messages">LinkedIn Messages</option>
                    <option value="TikTok">TikTok Shop</option>
                    <option value="Pinterest">Pinterest</option>
                  </optgroup>
                  <optgroup label="Traditional">
                    <option value="Email">Email</option>
                    <option value="Phone Call">Phone Call</option>
                    <option value="In Person">In Person</option>
                    <option value="Skype">Skype</option>
                    <option value="Slack">Slack</option>
                    <option value="Teams">Microsoft Teams</option>
                  </optgroup>
                  <optgroup label="Other">
                    <option value="Other">Other</option>
                  </optgroup>
                </select>
              </div>

              <div>
                <label for="newClientCompany" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Company/Business Name</label>
                <input type="text" id="newClientCompany" name="company" placeholder="Optional" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>

              <div>
                <label for="newClientTags" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Tags</label>
                <input type="text" id="newClientTags" name="tags" placeholder="e.g., repeat, wholesale, local" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Comma-separated tags for easy filtering</p>
              </div>
            </div>
          </div>

          <!-- Address Information (Right Column) -->
          <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a;">
            <h4 style="color: #ffffff; margin: 0 0 24px 0; font-size: 16px; font-weight: 600;">Address Information</h4>
            
            <div style="display: grid; gap: 16px;">
              <div>
                <label for="newClientAddressSearch" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Address Search</label>
                <input type="text" id="newClientAddressSearch" name="addressSearch" placeholder="Start typing address..." autocomplete="street-address" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Use Google Places autocomplete to quickly fill address</p>
              </div>

              <div>
                <label for="newClientStreet" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Street Address</label>
                <input type="text" id="newClientStreet" name="street" placeholder="123 Main St" autocomplete="street-address" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <div>
                  <label for="newClientCity" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">City</label>
                  <input type="text" id="newClientCity" name="city" placeholder="City" autocomplete="address-level2" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                </div>

                <div>
                  <label for="newClientState" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">State/Province</label>
                  <input type="text" id="newClientState" name="state" placeholder="State/Province" autocomplete="address-level1" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <div>
                  <label for="newClientPostalCode" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Postal Code</label>
                  <input type="text" id="newClientPostalCode" name="postalCode" placeholder="12345" autocomplete="postal-code" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                </div>

                <div>
                  <label for="newClientCountry" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Country</label>
                  <input type="text" id="newClientCountry" name="country" placeholder="Country" autocomplete="country-name" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Extra Notes & Preferences -->
        <div style="padding: 24px; background: rgba(36, 29, 53, 0.4); border-radius: 12px; border: 1px solid #2d2e3a; margin-bottom: 24px;">
          <h4 style="color: #ffffff; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Additional Information</h4>
          
          <div style="display: grid; gap: 16px;">
            <div>
              <label for="newClientLanguage" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Preferred Language</label>
              <select id="newClientLanguage" name="preferredLanguage" style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px;">
                <option value="">Select preferred language...</option>
                <optgroup label="Most Common">
                  <option value="English">English</option>
                  <option value="Spanish">Spanish (Español)</option>
                  <option value="French">French (Français)</option>
                  <option value="German">German (Deutsch)</option>
                  <option value="Portuguese">Portuguese (Português)</option>
                  <option value="Italian">Italian (Italiano)</option>
                  <option value="Russian">Russian (Русский)</option>
                  <option value="Chinese">Chinese (中文)</option>
                  <option value="Japanese">Japanese (日本語)</option>
                  <option value="Korean">Korean (한국어)</option>
                  <option value="Arabic">Arabic (العربية)</option>
                  <option value="Hindi">Hindi (हिन्दी)</option>
                </optgroup>
                <optgroup label="European Languages">
                  <option value="Dutch">Dutch (Nederlands)</option>
                  <option value="Polish">Polish (Polski)</option>
                  <option value="Swedish">Swedish (Svenska)</option>
                  <option value="Norwegian">Norwegian (Norsk)</option>
                  <option value="Danish">Danish (Dansk)</option>
                  <option value="Finnish">Finnish (Suomi)</option>
                  <option value="Greek">Greek (Ελληνικά)</option>
                  <option value="Czech">Czech (Čeština)</option>
                  <option value="Romanian">Romanian (Română)</option>
                  <option value="Hungarian">Hungarian (Magyar)</option>
                  <option value="Turkish">Turkish (Türkçe)</option>
                  <option value="Ukrainian">Ukrainian (Українська)</option>
                </optgroup>
                <optgroup label="Asian Languages">
                  <option value="Thai">Thai (ไทย)</option>
                  <option value="Vietnamese">Vietnamese (Tiếng Việt)</option>
                  <option value="Indonesian">Indonesian (Bahasa Indonesia)</option>
                  <option value="Malay">Malay (Bahasa Melayu)</option>
                  <option value="Tagalog">Tagalog (Filipino)</option>
                  <option value="Bengali">Bengali (বাংলা)</option>
                  <option value="Urdu">Urdu (اردو)</option>
                  <option value="Persian">Persian (فارسی)</option>
                </optgroup>
                <optgroup label="Other Languages">
                  <option value="Hebrew">Hebrew (עברית)</option>
                  <option value="Swahili">Swahili (Kiswahili)</option>
                  <option value="Afrikaans">Afrikaans</option>
                  <option value="Catalan">Catalan (Català)</option>
                  <option value="Croatian">Croatian (Hrvatski)</option>
                  <option value="Serbian">Serbian (Српски)</option>
                  <option value="Bulgarian">Bulgarian (Български)</option>
                  <option value="Slovak">Slovak (Slovenčina)</option>
                  <option value="Slovenian">Slovenian (Slovenščina)</option>
                  <option value="Lithuanian">Lithuanian (Lietuvių)</option>
                  <option value="Latvian">Latvian (Latviešu)</option>
                  <option value="Estonian">Estonian (Eesti)</option>
                </optgroup>
              </select>
            </div>

            <div>
              <label for="newClientNotes" style="display: block; color: #9ca3af; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">Notes</label>
              <textarea id="newClientNotes" name="notes" rows="4" placeholder="Add any additional notes about this client..." style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 0 0 0; border-top: 1px solid rgba(255, 255, 255, 0.1);">
          <button type="button" class="btn-calc-ghost" onclick="closeAddClientModal()">Cancel</button>
          <button type="submit" class="btn-calc">Add Client</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CLIENT MODAL - END --> q
  <!-- ============================================ -->

  <!-- Notification Component - Toast Notifications -->
  <style>
    /* Notification Styles - Modern Toast Design */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      transform: translateX(400px);
      background: #1e172e;
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(168, 85, 247, 0.1);
      z-index: 9999;
      min-width: 320px;
      max-width: 420px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0);
      pointer-events: all;
    }

    .notification-icon {
      font-size: 28px;
      min-width: 28px;
      text-align: center;
      filter: drop-shadow(0 0 8px currentColor);
    }

    .notification-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .notification-title {
      font-size: 16px;
      font-weight: 600;
      color: #f3f4f6;
      line-height: 1.3;
    }

    .notification-message {
      font-size: 14px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .notification-close {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
      line-height: 1;
      opacity: 0.6;
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #f3f4f6;
      opacity: 1;
    }

    /* Success variant */
    .notification.success {
      border-color: rgba(16, 185, 129, 0.4);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
    }

    .notification.success .notification-icon {
      color: #10b981;
    }

    /* Error variant */
    .notification.error {
      border-color: rgba(239, 68, 68, 0.4);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
    }

    .notification.error .notification-icon {
      color: #ef4444;
    }

    /* Warning variant */
    .notification.warning {
      border-color: rgba(245, 158, 11, 0.4);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
    }

    .notification.warning .notification-icon {
      color: #f59e0b;
    }

    /* Progress bar animation */
    .notification::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #a855f7, #c084fc);
      border-radius: 0 0 12px 12px;
      animation: notificationProgress 3s linear forwards;
    }

    .notification.success::after {
      background: linear-gradient(90deg, #10b981, #34d399);
    }

    .notification.error::after {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }

    .notification.warning::after {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    @keyframes notificationProgress {
      from {
        width: 100%;
      }
      to {
        width: 0%;
      }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .notification {
        top: 12px;
        right: 12px;
        left: 12px;
        min-width: auto;
        max-width: none;
      }
    }
  </style>

  <!-- Confirm Modal -->
  <div id="adminConfirmModal" class="modal-overlay" style="display: none; z-index: 10002;">
    <div class="modal-card" style="max-width: 500px;">
      <h3 id="adminConfirmTitle" style="color: #ffffff; margin: 0 0 16px 0;">Confirm Action</h3>
      <p id="adminConfirmMessage" style="color: #9ca3af; margin-bottom: 24px;"></p>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="adminConfirmCancel" class="secondary-button" style="padding: 10px 24px;">Cancel</button>
        <button id="adminConfirmOk" class="primary-button" style="padding: 10px 24px;">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Prompt Modal -->
  <div id="adminPromptModal" class="modal-overlay" style="display: none; z-index: 10002;">
    <div class="modal-card" style="max-width: 500px;">
      <h3 id="adminPromptTitle" style="color: #ffffff; margin: 0 0 16px 0;">Enter Value</h3>
      <p id="adminPromptMessage" style="color: #9ca3af; margin-bottom: 16px;"></p>
      <input type="text" id="adminPromptInput" style="width: 100%; padding: 10px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; margin-bottom: 24px;">
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="adminPromptCancel" class="secondary-button" style="padding: 10px 24px;">Cancel</button>
        <button id="adminPromptOk" class="primary-button" style="padding: 10px 24px;">OK</button>
      </div>
    </div>
  </div>

  <!-- Notification HTML -->
  <div id="customNotification" class="notification">
    <div class="notification-icon">✓</div>
    <div class="notification-content">
      <div class="notification-title">Success!</div>
      <div class="notification-message"></div>
    </div>
    <button class="notification-close" onclick="hideNotification()">×</button>
  </div>

  <!-- Define notification functions BEFORE loading external scripts -->
  <script>
    /**
     * Show a toast notification
     * @param {string} message - The notification message
     * @param {string} type - 'success', 'error', or 'warning' (default: 'success')
     * @param {string} title - Optional custom title
     */
    window.showNotification = function(message, type = 'success', title = '') {
      const notification = document.getElementById('customNotification');
      
      // Remove previous type classes
      notification.classList.remove('success', 'error', 'warning');
      
      // Set icon and title based on type
      let icon = '✓';
      let notificationTitle = title || 'Success!';
      
      if (type === 'error') {
        icon = '✕';
        notificationTitle = title || 'Error';
      } else if (type === 'warning') {
        icon = '⚠';
        notificationTitle = title || 'Warning';
      }
      
      // Update content
      notification.querySelector('.notification-icon').textContent = icon;
      notification.querySelector('.notification-title').textContent = notificationTitle;
      notification.querySelector('.notification-message').textContent = message;
      
      // Add type class and show
      notification.classList.add(type);
      notification.classList.add('show');
      
      // Auto-hide after 5 seconds (longer so it's visible after modal closes)
      setTimeout(() => {
        hideNotification();
      }, 5000);
    }

    /**
     * Manually hide the notification
     */
    window.hideNotification = function() {
      const notification = document.getElementById('customNotification');
      notification.classList.remove('show');
    }
  </script>

  <!-- Upload Model Script -->
  <script src="../js/upload-model.js" defer></script>

</body>
</html>
