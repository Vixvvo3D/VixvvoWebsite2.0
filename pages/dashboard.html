<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<!-- Initialize Firebase and Google Maps - must load immediately after Firebase SDKs -->
<script src="../js/dashboard.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="../css/shared-styles.css">
<link rel="stylesheet" href="../css/dashboard.css">
<link rel="stylesheet" href="../css/notification-modals.css">

<!-- Load shared navbar components -->
<script src="../js/navbar-helper.js" defer></script>
<script src="../js/navbar-loader.js" defer></script>
<script src="../js/settings-dropdown.js" defer></script>
<script src="../js/navbar-auth.js" defer></script>
<script src="../js/auth.js" defer></script>
<script src="../js/currency.js" defer></script>

<!-- Google Places API for Address Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN2UpD_xHvxrQ2LQjDHIlLmuRi8e4wAQQ&loading=async&libraries=places&callback=initGoogleMaps" async defer></script>
</head>
<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <span class="sidebar-brand">VIXVVO</span>
      </div>
      <span class="sidebar-subtitle">TOOLS</span>
    </div>

    <ul class="sidebar-menu">
      <li>
        <a href="#" class="nav-link active" data-page="dashboard">
          <span class="sidebar-icon"><img src="../images/Icons/House.svg" alt="Dashboard"></span>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="calculator">
          <span class="sidebar-icon"><img src="../images/Icons/Calculator.svg" alt="Calculator"></span>
          <span>Calculator</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="upload-model">
          <span class="sidebar-icon"><img src="../images/Icons/Upload.svg" alt="Upload"></span>
          <span>Upload Model</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="orders">
          <span class="sidebar-icon"><img src="../images/Icons/ShoppingCart.svg" alt="Orders"></span>
          <span>Orders</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="tools">
          <span class="sidebar-icon"><img src="../images/Icons/Toolbox.svg" alt="Tools"></span>
          <span>Tools</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="activity">
          <span class="sidebar-icon"><img src="../images/Icons/Clock.svg" alt="Activity"></span>
          <span>Activity</span>
        </a>
      </li>
      <li>
        <a href="#" class="nav-link" data-page="settings">
          <span class="sidebar-icon"><img src="../images/Icons/GearSix.svg" alt="Settings"></span>
          <span>Settings</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Dashboard -->
  <div class="dashboard-wrapper">
    <!-- Dashboard Content -->
    <main class="dashboard-content">
      <div class="content-container">
        <!-- Header -->
        <header class="dashboard-header">
          <div class="header-left">
            <h1 id="greeting">Loading...</h1>
            <p class="header-date" id="current-date">Loading...</p>
          </div>
          <div class="header-right">
            <button class="header-icon-btn" title="Search">
              <img src="../images/Icons/MagnifyingGlass.svg" alt="Search">
            </button>
            
            <!-- Currency Selector -->
            <div class="currency-selector-wrapper">
              <select id="currencySelector" class="currency-selector" title="Select Currency">
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="GBP">GBP (£)</option>
                <option value="JPY">JPY (¥)</option>
                <option value="CNY">CNY (¥)</option>
                <option value="CAD">CAD ($)</option>
                <option value="AUD">AUD ($)</option>
                <option value="CHF">CHF (Fr)</option>
                <option value="INR">INR (₹)</option>
                <option value="MXN">MXN ($)</option>
                <option value="BRL">BRL (R$)</option>
                <option value="ZAR">ZAR (R)</option>
                <option value="KRW">KRW (₩)</option>
                <option value="SGD">SGD ($)</option>
                <option value="NZD">NZD ($)</option>
                <option value="SEK">SEK (kr)</option>
                <option value="NOK">NOK (kr)</option>
                <option value="DKK">DKK (kr)</option>
                <option value="PLN">PLN (zł)</option>
                <option value="THB">THB (฿)</option>
                <option value="IDR">IDR (Rp)</option>
                <option value="HUF">HUF (Ft)</option>
                <option value="CZK">CZK (Kč)</option>
                <option value="ILS">ILS (₪)</option>
                <option value="CLP">CLP ($)</option>
                <option value="PHP">PHP (₱)</option>
                <option value="AED">AED (د.إ)</option>
                <option value="SAR">SAR (﷼)</option>
                <option value="MYR">MYR (RM)</option>
                <option value="RON">RON (lei)</option>
              </select>
              <button id="saveCurrencyBtn" class="header-icon-btn" title="Save Currency Preference" style="margin-left: 8px;">
                <img src="../images/Icons/Check.svg" alt="Save">
              </button>
            </div>
            
            <button class="header-icon-btn" title="Notifications">
              <img src="../images/Icons/Bell.svg" alt="Notifications">
            </button>
            <div class="user-avatar" id="user-avatar">?</div>
          </div>
        </header>

        <!-- Page Content Container - Dynamically changes based on sidebar selection -->
        <div id="page-content-wrapper">
          <!-- DASHBOARD SECTION -->
          <div class="page-section active" id="dashboard-section">
            <!-- Stats Cards -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon"><img src="../images/Icons/Ruler.svg" alt="Calculations"></div>
                <div class="stat-value" id="total-calculations">0</div>
                <div class="stat-label">Total Calculations</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><img src="../images/Icons/Cube.svg" alt="Models"></div>
                <div class="stat-value" id="models-uploaded">0</div>
                <div class="stat-label">Models Uploaded</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon"><img src="../images/Icons/Package.svg" alt="Orders"></div>
                <div class="stat-value" id="active-orders">0</div>
                <div class="stat-label">Active Orders</div>
              </div>
              <div class="stat-card add-new" id="add-metric">
                <div class="add-icon">+</div>
                <div class="add-text">Add New</div>
                <div class="add-subtext">Track more metrics</div>
              </div>
            </div>      <!-- Main Grid -->
      <div class="main-grid">
        <!-- Chart Card -->
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Activity Overview</h3>
            <div class="time-filter">
              <span>Last month</span>
              <span>▼</span>
            </div>
          </div>
          <div class="chart-area">
            <div class="chart-placeholder">
              <div class="chart-line"></div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-card">
          <div class="chart-header">
            <h3 class="chart-title">Quick Actions</h3>
          </div>
          <ul class="action-list">
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/Calculator.svg" alt="Calculator"></div>
                <div class="action-details">
                  <h4>Price Calculator</h4>
                  <p>Calculate print costs</p>
                </div>
              </div>
              <button class="action-btn" onclick="window.location.href='calculator.html'">Start</button>
            </li>
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/Upload.svg" alt="Upload"></div>
                <div class="action-details">
                  <h4>Upload Model</h4>
                  <p>Add new 3D model</p>
                </div>
              </div>
              <button class="action-btn" onclick="window.location.href='upload-model.html'">Upload</button>
            </li>
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/ShoppingCart.svg" alt="Orders"></div>
                <div class="action-details">
                  <h4>View Orders</h4>
                  <p>Check order status</p>
                </div>
              </div>
              <button class="action-btn" onclick="window.location.href='orders.html'">View</button>
            </li>
            <li class="action-item">
              <div class="action-info">
                <div class="action-avatar"><img src="../images/Icons/Toolbox.svg" alt="Tools"></div>
                <div class="action-details">
                  <h4>More Tools</h4>
                  <p>Explore all features</p>
                </div>
              </div>
              <button class="action-btn" onclick="window.location.href='more-tools.html'">Explore</button>
            </li>
          </ul>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="activity-section">
        <div class="section-header">
          <h2 class="section-title">Recent Activity</h2>
          <a href="#" class="view-all">View all →</a>
        </div>
        <div class="activity-list" id="activity-list">
          <div class="activity-item">
            <div style="display: flex; align-items: center;">
              <div class="activity-icon"><img src="../images/Icons/Calculator.svg" alt="Calculation"></div>
              <div class="activity-content">
                <h4>Price calculation completed</h4>
                <p>Standard PLA print calculation</p>
              </div>
            </div>
            <span class="activity-time">2 hours ago</span>
          </div>
        </div>
      </div>
          </div>
          <!-- END DASHBOARD SECTION -->

          <!-- CALCULATOR SECTION -->
          <div class="page-section" id="calculator-section">
            <div class="calculator-container">
              <div class="calculator-header">
                <h2 class="calculator-title">
                  3D Printing <span class="highlight">Cost Calculator</span>
                </h2>
                <p class="calculator-subtitle">Calculate accurate costs for your 3D printing projects</p>
              </div>

              <!-- Tabs -->
              <div class="calc-tabs">
                <button class="calc-tab active" onclick="switchCalcTab('calculator')">
                  <img src="../images/Icons/Calculator.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Calculator
                </button>
                <button class="calc-tab" onclick="switchCalcTab('printers')">
                  <img src="../images/Icons/Printer.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Printer Presets
                </button>
                <button class="calc-tab" onclick="switchCalcTab('filaments')">
                  <img src="../images/Icons/Yarn.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Filament Presets
                </button>
                <button class="calc-tab" onclick="switchCalcTab('userPresets')">
                  <img src="../images/Icons/User.svg" alt="" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle; opacity: 0.7;">
                  Your Presets
                </button>
              </div>

              <!-- Calculator Tab -->
              <div id="calculatorTab" class="calc-tab-content active">
                <div class="calculator-grid">
                  <!-- Left Column - Input Categories -->
                  <div class="calc-inputs-wrapper">
                    
                    <!-- Printer & Filament Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Printer.svg" alt="">
                        Printer & Filament
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Select Printer</label>
                          <select id="printerSelect">
                            <option value="">Choose a printer...</option>
                          </select>
                        </div>
                        <div class="form-group">
                          <label>Select Filament</label>
                          <select id="filamentSelect">
                            <option value="">Choose filament...</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group" id="printerCostBox" style="display: none;">
                          <label>Printer Cost</label>
                          <div id="printerCostInfo" style="padding: 12px; background: #0a0a0a; border-radius: 8px; color: #ffffff; font-size: 14px; border: 1px solid #2a2a2a;">-</div>
                        </div>
                        <div class="form-group" id="filamentCostBox" style="display: none;">
                          <label>Filament Cost</label>
                          <div id="filamentCostInfo" style="padding: 12px; background: #0a0a0a; border-radius: 8px; color: #ffffff; font-size: 14px; border: 1px solid #2a2a2a;">-</div>
                        </div>
                      </div>
                      <div class="form-group" style="display: flex; align-items: center; gap: 10px; flex-direction: row;">
                        <input type="checkbox" id="includePrinterDepreciation" checked style="width: auto; cursor: pointer;">
                        <label for="includePrinterDepreciation" style="cursor: pointer; margin: 0;">Include Printer Depreciation in Cost</label>
                      </div>
                    </div>

                    <!-- Print Parameters Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Ruler.svg" alt="">
                        Print Parameters
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Print Time (hours)</label>
                          <input type="number" id="printTime" placeholder="0" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                          <label>Filament Weight (g)</label>
                          <input type="number" id="weight" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Time to Print (duplicate)</label>
                          <input type="number" id="printTimeDuplicate" placeholder="0" min="0" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                          <label>Electricity Cost (<span data-currency-label>USD ($)</span>/kWh)</label>
                          <input type="number" id="elec" placeholder="0.12" min="0" step="0.01" value="0.12">
                        </div>
                      </div>
                    </div>

                    <!-- Post-Processing Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Scissors.svg" alt="">
                        Post-Processing
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Job Removal (min)</label>
                          <input type="number" id="jobRemoval" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                          <label>Support Removal (min)</label>
                          <input type="number" id="supportRemoval" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Additional Work (min)</label>
                        <input type="number" id="additionalWork" placeholder="0" min="0" step="0.1" value="0">
                      </div>
                      <div class="form-group">
                        <label>Labor Rate (<span data-currency-label>USD ($)</span>/h)</label>
                        <input type="number" id="postProcessingRate" placeholder="20" min="0" step="0.5" value="20">
                      </div>
                    </div>

                    <!-- Preparation Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Wrench.svg" alt="">
                        Preparation
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Model Prep (min)</label>
                          <input type="number" id="modelPrep" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                          <label>Slicing (min)</label>
                          <input type="number" id="slicing" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Material Change (min)</label>
                          <input type="number" id="materialChange" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                        <div class="form-group">
                          <label>Transfer & Start (min)</label>
                          <input type="number" id="transferStart" placeholder="0" min="0" step="0.1" value="0">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Labor Rate (<span data-currency-label>USD ($)</span>/h)</label>
                        <input type="number" id="preparationRate" placeholder="20" min="0" step="0.5" value="20">
                      </div>
                    </div>

                    <!-- Markups & Failures Card -->
                    <div class="calc-card">
                      <h3>
                        <img src="../images/Icons/Percent.svg" alt="">
                        Markups & Failures
                      </h3>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Filament Markup (×)</label>
                          <input type="number" id="filamentMarkup" placeholder="2.7" min="1" step="0.1" value="2.7">
                        </div>
                        <div class="form-group">
                          <label>General Markup (%)</label>
                          <input type="number" id="generalMarkup" placeholder="50" min="0" step="1" value="50">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Failure Rate (%)</label>
                        <input type="number" id="failureRate" placeholder="10" min="0" max="100" step="1" value="10">
                      </div>
                    </div>

                    <!-- Calculate Button Card -->
                    <div class="calc-card" style="text-align: center;">
                      <button id="btnCalculate" class="btn-calc" style="width: 100%; padding: 16px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="../../images/Icons/Calculator.svg" alt="" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
                        Calculate Cost
                      </button>
                      <div id="calculationLimitInfo" style="text-align: center; margin-top: 12px; font-size: 12px; color: #6b7280;">
                        <!-- Will show calculation usage for tier limits -->
                      </div>
                    </div>

                  </div>

                  <!-- Right Column - Presets and Results -->
                  <div class="calc-right-wrapper">
                    <!-- Presets Card -->
                    <div class="calc-card">
                      <div class="calc-card-header">
                        <h3>
                          <img src="../images/Icons/Faders.svg" alt="">
                          Print Detail Presets
                        </h3>
                        <button id="btnResetCalculator" class="btn-calc-ghost btn-small">Reset</button>
                      </div>
                      <span id="presetLimitInfo" style="font-size: 13px; color: #9ca3af; display: block; margin-bottom: 16px; font-weight: 500;"></span>
                      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button id="btnSavePreset" class="btn-calc" style="flex: 1;">Save Current Settings</button>
                        <button id="btnManagePresets" class="btn-calc-ghost" style="flex: 1;">Manage Presets</button>
                      </div>
                      <div id="presetQuickAccess" style="display: none;">
                        <label style="font-size: 12px; color: #6b7280; margin-bottom: 8px; display: block;">Quick Load:</label>
                        <div id="presetButtons" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                      </div>
                    </div>

                    <!-- Results Card -->
                    <div class="calc-card results-card">
                      <h3>
                        <img src="../images/Icons/ChartPie.svg" alt="">
                        Cost Breakdown
                      </h3>
                    <div id="resultsContent">
                      <div class="result-item">
                        <span class="result-label">Printer Depreciation</span>
                        <span class="result-value" id="printerCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <div>
                          <div class="result-label">Filament Cost</div>
                          <div class="result-sublabel" id="filamentDetails"></div>
                        </div>
                        <span class="result-value" id="filamentCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <div>
                          <div class="result-label">Electricity Cost</div>
                          <div class="result-sublabel" id="electricityDetails"></div>
                        </div>
                        <span class="result-value" id="electricityCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <div>
                          <div class="result-label">Labor Cost</div>
                          <div class="result-sublabel" id="laborDetails"></div>
                        </div>
                        <span class="result-value" id="laborCost">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">Subtotal (before markup)</span>
                        <span class="result-value" id="subtotal">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">General Markup Applied</span>
                        <span class="result-value" id="markupAmount">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">Failure Rate Adjustment</span>
                        <span class="result-value" id="failureCostDisplay">$0.00</span>
                      </div>
                      <div class="result-item">
                        <span class="result-label">Total Price</span>
                        <span class="result-value" id="totalCost">$0.00</span>
                      </div>
                    </div>
                    <p class="calc-note" id="handTimeNote">Unbilled hand time: 0.00 hours</p>
                  </div>
                </div>
              </div>
              </div>

              <!-- Printers Tab -->
              <div id="printersTab" class="calc-tab-content">
                <div class="calc-card">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">Printers Library</h3>
                    <button id="btnAddGlobalPrinter" class="btn-calc btn-small" style="display: none;">+ Add Global Printer</button>
                  </div>
                  <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                    Browse available printer presets with their depreciation costs.
                  </p>
                  <div id="printersList">
                    <div class="empty-state">
                      <div class="empty-state-icon">
                        <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
                      </div>
                      <p>Loading printers...</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Filaments Tab -->
              <div id="filamentsTab" class="calc-tab-content">
                <div class="calc-card">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">Filaments Library</h3>
                    <button id="btnAddGlobalFilament" class="btn-calc btn-small" style="display: none;">+ Add Global Filament</button>
                  </div>
                  <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                    Browse available filament presets with pricing information.
                  </p>
                  <div id="filamentsList">
                    <div class="empty-state">
                      <div class="empty-state-icon">
                        <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
                      </div>
                      <p>Loading filaments...</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- User Presets Tab -->
              <div id="userPresetsTab" class="calc-tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                  
                  <!-- Your Printers Section -->
                  <div class="calc-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                      <h3 style="margin: 0;">Your Printers Library</h3>
                      <div style="display: flex; gap: 8px;">
                        <button id="btnToggleUserPrinterMassDelete" class="btn-calc-ghost btn-small" style="display:none;">Mass Delete</button>
                        <button id="btnAddUserPrinter" class="btn-calc btn-small" style="display:none;">+ Add Printer</button>
                      </div>
                    </div>
                    <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                      Your personal printers library. These are only visible to you and can be customized for your specific needs.
                    </p>
                    
                    <!-- Mass Delete Controls -->
                    <div id="userPrinterMassDeleteControls" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                          <input type="checkbox" id="selectAllUserPrinters" style="width: auto; cursor: pointer;">
                          <label for="selectAllUserPrinters" style="cursor: pointer; margin: 0; font-weight: 600;">Select All</label>
                          <span id="userPrinterSelectedCount" style="color: #6b7280; font-size: 13px;">0 selected</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                          <button id="btnDeleteSelectedUserPrinters" class="btn-calc-ghost" style="border-color: #ef4444; color: #ef4444; padding: 8px 16px; font-size: 13px;">Delete Selected</button>
                          <button id="btnCancelUserPrinterMassDelete" class="btn-calc-ghost" style="padding: 8px 16px; font-size: 13px;">Cancel</button>
                        </div>
                      </div>
                    </div>
                    
                    <div id="userPrintersListContainer" style="display: none;">
                      <div id="userPrintersMassDeleteList"></div>
                    </div>
                    <div id="userPrintersList">
                      <div class="empty-state">
                        <div class="empty-state-icon">
                          <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
                        </div>
                        <p>Login to manage your personal printers</p>
                      </div>
                    </div>
                  </div>

                  <!-- Your Filaments Section -->
                  <div class="calc-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                      <h3 style="margin: 0;">Your Filaments Library</h3>
                      <div style="display: flex; gap: 8px;">
                        <button id="btnToggleUserFilamentMassDelete" class="btn-calc-ghost btn-small" style="display:none;">Mass Delete</button>
                        <button id="btnAddUserFilament" class="btn-calc btn-small" style="display:none;">+ Add Filament</button>
                      </div>
                    </div>
                    <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                      Your personal filaments library. These are only visible to you and can be customized for your specific needs.
                    </p>
                    
                    <!-- Mass Delete Controls -->
                    <div id="userFilamentMassDeleteControls" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                          <input type="checkbox" id="selectAllUserFilaments" style="width: auto; cursor: pointer;">
                          <label for="selectAllUserFilaments" style="cursor: pointer; margin: 0; font-weight: 600;">Select All</label>
                          <span id="userFilamentSelectedCount" style="color: #6b7280; font-size: 13px;">0 selected</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                          <button id="btnDeleteSelectedUserFilaments" class="btn-calc-ghost" style="border-color: #ef4444; color: #ef4444; padding: 8px 16px; font-size: 13px;">Delete Selected</button>
                          <button id="btnCancelUserFilamentMassDelete" class="btn-calc-ghost" style="padding: 8px 16px; font-size: 13px;">Cancel</button>
                        </div>
                      </div>
                    </div>
                    
                    <div id="userFilamentsListContainer" style="display: none;">
                      <div id="userFilamentsMassDeleteList"></div>
                    </div>
                    <div id="userFilamentsList">
                      <div class="empty-state">
                        <div class="empty-state-icon">
                          <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
                        </div>
                        <p>Login to manage your personal filaments</p>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

          <!-- Save Preset Modal -->
          <div id="savePresetModal" style="display: none;">
            <div class="modal-card">
              <h3>Save Preset</h3>
              <p class="modal-subtitle">Save your current print settings for quick access later.</p>
              
              <label>Preset Name</label>
              <input id="presetName" type="text" placeholder="e.g., Standard Mini Print" maxlength="30">
              <div id="presetSaveErr" class="err" style="display: none;"></div>
              <div id="presetSaveInfo" class="modal-hint"></div>
              
              <div class="modal-buttons">
                <button id="doSavePreset" class="btn btn-primary">Save Preset</button>
                <button id="closeSavePreset" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Manage Presets Modal -->
          <div id="managePresetsModal" style="display: none;">
            <div class="modal-card" style="max-width: 600px;">
              <h3>Manage Presets</h3>
              <p class="modal-subtitle">Load or delete your saved print settings.</p>
              
              <div id="presetsList" style="max-height: 400px; overflow-y: auto; margin: 16px 0;"></div>
              <div id="noPresetsMessage" style="text-align: center; padding: 32px; color: rgba(255, 255, 255, 0.4); display: none;">
                <p style="font-size: 16px; margin-bottom: 8px;">No presets saved yet</p>
                <p style="font-size: 13px;">Save your first preset to quickly load print settings!</p>
              </div>
              
              <div class="modal-buttons">
                <button id="closeManagePresets" class="btn btn-ghost">Close</button>
              </div>
            </div>
          </div>

          <!-- Add Printer Modal -->
          <div id="printerModal" style="display: none;">
            <div class="modal-card modal-wide">
              <button class="modal-close" id="closePrinterX">×</button>
              
              <h3 id="printerModalTitle">Add Your Printer</h3>
              <p class="modal-subtitle">Add a printer to your personal library.</p>
              
              <div class="modal-two-column">
                <!-- Left Column: Manual Input -->
                <div class="modal-column">
                  <label>Printer Name</label>
                  <input id="printerName" type="text" placeholder="e.g., i3 MK3">
                  
                  <label>Brand</label>
                  <input id="printerBrand" type="text" placeholder="e.g., Prusa">
                  
                  <label>Printer Price ($)</label>
                  <input id="printerPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
                  
                  <label>Expected Lifespan (hours)</label>
                  <input id="printerLifespan" type="number" placeholder="e.g., 5000" min="1" step="1" value="5000">
                  
                  <div class="modal-hint">
                    Depreciation will be calculated as: Price ÷ Lifespan
                  </div>
                </div>
                
                <!-- Right Column: Batch Add -->
                <div class="modal-column">
                  <label>Batch Add (paste multiple)</label>
                  <textarea id="printerQuickAdd" 
                    placeholder='["X-Smart 1", "QIDI", 299, 5000]; ["X-Smart 2", "QIDI", 299, 5000]'
                    style="flex: 1; min-height: 200px;"></textarea>
                  
                  <button id="btnParseQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; margin-bottom: 8px;">
                    Add All Printers
                  </button>
                  
                  <div class="modal-format-hint">
                    <strong>Format:</strong> ["Name", "Brand", Price, Lifespan]<br>
                    <strong>Example:</strong> ["i3 MK3S+", "Prusa", 1099, 5000]; ["Ender 3", "Creality", 259, 3000]
                  </div>
                </div>
              </div>
              
              <div id="printerErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="savePrinter" class="btn btn-primary">Save Printer</button>
                <button id="closePrinter" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Filament Modal -->
          <div id="filamentModal" style="display: none;">
            <div class="modal-card modal-wide">
              <button class="modal-close" id="closeFilamentX">×</button>
              
              <h3 id="filamentModalTitle">Add Your Filament</h3>
              <p class="modal-subtitle">Add a filament to your personal library.</p>
              
              <div class="modal-two-column">
                <!-- Left Column: Manual Input -->
                <div class="modal-column">
                  <label>Filament Type</label>
                  <input id="filamentType" type="text" placeholder="e.g., PLA">
                  
                  <label>Brand</label>
                  <input id="filamentBrand" type="text" placeholder="e.g., Hatchbox">
                  
                  <label>Spool Weight (g)</label>
                  <input id="spoolWeight" type="number" placeholder="1000" min="1" step="1" value="1000">
                  
                  <label>Cost Per Spool ($)</label>
                  <input id="spoolCost" type="number" placeholder="20.00" min="0" step="0.01">
                  
                  <div class="modal-hint">
                    Cost per gram will be calculated as: Spool Cost ÷ Spool Weight
                  </div>
                </div>
                
                <!-- Right Column: Batch Add -->
                <div class="modal-column">
                  <label>Batch Add (paste multiple)</label>
                  <textarea id="filamentQuickAdd" 
                    placeholder='["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]'
                    style="flex: 1; min-height: 200px;"></textarea>
                  
                  <button id="btnParseFilamentQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; margin-bottom: 8px;">
                    Add All Filaments
                  </button>
                  
                  <div class="modal-format-hint">
                    <strong>Format:</strong> ["Type", "Brand", Weight, Cost]<br>
                    <strong>Example:</strong> ["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]
                  </div>
                </div>
              </div>
              
              <div id="filamentErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveFilament" class="btn btn-primary">Save Filament</button>
                <button id="closeFilament" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Edit Global Printer Modal (Admin Only) -->
          <div id="editGlobalPrinterModal" style="display: none;">
            <div class="modal-card">
              <button class="modal-close" id="closeEditGlobalPrinterX">×</button>
              
              <h3 id="editGlobalPrinterTitle">Edit Global Printer</h3>
              <p class="modal-subtitle">Edit this printer preset (admin only).</p>
              
              <input type="hidden" id="editGlobalPrinterOriginalName">
              
              <label>Printer Name</label>
              <input id="editGlobalPrinterName" type="text" placeholder="e.g., i3 MK3">
              
              <label>Brand</label>
              <input id="editGlobalPrinterBrand" type="text" placeholder="e.g., Prusa">
              
              <label>Printer Price ($)</label>
              <input id="editGlobalPrinterPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
              
              <label>Expected Lifespan (hours)</label>
              <input id="editGlobalPrinterLifespan" type="number" placeholder="e.g., 5000" min="1" step="1">
              
              <div class="modal-hint">
                Depreciation: Price ÷ Lifespan = <span id="editGlobalPrinterDepreciation">-</span>/hr
              </div>
              
              <div id="editGlobalPrinterErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveEditGlobalPrinter" class="btn btn-primary">Save Changes</button>
                <button id="closeEditGlobalPrinter" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Edit Global Filament Modal (Admin Only) -->
          <div id="editGlobalFilamentModal" style="display: none;">
            <div class="modal-card">
              <button class="modal-close" id="closeEditGlobalFilamentX">×</button>
              
              <h3 id="editGlobalFilamentTitle">Edit Global Filament</h3>
              <p class="modal-subtitle">Edit this filament preset (admin only).</p>
              
              <input type="hidden" id="editGlobalFilamentOriginalType">
              
              <label>Filament Type</label>
              <input id="editGlobalFilamentType" type="text" placeholder="e.g., PLA">
              
              <label>Brand</label>
              <input id="editGlobalFilamentBrand" type="text" placeholder="e.g., Hatchbox">
              
              <label>Spool Weight (g)</label>
              <input id="editGlobalFilamentWeight" type="number" placeholder="1000" min="1" step="1">
              
              <label>Cost Per Spool ($)</label>
              <input id="editGlobalFilamentCost" type="number" placeholder="20.00" min="0" step="0.01">
              
              <div class="modal-hint">
                Cost per gram: <span id="editGlobalFilamentCostPerG">-</span>
              </div>
              
              <div id="editGlobalFilamentErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveEditGlobalFilament" class="btn btn-primary">Save Changes</button>
                <button id="closeEditGlobalFilament" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Global Printer Modal (Admin Only) -->
          <div id="addGlobalPrinterModal" style="display: none;">
            <div class="modal-card">
              <button class="modal-close" id="closeAddGlobalPrinterX">×</button>
              
              <h3>Add Global Printer</h3>
              <p class="modal-subtitle">Add a new printer preset to the global library (admin only).</p>
              
              <label>Printer Name</label>
              <input id="addGlobalPrinterName" type="text" placeholder="e.g., i3 MK3">
              
              <label>Brand</label>
              <input id="addGlobalPrinterBrand" type="text" placeholder="e.g., Prusa">
              
              <label>Printer Price ($)</label>
              <input id="addGlobalPrinterPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
              
              <label>Expected Lifespan (hours)</label>
              <input id="addGlobalPrinterLifespan" type="number" placeholder="e.g., 5000" min="1" step="1" value="5000">
              
              <div class="modal-hint">
                Depreciation: <span id="addGlobalPrinterDepreciation">-</span>/hr
              </div>
              
              <div id="addGlobalPrinterErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveAddGlobalPrinter" class="btn btn-primary">Add Printer</button>
                <button id="closeAddGlobalPrinter" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Global Filament Modal (Admin Only) -->
          <div id="addGlobalFilamentModal" style="display: none;">
            <div class="modal-card">
              <button class="modal-close" id="closeAddGlobalFilamentX">×</button>
              
              <h3>Add Global Filament</h3>
              <p class="modal-subtitle">Add a new filament preset to the global library (admin only).</p>
              
              <label>Filament Type</label>
              <input id="addGlobalFilamentType" type="text" placeholder="e.g., PLA">
              
              <label>Brand</label>
              <input id="addGlobalFilamentBrand" type="text" placeholder="e.g., Hatchbox">
              
              <label>Spool Weight (g)</label>
              <input id="addGlobalFilamentWeight" type="number" placeholder="1000" min="1" step="1" value="1000">
              
              <label>Cost Per Spool ($)</label>
              <input id="addGlobalFilamentCost" type="number" placeholder="20.00" min="0" step="0.01">
              
              <div class="modal-hint">
                Cost per gram: <span id="addGlobalFilamentCostPerG">-</span>
              </div>
              
              <div id="addGlobalFilamentErr" class="err" style="display: none;"></div>
              
              <div class="modal-buttons">
                <button id="saveAddGlobalFilament" class="btn btn-primary">Add Filament</button>
                <button id="closeAddGlobalFilament" class="btn btn-ghost">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Notification Modal -->
          <div id="adminNotificationModal" class="modal-overlay" style="display: none;">
            <div class="modal-card" style="max-width: 500px;">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <div id="adminNotificationIcon" class="notification-icon">
                  <!-- Icon will be set dynamically -->
                </div>
                <h3 id="adminNotificationTitle" style="margin: 0; flex: 1;">Notification</h3>
              </div>
              <p id="adminNotificationMessage" style="color: #9ca3af; margin-bottom: 24px; line-height: 1.6;"></p>
              <div class="modal-buttons">
                <button id="adminNotificationOk" class="btn btn-primary" style="width: 100%;">OK</button>
              </div>
            </div>
          </div>

          <!-- Confirmation Modal -->
          <div id="adminConfirmModal" class="modal-overlay" style="display: none;">
            <div class="modal-card" style="max-width: 500px;">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <div class="notification-icon warning-icon">
                  <img src="../images/Icons/Warning.svg" width="48" height="48" style="filter: brightness(0) saturate(100%) invert(71%) sepia(87%) saturate(1495%) hue-rotate(358deg) brightness(97%) contrast(96%);">
                </div>
                <h3 id="adminConfirmTitle" style="margin: 0; flex: 1;">Confirm Action</h3>
              </div>
              <p id="adminConfirmMessage" style="color: #9ca3af; margin-bottom: 24px; line-height: 1.6;"></p>
              <div class="modal-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button id="adminConfirmCancel" class="btn btn-ghost" style="width: 100%;">Cancel</button>
                <button id="adminConfirmOk" class="btn btn-primary" style="width: 100%; background: #ef4444; border-color: #ef4444;">Confirm</button>
              </div>
            </div>
          </div>

          <!-- Prompt Modal -->
          <div id="adminPromptModal" class="modal-overlay" style="display: none;">
            <div class="modal-card" style="max-width: 500px;">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <div class="notification-icon input-icon">
                  <img src="../images/Icons/PencilSimple.svg" width="48" height="48" style="filter: brightness(0) saturate(100%) invert(43%) sepia(63%) saturate(1752%) hue-rotate(236deg) brightness(93%) contrast(92%);">
                </div>
                <h3 id="adminPromptTitle" style="margin: 0; flex: 1;">Enter Value</h3>
              </div>
              <p id="adminPromptMessage" style="color: #9ca3af; margin-bottom: 16px; line-height: 1.6;"></p>
              <input id="adminPromptInput" type="text" placeholder="Enter value..." style="width: 100%; margin-bottom: 20px;">
              <div class="modal-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button id="adminPromptCancel" class="btn btn-ghost">Cancel</button>
                <button id="adminPromptOk" class="btn btn-primary">OK</button>
              </div>
            </div>
          </div>

          <!-- UPLOAD MODEL SECTION -->
          <div class="page-section" id="upload-model-section">
            
          </div>

          <!-- ORDERS SECTION -->
          <div class="page-section" id="orders-section">
            <h2 style="margin-bottom: 24px;">Orders Management</h2>
            
            <!-- Action Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; gap: 16px; flex-wrap: wrap;">
              <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
                <div style="flex: 1; min-width: 250px;">
                  <input type="text" id="ordersSearchInput" placeholder="Search orders..." style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
                </div>
                <select id="ordersStatusFilter" style="padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; cursor: pointer;">
                  <option value="all">All Orders</option>
                  <optgroup label="Order Status">
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                  </optgroup>
                  <optgroup label="Payment Status">
                    <option value="paid">Paid</option>
                    <option value="partially">Partially</option>
                    <option value="unpaid">Unpaid</option>
                  </optgroup>
                </select>
              </div>
              <div style="display: flex; gap: 12px;">
                <button class="btn-calc-ghost btn-small" id="btnManageColors">Manage Colors</button>
                <button class="btn-calc btn-small" id="btnNewOrder">New Order</button>
              </div>
            </div>

            <!-- Orders Content -->
            <div id="ordersContent">
              <!-- Orders will be loaded here -->
            </div>
          </div>

          <!-- TOOLS SECTION -->
          <div class="page-section" id="tools-section">
            
          </div>

          <!-- ACTIVITY SECTION -->
          <div class="page-section" id="activity-section">
            
          </div>

          <!-- SETTINGS SECTION -->
          <div class="page-section" id="settings-section">
            <div class="settings-container">
              <div class="settings-group">
                <h3>Account Actions</h3>
                <button class="logout-btn" onclick="handleLogout()">
                  <svg class="logout-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Color Management Modal -->
  <div id="colorManagementModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="max-width: 1400px; width: 95%; max-height: 92vh; overflow-y: auto;">
      <!-- Modal Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h3 style="color: #ffffff; margin: 0 0 4px 0; font-size: 24px; font-weight: 600;">Color Management</h3>
          <p style="font-size: 14px; color: #9ca3af; margin: 0;">Manage your global and personal color libraries</p>
        </div>
        <button class="modal-close" onclick="closeColorManagementModal()">×</button>
      </div>
      
      <!-- Tabs -->
      <div class="preset-tabs" style="margin-bottom: 24px;">
        <button class="preset-tab active" data-tab="globalColors">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <circle cx="8" cy="8" r="6"/>
          </svg>
          Global Colors
        </button>
        <button class="preset-tab" data-tab="userColors">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M8 3c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4z"/>
            <path d="M8 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z"/>
          </svg>
          Your Colors
        </button>
      </div>

      <!-- Global Colors Tab -->
      <div id="globalColors" class="tab-content active">
        <div class="tab-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #2d2e3a;">
          <h4 style="color: #ffffff; margin: 0; font-size: 16px; font-weight: 500;">Global Color Library</h4>
          <div style="display: flex; gap: 8px;">
            <button class="btn-calc-ghost btn-small" id="btnCancelGlobalSelection" style="display: none;" onclick="cancelGlobalSelection()">Cancel</button>
            <button class="btn-calc btn-small" id="btnMassDeleteGlobalColors" style="display: none; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);" onclick="massDeleteGlobalColors()">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M3 3l8 8M11 3l-8 8"/>
              </svg>
              Mass Delete
            </button>
            <button class="btn-calc btn-small" id="btnAddGlobalColor" style="display: none;">+ Add Global Color</button>
          </div>
        </div>
        <div id="globalColorsGrid" class="colors-grid">
          <!-- Global colors will be rendered here -->
        </div>
      </div>

      <!-- User Colors Tab -->
      <div id="userColors" class="tab-content" style="display: none;">
        <div class="tab-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #2d2e3a;">
          <h4 style="color: #ffffff; margin: 0; font-size: 16px; font-weight: 500;">Your Personal Colors</h4>
          <div style="display: flex; gap: 8px;">
            <button class="btn-calc-ghost btn-small" id="btnCancelUserSelection" style="display: none;" onclick="cancelUserSelection()">Cancel</button>
            <button class="btn-calc btn-small" id="btnMassDeleteUserColors" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);" onclick="massDeleteUserColors()">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M3 3l8 8M11 3l-8 8"/>
              </svg>
              Mass Delete
            </button>
            <button class="btn-calc btn-small" id="btnAddUserColor">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                <path d="M8 3v10M3 8h10"/>
              </svg>
              Add Color
            </button>
          </div>
        </div>
        <div id="userColorsGrid" class="colors-grid">
          <!-- User colors will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- New Order Modal -->
  <div id="newOrderModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="max-width: 1600px; width: 95%; max-height: 92vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h3 style="color: #ffffff; margin: 0 0 4px 0; font-size: 24px; font-weight: 600;">Create New Order</h3>
          <p style="font-size: 14px; color: #9ca3af; margin: 0;">Fill in the order details below</p>
        </div>
        <button class="modal-close" onclick="closeNewOrderModal()">×</button>
      </div>

      <form id="newOrderForm">
      <!-- Order Information -->
      <div class="form-section">
        <div class="section-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
            <rect x="3" y="3" width="10" height="10" rx="1"/>
            <path d="M6 6h4M6 8h4M6 10h2"/>
          </svg>
          Order Information
        </div>
        <div class="form-row single">
          <div class="form-group">
            <label for="orderTitle">Order Title *</label>
            <input type="text" id="orderTitle" name="orderTitle" required placeholder="Enter order title">
          </div>
        </div>
      </div>

      <!-- Client Information -->
      <div class="form-section">
        <div class="section-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
            <circle cx="8" cy="5" r="2"/>
            <path d="M3 13c0-2.2 2.2-4 5-4s5 1.8 5 4"/>
          </svg>
          Client Information
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientName">Client Name *</label>
            <input type="text" id="clientName" name="clientName" required placeholder="Enter client name" autocomplete="name">
          </div>
          <div class="form-group">
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" name="clientEmail" placeholder="client@example.com" autocomplete="email">
          </div>
          <div class="form-group">
            <label for="clientPhone">Phone</label>
            <input type="tel" id="clientPhone" name="clientPhone" placeholder="+1 (555) 123-4567" autocomplete="tel">
          </div>
        </div>
        <div class="form-row single">
          <div class="form-group">
            <label for="addressAutocomplete">Address Search</label>
            <input type="text" id="addressAutocomplete" name="addressAutocomplete" placeholder="Start typing address..." autocomplete="street-address">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientStreet">Street Address</label>
            <input type="text" id="clientStreet" name="clientStreet" placeholder="123 Main St" autocomplete="street-address">
          </div>
          <div class="form-group">
            <label for="clientCity">City</label>
            <input type="text" id="clientCity" name="clientCity" placeholder="City" autocomplete="address-level2">
          </div>
          <div class="form-group">
            <label for="clientState">State/Province</label>
            <input type="text" id="clientState" name="clientState" placeholder="State/Province" autocomplete="address-level1">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientPostalCode">Postal Code</label>
            <input type="text" id="clientPostalCode" name="clientPostalCode" placeholder="12345" autocomplete="postal-code">
          </div>
          <div class="form-group">
            <label for="clientCountry">Country</label>
            <input type="text" id="clientCountry" name="clientCountry" placeholder="Country" autocomplete="country-name">
          </div>
          <div class="form-group">
            <label for="messaging_app">Messaging App / Platform</label>
            <div class="messaging-apps">
              <select id="messaging_app" name="messaging_app">
                <option value="">Select messaging app or platform...</option>
                <optgroup label="Messaging Apps">
                  <option value="WhatsApp">WhatsApp</option>
                  <option value="Facebook Messenger">Facebook Messenger</option>
                  <option value="Instagram DM">Instagram Direct Message</option>
                  <option value="Telegram">Telegram</option>
                  <option value="Discord">Discord</option>
                  <option value="WeChat">WeChat</option>
                  <option value="Line">LINE</option>
                  <option value="Viber">Viber</option>
                  <option value="Snapchat">Snapchat</option>
                  <option value="iMessage">iMessage</option>
                  <option value="SMS">SMS/Text Message</option>
                  <option value="Signal">Signal</option>
                  <option value="Kakao Talk">Kakao Talk</option>
                </optgroup>
                <optgroup label="E-Commerce Marketplaces">
                  <option value="Etsy">Etsy</option>
                  <option value="eBay">eBay</option>
                  <option value="Amazon">Amazon</option>
                  <option value="Shopify">Shopify</option>
                  <option value="Facebook Marketplace">Facebook Marketplace</option>
                  <option value="Mercari">Mercari</option>
                  <option value="Poshmark">Poshmark</option>
                  <option value="Depop">Depop</option>
                  <option value="Vinted">Vinted</option>
                  <option value="Craigslist">Craigslist</option>
                  <option value="OfferUp">OfferUp</option>
                  <option value="Letgo">Letgo</option>
                  <option value="AliExpress">AliExpress</option>
                  <option value="Alibaba">Alibaba</option>
                  <option value="Walmart Marketplace">Walmart Marketplace</option>
                  <option value="Target Plus">Target Plus</option>
                  <option value="Wish">Wish</option>
                  <option value="Temu">Temu</option>
                  <option value="Shein">Shein</option>
                </optgroup>
                <optgroup label="Social & Professional">
                  <option value="Twitter DM">Twitter/X Direct Message</option>
                  <option value="LinkedIn Messages">LinkedIn Messages</option>
                  <option value="TikTok">TikTok Shop</option>
                  <option value="Pinterest">Pinterest</option>
                </optgroup>
                <optgroup label="Traditional">
                  <option value="Email">Email</option>
                  <option value="Phone Call">Phone Call</option>
                  <option value="In Person">In Person</option>
                  <option value="Skype">Skype</option>
                  <option value="Slack">Slack</option>
                  <option value="Teams">Microsoft Teams</option>
                </optgroup>
                <optgroup label="Other">
                  <option value="Other">Other</option>
                </optgroup>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Information -->
      <div class="form-section">
        <div class="section-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
            <rect x="2" y="4" width="12" height="10" rx="1"/>
            <path d="M4 4V3a1 1 0 011-1h6a1 1 0 011 1v1"/>
          </svg>
          Product Information
        </div>
        <div class="form-row double">
          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input type="text" id="productName" name="productName" required placeholder="Enter product name">
          </div>
          <div class="form-group">
            <label for="quantity">Quantity *</label>
            <input type="number" id="quantity" name="quantity" required min="1" value="1" placeholder="1">
          </div>
        </div>
      </div>

      <!-- Customization Options -->
      <div class="form-section">
        <div class="section-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
            <circle cx="8" cy="8" r="6"/>
            <path d="M8 5v6M5 8h6"/>
          </svg>
          Customization Options
        </div>
        <div class="form-row single">
          <div class="form-group">
            <label>Color(s) - Select up to 4 colors</label>
            <input type="text" id="colorSearchInput" placeholder="Search colors by name..." 
              style="width: 100%; padding: 12px 16px; background: rgba(36, 29, 53, 0.6); border: 1px solid #2d2e3a; border-radius: 8px; color: #ffffff; font-size: 14px; margin-bottom: 12px;">
            <div id="colorSelectionGrid" class="color-selection-grid">
              <!-- Colors will be populated here -->
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center; padding: 12px; background: rgba(36, 29, 53, 0.3); border-radius: 8px; border: 1px solid #2d2e3a;">
              <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Selected:</span>
              <div id="selectedColorsPreview" style="display: flex; gap: 8px; flex: 1;">
                <!-- Selected colors will appear here -->
              </div>
            </div>
            <input type="hidden" id="color1" value="">
            <input type="hidden" id="color2" value="">
            <input type="hidden" id="color3" value="">
            <input type="hidden" id="color4" value="">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="material">Material</label>
            <select id="material" name="material">
              <option value="">Select material</option>
              <!-- Options will be populated dynamically from Firebase -->
            </select>
          </div>
          <div class="form-group">
            <label for="finish">Finish</label>
            <select id="finish" name="finish">
              <option value="">Select finish</option>
              <option value="Matte">Matte</option>
              <option value="Glossy">Glossy</option>
              <option value="Textured">Textured</option>
              <option value="Smooth">Smooth</option>
            </select>
          </div>
          <div class="form-group">
            <label for="scale">Scale (%)</label>
            <input type="number" id="scale" name="scale" placeholder="100" min="1">
          </div>
        </div>
      </div>

      <!-- Payment Information -->
      <div class="form-section">
        <div class="section-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
            <rect x="2" y="4" width="12" height="8" rx="1"/>
            <path d="M2 7h12"/>
          </svg>
          Payment Information
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="orderTotal">Total Price</label>
            <input type="number" id="orderTotal" name="orderTotal" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="amountPaid">Amount Paid</label>
            <input type="number" id="amountPaid" name="amountPaid" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod" name="paymentMethod">
              <option value="">Not specified</option>
              <optgroup label="Digital Payments">
                <option value="PayPal">PayPal</option>
                <option value="Card">Credit/Debit Card</option>
                <option value="Wire Transfer">Wire Transfer</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Venmo">Venmo</option>
                <option value="Zelle">Zelle</option>
                <option value="Apple Pay">Apple Pay</option>
                <option value="Google Pay">Google Pay</option>
                <option value="Stripe">Stripe</option>
                <option value="Square">Square</option>
              </optgroup>
              <optgroup label="Traditional">
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Money Order">Money Order</option>
              </optgroup>
              <optgroup label="Cryptocurrency">
                <option value="Bitcoin">Bitcoin</option>
                <option value="Ethereum">Ethereum</option>
                <option value="Crypto">Other Cryptocurrency</option>
              </optgroup>
              <optgroup label="Other">
                <option value="Trade/Barter">Trade/Barter</option>
                <option value="Store Credit">Store Credit</option>
                <option value="Other">Other</option>
              </optgroup>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="paymentStatus">Payment Status</label>
            <select id="paymentStatus" name="paymentStatus">
              <option value="unpaid">Unpaid</option>
              <option value="partially">Partially</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="form-group">
            <label for="orderStatus">Order Status</label>
            <select id="orderStatus" name="orderStatus">
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Additional Notes -->
      <div class="form-section">
        <div class="section-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
            <path d="M4 3h8a1 1 0 011 1v9a1 1 0 01-1 1H4a1 1 0 01-1-1V4a1 1 0 011-1z"/>
            <path d="M6 6h4M6 9h4M6 11h2"/>
          </svg>
          Additional Information
        </div>
        <div class="form-row single">
          <div class="form-group">
            <label for="extraNotes">Extra Notes</label>
            <textarea id="extraNotes" name="extraNotes" placeholder="Add any special instructions or notes..."></textarea>
          </div>
        </div>
      </div>

      <!-- Modal Actions -->
      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 1px solid #2d2e3a;">
        <button type="button" class="btn-calc-ghost" onclick="closeNewOrderModal()">Cancel</button>
        <button type="submit" class="btn-calc">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M3 8l3 3 6-6"/>
          </svg>
          Create Order
        </button>
      </div>
      </form>
    </div>
  </div>

  <!-- View Order Modal -->
  <div id="viewOrderModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="max-width: 1400px; width: 95%; max-height: 92vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
          <h3 style="color: #ffffff; margin: 0 0 4px 0; font-size: 24px; font-weight: 600;">Order Details</h3>
          <p style="font-size: 14px; color: #9ca3af; margin: 0;">View and manage order information</p>
        </div>
        <button class="modal-close" onclick="closeViewOrderModal()">×</button>
      </div>

      <div id="viewOrderContent">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>

  <script>
    // Use existing Firebase instance from auth.js
    // auth and db are already declared in the global scope by auth.js
    
    // Page Navigation System
    function switchPage(pageName) {
      // Hide all page sections
      const sections = document.querySelectorAll('.page-section');
      sections.forEach(section => section.classList.remove('active'));
      
      // Show the selected page section
      const targetSection = document.getElementById(pageName + '-section');
      if (targetSection) {
        targetSection.classList.add('active');
      }
      
      // Update active state in sidebar
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => link.classList.remove('active'));
      
      const activeLink = document.querySelector(`[data-page="${pageName}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
      
      // Load data when switching to orders page
      if (pageName === 'orders' && currentUser) {
        loadOrders();
        loadColors(currentUser);
      }
      
      // Update page title and header
      updatePageTitle(pageName);
    }

    function updatePageTitle(pageName) {
      const titles = {
        'dashboard': 'Dashboard',
        'calculator': 'Calculator',
        'upload-model': 'Upload Model',
        'orders': 'Orders',
        'tools': 'Tools',
        'activity': 'Activity',
        'settings': 'Settings'
      };
      
      const descriptions = {
        'dashboard': '', // Will show date
        'calculator': 'Calculate 3D printing costs and pricing',
        'upload-model': 'Upload and manage your 3D models',
        'orders': 'View and track your print orders',
        'tools': 'Explore additional tools and features',
        'activity': 'View your recent activity and history',
        'settings': 'Manage your account and preferences'
      };
      
      document.title = (titles[pageName] || 'Vixvvo') + ' - Vixvvo Tools';
      
      // Update the header greeting/title
      const greetingElement = document.getElementById('greeting');
      const dateElement = document.getElementById('current-date');
      
      if (pageName === 'dashboard') {
        // On dashboard, restore the greeting
        const user = firebase.auth().currentUser;
        if (user) {
          updateGreeting(user);
        }
        updateDate(); // Update with current date
        dateElement.style.display = 'block';
      } else {
        // On other pages, show the page title and description
        greetingElement.textContent = titles[pageName] || 'Vixvvo';
        dateElement.textContent = descriptions[pageName] || '';
        dateElement.style.display = 'block';
      }
    }

    // Initialize Dashboard
    function initializeDashboard() {
      // Update date
      updateDate();
      
      // Setup navigation
      setupNavigation();
      
      // Check authentication - wait for Firebase to be ready
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          updateGreeting(user);
          loadUserStats(user.uid);
          loadRecentActivity(user.uid);
        } else {
          // Double-check: Wait a moment for auth to fully initialize
          // This prevents false redirects when the page first loads
          setTimeout(() => {
            const stillNoUser = firebase.auth().currentUser;
            if (!stillNoUser) {
              // Redirect to home if not logged in
              window.location.href = '../index.html';
            }
          }, 500);
        }
      });
    }

    // Setup navigation event listeners
    function setupNavigation() {
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const pageName = this.getAttribute('data-page');
          switchPage(pageName);
        });
      });
    }

    // Update current date
    function updateDate() {
      const now = new Date();
      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      const dateString = now.toLocaleDateString('en-US', options);
      document.getElementById('current-date').textContent = dateString;
    }

    // Update greeting with user name
    function updateGreeting(user) {
      const hour = new Date().getHours();
      let greeting = 'Hey';
      
      if (hour < 12) greeting = 'Good morning';
      else if (hour < 18) greeting = 'Good afternoon';
      else greeting = 'Good evening';

      // Try to get username from database first, then displayName, then email
      firebase.database().ref(`users/${user.uid}/username`).once('value', (snapshot) => {
        let displayName;
        if (snapshot.exists()) {
          displayName = snapshot.val();
        } else {
          displayName = user.displayName || user.email.split('@')[0];
        }
        
        document.getElementById('greeting').textContent = `${greeting}, ${displayName}!`;
        
        // Update avatar
        const initial = displayName.charAt(0).toUpperCase();
        document.getElementById('user-avatar').textContent = initial;
      });
    }

    // Load user statistics
    function loadUserStats(userId) {
      // Load calculations count
      firebase.database().ref(`users/${userId}/calculations`).once('value', (snapshot) => {
        const count = snapshot.exists() ? snapshot.numChildren() : 0;
        document.getElementById('total-calculations').textContent = count;
      });

      // Load models count
      firebase.database().ref(`users/${userId}/models`).once('value', (snapshot) => {
        const count = snapshot.exists() ? snapshot.numChildren() : 0;
        document.getElementById('models-uploaded').textContent = count;
      });

      // Load orders count
      firebase.database().ref(`users/${userId}/orders`).once('value', (snapshot) => {
        const count = snapshot.exists() ? snapshot.numChildren() : 0;
        document.getElementById('active-orders').textContent = count;
      });
    }

    // Load recent activity
    function loadRecentActivity(userId) {
      const activityList = document.getElementById('activity-list');
      
      firebase.database().ref(`users/${userId}/activity`).limitToLast(5).once('value', (snapshot) => {
        if (snapshot.exists()) {
          activityList.innerHTML = '';
          snapshot.forEach((childSnapshot) => {
            const activity = childSnapshot.val();
            const item = createActivityItem(activity);
            activityList.appendChild(item);
          });
        }
      });
    }

    // Create activity item element
    function createActivityItem(activity) {
      const item = document.createElement('div');
      item.className = 'activity-item';
      
      const icon = getActivityIcon(activity.type);
      const timeAgo = getTimeAgo(activity.timestamp);
      
      item.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div class="activity-icon">${icon}</div>
          <div class="activity-content">
            <h4>${activity.title}</h4>
            <p>${activity.description}</p>
          </div>
        </div>
        <span class="activity-time">${timeAgo}</span>
      `;
      
      return item;
    }

    // Get icon based on activity type
    function getActivityIcon(type) {
      const icons = {
        calculation: 'Calculator.svg',
        upload: 'Upload.svg',
        order: 'ShoppingCart.svg',
        settings: 'GearSix.svg',
        default: 'File.svg'
      };
      return `<img src="../images/Icons/${icons[type] || icons.default}" alt="${type}">`;
    }

    // Calculate time ago
    function getTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
      if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
      if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
      return 'Just now';
    }

    // Handle logout
    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        firebase.auth().signOut().then(() => {
          window.location.href = '../index.html';
        }).catch((error) => {
          console.error('Logout error:', error);
          alert('Error logging out. Please try again.');
        });
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializeDashboard);

    // ===============================================
    // CURRENCY SELECTOR FUNCTIONALITY
    // ===============================================
    
    // Load user's currency preference from Firebase
    async function loadUserCurrency() {
      const user = firebase.auth().currentUser;
      if (!user) {
        window.currentCurrency = 'USD';
        return;
      }
      
      try {
        const snapshot = await firebase.database().ref(`users/${user.uid}/preferences/currency`).once('value');
        const savedCurrency = snapshot.val();
        
        if (savedCurrency) {
          window.currentCurrency = savedCurrency;
          console.log('Loaded currency from Firebase:', savedCurrency);
        } else {
          window.currentCurrency = 'USD';
        }
      } catch (error) {
        console.error('Error loading currency preference:', error);
        window.currentCurrency = 'USD';
      }
    }
    
    // Save user's currency preference to Firebase
    async function saveUserCurrency(currency) {
      const user = firebase.auth().currentUser;
      if (!user) {
        console.warn('No user logged in, cannot save currency preference');
        return false;
      }
      
      try {
        const ref = firebase.database().ref(`users/${user.uid}/preferences/currency`);
        console.log('Attempting to save currency to:', `users/${user.uid}/preferences/currency`);
        console.log('Currency value:', currency);
        
        await ref.set(currency);
        
        console.log('✅ Currency preference saved to Firebase:', currency);
        
        // Verify it was saved
        const verification = await ref.once('value');
        console.log('Verification - saved value:', verification.val());
        
        return true;
      } catch (error) {
        console.error('❌ Error saving currency preference:', error);
        alert('Failed to save currency: ' + error.message);
        return false;
      }
    }
    
    // Initialize currency selector
    async function initializeCurrencySelector() {
      const currencySelector = document.getElementById('currencySelector');
      const saveCurrencyBtn = document.getElementById('saveCurrencyBtn');
      
      if (!currencySelector) {
        console.warn('Currency selector not found in DOM');
        return;
      }
      
      console.log('Initializing currency selector...');
      
      // Load saved currency from Firebase
      await loadUserCurrency();
      currencySelector.value = window.currentCurrency || 'USD';
      
      // Update labels on initial load
      updateAllPriceDisplays();
      
      // Listen for currency changes - AUTO-SAVE and update live
      currencySelector.addEventListener('change', async function() {
        const newCurrency = this.value;
        const oldCurrency = window.currentCurrency;
        window.currentCurrency = newCurrency;
        
        console.log('Currency changed from', oldCurrency, 'to', newCurrency);
        
        // Save to Firebase immediately (auto-save)
        const saved = await saveUserCurrency(newCurrency);
        
        if (saved) {
          // Update all displays live
          updateAllPriceDisplays();
          
          // Re-calculate if there's existing calculation results
          const printerSelect = document.getElementById('printerSelect');
          const filamentSelect = document.getElementById('filamentSelect');
          const totalCostElement = document.getElementById('totalCost');
          
          // If user has selected printer/filament and there are results, recalculate
          if (printerSelect?.value && filamentSelect?.value && totalCostElement) {
            // Check if calculation has been run (totalCost is not the default $0.00)
            const currentTotal = totalCostElement.textContent;
            if (currentTotal !== '$0.00' && currentTotal !== 'USD ($0.00)') {
              calculateCost();
            }
          }
          
          console.log('✅ Currency updated and saved:', newCurrency);
        } else {
          // Revert if save failed
          console.error('❌ Failed to save currency, reverting to:', oldCurrency);
          window.currentCurrency = oldCurrency;
          currencySelector.value = oldCurrency;
        }
      });
      
      // Hide save button since we're auto-saving now
      if (saveCurrencyBtn) {
        saveCurrencyBtn.style.display = 'none';
      }
    }
    
    // Update all price displays when currency changes
    function updateAllPriceDisplays() {
      // Update currency labels in calculator form
      const currencyLabels = document.querySelectorAll('[data-currency-label]');
      currencyLabels.forEach(label => {
        label.textContent = getCurrencyLabel(window.currentCurrency);
      });
      
      // Refresh printer and filament lists with new currency
      if (typeof renderPrintersList === 'function') {
        renderPrintersList();
      }
      if (typeof renderFilamentsList === 'function') {
        renderFilamentsList();
      }
      
      // Refresh dropdowns (these already display updated prices in the options)
      if (typeof renderPrinterSelect === 'function') {
        renderPrinterSelect();
      }
      if (typeof renderFilamentSelect === 'function') {
        renderFilamentSelect();
      }
      
      // Update price info boxes (selected printer/filament costs)
      if (typeof updatePriceInfo === 'function') {
        updatePriceInfo();
      }
      
      // Refresh calculator UI if the external function exists
      if (typeof window.refreshCalculatorCurrency === 'function') {
        window.refreshCalculatorCurrency();
      }
    }
    
    // Initialize currency selector on page load (after auth state is known)
    firebase.auth().onAuthStateChanged((user) => {
      console.log('Auth state changed. User:', user ? user.uid : 'null');
      if (user) {
        console.log('User is logged in, initializing currency selector...');
        initializeCurrencySelector();
      } else {
        console.log('No user logged in, skipping currency selector initialization');
      }
    });

    // ===============================================
    // CALCULATOR FUNCTIONALITY
    // ===============================================
    
    // Calculator State
    let printersData = {};
    let filamentsData = {};
    let userPrintersData = {};
    let userFilamentsData = {};
    let dataLoaded = false;
    let currentUserTier = 'free';
    let calculationsThisMonth = 0;

    // Tier Limits for calculations
    const TIER_CALCULATION_LIMITS = {
      free: 10,
      basic: 50,
      premium: 200,
      professional: 1000,
      admin: Infinity
    };

    // Firebase refs for calculator
    const printersRef = firebase.database().ref('printers');
    const filamentsRef = firebase.database().ref('filaments');
    let userPrintersRef = null;
    let userFilamentsRef = null;

    // Helper functions
    function money(n) {
      // Use formatCurrency if available (from currency.js)
      if (typeof window.formatCurrency === 'function' && window.currentCurrency) {
        return window.formatCurrency(n, window.currentCurrency);
      }
      
      // Fallback if formatCurrency is not loaded yet
      const currency = window.currentCurrency || 'USD';
      const symbol = getCurrencySymbol(currency);
      const amount = (Math.round(n * 100) / 100).toFixed(2);
      return `${currency} ${symbol}${amount}`;
    }

    // Tab switching for calculator
    function switchCalcTab(tabName) {
      document.querySelectorAll('.calc-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.calc-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      if (tabName === 'calculator') {
        document.getElementById('calculatorTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(1)').classList.add('active');
      } else if (tabName === 'printers') {
        document.getElementById('printersTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(2)').classList.add('active');
        renderPrintersList();
      } else if (tabName === 'filaments') {
        document.getElementById('filamentsTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(3)').classList.add('active');
        renderFilamentsList();
      } else if (tabName === 'userPresets') {
        document.getElementById('userPresetsTab').classList.add('active');
        document.querySelector('.calc-tabs .calc-tab:nth-child(4)').classList.add('active');
      }
    }

    /* Presets System */
    const savePresetModal = document.getElementById('savePresetModal');
    const managePresetsModal = document.getElementById('managePresetsModal');
    const printerModal = document.getElementById('printerModal');
    const filamentModal = document.getElementById('filamentModal');
    const btnSavePreset = document.getElementById('btnSavePreset');
    const btnManagePresets = document.getElementById('btnManagePresets');
    const btnCloseSavePreset = document.getElementById('closeSavePreset');
    const btnCloseManagePresets = document.getElementById('closeManagePresets');
    const btnDoSavePreset = document.getElementById('doSavePreset');
    const presetNameInput = document.getElementById('presetName');
    const presetSaveErr = document.getElementById('presetSaveErr');
    const presetSaveInfo = document.getElementById('presetSaveInfo');
    const presetsList = document.getElementById('presetsList');
    const noPresetsMessage = document.getElementById('noPresetsMessage');
    const presetLimitInfo = document.getElementById('presetLimitInfo');
    const presetQuickAccess = document.getElementById('presetQuickAccess');
    const presetButtons = document.getElementById('presetButtons');

    let userPresets = [];
    const MAX_PRESETS_FREE = 2;
    const MAX_PRESETS_PREMIUM = 10;

    // Modal helper functions
    function showModal(modal) {
      if (modal) modal.style.display = 'grid';
    }

    function hideModal(modal) {
      if (modal) modal.style.display = 'none';
    }

    // Get current form data for saving as preset
    function getCurrentPrintDetails() {
      const getValueSafe = (id) => {
        const elem = document.getElementById(id);
        return elem ? elem.value : '';
      };
      
      const getCheckedSafe = (id) => {
        const elem = document.getElementById(id);
        return elem ? elem.checked : true;
      };
      
      return {
        selectedPrinter: getValueSafe('printerSelect'),
        selectedFilament: getValueSafe('filamentSelect'),
        filamentMarkup: getValueSafe('filamentMarkup'),
        generalMarkup: getValueSafe('generalMarkup'),
        failureRate: getValueSafe('failureRate'),
        postProcessingRate: getValueSafe('postProcessingRate'),
        preparationRate: getValueSafe('preparationRate'),
        jobRemoval: getValueSafe('jobRemoval'),
        supportRemoval: getValueSafe('supportRemoval'),
        additionalWork: getValueSafe('additionalWork'),
        modelPrep: getValueSafe('modelPrep'),
        slicing: getValueSafe('slicing'),
        materialChange: getValueSafe('materialChange'),
        transferStart: getValueSafe('transferStart'),
        includePrinterDepreciation: getCheckedSafe('includePrinterDepreciation')
      };
    }

    // Load preset data into form
    function loadPresetData(preset) {
      const setValueSafe = (id, value, defaultValue) => {
        const elem = document.getElementById(id);
        if (elem) {
          elem.value = value || defaultValue;
        }
      };
      
      if (preset.selectedPrinter) {
        setValueSafe('printerSelect', preset.selectedPrinter, '');
      }
      if (preset.selectedFilament) {
        setValueSafe('filamentSelect', preset.selectedFilament, '');
      }
      setValueSafe('filamentMarkup', preset.filamentMarkup, 0);
      setValueSafe('generalMarkup', preset.generalMarkup, 50);
      setValueSafe('failureRate', preset.failureRate, 10);
      setValueSafe('postProcessingRate', preset.postProcessingRate, 20);
      setValueSafe('preparationRate', preset.preparationRate, 20);
      setValueSafe('jobRemoval', preset.jobRemoval, 0);
      setValueSafe('supportRemoval', preset.supportRemoval, 0);
      setValueSafe('additionalWork', preset.additionalWork, 0);
      setValueSafe('modelPrep', preset.modelPrep, 0);
      setValueSafe('slicing', preset.slicing, 0);
      setValueSafe('materialChange', preset.materialChange, 0);
      setValueSafe('transferStart', preset.transferStart, 0);
      
      const includePrinterDepreciation = preset.includePrinterDepreciation !== undefined ? preset.includePrinterDepreciation : true;
      const depreciationCheckbox = document.getElementById('includePrinterDepreciation');
      if (depreciationCheckbox) {
        depreciationCheckbox.checked = includePrinterDepreciation;
      }
      
      updatePriceInfo();
    }

    // Save preset button
    if (btnSavePreset) {
      btnSavePreset.addEventListener('click', () => {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Please login to save presets');
          return;
        }
        
        const maxPresets = currentUserTier === 'admin' || currentUserTier === 'premium' || currentUserTier === 'professional' ? MAX_PRESETS_PREMIUM : MAX_PRESETS_FREE;
        presetSaveInfo.textContent = `You have ${userPresets.length} of ${maxPresets} presets saved`;
        
        if (userPresets.length >= maxPresets) {
          presetSaveErr.textContent = `You've reached the maximum of ${maxPresets} presets. Delete one to save a new preset.`;
          presetSaveErr.style.display = 'block';
        } else {
          presetSaveErr.textContent = '';
          presetSaveErr.style.display = 'none';
        }
        
        presetNameInput.value = '';
        showModal(savePresetModal);
      });
    }

    // Close save preset modal
    if (btnCloseSavePreset) {
      btnCloseSavePreset.addEventListener('click', () => {
        hideModal(savePresetModal);
      });
    }

    // Do save preset
    if (btnDoSavePreset) {
      btnDoSavePreset.addEventListener('click', async () => {
        const user = firebase.auth().currentUser;
        if (!user) return;
        
        const name = presetNameInput.value.trim();
        if (!name) {
          presetSaveErr.textContent = 'Please enter a preset name';
          presetSaveErr.style.display = 'block';
          return;
        }
        
        const maxPresets = currentUserTier === 'admin' || currentUserTier === 'premium' || currentUserTier === 'professional' ? MAX_PRESETS_PREMIUM : MAX_PRESETS_FREE;
        if (userPresets.length >= maxPresets) {
          presetSaveErr.textContent = `Maximum ${maxPresets} presets reached`;
          presetSaveErr.style.display = 'block';
          return;
        }
        
        const presetData = getCurrentPrintDetails();
        const presetId = Date.now().toString();
        
        try {
          await firebase.database().ref(`users/${user.uid}/presets/${presetId}`).set({
            name: name,
            data: presetData,
            createdAt: Date.now()
          });
          
          console.log('Preset saved successfully');
          hideModal(savePresetModal);
          loadUserPresets();
        } catch (error) {
          console.error('Error saving preset:', error);
          presetSaveErr.textContent = 'Error saving preset. Please try again.';
          presetSaveErr.style.display = 'block';
        }
      });
    }

    // Manage presets button
    if (btnManagePresets) {
      btnManagePresets.addEventListener('click', () => {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Please login to manage presets');
          return;
        }
        renderPresetsList();
        showModal(managePresetsModal);
      });
    }

    // Close manage presets modal
    if (btnCloseManagePresets) {
      btnCloseManagePresets.addEventListener('click', () => {
        hideModal(managePresetsModal);
      });
    }

    // Close printer modal
    const closePrinterBtn = document.getElementById('closePrinter');
    if (closePrinterBtn) {
      closePrinterBtn.addEventListener('click', () => {
        hideModal(printerModal);
      });
    }

    // Close filament modal
    const closeFilamentBtn = document.getElementById('closeFilament');
    if (closeFilamentBtn) {
      closeFilamentBtn.addEventListener('click', () => {
        hideModal(filamentModal);
      });
    }

    // Close printer modal (X button)
    const closePrinterX = document.getElementById('closePrinterX');
    if (closePrinterX) {
      closePrinterX.addEventListener('click', () => {
        hideModal(printerModal);
      });
    }

    // Close filament modal (X button)
    const closeFilamentX = document.getElementById('closeFilamentX');
    if (closeFilamentX) {
      closeFilamentX.addEventListener('click', () => {
        hideModal(filamentModal);
      });
    }

    // Load user presets from Firebase
    async function loadUserPresets() {
      const user = firebase.auth().currentUser;
      if (!user) {
        userPresets = [];
        updatePresetsUI();
        return;
      }
      
      try {
        const snapshot = await firebase.database().ref(`users/${user.uid}/presets`).once('value');
        const data = snapshot.val();
        
        if (data) {
          userPresets = Object.keys(data).map(id => ({
            id: id,
            ...data[id]
          }));
        } else {
          userPresets = [];
        }
        
        updatePresetsUI();
      } catch (error) {
        console.error('Error loading presets:', error);
        userPresets = [];
        updatePresetsUI();
      }
    }

    // Update presets UI
    function updatePresetsUI() {
      const maxPresets = currentUserTier === 'admin' || currentUserTier === 'premium' || currentUserTier === 'professional' ? MAX_PRESETS_PREMIUM : MAX_PRESETS_FREE;
      if (presetLimitInfo) {
        presetLimitInfo.textContent = `${userPresets.length}/${maxPresets} presets`;
      }
      
      if (userPresets.length > 0) {
        if (presetQuickAccess) presetQuickAccess.style.display = 'block';
        if (presetButtons) {
          presetButtons.innerHTML = '';
          
          userPresets.forEach(preset => {
            const btn = document.createElement('button');
            btn.className = 'btn-calc-ghost';
            btn.style.fontSize = '12px';
            btn.style.padding = '6px 12px';
            btn.textContent = preset.name;
            btn.onclick = () => loadPresetData(preset.data);
            presetButtons.appendChild(btn);
          });
        }
      } else {
        if (presetQuickAccess) presetQuickAccess.style.display = 'none';
      }
    }

    // Render presets list in manage modal
    function renderPresetsList() {
      if (userPresets.length === 0) {
        if (presetsList) presetsList.style.display = 'none';
        if (noPresetsMessage) noPresetsMessage.style.display = 'block';
        return;
      }
      
      if (presetsList) presetsList.style.display = 'block';
      if (noPresetsMessage) noPresetsMessage.style.display = 'none';
      
      if (presetsList) {
        presetsList.innerHTML = userPresets.map(preset => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid #2d2e3a; border-radius: 8px; margin-bottom: 12px;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px; color: #ffffff;">${preset.name}</div>
              <div style="font-size: 11px; color: #6b7280;">Saved ${new Date(preset.createdAt).toLocaleDateString()}</div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-calc" style="padding: 8px 16px; font-size: 13px;" onclick="loadPresetAndClose('${preset.id}')">Load</button>
              <button class="btn-calc-ghost" style="padding: 8px 16px; font-size: 13px; border-color: #ef4444; color: #ef4444;" onclick="deletePreset('${preset.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    // Load preset and close modal (global function for onclick)
    window.loadPresetAndClose = function(presetId) {
      const preset = userPresets.find(p => p.id === presetId);
      if (preset) {
        loadPresetData(preset.data);
        hideModal(managePresetsModal);
      }
    };

    // Delete preset (global function for onclick)
    window.deletePreset = async function(presetId) {
      const user = firebase.auth().currentUser;
      if (!user) return;
      
      if (!confirm('Are you sure you want to delete this preset?')) return;
      
      try {
        await firebase.database().ref(`users/${user.uid}/presets/${presetId}`).remove();
        console.log('Preset deleted successfully');
        await loadUserPresets();
        renderPresetsList();
      } catch (error) {
        console.error('Error deleting preset:', error);
        alert('Error deleting preset. Please try again.');
      }
    };

    /* User Printers and Filaments */
    
    // Render user printers list
    function renderUserPrintersList() {
      const list = document.getElementById('userPrintersList');
      const addBtn = document.getElementById('btnAddUserPrinter');
      if (!list) return;
      
      const user = firebase.auth().currentUser;
      
      // Show/hide add button
      if (addBtn) {
        addBtn.style.display = user ? 'inline-block' : 'none';
      }
      
      if (!user) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Login to Add Your Printers</p>
            <p style="font-size: 14px; color: #6b7280; max-width: 400px; margin: 0 auto;">
              Create and manage your personal printer library, separate from the global presets.
            </p>
          </div>
        `;
        return;
      }
      
      const printerCount = Object.keys(userPrintersData).length;
      
      if (printerCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 16px; margin-bottom: 8px;">No personal printers yet</p>
            <p style="margin-top: 8px; font-size: 14px; color: #6b7280;">Click "Add Printer" above to create your first personal printer preset.</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `<div style="font-size: 14px; color: #6b7280; margin-bottom: 16px; font-weight: 600;">Total: ${printerCount} printer${printerCount !== 1 ? 's' : ''}</div>`;
      
      Object.entries(userPrintersData).forEach(([id, printer]) => {
        const printerCard = document.createElement('div');
        printerCard.style.cssText = 'padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid #2d2e3a; border-radius: 8px; margin-bottom: 12px;';
        printerCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px;">${printer.brand} ${printer.name}</div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Price:</span> ${money(printer.price)}
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Lifespan:</span> ${printer.lifespan.toLocaleString()} hrs
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Depreciation:</span> ${money(printer.price / printer.lifespan)}/hr
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editUserPrinter('${id}')" style="padding: 6px 12px; font-size: 13px;">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="deleteUserPrinter('${id}')" style="padding: 6px 12px; font-size: 13px; border-color: #ef4444; color: #ef4444;">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(printerCard);
      });
      
      // Update calculator dropdowns
      renderPrinterSelect();
    }

    // Render user filaments list
    function renderUserFilamentsList() {
      const list = document.getElementById('userFilamentsList');
      const addBtn = document.getElementById('btnAddUserFilament');
      if (!list) return;
      
      const user = firebase.auth().currentUser;
      
      // Show/hide add button
      if (addBtn) {
        addBtn.style.display = user ? 'inline-block' : 'none';
      }
      
      if (!user) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Login to Add Your Filaments</p>
            <p style="font-size: 14px; color: #6b7280; max-width: 400px; margin: 0 auto;">
              Create and manage your personal filament library, separate from the global presets.
            </p>
          </div>
        `;
        return;
      }
      
      const filamentCount = Object.keys(userFilamentsData).length;
      
      if (filamentCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p style="font-size: 16px; margin-bottom: 8px;">No personal filaments yet</p>
            <p style="margin-top: 8px; font-size: 14px; color: #6b7280;">Click "Add Filament" above to create your first personal filament preset.</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `<div style="font-size: 14px; color: #6b7280; margin-bottom: 16px; font-weight: 600;">Total: ${filamentCount} filament${filamentCount !== 1 ? 's' : ''}</div>`;
      
      Object.entries(userFilamentsData).forEach(([id, filament]) => {
        const filamentCard = document.createElement('div');
        filamentCard.style.cssText = 'padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid #2d2e3a; border-radius: 8px; margin-bottom: 12px;';
        filamentCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 8px; font-size: 15px;">${filament.brand} - ${filament.type}</div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Spool Weight:</span> ${filament.spoolWeight}g
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Spool Cost:</span> $${filament.spoolCost.toFixed(2)}
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  <span style="color: #9ca3af;">Cost per Gram:</span> $${(filament.spoolCost / filament.spoolWeight).toFixed(4)}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editUserFilament('${id}')" style="padding: 6px 12px; font-size: 13px;">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="deleteUserFilament('${id}')" style="padding: 6px 12px; font-size: 13px; border-color: #ef4444; color: #ef4444;">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(filamentCard);
      });
      
      // Update calculator dropdowns
      renderFilamentSelect();
    }

    // Load user printers from Firebase
    function loadUserPrinters() {
      const user = firebase.auth().currentUser;
      if (!user) {
        userPrintersData = {};
        renderUserPrintersList();
        return;
      }
      
      // Listen for real-time updates
      firebase.database().ref(`users/${user.uid}/printers`).on('value', snapshot => {
        userPrintersData = {};
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const printer = child.val();
            printer.id = child.key;
            userPrintersData[child.key] = printer;
          });
        }
        renderUserPrintersList();
      });
    }

    // Load user filaments from Firebase
    function loadUserFilaments() {
      const user = firebase.auth().currentUser;
      if (!user) {
        userFilamentsData = {};
        renderUserFilamentsList();
        return;
      }
      
      // Listen for real-time updates
      firebase.database().ref(`users/${user.uid}/filaments`).on('value', snapshot => {
        userFilamentsData = {};
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const filament = child.val();
            filament.id = child.key;
            userFilamentsData[child.key] = filament;
          });
        }
        renderUserFilamentsList();
      });
    }

    /* User Printers and Filaments CRUD */
    let editingUserPrinterId = null;
    let editingUserFilamentId = null;

    // Add user printer button handler
    if (document.getElementById('btnAddUserPrinter')) {
      document.getElementById('btnAddUserPrinter').onclick = () => {
        if (!firebase.auth().currentUser) {
          alert('Please login to add your own printers');
          return;
        }
        editingUserPrinterId = null;
        document.getElementById('printerModalTitle').textContent = 'Add Your Printer';
        document.getElementById('printerBrand').value = '';
        document.getElementById('printerName').value = '';
        document.getElementById('printerPrice').value = '';
        document.getElementById('printerLifespan').value = '5000';
        const printerErr = document.getElementById('printerErr');
        printerErr.textContent = '';
        printerErr.style.display = 'none';
        
        // Set save handler for user printer
        document.getElementById('savePrinter').onclick = saveUserPrinter;
        showModal(printerModal);
      };
    }

    // Add user filament button handler
    if (document.getElementById('btnAddUserFilament')) {
      document.getElementById('btnAddUserFilament').onclick = () => {
        if (!firebase.auth().currentUser) {
          alert('Please login to add your own filaments');
          return;
        }
        editingUserFilamentId = null;
        document.getElementById('filamentModalTitle').textContent = 'Add Your Filament';
        document.getElementById('filamentBrand').value = '';
        document.getElementById('filamentType').value = '';
        document.getElementById('spoolWeight').value = '1000';
        document.getElementById('spoolCost').value = '';
        const filamentErr = document.getElementById('filamentErr');
        filamentErr.textContent = '';
        filamentErr.style.display = 'none';
        
        // Set save handler for user filament
        document.getElementById('saveFilament').onclick = saveUserFilament;
        showModal(filamentModal);
      };
    }

    // Save user printer
    function saveUserPrinter() {
      if (!firebase.auth().currentUser) {
        alert('Please login to save your printer');
        return;
      }
      
      const brand = document.getElementById('printerBrand').value.trim();
      const name = document.getElementById('printerName').value.trim();
      const price = parseFloat(document.getElementById('printerPrice').value);
      const lifespan = parseInt(document.getElementById('printerLifespan').value);
      const printerErr = document.getElementById('printerErr');
      
      if (!brand || !name || !price || price < 0 || !lifespan || lifespan < 1) {
        printerErr.textContent = 'Please fill all fields correctly.';
        printerErr.style.display = 'block';
        return;
      }
      
      const printerData = { brand, name, price, lifespan };
      const userPrintersRef = firebase.database().ref(`users/${firebase.auth().currentUser.uid}/printers`);
      
      if (editingUserPrinterId) {
        userPrintersRef.child(editingUserPrinterId).update(printerData)
          .then(() => {
            editingUserPrinterId = null;
            hideModal(printerModal);
            alert(`"${brand} ${name}" has been updated in your library.`);
          })
          .catch((error) => {
            printerErr.textContent = 'Error updating printer: ' + error.message;
            printerErr.style.display = 'block';
          });
      } else {
        userPrintersRef.push(printerData)
          .then(() => {
            hideModal(printerModal);
            alert(`"${brand} ${name}" has been added to your library!`);
          })
          .catch((error) => {
            printerErr.textContent = 'Error saving printer: ' + error.message;
            printerErr.style.display = 'block';
          });
      }
    }

    // Save user filament
    function saveUserFilament() {
      if (!firebase.auth().currentUser) {
        alert('Please login to save your filament');
        return;
      }
      
      const brand = document.getElementById('filamentBrand').value.trim();
      const type = document.getElementById('filamentType').value.trim();
      const spoolWeight = parseFloat(document.getElementById('spoolWeight').value);
      const spoolCost = parseFloat(document.getElementById('spoolCost').value);
      const filamentErr = document.getElementById('filamentErr');
      
      if (!brand || !type || !spoolWeight || spoolWeight <= 0 || !spoolCost || spoolCost < 0) {
        filamentErr.textContent = 'Please fill all fields correctly.';
        filamentErr.style.display = 'block';
        return;
      }
      
      const filamentData = { brand, type, spoolWeight, spoolCost };
      const userFilamentsRef = firebase.database().ref(`users/${firebase.auth().currentUser.uid}/filaments`);
      
      if (editingUserFilamentId) {
        userFilamentsRef.child(editingUserFilamentId).update(filamentData)
          .then(() => {
            editingUserFilamentId = null;
            hideModal(filamentModal);
            alert(`"${brand} - ${type}" has been updated in your library.`);
          })
          .catch((error) => {
            filamentErr.textContent = 'Error updating filament: ' + error.message;
            filamentErr.style.display = 'block';
          });
      } else {
        userFilamentsRef.push(filamentData)
          .then(() => {
            hideModal(filamentModal);
            alert(`"${brand} - ${type}" has been added to your library!`);
          })
          .catch((error) => {
            filamentErr.textContent = 'Error saving filament: ' + error.message;
            filamentErr.style.display = 'block';
          });
      }
    }

    // Batch add printers functionality
    if (document.getElementById('btnParseQuickAdd')) {
      document.getElementById('btnParseQuickAdd').onclick = async function() {
        if (!firebase.auth().currentUser) {
          alert('Please login to add printers');
          return;
        }
        
        const quickAddText = document.getElementById('printerQuickAdd').value.trim();
        const printerErr = document.getElementById('printerErr');
        
        if (!quickAddText) {
          printerErr.textContent = 'Please enter printer data to batch add.';
          printerErr.style.display = 'block';
          return;
        }
        
        try {
          // Split by semicolon and parse each entry
          const entries = quickAddText.split(';').map(s => s.trim()).filter(s => s);
          const printers = [];
          
          for (const entry of entries) {
            const parsed = JSON.parse(entry);
            if (!Array.isArray(parsed) || parsed.length !== 4) {
              throw new Error('Each entry must be: ["Name", "Brand", Price, Lifespan]');
            }
            const [name, brand, price, lifespan] = parsed;
            if (!name || !brand || typeof price !== 'number' || typeof lifespan !== 'number') {
              throw new Error('Invalid data format');
            }
            printers.push({ name, brand, price, lifespan });
          }
          
          if (printers.length === 0) {
            throw new Error('No valid printers found');
          }
          
          // Add all printers to Firebase
          const userPrintersRef = db.ref(`users/${auth.currentUser.uid}/printers`);
          const promises = printers.map(printer => userPrintersRef.push(printer));
          await Promise.all(promises);
          
          hideModal(printerModal);
          alert(`Successfully added ${printers.length} printer(s) to your library!`);
          document.getElementById('printerQuickAdd').value = '';
          
        } catch (error) {
          printerErr.textContent = 'Error: ' + error.message;
          printerErr.style.display = 'block';
        }
      };
    }

    // Batch add filaments functionality
    if (document.getElementById('btnParseFilamentQuickAdd')) {
      document.getElementById('btnParseFilamentQuickAdd').onclick = async function() {
        if (!auth.currentUser) {
          alert('Please login to add filaments');
          return;
        }
        
        const quickAddText = document.getElementById('filamentQuickAdd').value.trim();
        const filamentErr = document.getElementById('filamentErr');
        
        if (!quickAddText) {
          filamentErr.textContent = 'Please enter filament data to batch add.';
          filamentErr.style.display = 'block';
          return;
        }
        
        try {
          // Split by semicolon and parse each entry
          const entries = quickAddText.split(';').map(s => s.trim()).filter(s => s);
          const filaments = [];
          
          for (const entry of entries) {
            const parsed = JSON.parse(entry);
            if (!Array.isArray(parsed) || parsed.length !== 4) {
              throw new Error('Each entry must be: ["Type", "Brand", Weight, Cost]');
            }
            const [type, brand, spoolWeight, spoolCost] = parsed;
            if (!type || !brand || typeof spoolWeight !== 'number' || typeof spoolCost !== 'number') {
              throw new Error('Invalid data format');
            }
            filaments.push({ type, brand, spoolWeight, spoolCost });
          }
          
          if (filaments.length === 0) {
            throw new Error('No valid filaments found');
          }
          
          // Add all filaments to Firebase
          const userFilamentsRef = db.ref(`users/${auth.currentUser.uid}/filaments`);
          const promises = filaments.map(filament => userFilamentsRef.push(filament));
          await Promise.all(promises);
          
          hideModal(filamentModal);
          alert(`Successfully added ${filaments.length} filament(s) to your library!`);
          document.getElementById('filamentQuickAdd').value = '';
          
        } catch (error) {
          filamentErr.textContent = 'Error: ' + error.message;
          filamentErr.style.display = 'block';
        }
      };
    }

    // Edit user printer (global function for onclick)
    window.editUserPrinter = function(id) {
      if (!auth.currentUser) return;
      
      editingUserPrinterId = id;
      const printer = userPrintersData[id];
      if (!printer) return;
      
      document.getElementById('printerModalTitle').textContent = 'Edit Your Printer';
      document.getElementById('printerBrand').value = printer.brand;
      document.getElementById('printerName').value = printer.name;
      document.getElementById('printerPrice').value = printer.price.toFixed(2);
      document.getElementById('printerLifespan').value = printer.lifespan;
      const printerErr = document.getElementById('printerErr');
      printerErr.textContent = '';
      printerErr.style.display = 'none';
      
      // Set save handler for user printer
      document.getElementById('savePrinter').onclick = saveUserPrinter;
      showModal(printerModal);
    };

    // Delete user printer (global function for onclick)
    window.deleteUserPrinter = function(id) {
      if (!auth.currentUser) return;
      
      const printer = userPrintersData[id];
      if (!printer) return;
      
      if (!confirm(`Delete "${printer.brand} ${printer.name}" from your library? This action cannot be undone.`)) return;
      
      db.ref(`users/${auth.currentUser.uid}/printers/${id}`).remove()
        .then(() => {
          alert(`"${printer.brand} ${printer.name}" has been deleted from your library.`);
        })
        .catch(error => {
          alert('Error deleting printer: ' + error.message);
        });
    };

    // Edit user filament (global function for onclick)
    window.editUserFilament = function(id) {
      if (!auth.currentUser) return;
      
      editingUserFilamentId = id;
      const filament = userFilamentsData[id];
      if (!filament) return;
      
      document.getElementById('filamentModalTitle').textContent = 'Edit Your Filament';
      document.getElementById('filamentBrand').value = filament.brand;
      document.getElementById('filamentType').value = filament.type;
      document.getElementById('spoolWeight').value = filament.spoolWeight;
      document.getElementById('spoolCost').value = filament.spoolCost.toFixed(2);
      const filamentErr = document.getElementById('filamentErr');
      filamentErr.textContent = '';
      filamentErr.style.display = 'none';
      
      // Set save handler for user filament
      document.getElementById('saveFilament').onclick = saveUserFilament;
      showModal(filamentModal);
    };

    // Delete user filament (global function for onclick)
    window.deleteUserFilament = function(id) {
      if (!auth.currentUser) return;
      
      const filament = userFilamentsData[id];
      if (!filament) return;
      
      if (!confirm(`Delete "${filament.brand} - ${filament.type}" from your library? This action cannot be undone.`)) return;
      
      db.ref(`users/${auth.currentUser.uid}/filaments/${id}`).remove()
        .then(() => {
          alert(`"${filament.brand} - ${filament.type}" has been deleted from your library.`);
        })
        .catch(error => {
          alert('Error deleting filament: ' + error.message);
        });
    };

    // Load printers from Firebase
    function loadPrinters() {
      console.log('Loading printers from Firebase...');
      printersRef.on('value', snapshot => {
        printersData = {};
        const data = snapshot.val();
        
        if (!data) {
          renderPrinterSelect();
          renderPrintersList();
          return;
        }
        
        Object.entries(data).forEach(([key, value]) => {
          const name = value.name;
          const brand = value.brand || 'Unknown';
          const price = Number(value.price || 0);
          const lifespan = Number(value.lifespan || 5000);
          const costPerHour = price / lifespan;
          
          printersData[name] = {
            id: key,
            name: name,
            brand: brand,
            price: price,
            lifespan: lifespan,
            costPerHour: costPerHour
          };
        });
        
        dataLoaded = true;
        renderPrinterSelect();
        renderPrintersList();
        updatePriceInfo();
      });
    }

    // Load filaments from Firebase
    function loadFilaments() {
      filamentsRef.on('value', snapshot => {
        filamentsData = {};
        const data = snapshot.val();
        
        if (!data) {
          renderFilamentSelect();
          renderFilamentsList();
          return;
        }
        
        Object.entries(data).forEach(([key, value]) => {
          const type = value.type;
          const spoolWeight = Number(value.spoolWeight || 1000);
          const spoolCost = Number(value.spoolCost || 0);
          const costPerG = spoolCost / spoolWeight;
          
          filamentsData[type] = {
            id: key,
            type: type,
            brand: value.brand,
            spoolWeight: spoolWeight,
            spoolCost: spoolCost,
            costPerG: costPerG
          };
        });
        
        renderFilamentSelect();
        renderFilamentsList();
        updatePriceInfo();
      });
    }

    // Render printer select dropdown
    function renderPrinterSelect() {
      const select = document.getElementById('printerSelect');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">Choose a printer...</option>';
      
      // Add user printers first (if any)
      if (Object.keys(userPrintersData).length > 0) {
        // Add user printers header
        const userHeader = document.createElement('option');
        userHeader.disabled = true;
        userHeader.textContent = '── My Printers ──';
        userHeader.style.fontWeight = 'bold';
        userHeader.style.textAlign = 'center';
        userHeader.style.color = '#8b5cf6';
        select.appendChild(userHeader);
        
        // Group user printers by brand
        const userBrandGroups = {};
        Object.entries(userPrintersData).forEach(([id, printer]) => {
          const brand = printer.brand || 'Unknown Brand';
          if (!userBrandGroups[brand]) {
            userBrandGroups[brand] = [];
          }
          userBrandGroups[brand].push({ id, ...printer });
        });
        
        // Sort brands and add each as optgroup
        const sortedUserBrands = Object.keys(userBrandGroups).sort();
        sortedUserBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          userBrandGroups[brand].sort((a, b) => a.name.localeCompare(b.name)).forEach(printer => {
            const option = document.createElement('option');
            option.value = `user:${printer.id}`;
            option.textContent = printer.name;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      // Add global printers
      if (Object.keys(printersData).length > 0) {
        // Add global printers header
        const globalHeader = document.createElement('option');
        globalHeader.disabled = true;
        globalHeader.textContent = '── Global Printers ──';
        globalHeader.style.fontWeight = 'bold';
        globalHeader.style.textAlign = 'center';
        globalHeader.style.color = '#8b5cf6';
        select.appendChild(globalHeader);
        
        // Group global printers by brand
        const brandGroups = {};
        Object.entries(printersData).forEach(([name, printer]) => {
          const brand = printer.brand || 'Unknown Brand';
          if (!brandGroups[brand]) {
            brandGroups[brand] = [];
          }
          brandGroups[brand].push({ name, ...printer });
        });
        
        // Sort brands and add each as optgroup
        const sortedBrands = Object.keys(brandGroups).sort();
        sortedBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          brandGroups[brand].sort((a, b) => a.name.localeCompare(b.name)).forEach(printer => {
            const option = document.createElement('option');
            option.value = `global:${printer.name}`;
            option.textContent = printer.name;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      if (currentValue) {
        select.value = currentValue;
      }
      
      updatePriceInfo();
    }

    // Render filament select dropdown
    function renderFilamentSelect() {
      const select = document.getElementById('filamentSelect');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">Choose filament...</option>';
      
      // Add user filaments first (if any)
      if (Object.keys(userFilamentsData).length > 0) {
        // Add user filaments header
        const userHeader = document.createElement('option');
        userHeader.disabled = true;
        userHeader.textContent = '── My Filaments ──';
        userHeader.style.fontWeight = 'bold';
        userHeader.style.textAlign = 'center';
        userHeader.style.color = '#8b5cf6';
        select.appendChild(userHeader);
        
        // Group user filaments by brand
        const userBrandGroups = {};
        Object.entries(userFilamentsData).forEach(([id, filament]) => {
          const brand = filament.brand || 'Unknown Brand';
          if (!userBrandGroups[brand]) {
            userBrandGroups[brand] = [];
          }
          userBrandGroups[brand].push({ id, ...filament });
        });
        
        // Sort brands and add each as optgroup
        const sortedUserBrands = Object.keys(userBrandGroups).sort();
        sortedUserBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          userBrandGroups[brand].sort((a, b) => a.type.localeCompare(b.type)).forEach(filament => {
            const option = document.createElement('option');
            option.value = `user:${filament.id}`;
            option.textContent = filament.type;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      // Add global filaments
      if (Object.keys(filamentsData).length > 0) {
        // Add global filaments header
        const globalHeader = document.createElement('option');
        globalHeader.disabled = true;
        globalHeader.textContent = '── Global Filaments ──';
        globalHeader.style.fontWeight = 'bold';
        globalHeader.style.textAlign = 'center';
        globalHeader.style.color = '#8b5cf6';
        select.appendChild(globalHeader);
        
        // Group global filaments by brand
        const brandGroups = {};
        Object.entries(filamentsData).forEach(([type, filament]) => {
          const brand = filament.brand || 'Unknown Brand';
          if (!brandGroups[brand]) {
            brandGroups[brand] = [];
          }
          brandGroups[brand].push({ type, ...filament });
        });
        
        // Sort brands and add each as optgroup
        const sortedBrands = Object.keys(brandGroups).sort();
        sortedBrands.forEach(brand => {
          const brandGroup = document.createElement('optgroup');
          brandGroup.label = brand;
          
          brandGroups[brand].sort((a, b) => a.type.localeCompare(b.type)).forEach(filament => {
            const option = document.createElement('option');
            option.value = `global:${filament.type}`;
            option.textContent = filament.type;
            brandGroup.appendChild(option);
          });
          
          select.appendChild(brandGroup);
        });
      }
      
      if (currentValue) {
        select.value = currentValue;
      }
      
      updatePriceInfo();
    }

    // Render printers list
    function renderPrintersList() {
      const list = document.getElementById('printersList');
      if (!list) return;
      
      list.innerHTML = '';
      
      const printerCount = Object.keys(printersData).length;
      const isAdmin = currentUserTier === 'admin';
      
      if (printerCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Printer.svg" alt="Printer" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p>No printers available yet.</p>
          </div>
        `;
        return;
      }

      // Group by brand
      const brandGroups = {};
      Object.entries(printersData).forEach(([name, printer]) => {
        const brand = printer.brand || 'Unknown';
        if (!brandGroups[brand]) {
          brandGroups[brand] = [];
        }
        brandGroups[brand].push(printer);
      });
      
      const sortedBrands = Object.keys(brandGroups).sort();
      
      sortedBrands.forEach(brand => {
        const printers = brandGroups[brand].sort((a, b) => a.name.localeCompare(b.name));
        
        const brandSection = document.createElement('div');
        brandSection.style.marginBottom = '24px';
        brandSection.innerHTML = `
          <h4 style="color: #8b5cf6; font-size: 16px; font-weight: 700; margin-bottom: 16px;">${brand}</h4>
        `;
        
        printers.forEach(printer => {
          const item = document.createElement('div');
          item.className = 'list-item';
          
          // Admin action buttons
          const adminButtons = isAdmin ? `
            <div class="btn-actions" style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editGlobalPrinter('${printer.name}')">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="duplicateGlobalPrinter('${printer.name}')">Duplicate</button>
              <button class="btn-delete btn-small" onclick="deleteGlobalPrinter('${printer.name}')">Delete</button>
            </div>
          ` : '';
          
          item.innerHTML = `
            <div class="item-info">
              <div class="item-name">${printer.name}</div>
              <div class="item-details">
                Price: ${money(printer.price)} | Lifespan: ${printer.lifespan.toLocaleString()} hrs | Depreciation: ${money(printer.costPerHour)}/hr
              </div>
            </div>
            ${adminButtons}
          `;
          brandSection.appendChild(item);
        });
        
        list.appendChild(brandSection);
      });
    }

    // Render filaments list
    function renderFilamentsList() {
      const list = document.getElementById('filamentsList');
      if (!list) return;
      
      list.innerHTML = '';
      
      const filamentCount = Object.keys(filamentsData).length;
      const isAdmin = currentUserTier === 'admin';
      
      if (filamentCount === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <img src="../../images/Icons/Yarn.svg" alt="Filament" style="width: 48px; height: 48px; opacity: 0.5;">
            </div>
            <p>No filaments available yet.</p>
          </div>
        `;
        return;
      }

      // Group by brand
      const brandGroups = {};
      Object.entries(filamentsData).forEach(([type, filament]) => {
        const brand = filament.brand || 'Unknown';
        if (!brandGroups[brand]) {
          brandGroups[brand] = [];
        }
        brandGroups[brand].push(filament);
      });
      
      const sortedBrands = Object.keys(brandGroups).sort();
      
      sortedBrands.forEach(brand => {
        const filaments = brandGroups[brand].sort((a, b) => a.type.localeCompare(b.type));
        
        const brandSection = document.createElement('div');
        brandSection.style.marginBottom = '24px';
        brandSection.innerHTML = `
          <h4 style="color: #8b5cf6; font-size: 16px; font-weight: 700; margin-bottom: 16px;">${brand}</h4>
        `;
        
        filaments.forEach(filament => {
          const item = document.createElement('div');
          item.className = 'list-item';
          const perKg = filament.costPerG * 1000;
          
          // Admin action buttons
          const adminButtons = isAdmin ? `
            <div class="btn-actions" style="display: flex; gap: 8px;">
              <button class="btn-calc-ghost btn-small" onclick="editGlobalFilament('${filament.type.replace(/'/g, "\\'")}')">Edit</button>
              <button class="btn-calc-ghost btn-small" onclick="duplicateGlobalFilament('${filament.type.replace(/'/g, "\\'")}')">Duplicate</button>
              <button class="btn-delete btn-small" onclick="deleteGlobalFilament('${filament.type.replace(/'/g, "\\'")}')">Delete</button>
            </div>
          ` : '';
          
          item.innerHTML = `
            <div class="item-info">
              <div class="item-name">${filament.type}</div>
              <div class="item-details">
                Spool: ${money(filament.spoolCost)} (${filament.spoolWeight}g) | Per kg: ${money(perKg)} | Per g: ${money(filament.costPerG)}
              </div>
            </div>
            ${adminButtons}
          `;
          brandSection.appendChild(item);
        });
        
        list.appendChild(brandSection);
      });
    }

    // Update price info boxes
    function updatePriceInfo() {
      const printerValue = document.getElementById('printerSelect')?.value;
      const filamentValue = document.getElementById('filamentSelect')?.value;
      const printerCostBox = document.getElementById('printerCostBox');
      const filamentCostBox = document.getElementById('filamentCostBox');
      const printerCostInfo = document.getElementById('printerCostInfo');
      const filamentCostInfo = document.getElementById('filamentCostInfo');
      
      if (!printerCostBox || !filamentCostBox) return;
      
      // Get printer data
      let printer = null;
      if (printerValue) {
        if (printerValue.startsWith('user:')) {
          const id = printerValue.substring(5);
          printer = userPrintersData[id];
          if (printer) {
            // Calculate cost per hour for user printer
            printer = {
              ...printer,
              costPerHour: printer.price / printer.lifespan
            };
          }
        } else if (printerValue.startsWith('global:')) {
          const name = printerValue.substring(7);
          printer = printersData[name];
        }
      }
      
      if (printer) {
        printerCostInfo.textContent = `${money(printer.costPerHour)}/h`;
        printerCostBox.style.display = 'block';
      } else {
        printerCostBox.style.display = 'none';
      }
      
      // Get filament data
      let filament = null;
      if (filamentValue) {
        if (filamentValue.startsWith('user:')) {
          const id = filamentValue.substring(5);
          filament = userFilamentsData[id];
          if (filament) {
            // Calculate cost per gram for user filament
            filament = {
              ...filament,
              costPerG: filament.spoolCost / filament.spoolWeight
            };
          }
        } else if (filamentValue.startsWith('global:')) {
          const type = filamentValue.substring(7);
          filament = filamentsData[type];
        }
      }
      
      if (filament) {
        const perKg = filament.costPerG * 1000;
        filamentCostInfo.textContent = `${money(perKg)}/kg`;
        filamentCostBox.style.display = 'block';
      } else {
        filamentCostBox.style.display = 'none';
      }
    }

    // ===============================================
    // NOTIFICATION MODAL FUNCTIONS (Available for all users)
    // Replacements for alert/confirm/prompt with custom styling
    // ===============================================
    
    // Show notification modal (replaces alert)
    // type: 'success', 'error', 'warning', 'info'
    function showNotification(message, title = 'Notification', type = 'info') {
      return new Promise((resolve) => {
        const modal = document.getElementById('adminNotificationModal');
        const titleEl = document.getElementById('adminNotificationTitle');
        const messageEl = document.getElementById('adminNotificationMessage');
        const iconEl = document.getElementById('adminNotificationIcon');
        const okBtn = document.getElementById('adminNotificationOk');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        // Set icon SVG and color based on type
        let iconSVG = '';
        let iconColor = '';
        
        switch(type) {
          case 'success':
            iconColor = '#10b981';
            iconSVG = '<img src="../images/Icons/CheckCircle.svg" width="48" height="48" style="filter: brightness(0) saturate(100%) invert(66%) sepia(28%) saturate(2050%) hue-rotate(101deg) brightness(95%) contrast(86%);">';
            break;
          case 'error':
            iconColor = '#ef4444';
            iconSVG = '<img src="../images/Icons/XCircle.svg" width="48" height="48" style="filter: brightness(0) saturate(100%) invert(38%) sepia(72%) saturate(2826%) hue-rotate(340deg) brightness(100%) contrast(89%);">';
            break;
          case 'warning':
            iconColor = '#f59e0b';
            iconSVG = '<img src="../images/Icons/Warning.svg" width="48" height="48" style="filter: brightness(0) saturate(100%) invert(71%) sepia(87%) saturate(1495%) hue-rotate(358deg) brightness(97%) contrast(96%);">';
            break;
          default: // info
            iconColor = '#8b5cf6';
            iconSVG = '<img src="../images/Icons/Info.svg" width="48" height="48" style="filter: brightness(0) saturate(100%) invert(43%) sepia(63%) saturate(1752%) hue-rotate(236deg) brightness(93%) contrast(92%);">';
        }
        
        iconEl.innerHTML = iconSVG;
        iconEl.style.color = iconColor;
        
        modal.style.display = 'grid';
        
        const handleClose = () => {
          modal.style.display = 'none';
          okBtn.removeEventListener('click', handleClose);
          resolve(true);
        };
        
        okBtn.addEventListener('click', handleClose);
      });
    }
    
    // Show confirmation modal (replaces confirm)
    function showConfirm(message, title = 'Confirm Action') {
      return new Promise((resolve) => {
        const modal = document.getElementById('adminConfirmModal');
        const titleEl = document.getElementById('adminConfirmTitle');
        const messageEl = document.getElementById('adminConfirmMessage');
        const cancelBtn = document.getElementById('adminConfirmCancel');
        const okBtn = document.getElementById('adminConfirmOk');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.style.display = 'grid';
        
        const handleCancel = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(false);
        };
        
        const handleOk = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(true);
        };
        
        const cleanup = () => {
          cancelBtn.removeEventListener('click', handleCancel);
          okBtn.removeEventListener('click', handleOk);
        };
        
        cancelBtn.addEventListener('click', handleCancel);
        okBtn.addEventListener('click', handleOk);
      });
    }
    
    // Show prompt modal (replaces prompt)
    function showPrompt(message, defaultValue = '', title = 'Enter Value') {
      return new Promise((resolve) => {
        const modal = document.getElementById('adminPromptModal');
        const titleEl = document.getElementById('adminPromptTitle');
        const messageEl = document.getElementById('adminPromptMessage');
        const inputEl = document.getElementById('adminPromptInput');
        const cancelBtn = document.getElementById('adminPromptCancel');
        const okBtn = document.getElementById('adminPromptOk');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.value = defaultValue;
        modal.style.display = 'grid';
        
        // Focus input
        setTimeout(() => inputEl.focus(), 100);
        
        const handleCancel = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(null);
        };
        
        const handleOk = () => {
          const value = inputEl.value.trim();
          modal.style.display = 'none';
          cleanup();
          resolve(value || null);
        };
        
        const handleKeyPress = (e) => {
          if (e.key === 'Enter') handleOk();
          if (e.key === 'Escape') handleCancel();
        };
        
        const cleanup = () => {
          cancelBtn.removeEventListener('click', handleCancel);
          okBtn.removeEventListener('click', handleOk);
          inputEl.removeEventListener('keypress', handleKeyPress);
        };
        
        cancelBtn.addEventListener('click', handleCancel);
        okBtn.addEventListener('click', handleOk);
        inputEl.addEventListener('keypress', handleKeyPress);
      });
    }

    // ===============================================
    // ADMIN FUNCTIONS FOR GLOBAL PRINTERS & FILAMENTS
    // ===============================================
    
    // Edit Global Printer (Admin Only)
    window.editGlobalPrinter = async function(printerName) {
      console.log('editGlobalPrinter called with:', printerName);
      console.log('Current user tier:', currentUserTier);
      console.log('Available printers:', Object.keys(printersData));
      
      if (currentUserTier !== 'admin') {
        await showNotification('You need admin access to edit global printers.', 'Access Denied', '🔒');
        return;
      }
      
      const printer = printersData[printerName];
      if (!printer) {
        console.error('Printer not found:', printerName);
        await showNotification('Printer not found in the database.', 'Error', '❌');
        return;
      }
      
      console.log('Opening edit modal for printer:', printer);
      
      // Populate modal
      document.getElementById('editGlobalPrinterOriginalName').value = printerName;
      document.getElementById('editGlobalPrinterName').value = printer.name;
      document.getElementById('editGlobalPrinterBrand').value = printer.brand || '';
      document.getElementById('editGlobalPrinterPrice').value = printer.price;
      document.getElementById('editGlobalPrinterLifespan').value = printer.lifespan;
      
      // Update depreciation display
      updateGlobalPrinterDepreciation();
      
      // Show modal
      const modal = document.getElementById('editGlobalPrinterModal');
      console.log('Modal element:', modal);
      if (modal) {
        modal.style.display = 'grid';
        console.log('Modal should now be visible');
      } else {
        console.error('Modal element not found!');
      }
    };
    
    // Delete Global Printer (Admin Only)
    window.deleteGlobalPrinter = async function(printerName) {
      if (currentUserTier !== 'admin') {
        await showNotification('You need admin access to delete global printers.', 'Access Denied', '🔒');
        return;
      }
      
      const confirmed = await showConfirm(
        `Delete global printer "${printerName}"? This will affect all users and cannot be undone.`,
        'Delete Printer?'
      );
      
      if (!confirmed) return;
      
      // Find and delete from Firebase
      printersRef.orderByChild('name').equalTo(printerName).once('value', snapshot => {
        snapshot.forEach(child => {
          child.ref.remove()
            .then(async () => {
              await showNotification(`Printer "${printerName}" has been deleted successfully.`, 'Success', '✅');
              renderPrintersList();
            })
            .catch(async (error) => {
              await showNotification(`Error deleting printer: ${error.message}`, 'Error', '❌');
            });
        });
      });
    };
    
    // Duplicate Global Printer (Admin Only)
    window.duplicateGlobalPrinter = async function(printerName) {
      if (currentUserTier !== 'admin') {
        await showNotification('You need admin access to duplicate global printers.', 'Access Denied', '🔒');
        return;
      }
      
      const printer = printersData[printerName];
      if (!printer) {
        await showNotification('Printer not found in the database.', 'Error', '❌');
        return;
      }
      
      const newName = await showPrompt(
        'Enter name for the duplicated printer:',
        printer.name + ' (Copy)',
        'Duplicate Printer'
      );
      
      if (!newName) return;
      
      // Create duplicate with new name
      const newPrinter = {
        name: newName,
        brand: printer.brand,
        price: printer.price,
        lifespan: printer.lifespan,
        costPerHour: printer.costPerHour
      };
      
      printersRef.push(newPrinter)
        .then(async () => {
          await showNotification(`Printer "${newName}" has been duplicated successfully.`, 'Success', '✅');
          renderPrintersList();
        })
        .catch(async (error) => {
          await showNotification(`Error duplicating printer: ${error.message}`, 'Error', '❌');
        });
    };
    
    // Edit Global Filament (Admin Only)
    window.editGlobalFilament = async function(filamentType) {
      console.log('editGlobalFilament called with:', filamentType);
      console.log('Current user tier:', currentUserTier);
      console.log('Available filaments:', Object.keys(filamentsData));
      
      if (currentUserTier !== 'admin') {
        await showNotification('You need admin access to edit global filaments.', 'Access Denied', '🔒');
        return;
      }
      
      const filament = filamentsData[filamentType];
      if (!filament) {
        console.error('Filament not found:', filamentType);
        await showNotification('Filament not found in the database.', 'Error', '❌');
        return;
      }
      
      console.log('Opening edit modal for filament:', filament);
      
      // Populate modal
      document.getElementById('editGlobalFilamentOriginalType').value = filamentType;
      document.getElementById('editGlobalFilamentType').value = filament.type;
      document.getElementById('editGlobalFilamentBrand').value = filament.brand || '';
      document.getElementById('editGlobalFilamentWeight').value = filament.spoolWeight;
      document.getElementById('editGlobalFilamentCost').value = filament.spoolCost;
      
      // Update cost per gram display
      updateGlobalFilamentCostPerG();
      
      // Show modal
      const modal = document.getElementById('editGlobalFilamentModal');
      console.log('Modal element:', modal);
      if (modal) {
        modal.style.display = 'grid';
        console.log('Modal should now be visible');
      } else {
        console.error('Modal element not found!');
      }
    };
    
    // Delete Global Filament (Admin Only)
    window.deleteGlobalFilament = async function(filamentType) {
      if (currentUserTier !== 'admin') {
        await showNotification('You need admin access to delete global filaments.', 'Access Denied', '🔒');
        return;
      }
      
      const confirmed = await showConfirm(
        `Delete global filament "${filamentType}"? This will affect all users and cannot be undone.`,
        'Delete Filament?'
      );
      
      if (!confirmed) return;
      
      // Find and delete from Firebase
      filamentsRef.orderByChild('type').equalTo(filamentType).once('value', snapshot => {
        snapshot.forEach(child => {
          child.ref.remove()
            .then(async () => {
              await showNotification(`Filament "${filamentType}" has been deleted successfully.`, 'Success', '✅');
              renderFilamentsList();
            })
            .catch(async (error) => {
              await showNotification(`Error deleting filament: ${error.message}`, 'Error', '❌');
            });
        });
      });
    };
    
    // Duplicate Global Filament (Admin Only)
    window.duplicateGlobalFilament = async function(filamentType) {
      if (currentUserTier !== 'admin') {
        await showNotification('You need admin access to duplicate global filaments.', 'Access Denied', '🔒');
        return;
      }
      
      const filament = filamentsData[filamentType];
      if (!filament) {
        await showNotification('Filament not found in the database.', 'Error', '❌');
        return;
      }
      
      const newType = await showPrompt(
        'Enter type for the duplicated filament:',
        filament.type + ' (Copy)',
        'Duplicate Filament'
      );
      
      if (!newType) return;
      
      // Create duplicate with new type
      const newFilament = {
        type: newType,
        brand: filament.brand,
        spoolWeight: filament.spoolWeight,
        spoolCost: filament.spoolCost,
        costPerG: filament.costPerG
      };
      
      filamentsRef.push(newFilament)
        .then(async () => {
          await showNotification(`Filament "${newType}" has been duplicated successfully.`, 'Success', '✅');
          renderFilamentsList();
        })
        .catch(async (error) => {
          await showNotification(`Error duplicating filament: ${error.message}`, 'Error', '❌');
        });
    };
    
    // Update depreciation display for global printer editing
    function updateGlobalPrinterDepreciation() {
      const price = parseFloat(document.getElementById('editGlobalPrinterPrice').value) || 0;
      const lifespan = parseFloat(document.getElementById('editGlobalPrinterLifespan').value) || 1;
      const depreciation = price / lifespan;
      document.getElementById('editGlobalPrinterDepreciation').textContent = money(depreciation);
    }
    
    // Update cost per gram display for global filament editing
    function updateGlobalFilamentCostPerG() {
      const cost = parseFloat(document.getElementById('editGlobalFilamentCost').value) || 0;
      const weight = parseFloat(document.getElementById('editGlobalFilamentWeight').value) || 1;
      const costPerG = cost / weight;
      document.getElementById('editGlobalFilamentCostPerG').textContent = money(costPerG);
    }
    
    // Update depreciation display for adding global printer
    function updateAddGlobalPrinterDepreciation() {
      const price = parseFloat(document.getElementById('addGlobalPrinterPrice').value) || 0;
      const lifespan = parseFloat(document.getElementById('addGlobalPrinterLifespan').value) || 1;
      const depreciation = price / lifespan;
      document.getElementById('addGlobalPrinterDepreciation').textContent = money(depreciation);
    }
    
    // Update cost per gram display for adding global filament
    function updateAddGlobalFilamentCostPerG() {
      const cost = parseFloat(document.getElementById('addGlobalFilamentCost').value) || 0;
      const weight = parseFloat(document.getElementById('addGlobalFilamentWeight').value) || 1;
      const costPerG = cost / weight;
      document.getElementById('addGlobalFilamentCostPerG').textContent = money(costPerG);
    }
    
    // Show/hide admin buttons based on user tier
    function updateAdminButtonsVisibility() {
      const btnAddGlobalPrinter = document.getElementById('btnAddGlobalPrinter');
      const btnAddGlobalFilament = document.getElementById('btnAddGlobalFilament');
      
      if (currentUserTier === 'admin') {
        if (btnAddGlobalPrinter) btnAddGlobalPrinter.style.display = 'inline-block';
        if (btnAddGlobalFilament) btnAddGlobalFilament.style.display = 'inline-block';
      } else {
        if (btnAddGlobalPrinter) btnAddGlobalPrinter.style.display = 'none';
        if (btnAddGlobalFilament) btnAddGlobalFilament.style.display = 'none';
      }
    }
    
    // Setup modal event listeners for global editing
    document.addEventListener('DOMContentLoaded', function() {
      // Global Printer Modal
      const editGlobalPrinterModal = document.getElementById('editGlobalPrinterModal');
      const closeEditGlobalPrinterX = document.getElementById('closeEditGlobalPrinterX');
      const closeEditGlobalPrinter = document.getElementById('closeEditGlobalPrinter');
      const saveEditGlobalPrinter = document.getElementById('saveEditGlobalPrinter');
      
      if (closeEditGlobalPrinterX) {
        closeEditGlobalPrinterX.addEventListener('click', () => {
          editGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (closeEditGlobalPrinter) {
        closeEditGlobalPrinter.addEventListener('click', () => {
          editGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (saveEditGlobalPrinter) {
        saveEditGlobalPrinter.addEventListener('click', async () => {
          const originalName = document.getElementById('editGlobalPrinterOriginalName').value;
          const newName = document.getElementById('editGlobalPrinterName').value.trim();
          const brand = document.getElementById('editGlobalPrinterBrand').value.trim();
          const price = parseFloat(document.getElementById('editGlobalPrinterPrice').value);
          const lifespan = parseFloat(document.getElementById('editGlobalPrinterLifespan').value);
          
          if (!newName || !brand || !price || !lifespan) {
            await showNotification('Please fill in all fields.', 'Missing Information', 'ℹ️');
            return;
          }
          
          const updatedPrinter = {
            name: newName,
            brand: brand,
            price: price,
            lifespan: lifespan,
            costPerHour: price / lifespan
          };
          
          // Find and update in Firebase
          printersRef.orderByChild('name').equalTo(originalName).once('value', snapshot => {
            snapshot.forEach(child => {
              child.ref.update(updatedPrinter)
                .then(async () => {
                  await showNotification(`Printer "${newName}" has been updated successfully.`, 'Success', '✅');
                  editGlobalPrinterModal.style.display = 'none';
                  renderPrintersList();
                })
                .catch(async (error) => {
                  await showNotification(`Error updating printer: ${error.message}`, 'Error', '❌');
                });
            });
          });
        });
      }
      
      // Update depreciation on input change
      const priceInput = document.getElementById('editGlobalPrinterPrice');
      const lifespanInput = document.getElementById('editGlobalPrinterLifespan');
      if (priceInput) priceInput.addEventListener('input', updateGlobalPrinterDepreciation);
      if (lifespanInput) lifespanInput.addEventListener('input', updateGlobalPrinterDepreciation);
      
      // Global Filament Modal
      const editGlobalFilamentModal = document.getElementById('editGlobalFilamentModal');
      const closeEditGlobalFilamentX = document.getElementById('closeEditGlobalFilamentX');
      const closeEditGlobalFilament = document.getElementById('closeEditGlobalFilament');
      const saveEditGlobalFilament = document.getElementById('saveEditGlobalFilament');
      
      if (closeEditGlobalFilamentX) {
        closeEditGlobalFilamentX.addEventListener('click', () => {
          editGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (closeEditGlobalFilament) {
        closeEditGlobalFilament.addEventListener('click', () => {
          editGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (saveEditGlobalFilament) {
        saveEditGlobalFilament.addEventListener('click', async () => {
          const originalType = document.getElementById('editGlobalFilamentOriginalType').value;
          const newType = document.getElementById('editGlobalFilamentType').value.trim();
          const brand = document.getElementById('editGlobalFilamentBrand').value.trim();
          const weight = parseFloat(document.getElementById('editGlobalFilamentWeight').value);
          const cost = parseFloat(document.getElementById('editGlobalFilamentCost').value);
          
          if (!newType || !brand || !weight || !cost) {
            await showNotification('Please fill in all fields.', 'Missing Information', 'ℹ️');
            return;
          }
          
          const updatedFilament = {
            type: newType,
            brand: brand,
            spoolWeight: weight,
            spoolCost: cost,
            costPerG: cost / weight
          };
          
          // Find and update in Firebase
          filamentsRef.orderByChild('type').equalTo(originalType).once('value', snapshot => {
            snapshot.forEach(child => {
              child.ref.update(updatedFilament)
                .then(async () => {
                  await showNotification(`Filament "${newType}" has been updated successfully.`, 'Success', '✅');
                  editGlobalFilamentModal.style.display = 'none';
                  renderFilamentsList();
                })
                .catch(async (error) => {
                  await showNotification(`Error updating filament: ${error.message}`, 'Error', '❌');
                });
            });
          });
        });
      }
      
      // Update cost per gram on input change
      const costInput = document.getElementById('editGlobalFilamentCost');
      const weightInput = document.getElementById('editGlobalFilamentWeight');
      if (costInput) costInput.addEventListener('input', updateGlobalFilamentCostPerG);
      if (weightInput) weightInput.addEventListener('input', updateGlobalFilamentCostPerG);
      
      // Add Global Printer Modal
      const addGlobalPrinterModal = document.getElementById('addGlobalPrinterModal');
      const btnAddGlobalPrinter = document.getElementById('btnAddGlobalPrinter');
      const closeAddGlobalPrinterX = document.getElementById('closeAddGlobalPrinterX');
      const closeAddGlobalPrinter = document.getElementById('closeAddGlobalPrinter');
      const saveAddGlobalPrinter = document.getElementById('saveAddGlobalPrinter');
      
      if (btnAddGlobalPrinter) {
        btnAddGlobalPrinter.addEventListener('click', async () => {
          if (currentUserTier !== 'admin') {
            await showNotification('You need admin access to add global printers.', 'Access Denied', '🔒');
            return;
          }
          // Clear form
          document.getElementById('addGlobalPrinterName').value = '';
          document.getElementById('addGlobalPrinterBrand').value = '';
          document.getElementById('addGlobalPrinterPrice').value = '';
          document.getElementById('addGlobalPrinterLifespan').value = '5000';
          document.getElementById('addGlobalPrinterDepreciation').textContent = '-';
          addGlobalPrinterModal.style.display = 'grid';
        });
      }
      
      if (closeAddGlobalPrinterX) {
        closeAddGlobalPrinterX.addEventListener('click', () => {
          addGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (closeAddGlobalPrinter) {
        closeAddGlobalPrinter.addEventListener('click', () => {
          addGlobalPrinterModal.style.display = 'none';
        });
      }
      
      if (saveAddGlobalPrinter) {
        saveAddGlobalPrinter.addEventListener('click', async () => {
          const name = document.getElementById('addGlobalPrinterName').value.trim();
          const brand = document.getElementById('addGlobalPrinterBrand').value.trim();
          const price = parseFloat(document.getElementById('addGlobalPrinterPrice').value);
          const lifespan = parseFloat(document.getElementById('addGlobalPrinterLifespan').value);
          
          if (!name || !brand || !price || !lifespan) {
            await showNotification('Please fill in all fields.', 'Missing Information', 'ℹ️');
            return;
          }
          
          const newPrinter = {
            name: name,
            brand: brand,
            price: price,
            lifespan: lifespan,
            costPerHour: price / lifespan
          };
          
          printersRef.push(newPrinter)
            .then(async () => {
              await showNotification(`Global printer "${name}" has been added successfully.`, 'Success', '✅');
              addGlobalPrinterModal.style.display = 'none';
              renderPrintersList();
            })
            .catch(async (error) => {
              await showNotification(`Error adding printer: ${error.message}`, 'Error', '❌');
            });
        });
      }
      
      // Update depreciation on input change for add modal
      const addPriceInput = document.getElementById('addGlobalPrinterPrice');
      const addLifespanInput = document.getElementById('addGlobalPrinterLifespan');
      if (addPriceInput) addPriceInput.addEventListener('input', updateAddGlobalPrinterDepreciation);
      if (addLifespanInput) addLifespanInput.addEventListener('input', updateAddGlobalPrinterDepreciation);
      
      // Add Global Filament Modal
      const addGlobalFilamentModal = document.getElementById('addGlobalFilamentModal');
      const btnAddGlobalFilament = document.getElementById('btnAddGlobalFilament');
      const closeAddGlobalFilamentX = document.getElementById('closeAddGlobalFilamentX');
      const closeAddGlobalFilament = document.getElementById('closeAddGlobalFilament');
      const saveAddGlobalFilament = document.getElementById('saveAddGlobalFilament');
      
      if (btnAddGlobalFilament) {
        btnAddGlobalFilament.addEventListener('click', async () => {
          if (currentUserTier !== 'admin') {
            await showNotification('You need admin access to add global filaments.', 'Access Denied', '🔒');
            return;
          }
          // Clear form
          document.getElementById('addGlobalFilamentType').value = '';
          document.getElementById('addGlobalFilamentBrand').value = '';
          document.getElementById('addGlobalFilamentWeight').value = '1000';
          document.getElementById('addGlobalFilamentCost').value = '';
          document.getElementById('addGlobalFilamentCostPerG').textContent = '-';
          addGlobalFilamentModal.style.display = 'grid';
        });
      }
      
      if (closeAddGlobalFilamentX) {
        closeAddGlobalFilamentX.addEventListener('click', () => {
          addGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (closeAddGlobalFilament) {
        closeAddGlobalFilament.addEventListener('click', () => {
          addGlobalFilamentModal.style.display = 'none';
        });
      }
      
      if (saveAddGlobalFilament) {
        saveAddGlobalFilament.addEventListener('click', async () => {
          const type = document.getElementById('addGlobalFilamentType').value.trim();
          const brand = document.getElementById('addGlobalFilamentBrand').value.trim();
          const weight = parseFloat(document.getElementById('addGlobalFilamentWeight').value);
          const cost = parseFloat(document.getElementById('addGlobalFilamentCost').value);
          
          if (!type || !brand || !weight || !cost) {
            await showNotification('Please fill in all fields.', 'Missing Information', 'ℹ️');
            return;
          }
          
          const newFilament = {
            type: type,
            brand: brand,
            spoolWeight: weight,
            spoolCost: cost,
            costPerG: cost / weight
          };
          
          filamentsRef.push(newFilament)
            .then(async () => {
              await showNotification(`Global filament "${type}" has been added successfully.`, 'Success', '✅');
              addGlobalFilamentModal.style.display = 'none';
              renderFilamentsList();
            })
            .catch(async (error) => {
              await showNotification(`Error adding filament: ${error.message}`, 'Error', '❌');
            });
        });
      }
      
      // Update cost per gram on input change for add modal
      const addCostInput = document.getElementById('addGlobalFilamentCost');
      const addWeightInput = document.getElementById('addGlobalFilamentWeight');
      if (addCostInput) addCostInput.addEventListener('input', updateAddGlobalFilamentCostPerG);
      if (addWeightInput) addWeightInput.addEventListener('input', updateAddGlobalFilamentCostPerG);
    });

    // Check if user can perform calculation (tier limit)
    async function checkCalculationLimit() {
      const user = firebase.auth().currentUser;
      if (!user) {
        // Not logged in - allow limited calculations
        return { allowed: true, tier: 'free', used: 0, limit: TIER_CALCULATION_LIMITS.free };
      }

      try {
        // Get user's tier
        const tierSnapshot = await firebase.database().ref(`users/${user.uid}/membership/tier`).once('value');
        const tier = tierSnapshot.val() || 'free';
        currentUserTier = tier;

        // Get user's role (admin override)
        const roleSnapshot = await firebase.database().ref(`users/${user.uid}/role`).once('value');
        const role = roleSnapshot.val();
        
        if (role === 'admin') {
          currentUserTier = 'admin';
        }
        
        // Update admin button visibility
        updateAdminButtonsVisibility();

        // Get current month's calculation count
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const calcSnapshot = await firebase.database().ref(`users/${user.uid}/calculationHistory/${monthKey}`).once('value');
        const calculations = calcSnapshot.val() || {};
        calculationsThisMonth = Object.keys(calculations).length;

        const limit = TIER_CALCULATION_LIMITS[currentUserTier] || TIER_CALCULATION_LIMITS.free;
        const allowed = calculationsThisMonth < limit;

        return { allowed, tier: currentUserTier, used: calculationsThisMonth, limit };
      } catch (error) {
        console.error('Error checking calculation limit:', error);
        return { allowed: true, tier: 'free', used: 0, limit: TIER_CALCULATION_LIMITS.free };
      }
    }

    // Update calculation limit display
    function updateCalculationLimitDisplay() {
      const infoDiv = document.getElementById('calculationLimitInfo');
      if (!infoDiv) return;

      const limit = TIER_CALCULATION_LIMITS[currentUserTier] || TIER_CALCULATION_LIMITS.free;
      
      if (currentUserTier === 'admin') {
        infoDiv.innerHTML = `<span style="color: #8b5cf6;">✨ Unlimited calculations (Admin)</span>`;
      } else {
        const remaining = limit - calculationsThisMonth;
        const percentage = (calculationsThisMonth / limit) * 100;
        
        let color = '#10b981'; // green
        if (percentage >= 90) color = '#ef4444'; // red
        else if (percentage >= 70) color = '#f59e0b'; // orange
        
        infoDiv.innerHTML = `
          <span style="color: ${color};">
            ${calculationsThisMonth} / ${limit} calculations used this month
            ${remaining > 0 ? `(${remaining} remaining)` : '(Limit reached)'}
          </span>
        `;
      }
    }

    // Save calculation to history
    async function saveCalculationToHistory(calculationData) {
      const user = firebase.auth().currentUser;
      if (!user) return;

      try {
        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const timestamp = now.getTime();
        
        await firebase.database().ref(`users/${user.uid}/calculationHistory/${monthKey}/${timestamp}`).set({
          ...calculationData,
          timestamp: timestamp,
          date: now.toISOString()
        });

        console.log('Calculation saved to history');
      } catch (error) {
        console.error('Error saving calculation:', error);
      }
    }

    // Calculate cost (now only called when Calculate button is pressed)
    async function calculateCost() {
      const printerValue = document.getElementById('printerSelect')?.value;
      const filamentValue = document.getElementById('filamentSelect')?.value;
      
      if (!printerValue || !filamentValue) {
        alert('Please select both a printer and filament before calculating.');
        return;
      }

      // Check calculation limit
      const limitCheck = await checkCalculationLimit();
      
      if (!limitCheck.allowed) {
        alert(`You've reached your calculation limit for this month (${limitCheck.limit} calculations for ${limitCheck.tier} tier).\n\nUpgrade your membership to get more calculations!`);
        return;
      }

      // Get printer data
      let printer = null;
      if (printerValue.startsWith('user:')) {
        const id = printerValue.substring(5);
        printer = userPrintersData[id];
        if (printer) {
          // Calculate cost per hour for user printer
          printer = {
            ...printer,
            costPerHour: printer.price / printer.lifespan
          };
        }
      } else if (printerValue.startsWith('global:')) {
        const name = printerValue.substring(7);
        printer = printersData[name];
      }
      
      // Get filament data
      let filament = null;
      if (filamentValue.startsWith('user:')) {
        const id = filamentValue.substring(5);
        filament = userFilamentsData[id];
        if (filament) {
          // Calculate cost per gram for user filament
          filament = {
            ...filament,
            costPerG: filament.spoolCost / filament.spoolWeight
          };
        }
      } else if (filamentValue.startsWith('global:')) {
        const type = filamentValue.substring(7);
        filament = filamentsData[type];
      }
      
      if (!printer || !filament) {
        alert('Error loading printer or filament data. Please try again.');
        return;
      }

      // Get all values
      const pt = parseFloat(document.getElementById('printTime').value) || 0;
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const electricityPrice = parseFloat(document.getElementById('elec').value) || 0.12;
      const electricityUsagePerHour = 0.1; // kWh/h

      // Post-processing (minutes to hours)
      const jobRemoval = (parseFloat(document.getElementById('jobRemoval').value) || 0) / 60;
      const supportRemoval = (parseFloat(document.getElementById('supportRemoval').value) || 0) / 60;
      const additionalWork = (parseFloat(document.getElementById('additionalWork').value) || 0) / 60;
      const postProcessingTime = jobRemoval + supportRemoval + additionalWork;

      // Preparation (minutes to hours)
      const modelPrep = (parseFloat(document.getElementById('modelPrep').value) || 0) / 60;
      const slicing = (parseFloat(document.getElementById('slicing').value) || 0) / 60;
      const materialChange = (parseFloat(document.getElementById('materialChange').value) || 0) / 60;
      const transferStart = (parseFloat(document.getElementById('transferStart').value) || 0) / 60;
      const preparationTime = modelPrep + slicing + materialChange + transferStart;

      const totalHandTime = postProcessingTime + preparationTime;

      // Labor rates
      const postProcessingRate = parseFloat(document.getElementById('postProcessingRate').value) || 0;
      const preparationRate = parseFloat(document.getElementById('preparationRate').value) || 0;

      // Markups
      const filamentMarkup = parseFloat(document.getElementById('filamentMarkup').value) || 1;
      const generalMarkup = (parseFloat(document.getElementById('generalMarkup').value) || 0) / 100;
      const failureRate = (parseFloat(document.getElementById('failureRate').value) || 0) / 100;
      const includePrinterDepreciation = document.getElementById('includePrinterDepreciation').checked;

      // Convert printer and filament costs from USD to selected currency
      const userCurrency = window.currentCurrency || 'USD';
      const printerCostInCurrency = userCurrency === 'USD' ? printer.costPerHour : convertFromUSD(printer.costPerHour, userCurrency);
      const filamentCostInCurrency = userCurrency === 'USD' ? filament.costPerG : convertFromUSD(filament.costPerG, userCurrency);

      // Calculate costs (all in user's selected currency)
      const costPrinter = includePrinterDepreciation ? (printerCostInCurrency * pt) : 0;
      const costElectric = pt * electricityUsagePerHour * electricityPrice;
      const costFilament = filamentCostInCurrency * weight * filamentMarkup;
      const costPostProcessing = postProcessingTime * postProcessingRate;
      const costPreparation = preparationTime * preparationRate;
      const costLabor = costPostProcessing + costPreparation;
      
      // Subtotal WITHOUT labor
      const subtotalBeforeLabor = costPrinter + costFilament + costElectric;
      const subtotalWithMarkup = subtotalBeforeLabor * (1 + generalMarkup);
      const priceAfterFailureRate = subtotalWithMarkup / (1 - failureRate);
      
      // Add labor AFTER markup and failure rate
      const finalPrice = priceAfterFailureRate + costLabor;
      
      const subtotal = subtotalBeforeLabor;
      const markupApplied = subtotalWithMarkup - subtotalBeforeLabor;
      const failureAdjustment = priceAfterFailureRate - subtotalWithMarkup;

      // Update UI
      document.getElementById('printerCost').textContent = money(costPrinter);
      document.getElementById('filamentCost').textContent = money(costFilament);
      document.getElementById('filamentDetails').textContent = `${weight.toFixed(0)} g @ ${money(filamentCostInCurrency)}/g × ${filamentMarkup.toFixed(2)}`;
      document.getElementById('electricityCost').textContent = money(costElectric);
      document.getElementById('electricityDetails').textContent = `${electricityUsagePerHour} kWh/h`;
      
      document.getElementById('laborCost').textContent = money(costLabor);
      const postProcText = postProcessingTime > 0 ? `Post-Proc: ${postProcessingTime.toFixed(2)}h @ $${postProcessingRate.toFixed(2)}/h` : '';
      const prepText = preparationTime > 0 ? `Prep: ${preparationTime.toFixed(2)}h @ $${preparationRate.toFixed(2)}/h` : '';
      const separator = postProcText && prepText ? ' | ' : '';
      document.getElementById('laborDetails').textContent = postProcText + separator + prepText || 'No labor time';
      
      document.getElementById('subtotal').textContent = money(subtotal);
      document.getElementById('markupAmount').textContent = money(markupApplied);
      document.getElementById('failureCostDisplay').textContent = money(failureAdjustment);
      document.getElementById('totalCost').textContent = money(finalPrice);
      
      const hasLabor = (postProcessingRate > 0 && postProcessingTime > 0) || (preparationRate > 0 && preparationTime > 0);
      document.getElementById('handTimeNote').textContent = hasLabor ? `Total labor: ${totalHandTime.toFixed(2)} hours` : `Hand time: ${totalHandTime.toFixed(2)} hours (set labor rates to bill)`;

      // Save calculation to history (ALWAYS store in USD for consistency)
      const currentCurrency = window.currentCurrency || 'USD';
      
      // Convert all costs back to USD before saving
      const toUSD = (amount) => {
        if (currentCurrency === 'USD') return amount;
        return convertToUSD(amount, currentCurrency);
      };
      
      const calculationData = {
        printer: printer.name,
        printerBrand: printer.brand,
        filament: filament.type,
        filamentBrand: filament.brand,
        printTime: pt,
        weight: weight,
        totalCost: toUSD(finalPrice), // Store in USD
        calculatedInCurrency: currentCurrency, // Track what currency was used during calculation
        breakdown: {
          printerCost: toUSD(costPrinter),
          filamentCost: toUSD(costFilament),
          electricityCost: toUSD(costElectric),
          laborCost: toUSD(costLabor),
          subtotal: toUSD(subtotal),
          markup: toUSD(markupApplied),
          failureAdjustment: toUSD(failureAdjustment)
        },
        parameters: {
          electricityPrice: toUSD(electricityPrice),
          filamentMarkup,
          generalMarkup: generalMarkup * 100,
          failureRate: failureRate * 100,
          postProcessingRate: toUSD(postProcessingRate),
          preparationRate: toUSD(preparationRate),
          includePrinterDepreciation
        }
      };

      await saveCalculationToHistory(calculationData);
      
      // Update the count and display
      calculationsThisMonth++;
      updateCalculationLimitDisplay();

      // Show success feedback
      const btnCalculate = document.getElementById('btnCalculate');
      const originalText = btnCalculate.innerHTML;
      btnCalculate.innerHTML = '✅ Calculated!';
      btnCalculate.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      setTimeout(() => {
        btnCalculate.innerHTML = originalText;
        btnCalculate.style.background = '';
      }, 2000);
    }

    // Reset results display
    function resetResults() {
      document.getElementById('printerCost').textContent = money(0);
      document.getElementById('filamentCost').textContent = money(0);
      document.getElementById('electricityCost').textContent = money(0);
      document.getElementById('laborCost').textContent = money(0);
      document.getElementById('subtotal').textContent = money(0);
      document.getElementById('markupAmount').textContent = money(0);
      document.getElementById('failureCostDisplay').textContent = money(0);
      document.getElementById('totalCost').textContent = money(0);
      document.getElementById('filamentDetails').textContent = '';
      document.getElementById('electricityDetails').textContent = '';
      document.getElementById('laborDetails').textContent = '';
      document.getElementById('handTimeNote').textContent = 'Unbilled hand time: 0.00 hours';
    }

    // Sync print time fields
    const printTimeInput = document.getElementById('printTime');
    const printTimeDuplicate = document.getElementById('printTimeDuplicate');
    
    if (printTimeInput && printTimeDuplicate) {
      printTimeInput.addEventListener('input', () => {
        printTimeDuplicate.value = printTimeInput.value || 0;
      });
    }

    // Calculate button click handler
    const btnCalculate = document.getElementById('btnCalculate');
    if (btnCalculate) {
      btnCalculate.addEventListener('click', calculateCost);
    }

    // Printer select change - only update price info, don't calculate
    const printerSelect = document.getElementById('printerSelect');
    if (printerSelect) {
      printerSelect.addEventListener('change', updatePriceInfo);
    }

    // Filament select change - only update price info, don't calculate
    const filamentSelect = document.getElementById('filamentSelect');
    if (filamentSelect) {
      filamentSelect.addEventListener('change', updatePriceInfo);
    }

    // Reset calculator button
    const btnResetCalculator = document.getElementById('btnResetCalculator');
    if (btnResetCalculator) {
      btnResetCalculator.addEventListener('click', () => {
        if (confirm('Reset all fields to default values?')) {
          // Define defaults
          const defaults = {
            'printerSelect': '',
            'filamentSelect': '',
            'printTime': '0',
            'weight': '0',
            'printTimeDuplicate': '',
            'elec': '0.12',
            'jobRemoval': '0',
            'supportRemoval': '0',
            'additionalWork': '0',
            'postProcessingRate': '20',
            'modelPrep': '0',
            'slicing': '0',
            'materialChange': '0',
            'transferStart': '0',
            'preparationRate': '20',
            'filamentMarkup': '2.7',
            'generalMarkup': '50',
            'failureRate': '10'
          };
          
          // Reset all fields
          for (const [id, defaultValue] of Object.entries(defaults)) {
            const elem = document.getElementById(id);
            if (elem) {
              elem.value = defaultValue;
            }
          }
          
          updatePriceInfo();
          resetResults();
        }
      });
    }

    // Initialize calculator when page loads
    async function initializeCalculator() {
      console.log('Initializing calculator...');
      loadPrinters();
      loadFilaments();
      
      // Load user's calculation count and tier
      const user = firebase.auth().currentUser;
      if (user) {
        const limitCheck = await checkCalculationLimit();
        updateCalculationLimitDisplay();
      } else {
        // Show info for non-logged in users
        const infoDiv = document.getElementById('calculationLimitInfo');
        if (infoDiv) {
          infoDiv.innerHTML = `<span style="color: #6b7280;">Login to track your calculations and access tier benefits</span>`;
        }
      }
      
      // Restore the last active tab after currency change reload
      const savedTab = localStorage.getItem('activeCalculatorTab');
      if (savedTab) {
        localStorage.removeItem('activeCalculatorTab'); // Clear it after using
        // Valid tab names: 'calculator', 'printers', 'filaments', 'userPresets'
        if (['calculator', 'printers', 'filaments', 'userPresets'].includes(savedTab)) {
          switchCalcTab(savedTab);
        }
      }
    }

    // Update calculation limits when user logs in/out
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        const limitCheck = await checkCalculationLimit();
        updateCalculationLimitDisplay();
        loadUserPresets(); // Load presets when user logs in
        loadUserPrinters(); // Load user printers
        loadUserFilaments(); // Load user filaments
      } else {
        currentUserTier = 'free';
        calculationsThisMonth = 0;
        const infoDiv = document.getElementById('calculationLimitInfo');
        if (infoDiv) {
          infoDiv.innerHTML = `<span style="color: #6b7280;">Login to track your calculations and access tier benefits</span>`;
        }
        userPresets = []; // Clear presets when user logs out
        updatePresetsUI();
        userPrintersData = {}; // Clear user printers
        userFilamentsData = {}; // Clear user filaments
        renderUserPrintersList();
        renderUserFilamentsList();
      }
    });

    // Call initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCalculator);
    } else {
      initializeCalculator();
    }

    // ==================== ORDERS FUNCTIONALITY ====================
    
    // Currency helper functions (wrappers for currency.js)
    function getCurrencySymbol(currencyCode) {
      const currencySymbols = {
        'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥', 'CNY': '¥',
        'CAD': '$', 'AUD': '$', 'CHF': 'Fr', 'INR': '₹', 'MXN': '$',
        'BRL': 'R$', 'ZAR': 'R', 'KRW': '₩', 'SGD': '$', 'NZD': '$',
        'SEK': 'kr', 'NOK': 'kr', 'DKK': 'kr', 'PLN': 'zł', 'THB': '฿',
        'IDR': 'Rp', 'HUF': 'Ft', 'CZK': 'Kč', 'ILS': '₪', 'CLP': '$',
        'PHP': '₱', 'AED': 'د.إ', 'SAR': '﷼', 'MYR': 'RM', 'RON': 'lei'
      };
      return currencySymbols[currencyCode] || '$';
    }

    function getCurrencyLabel(currencyCode) {
      const currency = currencyCode || window.currentCurrency || 'USD';
      const symbol = getCurrencySymbol(currency);
      
      // Consistent format for all currencies: "CAD ($)" or "EUR (€)"
      return `${currency} (${symbol})`;
    }

    function convertToUSD(amount, sourceCurrency) {
      const exchangeRates = {
        'USD': 1.00, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 149.50, 'CNY': 7.24,
        'CAD': 1.36, 'AUD': 1.53, 'CHF': 0.88, 'INR': 83.12, 'MXN': 17.05,
        'BRL': 4.98, 'ZAR': 18.35, 'KRW': 1342.50, 'SGD': 1.34, 'NZD': 1.65,
        'SEK': 10.58, 'NOK': 10.72, 'DKK': 6.85, 'PLN': 3.96, 'THB': 35.48,
        'IDR': 15420.00, 'HUF': 355.20, 'CZK': 22.95, 'ILS': 3.75, 'CLP': 945.50,
        'PHP': 56.25, 'AED': 3.67, 'SAR': 3.75, 'MYR': 4.68, 'RON': 4.56
      };
      const rate = exchangeRates[sourceCurrency] || 1;
      return amount / rate;
    }

    function convertFromUSD(amountUSD, targetCurrency) {
      const exchangeRates = {
        'USD': 1.00, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 149.50, 'CNY': 7.24,
        'CAD': 1.36, 'AUD': 1.53, 'CHF': 0.88, 'INR': 83.12, 'MXN': 17.05,
        'BRL': 4.98, 'ZAR': 18.35, 'KRW': 1342.50, 'SGD': 1.34, 'NZD': 1.65,
        'SEK': 10.58, 'NOK': 10.72, 'DKK': 6.85, 'PLN': 3.96, 'THB': 35.48,
        'IDR': 15420.00, 'HUF': 355.20, 'CZK': 22.95, 'ILS': 3.75, 'CLP': 945.50,
        'PHP': 56.25, 'AED': 3.67, 'SAR': 3.75, 'MYR': 4.68, 'RON': 4.56
      };
      const rate = exchangeRates[targetCurrency] || 1;
      return amountUSD * rate;
    }

    function getCurrencySymbolLocal() {
      return getCurrencySymbol(window.currentCurrency || 'USD');
    }

    function formatCurrencyLocal(amount) {
      const currency = window.currentCurrency || 'USD';
      // Format based on currency
      if (currency === 'JPY' || currency === 'KRW' || currency === 'IDR') {
        return Math.round(amount).toLocaleString();
      }
      return amount.toFixed(2);
    }

    function loadSavedCurrency(user) {
      return new Promise((resolve) => {
        if (!user) {
          window.currentCurrency = 'USD';
          resolve();
          return;
        }
        
        firebase.database().ref(`users/${user.uid}/currency`).once('value', (snapshot) => {
          window.currentCurrency = snapshot.val() || 'USD';
          console.log('Loaded currency:', window.currentCurrency);
          resolve();
        });
      });
    }
    
    // Google Maps initialization for address autocomplete
    let autocomplete, editAutocomplete;
    window.initGoogleMaps = function() {
      console.log('Google Maps API loaded');
    };

    // Orders data storage
    let ordersData = [];
    let globalColorsData = {};
    let userColorsData = {};
    let selectedColors = [];
    let currentViewingOrderId = null;

    // Initialize orders when user is authenticated
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadSavedCurrency(user);
        loadOrders();
        loadColors(user);
        
        // Load filaments for material dropdown (reuse existing filaments data from calculator)
        populateMaterialDropdowns();
      }
    });

    // Add event listeners for orders buttons
    const btnManageColors = document.getElementById('btnManageColors');
    if (btnManageColors) {
      btnManageColors.addEventListener('click', openColorManagementModal);
    }

    const btnNewOrder = document.getElementById('btnNewOrder');
    if (btnNewOrder) {
      btnNewOrder.addEventListener('click', () => {
        if (!currentUser) {
          alert('Please login to create an order');
          return;
        }
        openNewOrderModal();
      });
    }

    // Add event listener for Add User Color button
    const btnAddUserColor = document.getElementById('btnAddUserColor');
    if (btnAddUserColor) {
      btnAddUserColor.addEventListener('click', addUserColor);
    }

    // Search and filter functionality
    const searchInput = document.getElementById('ordersSearchInput');
    const statusFilter = document.getElementById('ordersStatusFilter');
    
    if (searchInput) {
      searchInput.addEventListener('input', () => renderOrdersTable());
    }
    
    if (statusFilter) {
      statusFilter.addEventListener('change', () => renderOrdersTable());
    }

    // Color Management Modal Functions
    function openColorManagementModal() {
      const modal = document.getElementById('colorManagementModal');
      if (modal) {
        modal.style.display = 'flex';
        // Re-render colors when modal opens to ensure they're visible
        renderGlobalColors();
        renderUserColors();
      }
    }

    function closeColorManagementModal() {
      const modal = document.getElementById('colorManagementModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Tab switching for color management
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('preset-tab')) {
        const tabName = e.target.getAttribute('data-tab');
        
        // Update tabs
        document.querySelectorAll('.preset-tab').forEach(tab => tab.classList.remove('active'));
        e.target.classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
        const targetContent = document.getElementById(tabName);
        if (targetContent) {
          targetContent.style.display = 'block';
        }
      }
    });

    // Load colors from Firebase
    function loadColors(user) {
      console.log('Loading colors for user:', user ? user.uid : 'no user');
      
      // Load global colors (using 'colors' path like orders.html)
      const globalColorsRef = firebase.database().ref('colors');
      globalColorsRef.on('value', snapshot => {
        globalColorsData = {};
        const data = snapshot.val();
        
        if (data) {
          Object.entries(data).forEach(([key, value]) => {
            globalColorsData[key] = {
              id: key,
              name: value.name,
              hex: value.hex,
              brand: value.brand || ''
            };
          });
        }
        
        console.log('Global colors loaded:', Object.keys(globalColorsData).length, 'colors');
        renderGlobalColors();
      });
      
      // Load user colors if authenticated (using 'userColors' path like orders.html)
      if (user) {
        const userColorsRef = firebase.database().ref(`userColors/${user.uid}`);
        userColorsRef.on('value', snapshot => {
          userColorsData = {};
          
          if (snapshot.exists()) {
            snapshot.forEach(child => {
              const color = child.val();
              userColorsData[child.key] = {
                id: child.key,
                name: color.name,
                hex: color.hex,
                brand: color.brand || ''
              };
            });
          }
          
          console.log('User colors loaded:', Object.keys(userColorsData).length, 'colors');
          renderUserColors();
        });
      }
    }

    // Helper function to convert hex to HSL for rainbow sorting
    function hexToHSL(hex) {
      // Convert hex to RGB
      const r = parseInt(hex.slice(1, 3), 16) / 255;
      const g = parseInt(hex.slice(3, 5), 16) / 255;
      const b = parseInt(hex.slice(5, 7), 16) / 255;

      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0; // achromatic
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }

      return { h: h * 360, s: s * 100, l: l * 100 };
    }

    function renderGlobalColors() {
      const grid = document.getElementById('globalColorsGrid');
      if (!grid) {
        console.warn('Global colors grid element not found');
        return;
      }
      
      const colors = Object.entries(globalColorsData);
      console.log('Rendering global colors:', colors.length);
      
      if (colors.length === 0) {
        grid.innerHTML = '<div class="empty-colors-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #9ca3af;"><h4 style="margin-bottom: 8px; color: #ffffff;">No global colors available</h4><p>Contact admin to add global colors</p></div>';
        return;
      }
      
      // Group colors by brand
      const colorsByBrand = {};
      colors.forEach(([id, color]) => {
        const brand = color.brand || 'No Brand';
        if (!colorsByBrand[brand]) {
          colorsByBrand[brand] = [];
        }
        colorsByBrand[brand].push([id, color]);
      });
      
      // Sort brands alphabetically
      const sortedBrands = Object.keys(colorsByBrand).sort();
      
      // Build HTML with brand categories
      let html = '';
      sortedBrands.forEach(brand => {
        // Sort colors within brand by rainbow (hue)
        const brandColors = colorsByBrand[brand].sort((a, b) => {
          const hslA = hexToHSL(a[1].hex);
          const hslB = hexToHSL(b[1].hex);
          return hslA.h - hslB.h;
        });
        
        // Add brand header
        html += `
          <div class="brand-category-header" style="grid-column: 1 / -1; padding: 16px 0 12px 0; margin-top: 24px; border-bottom: 2px solid rgba(99, 102, 241, 0.3);">
            <h3 style="color: #ffffff; font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px;">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="color: #a78bfa;">
                <rect x="3" y="3" width="14" height="14" rx="2"/>
                <path d="M7 3v14M13 3v14M3 7h14M3 13h14"/>
              </svg>
              ${brand}
              <span style="font-size: 14px; color: #9ca3af; font-weight: 400; margin-left: 8px;">(${brandColors.length} colors)</span>
            </h3>
          </div>
        `;
        
        // Add color cards for this brand
        brandColors.forEach(([id, color]) => {
          html += `
            <div class="color-card">
              <div class="color-preview" style="background-color: ${color.hex};"></div>
              <div class="color-info">
                <div class="color-name">${color.name}</div>
                <div class="color-hex">${color.hex}</div>
              </div>
            </div>
          `;
        });
      });
      
      grid.innerHTML = html;
    }

    function renderUserColors() {
      const grid = document.getElementById('userColorsGrid');
      if (!grid) {
        console.warn('User colors grid element not found');
        return;
      }
      
      const colors = Object.entries(userColorsData);
      console.log('Rendering user colors:', colors.length);
      
      if (colors.length === 0) {
        grid.innerHTML = '<div class="empty-colors-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #9ca3af;"><h4 style="margin-bottom: 8px; color: #ffffff;">No personal colors yet</h4><p>Add your first color to get started</p></div>';
        return;
      }
      
      // Group colors by brand
      const colorsByBrand = {};
      colors.forEach(([id, color]) => {
        const brand = color.brand || 'No Brand';
        if (!colorsByBrand[brand]) {
          colorsByBrand[brand] = [];
        }
        colorsByBrand[brand].push([id, color]);
      });
      
      // Sort brands alphabetically
      const sortedBrands = Object.keys(colorsByBrand).sort();
      
      // Build HTML with brand categories
      let html = '';
      sortedBrands.forEach(brand => {
        // Sort colors within brand by rainbow (hue)
        const brandColors = colorsByBrand[brand].sort((a, b) => {
          const hslA = hexToHSL(a[1].hex);
          const hslB = hexToHSL(b[1].hex);
          return hslA.h - hslB.h;
        });
        
        // Add brand header
        html += `
          <div class="brand-category-header" style="grid-column: 1 / -1; padding: 16px 0 12px 0; margin-top: 24px; border-bottom: 2px solid rgba(99, 102, 241, 0.3);">
            <h3 style="color: #ffffff; font-size: 18px; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 8px;">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="color: #a78bfa;">
                <rect x="3" y="3" width="14" height="14" rx="2"/>
                <path d="M7 3v14M13 3v14M3 7h14M3 13h14"/>
              </svg>
              ${brand}
              <span style="font-size: 14px; color: #9ca3af; font-weight: 400; margin-left: 8px;">(${brandColors.length} colors)</span>
            </h3>
          </div>
        `;
        
        // Add color cards for this brand
        brandColors.forEach(([id, color]) => {
          html += `
            <div class="color-card">
              <div class="color-preview" style="background-color: ${color.hex};"></div>
              <div class="color-info">
                <div class="color-name">${color.name}</div>
                <div class="color-hex">${color.hex}</div>
              </div>
              <div class="color-actions">
                <button class="btn-action" onclick="editUserColor('${id}')">Edit</button>
                <button class="btn-action" onclick="deleteUserColor('${id}')">Delete</button>
              </div>
            </div>
          `;
        });
      });
      
      grid.innerHTML = html;
    }

    // Add user color
    function addUserColor() {
      const name = prompt('Enter color name:');
      if (!name) return;
      
      const brand = prompt('Enter brand (optional):') || '';
      
      const hex = prompt('Enter hex code (e.g., #FF5733):');
      if (!hex || !hex.match(/^#[0-9A-F]{6}$/i)) {
        alert('Invalid hex code');
        return;
      }
      
      if (!currentUser) {
        alert('Please login to add colors');
        return;
      }
      
      const colorRef = firebase.database().ref(`userColors/${currentUser.uid}`).push();
      colorRef.set({
        name: name,
        brand: brand,
        hex: hex,
        createdAt: Date.now()
      }).then(() => {
        alert('Color added successfully!');
      }).catch(error => {
        alert('Error adding color: ' + error.message);
      });
    }

    // Edit user color
    function editUserColor(colorId) {
      const color = userColorsData[colorId];
      if (!color) return;
      
      const name = prompt('Enter color name:', color.name);
      if (!name) return;
      
      const brand = prompt('Enter brand (optional):', color.brand || '') || '';
      
      const hex = prompt('Enter hex code:', color.hex);
      if (!hex || !hex.match(/^#[0-9A-F]{6}$/i)) {
        alert('Invalid hex code');
        return;
      }
      
      firebase.database().ref(`userColors/${currentUser.uid}/${colorId}`).update({
        name: name,
        brand: brand,
        hex: hex
      }).then(() => {
        alert('Color updated successfully!');
      }).catch(error => {
        alert('Error updating color: ' + error.message);
      });
    }

    // Delete user color
    function deleteUserColor(colorId) {
      if (!confirm('Delete this color?')) return;
      
      firebase.database().ref(`userColors/${currentUser.uid}/${colorId}`).remove()
        .then(() => alert('Color deleted'))
        .catch(error => alert('Error: ' + error.message));
    }

    // Mass delete functions
    function massDeleteUserColors() {
      if (!confirm('Delete all your colors? This cannot be undone!')) return;
      
      firebase.database().ref(`userColors/${currentUser.uid}`).remove()
        .then(() => alert('All colors deleted'))
        .catch(error => alert('Error: ' + error.message));
    }

    function massDeleteGlobalColors() {
      alert('Only admins can delete global colors');
    }

    function cancelGlobalSelection() {
      // Placeholder for selection cancel
    }

    function cancelUserSelection() {
      // Placeholder for selection cancel
    }

    // Populate material dropdown from existing filaments data
    function populateMaterialDropdowns() {
      const materialSelect = document.getElementById('material');
      if (!materialSelect || !filamentsData) return;
      
      const brands = {};
      Object.values(filamentsData).forEach(filament => {
        if (!brands[filament.brand]) {
          brands[filament.brand] = [];
        }
        brands[filament.brand].push(filament);
      });
      
      materialSelect.innerHTML = '<option value="">Select material</option>';
      Object.keys(brands).sort().forEach(brand => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = brand;
        brands[brand].forEach(filament => {
          const option = document.createElement('option');
          option.value = filament.type;
          option.textContent = filament.type;
          optgroup.appendChild(option);
        });
        materialSelect.appendChild(optgroup);
      });
    }

    // Load orders from Firebase
    function loadOrders() {
      if (!currentUser) {
        document.getElementById('ordersContent').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">Please login to view orders</p>';
        return;
      }
      
      const ordersRef = firebase.database().ref(`orders/${currentUser.uid}`);
      ordersRef.on('value', snapshot => {
        const data = snapshot.val();
        ordersData = [];
        
        if (data) {
          Object.entries(data).forEach(([id, order]) => {
            ordersData.push({ id, ...order });
          });
        }
        
        console.log('Loaded orders:', ordersData.length);
        renderOrdersTable();
      });
    }

    // Render orders table
    function renderOrdersTable() {
      const container = document.getElementById('ordersContent');
      if (!container) return;
      
      let filteredOrders = [...ordersData];
      
      // Apply search filter
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (searchTerm) {
        filteredOrders = filteredOrders.filter(order => 
          order.orderTitle?.toLowerCase().includes(searchTerm) ||
          order.clientName?.toLowerCase().includes(searchTerm) ||
          order.productName?.toLowerCase().includes(searchTerm)
        );
      }
      
      // Apply status filter
      const statusValue = statusFilter ? statusFilter.value : 'all';
      if (statusValue !== 'all') {
        filteredOrders = filteredOrders.filter(order => 
          order.orderStatus === statusValue || order.paymentStatus === statusValue
        );
      }
      
      // Sort by date (newest first)
      filteredOrders.sort((a, b) => (b.date || 0) - (a.date || 0));
      
      if (filteredOrders.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">No orders found</p>';
        return;
      }
      
      container.innerHTML = `
        <div class="orders-table-container">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Title</th>
                <th>Client</th>
                <th>Product</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filteredOrders.map(order => `
                <tr>
                  <td>#${order.id.slice(0, 7).toUpperCase()}</td>
                  <td>${order.orderTitle || 'N/A'}</td>
                  <td>${order.clientName || 'N/A'}</td>
                  <td>${order.productName || 'N/A'}</td>
                  <td>${getCurrencySymbolLocal()}${formatCurrencyLocal(convertFromUSD(order.total || 0))}</td>
                  <td><span class="status-badge status-${order.orderStatus || 'pending'}">${order.orderStatus || 'pending'}</span></td>
                  <td><span class="status-badge status-${order.paymentStatus || 'unpaid'}">${order.paymentStatus || 'unpaid'}</span></td>
                  <td>${formatDate(order.date)}</td>
                  <td>
                    <div class="order-actions">
                      <button class="btn-action" onclick="viewOrder('${order.id}')">View</button>
                      <button class="btn-action" onclick="duplicateOrder('${order.id}')">Duplicate</button>
                      <button class="btn-action" onclick="deleteOrder('${order.id}')">Delete</button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Format date helper
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    // New Order Modal Functions
    function openNewOrderModal() {
      const modal = document.getElementById('newOrderModal');
      const form = document.getElementById('newOrderForm');
      
      if (form) {
        form.reset();
        selectedColors = [];
      }
      
      // Populate material dropdown
      populateMaterialDropdowns();
      
      // Populate color picker
      setTimeout(() => {
        populateColorPicker();
      }, 100);
      
      if (modal) {
        modal.style.display = 'grid';
      }
      
      // Initialize address autocomplete
      setTimeout(initAutocomplete, 200);
    }

    function closeNewOrderModal() {
      const modal = document.getElementById('newOrderModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Initialize address autocomplete
    function initAutocomplete() {
      const input = document.getElementById('addressAutocomplete');
      if (!input || !window.google) return;
      
      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['address']
      });
      
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.address_components) return;
        
        // Populate address fields
        place.address_components.forEach(component => {
          const types = component.types;
          if (types.includes('street_number') || types.includes('route')) {
            document.getElementById('clientStreet').value = place.name || '';
          }
          if (types.includes('locality')) {
            document.getElementById('clientCity').value = component.long_name;
          }
          if (types.includes('administrative_area_level_1')) {
            document.getElementById('clientState').value = component.short_name;
          }
          if (types.includes('postal_code')) {
            document.getElementById('clientPostalCode').value = component.long_name;
          }
          if (types.includes('country')) {
            document.getElementById('clientCountry').value = component.long_name;
          }
        });
      });
    }

    // Populate color picker
    function populateColorPicker() {
      const grid = document.getElementById('colorSelectionGrid');
      if (!grid) return;
      
      const allColors = [
        ...Object.entries(globalColorsData).map(([id, color]) => ({ ...color, id, source: 'global' })),
        ...Object.entries(userColorsData).map(([id, color]) => ({ ...color, id, source: 'user' }))
      ];
      
      if (allColors.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No colors available</p>';
        return;
      }
      
      grid.innerHTML = allColors.map(color => `
        <div class="color-option" 
             style="background-color: ${color.hex}; border-color: ${color.hex};" 
             onclick="selectColor('${color.id}', '${color.name}', '${color.hex}')"
             title="${color.name}">
          <span class="color-option-label" style="color: ${getContrastColor(color.hex)};">
            ${color.name.substring(0, 12)}
          </span>
        </div>
      `).join('');
    }

    // Select color for order
    function selectColor(id, name, hex) {
      if (selectedColors.length >= 4) {
        alert('Maximum 4 colors allowed');
        return;
      }
      
      if (selectedColors.some(c => c.hex === hex)) {
        alert('Color already selected');
        return;
      }
      
      selectedColors.push({ id, name, hex });
      updateSelectedColorsPreview();
      updateColorHiddenInputs();
    }

    function updateSelectedColorsPreview() {
      const preview = document.getElementById('selectedColorsPreview');
      if (!preview) return;
      
      preview.innerHTML = selectedColors.map((color, index) => `
        <div style="position: relative; width: 40px; height: 40px; border-radius: 6px; background-color: ${color.hex}; border: 2px solid var(--purple); cursor: pointer;" 
             onclick="removeSelectedColor(${index})"
             title="${color.name} - Click to remove">
        </div>
      `).join('');
    }

    function removeSelectedColor(index) {
      selectedColors.splice(index, 1);
      updateSelectedColorsPreview();
      updateColorHiddenInputs();
    }

    function updateColorHiddenInputs() {
      for (let i = 1; i <= 4; i++) {
        const input = document.getElementById(`color${i}`);
        if (input) {
          input.value = selectedColors[i-1] ? selectedColors[i-1].name : '';
        }
      }
    }

    // Get contrast color for text
    function getContrastColor(hexColor) {
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    // Handle new order form submission
    const newOrderForm = document.getElementById('newOrderForm');
    if (newOrderForm) {
      newOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentUser) {
          alert('Please login to create an order');
          return;
        }
        
        const orderData = {
          date: Date.now(),
          orderTitle: document.getElementById('orderTitle').value.trim(),
          clientName: document.getElementById('clientName').value.trim(),
          clientEmail: document.getElementById('clientEmail').value.trim(),
          clientPhone: document.getElementById('clientPhone').value.trim(),
          clientStreet: document.getElementById('clientStreet').value.trim(),
          clientCity: document.getElementById('clientCity').value.trim(),
          clientState: document.getElementById('clientState').value.trim(),
          clientPostalCode: document.getElementById('clientPostalCode').value.trim(),
          clientCountry: document.getElementById('clientCountry').value.trim(),
          messagingApp: document.getElementById('messaging_app').value,
          productName: document.getElementById('productName').value.trim(),
          quantity: parseInt(document.getElementById('quantity').value) || 1,
          colors: selectedColors.map(c => c.name),
          material: document.getElementById('material').value,
          finish: document.getElementById('finish').value,
          scale: document.getElementById('scale').value,
          extraNotes: document.getElementById('extraNotes').value.trim(),
          total: parseFloat(document.getElementById('orderTotal').value) || 0,
          amountPaid: parseFloat(document.getElementById('amountPaid').value) || 0,
          paymentMethod: document.getElementById('paymentMethod').value,
          paymentStatus: document.getElementById('paymentStatus').value,
          orderStatus: document.getElementById('orderStatus').value
        };
        
        try {
          const orderRef = firebase.database().ref(`orders/${currentUser.uid}`).push();
          await orderRef.set(orderData);
          alert('Order created successfully!');
          closeNewOrderModal();
        } catch (error) {
          alert('Error creating order: ' + error.message);
        }
      });
    }

    // View order
    function viewOrder(orderId) {
      alert('View order functionality - ID: ' + orderId + '\nFull implementation in progress');
    }

    function closeViewOrderModal() {
      const modal = document.getElementById('viewOrderModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Duplicate order
    function duplicateOrder(orderId) {
      if (!confirm('Create a duplicate of this order?')) return;
      
      const order = ordersData.find(o => o.id === orderId);
      if (!order) return;
      
      const duplicatedOrder = {
        ...order,
        date: Date.now(),
        orderStatus: 'pending',
        paymentStatus: 'unpaid',
        amountPaid: 0
      };
      
      delete duplicatedOrder.id;
      
      firebase.database().ref(`orders/${currentUser.uid}`).push().set(duplicatedOrder)
        .then(() => alert('Order duplicated successfully!'))
        .catch(error => alert('Error: ' + error.message));
    }

    // Delete order
    function deleteOrder(orderId) {
      if (!confirm('Delete this order? This cannot be undone!')) return;
      
      firebase.database().ref(`orders/${currentUser.uid}/${orderId}`).remove()
        .then(() => alert('Order deleted'))
        .catch(error => alert('Error: ' + error.message));
    }

  </script>

</body>
</html>
