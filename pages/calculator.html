<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Calculator - Vixvvo Tools</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="../css/shared-styles.css">

<!-- Load shared navbar -->
<script src="../js/navbar-helper.js"></script>
<script src="../js/navbar-loader.js"></script>
<script src="../js/settings-dropdown.js"></script>
<script src="../js/navbar-auth.js"></script>
<!-- Note: Calculator has its own currency system, not using currency.js -->
<style>
  /* Calculator Section */
  .calculator-section {
    max-width: 1400px;
    margin: 0 auto;
    padding: 60px 60px 80px;
  }
  
  .page-header {
    text-align: center;
    margin-bottom: 48px;
  }
  
  .page-title {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 16px;
  }
  
  .page-title .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .page-subtitle {
    color: var(--text-muted);
    font-size: 18px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
    border-bottom: 2px solid var(--border);
    justify-content: center;
  }

  .tab {
    padding: 12px 24px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-weight: 600;
    cursor: pointer;
    transition: all .3s;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
  }

  .tab:hover {
    color: var(--text);
  }

  .tab.active {
    color: var(--purple-light);
    border-bottom-color: var(--purple-light);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }
  
  .calculator-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 32px;
    margin-top: 40px;
  }
  
  .card {
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
  }
  
  .card h3 {
    font-size: 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .card-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  
  .form-group {
    margin-bottom: 16px;
  }

  .form-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .section-label {
    font-size: 14px;
    font-weight: 700;
    color: var(--purple-light);
    margin-bottom: 16px;
    display: block;
  }
  
  label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  
  input, select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(15, 11, 22, 0.6);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    font-family: 'Inter', sans-serif;
  }

  input[readonly] {
    background: rgba(15, 11, 22, 0.3);
    cursor: not-allowed;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--purple);
  }
  
  .results-card {
    position: sticky;
    top: 20px;
  }
  
  .result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .result-item:last-child {
    border-bottom: none;
    padding-top: 20px;
    margin-top: 8px;
    border-top: 2px solid var(--purple);
  }
  
  .result-label {
    color: var(--text-muted);
    font-size: 14px;
  }

  .result-sublabel {
    color: var(--text-muted);
    font-size: 11px;
    opacity: 0.7;
  }
  
  .result-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  
  .result-item:last-child .result-value {
    font-size: 32px;
    color: var(--purple-light);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .btn-small {
    padding: 8px 20px;
    font-size: 13px;
  }
  
  .list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: rgba(15, 11, 22, 0.4);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    transition: all .3s;
  }
  
  .list-item:hover {
    border-color: var(--purple);
    background: rgba(15, 11, 22, 0.6);
  }
  
  .item-info {
    flex: 1;
  }
  
  .item-name {
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 16px;
  }
  
  .item-details {
    font-size: 13px;
    color: var(--text-muted);
  }
  
  .btn-delete {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    padding: 8px 16px;
    font-size: 13px;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .btn-delete:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: none;
    box-shadow: none;
  }

  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .note {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 12px;
  }

  /* Mass Delete Styles */
  .btn-toggle-mass-delete {
    background: rgba(239, 68, 68, 0.08);
    color: #ef4444;
    padding: 8px 16px;
    font-size: 13px;
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-toggle-mass-delete:hover {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.3);
    transform: translateY(-1px);
  }

  .btn-toggle-mass-delete.active {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
  }

  .mass-delete-controls {
    display: none;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 8px;
    animation: slideDown 0.3s ease;
  }

  .mass-delete-controls.active {
    display: flex;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .select-all-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .mass-delete-checkbox {
    width: 18px;
    height: 18px;
    accent-color: var(--purple);
    cursor: pointer;
  }

  .select-all-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    user-select: none;
  }

  .btn-mass-delete {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    padding: 8px 16px;
    font-size: 13px;
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    opacity: 0.5;
    pointer-events: none;
  }

  .btn-mass-delete.enabled {
    opacity: 1;
    pointer-events: auto;
  }

  .btn-mass-delete.enabled:hover {
    background: rgba(239, 68, 68, 0.25);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  .list-item.with-checkbox {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 12px;
    align-items: center;
  }

  .item-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--purple);
    cursor: pointer;
    display: none;
  }

  .mass-delete-mode .item-checkbox {
    display: block;
  }

  .selected-count {
    font-size: 13px;
    color: var(--purple-light);
    font-weight: 600;
  }

  .btn-cancel-mass-delete {
    background: transparent;
    color: var(--text-muted);
    padding: 8px 16px;
    font-size: 13px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-cancel-mass-delete:hover {
    background: rgba(168, 85, 247, 0.1);
    color: var(--text);
    border-color: var(--purple);
  }
  
  /* Modal styles */
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.7);
    display: none;
    z-index: 200;
    backdrop-filter: blur(4px);
  }
  
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 300;
    place-items: center;
  }
  
  .modal-card {
    width: min(450px, 95vw);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
  }
  
  .modal-card h3 {
    font-size: 24px;
    margin-bottom: 24px;
    color: var(--text);
  }
  
  .err {
    color: #ff7b7b;
    font-size: 13px;
    margin: 12px 0;
    min-height: 18px;
  }
  
  .modal-buttons {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .modal-buttons .btn {
    flex: 1;
    padding: 14px;
  }

  .btn-actions {
    display: flex;
    gap: 8px;
  }
  
  .btn-edit {
    background: rgba(105, 183, 255, 0.1);
    color: #69b7ff;
    padding: 8px 16px;
    font-size: 13px;
    border: 1px solid rgba(105, 183, 255, 0.3);
  }
  
  .btn-edit:hover {
    background: rgba(105, 183, 255, 0.2);
    transform: none;
    box-shadow: none;
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .calculator-grid {
      grid-template-columns: 1fr;
    }
    
    .results-card {
      position: static;
    }
  }
  
  @media (max-width: 768px) {
    nav {
      padding: 20px 24px;
    }
    
    .nav-links {
      display: none;
    }
    
    .calculator-section {
      padding: 40px 24px;
    }
    
    .page-title {
      font-size: 32px;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }

    .tabs {
      overflow-x: auto;
    }

    .tab {
      white-space: nowrap;
    }
    
    .currency-selector {
      padding: 8px 12px;
    }
    
    .currency-label {
      display: none;
    }
    
    .currency-select {
      min-width: 75px;
      font-size: 12px;
    }
  }

  /* Filter styles */
  .filter-section {
    margin-bottom: 20px;
    padding: 14px 16px;
    background: rgba(15, 11, 22, 0.3);
    border: 1px solid var(--border);
    border-radius: 10px;
  }
  
  .filter-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .filter-stats {
    font-size: 11px;
    color: var(--text-muted);
    opacity: 0.8;
  }

  /* Brand Checkbox Grid - Compact Pills */
  .brand-checkbox-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 0;
  }

  .brand-checkbox-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: rgba(15, 11, 22, 0.5);
    border: 1.5px solid rgba(168, 85, 247, 0.25);
    border-radius: 24px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    font-size: 13px;
    position: relative;
  }

  .brand-checkbox-item:hover {
    border-color: rgba(168, 85, 247, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);
  }

  /* Custom Checkbox Styling */
  .brand-checkbox-item input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid rgba(168, 85, 247, 0.4);
    border-radius: 5px;
    cursor: pointer;
    margin: 0;
    position: relative;
    background: rgba(15, 11, 22, 0.6);
    transition: all 0.2s ease;
  }

  .brand-checkbox-item input[type="checkbox"]:hover {
    border-color: rgba(168, 85, 247, 0.7);
    background: rgba(168, 85, 247, 0.1);
  }

  .brand-checkbox-item input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    border-color: #a855f7;
  }

  .brand-checkbox-item input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
  }

  .brand-checkbox-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.2s ease;
  }

  .brand-checkbox-count {
    font-size: 11px;
    color: var(--text-muted);
    background: rgba(168, 85, 247, 0.15);
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
    transition: all 0.2s ease;
  }

  .brand-checkbox-item.checked {
    border-color: rgba(168, 85, 247, 0.6);
  }

  .brand-checkbox-item.checked .brand-checkbox-label {
    color: var(--purple-light);
  }

  .brand-checkbox-item.checked .brand-checkbox-count {
    background: rgba(168, 85, 247, 0.25);
    color: var(--purple-light);
  }

  @media (max-width: 768px) {
    .brand-checkbox-item {
      padding: 5px 10px;
      font-size: 12px;
    }

    .brand-checkbox-label {
      font-size: 12px;
    }
    
    .brand-checkbox-count {
      font-size: 10px;
      padding: 1px 5px;
    }
  }
  
  .no-results {
    text-align: center;
    padding: 40px 24px;
    color: var(--text-muted);
  }
  
  .no-results-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
  }
  
  .list-item.hidden {
    display: none;
  }

  /* Custom Notification Styles */
  /* Notification Styles - Modern Toast Design */
  .notification {
    position: fixed;
    top: 24px;
    right: 24px;
    transform: translateX(400px);
    background: #1e172e;
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 12px;
    padding: 20px 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(168, 85, 247, 0.1);
    z-index: 9999;
    min-width: 320px;
    max-width: 420px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .notification.show {
    opacity: 1;
    transform: translateX(0);
    pointer-events: all;
  }

  .notification-icon {
    font-size: 28px;
    min-width: 28px;
    text-align: center;
    filter: drop-shadow(0 0 8px currentColor);
  }

  .notification-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .notification-title {
    font-size: 16px;
    font-weight: 600;
    color: #f3f4f6;
    line-height: 1.3;
  }

  .notification-message {
    font-size: 14px;
    color: #9ca3af;
    line-height: 1.4;
  }

  .notification-close {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    line-height: 1;
    opacity: 0.6;
  }

  .notification-close:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #f3f4f6;
    opacity: 1;
  }

  /* Success variant */
  .notification.success {
    border-color: rgba(16, 185, 129, 0.4);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.success .notification-icon {
    color: #10b981;
  }

  /* Error variant */
  .notification.error {
    border-color: rgba(239, 68, 68, 0.4);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.error .notification-icon {
    color: #ef4444;
  }

  /* Warning variant */
  .notification.warning {
    border-color: rgba(245, 158, 11, 0.4);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.warning .notification-icon {
    color: #f59e0b;
  }

  /* Progress bar animation */
  .notification::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, #a855f7, #c084fc);
    border-radius: 0 0 12px 12px;
    animation: notificationProgress 3s linear forwards;
  }

  .notification.success::after {
    background: linear-gradient(90deg, #10b981, #34d399);
  }

  .notification.error::after {
    background: linear-gradient(90deg, #ef4444, #f87171);
  }

  .notification.warning::after {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
  }

  @keyframes notificationProgress {
    from {
      width: 100%;
    }
    to {
      width: 0%;
    }
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .notification {
      top: 12px;
      right: 12px;
      left: 12px;
      min-width: auto;
      max-width: none;
    }
  }

  /* Confirmation Dialog Styles */
  .confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 420px;
    width: 90%;
    display: block;
  }

  .confirm-dialog.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .confirm-icon {
    font-size: 56px;
    text-align: center;
    margin-bottom: 16px;
    display: block;
  }

  .confirm-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
    text-align: center;
  }

  .confirm-message {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.6;
    text-align: center;
  }

  .confirm-buttons {
    display: flex;
    gap: 12px;
  }

  .confirm-buttons .btn {
    flex: 1;
    padding: 14px;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, .4);
  }

  /* Modern Printer Presets Styles */
  #printersTab .list-item {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.05), rgba(192, 132, 252, 0.05));
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
  }

  #printersTab .list-item:hover {
    border-color: rgba(168, 85, 247, 0.4);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(192, 132, 252, 0.08));
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.15);
  }

  #printersTab .item-info {
    flex: 1;
  }

  #printersTab .item-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #printersTab .item-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 12px;
  }

  #printersTab .detail-badge {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 12px;
    background: rgba(15, 11, 22, 0.6);
    border: 1px solid rgba(168, 85, 247, 0.15);
    border-radius: 8px;
  }

  #printersTab .detail-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--purple-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #printersTab .detail-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }

  #printersTab .btn-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #printersTab .btn-edit,
  #printersTab .btn-delete {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  #printersTab .btn-edit {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #60a5fa;
  }

  #printersTab .btn-edit:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.25));
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  #printersTab .btn-delete {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #f87171;
  }

  #printersTab .btn-delete:hover {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  #printersTab .empty-state {
    text-align: center;
    padding: 60px 24px;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.03), rgba(192, 132, 252, 0.03));
    border: 2px dashed rgba(168, 85, 247, 0.2);
    border-radius: 16px;
    margin: 20px 0;
  }

  #printersTab .empty-state-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.6;
  }

  @media (max-width: 768px) {
    #printersTab .list-item {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    #printersTab .item-details {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    #printersTab .btn-actions {
      flex-direction: row;
      width: 100%;
    }

    #printersTab .btn-edit,
    #printersTab .btn-delete {
      flex: 1;
    }
  }

  /* Modern Filament Presets Styles */
  #filamentsTab .list-item {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.05), rgba(192, 132, 252, 0.05));
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
  }

  #filamentsTab .list-item:hover {
    border-color: rgba(168, 85, 247, 0.4);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(192, 132, 252, 0.08));
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.15);
  }

  #filamentsTab .item-info {
    flex: 1;
  }

  #filamentsTab .item-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }

  #filamentsTab .item-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 12px;
  }

  #filamentsTab .detail-badge {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 12px;
    background: rgba(15, 11, 22, 0.6);
    border: 1px solid rgba(168, 85, 247, 0.15);
    border-radius: 8px;
  }

  #filamentsTab .detail-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--purple-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #filamentsTab .detail-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }

  #filamentsTab .btn-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #filamentsTab .btn-edit,
  #filamentsTab .btn-delete {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  #filamentsTab .btn-edit {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #60a5fa;
  }

  #filamentsTab .btn-edit:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.25));
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  #filamentsTab .btn-delete {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #f87171;
  }

  #filamentsTab .btn-delete:hover {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  #filamentsTab .empty-state {
    text-align: center;
    padding: 60px 24px;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.03), rgba(192, 132, 252, 0.03));
    border: 2px dashed rgba(168, 85, 247, 0.2);
    border-radius: 16px;
    margin: 20px 0;
  }

  #filamentsTab .empty-state-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.6;
  }

  /* Modern User Presets Styles */
  #userPresetsTab .list-item {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.05), rgba(192, 132, 252, 0.05));
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
  }

  #userPresetsTab .list-item:hover {
    border-color: rgba(168, 85, 247, 0.4);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(192, 132, 252, 0.08));
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(168, 85, 247, 0.15);
  }

  #userPresetsTab .item-info {
    flex: 1;
  }

  #userPresetsTab .item-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }

  #userPresetsTab .item-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 12px;
  }

  #userPresetsTab .detail-badge {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 12px;
    background: rgba(15, 11, 22, 0.6);
    border: 1px solid rgba(168, 85, 247, 0.15);
    border-radius: 8px;
  }

  #userPresetsTab .detail-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--purple-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #userPresetsTab .detail-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }

  #userPresetsTab .btn-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #userPresetsTab .btn-edit,
  #userPresetsTab .btn-delete {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  #userPresetsTab .btn-edit {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #60a5fa;
  }

  #userPresetsTab .btn-edit:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.25));
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  #userPresetsTab .btn-delete {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #f87171;
  }

  #userPresetsTab .btn-delete:hover {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  #userPresetsTab .empty-state {
    text-align: center;
    padding: 60px 24px;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.03), rgba(192, 132, 252, 0.03));
    border: 2px dashed rgba(168, 85, 247, 0.2);
    border-radius: 16px;
    margin: 20px 0;
  }

  #userPresetsTab .empty-state-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.6;
  }

  @media (max-width: 768px) {
    #filamentsTab .list-item,
    #userPresetsTab .list-item {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    #filamentsTab .item-details,
    #userPresetsTab .item-details {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    #filamentsTab .btn-actions,
    #userPresetsTab .btn-actions {
      flex-direction: row;
      width: 100%;
    }

    #filamentsTab .btn-edit,
    #filamentsTab .btn-delete,
    #userPresetsTab .btn-edit,
    #userPresetsTab .btn-delete {
      flex: 1;
    }
  }

  /* Brand Category Sections */
  .brand-category {
    margin-bottom: 32px;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.03), rgba(192, 132, 252, 0.03));
    border: 1px solid rgba(168, 85, 247, 0.15);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
  }

  .brand-category:hover {
    border-color: rgba(168, 85, 247, 0.25);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.05), rgba(192, 132, 252, 0.05));
  }

  .brand-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(168, 85, 247, 0.2);
  }

  .brand-title {
    font-size: 24px;
    font-weight: 800;
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand-count {
    background: rgba(168, 85, 247, 0.15);
    color: var(--purple-light);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    border: 1px solid rgba(168, 85, 247, 0.3);
  }

  .brand-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media (max-width: 768px) {
    .brand-category {
      padding: 16px;
      margin-bottom: 20px;
    }

    .brand-title {
      font-size: 20px;
    }

    .brand-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    
    #userPresetsTab > div {
      grid-template-columns: 1fr !important;
    }
  }
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--dark-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s ease;
  ">
    <div style="
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Loading calculator...</p>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>
  
  <!-- Navbar will be loaded here dynamically -->
  <div id="navbar-container"></div>

  <section class="calculator-section">
    <div class="page-header">
      <h1 class="page-title">
        3D Printing <span class="highlight">Cost Calculator</span>
      </h1>
      <p class="page-subtitle">Calculate accurate costs for your 3D printing projects</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('calculator')">Calculator</button>
      <button class="tab" onclick="switchTab('printers')">Printer Presets</button>
      <button class="tab" onclick="switchTab('filaments')">Filament Presets</button>
      <button class="tab" onclick="switchTab('userPresets')">Your Presets</button>
    </div>

    <!-- Calculator Tab -->
    <div id="calculatorTab" class="tab-content active">
      <div class="calculator-grid">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Print Details</h3>
            <button id="btnResetCalculator" class="btn btn-ghost" style="padding: 8px 16px;">Reset to Default</button>
          </div>
          
          <!-- Presets Section -->
          <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span class="section-label">Print Detail Presets</span>
              <span id="presetLimitInfo" style="font-size: 11px; color: var(--text-muted);"></span>
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
              <button id="btnSavePreset" class="btn btn-primary" style="flex: 1;">Save Current Settings</button>
              <button id="btnManagePresets" class="btn btn-ghost" style="flex: 1;">Manage Presets</button>
            </div>
            <div id="presetQuickAccess" style="display: none;">
              <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; display: block;">Quick Load:</label>
              <div id="presetButtons" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>
          </div>

          <!-- Printer & Filament -->
          <div class="form-section">
            <span class="section-label">Printer & Filament</span>
            <div class="form-row">
              <div class="form-group">
                <label>Select Printer</label>
                <select id="printerSelect">
                  <option value="">Choose a printer...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Select Filament</label>
                <select id="filamentSelect">
                  <option value="">Choose filament...</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" id="printerCostBox" style="display: none;">
                <label>Printer Cost</label>
                <div id="printerCostInfo" style="padding: 10px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; color: var(--text); font-size: 14px;">-</div>
              </div>
              <div class="form-group" id="filamentCostBox" style="display: none;">
                <label>Filament Cost</label>
                <div id="filamentCostInfo" style="padding: 10px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; color: var(--text); font-size: 14px;">-</div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="includePrinterDepreciation" checked style="width: auto; cursor: pointer;">
                <label for="includePrinterDepreciation" style="cursor: pointer; margin: 0;">Include Printer Depreciation in Cost</label>
              </div>
            </div>
          </div>

          <!-- Print Parameters -->
          <div class="form-section">
            <span class="section-label">Print Parameters</span>
            <div class="form-row">
              <div class="form-group">
                <label>Print Time (hours)</label>
                <input type="number" id="printTime" placeholder="0" min="0" step="0.01" value="0">
              </div>
              <div class="form-group">
                <label>Filament Weight (g)</label>
                <input type="number" id="weight" placeholder="0" min="0" step="0.1" value="0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Time to Print (duplicate)</label>
                <input type="number" id="printTimeDuplicate" placeholder="0" min="0" step="0.01" readonly>
              </div>
              <div class="form-group">
                <label>Electricity Cost ($/kWh)</label>
                <input type="number" id="elec" placeholder="0.12" min="0" step="0.01" value="0.12">
              </div>
            </div>
          </div>

          <!-- Post-Processing -->
          <div class="form-section">
            <span class="section-label">Post-Processing (minutes)</span>
            <div class="form-row">
              <div class="form-group">
                <label>Job Removal</label>
                <input type="number" id="jobRemoval" placeholder="0" min="0" step="0.1" value="0">
              </div>
              <div class="form-group">
                <label>Support Removal</label>
                <input type="number" id="supportRemoval" placeholder="0" min="0" step="0.1" value="0">
              </div>
            </div>
            <div class="form-group">
              <label>Additional Work</label>
              <input type="number" id="additionalWork" placeholder="0" min="0" step="0.1" value="0">
            </div>
            <div class="form-group">
              <label>Post-Processing Labor Rate ($/h)</label>
              <input type="number" id="postProcessingRate" placeholder="20" min="0" step="0.5" value="20">
            </div>
          </div>

          <!-- Preparation -->
          <div class="form-section">
            <span class="section-label">Preparation (minutes)</span>
            <div class="form-row">
              <div class="form-group">
                <label>Model Prep</label>
                <input type="number" id="modelPrep" placeholder="0" min="0" step="0.1" value="0">
              </div>
              <div class="form-group">
                <label>Slicing</label>
                <input type="number" id="slicing" placeholder="0" min="0" step="0.1" value="0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Material Change</label>
                <input type="number" id="materialChange" placeholder="0" min="0" step="0.1" value="0">
              </div>
              <div class="form-group">
                <label>Transfer & Start</label>
                <input type="number" id="transferStart" placeholder="0" min="0" step="0.1" value="0">
              </div>
            </div>
            <div class="form-group">
              <label>Preparation Labor Rate ($/h)</label>
              <input type="number" id="preparationRate" placeholder="20" min="0" step="0.5" value="20">
            </div>
          </div>

          <!-- Markups & Failures -->
          <div class="form-section">
            <span class="section-label">Markups & Failures</span>
            <div class="form-row">
              <div class="form-group">
                <label>Filament Markup (×)</label>
                <input type="number" id="filamentMarkup" placeholder="2.7" min="1" step="0.1" value="2.7">
              </div>
              <div class="form-group">
                <label>General Markup (%)</label>
                <input type="number" id="generalMarkup" placeholder="50" min="0" step="1" value="50">
              </div>
            </div>
            <div class="form-group">
              <label>Failure Rate (%)</label>
              <input type="number" id="failureRate" placeholder="10" min="0" max="100" step="1" value="10">
            </div>
          </div>
        </div>

        <div class="card results-card">
          <h3>Cost Breakdown</h3>
          <div id="resultsContent">
            <div class="result-item">
              <span class="result-label">Printer Depreciation</span>
              <span class="result-value" id="printerCost">$0.00</span>
            </div>
            <div class="result-item">
              <div>
                <div class="result-label">Filament Cost</div>
                <div class="result-sublabel" id="filamentDetails"></div>
              </div>
              <span class="result-value" id="filamentCost">$0.00</span>
            </div>
            <div class="result-item">
              <div>
                <div class="result-label">Electricity Cost</div>
                <div class="result-sublabel" id="electricityDetails"></div>
              </div>
              <span class="result-value" id="electricityCost">$0.00</span>
            </div>
            <div class="result-item">
              <div>
                <div class="result-label">Labor Cost</div>
                <div class="result-sublabel" id="laborDetails"></div>
              </div>
              <span class="result-value" id="laborCost">$0.00</span>
            </div>
            <div class="result-item">
              <span class="result-label">Subtotal (before markup)</span>
              <span class="result-value" id="subtotal">$0.00</span>
            </div>
            <div class="result-item">
              <span class="result-label">General Markup Applied</span>
              <span class="result-value" id="markupAmount">$0.00</span>
            </div>
            <div class="result-item">
              <span class="result-label">Failure Rate Adjustment</span>
              <span class="result-value" id="failureCostDisplay">$0.00</span>
            </div>
            <div class="result-item">
              <span class="result-label">Total Price</span>
              <span class="result-value" id="totalCost">$0.00</span>
            </div>
          </div>
          <p class="note" id="handTimeNote">Unbilled hand time: 0.00 hours</p>
        </div>
      </div>
    </div>

    <!-- Printers Tab -->
    <div id="printersTab" class="tab-content">
      <div class="card">
        <div class="section-header">
          <h3>Printers Library</h3>
          <div style="display: flex; gap: 8px;">
            <button id="btnTogglePrinterMassDelete" class="btn btn-toggle-mass-delete" style="display:none;">Mass Delete</button>
            <button id="btnAddPrinter" class="btn btn-primary btn-small" style="display:none;">+ Add Printer</button>
          </div>
        </div>
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
          All available printers with their brands, purchase prices and calculated depreciation costs per hour.
        </p>
        
        <!-- Brand Filter Section -->
        <div class="filter-section">
          <div class="filter-label">
            <span>Filter by Brand</span>
            <span class="filter-stats" id="printerFilterStats">Showing all printers</span>
          </div>
          <div id="printerBrandFilters" class="brand-checkbox-grid">
            <!-- Checkboxes will be populated dynamically -->
          </div>
        </div>

        <!-- Mass Delete Controls -->
        <div id="printerMassDeleteControls" class="mass-delete-controls">
          <div class="select-all-container">
            <input type="checkbox" id="selectAllPrinters" class="mass-delete-checkbox">
            <label for="selectAllPrinters" class="select-all-label">Select All</label>
            <span class="selected-count" id="printerSelectedCount">0 selected</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="btnDeleteSelectedPrinters" class="btn-mass-delete">Delete Selected</button>
            <button id="btnCancelPrinterMassDelete" class="btn-cancel-mass-delete">Cancel</button>
          </div>
        </div>
        
        <div id="printersListContainer">
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            Loading printers...
          </div>
        </div>
        <div id="printersList"></div>
        <div id="printersNoResults" class="no-results" style="display: none;">
          <div class="no-results-icon"></div>
          <p style="font-size: 16px; margin-bottom: 8px;">No printers found</p>
          <p style="font-size: 14px;">Try adjusting your search terms</p>
        </div>
      </div>
    </div>

    <!-- User Presets Tab -->
    <div id="userPresetsTab" class="tab-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
        
        <!-- Your Printers Section -->
        <div class="card">
          <div class="section-header">
            <h3>Your Printers Library</h3>
            <div style="display: flex; gap: 8px;">
              <button id="btnToggleUserPrinterMassDelete" class="btn btn-toggle-mass-delete" style="display:none;">Mass Delete</button>
              <button id="btnAddUserPrinter" class="btn btn-primary btn-small" style="display:none;">+ Add Printer</button>
            </div>
          </div>
          <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
            Your personal printers library. These are only visible to you and can be customized for your specific needs.
          </p>
          
          <!-- Brand Filter Section -->
          <div class="filter-section">
            <div class="filter-label">
              <span>Filter by Brand</span>
              <span class="filter-stats" id="userPrinterFilterStats">Showing all printers</span>
            </div>
            <div id="userPrinterBrandFilters" class="brand-checkbox-grid">
              <!-- Checkboxes will be populated dynamically -->
            </div>
          </div>

          <!-- Mass Delete Controls -->
          <div id="userPrinterMassDeleteControls" class="mass-delete-controls">
            <div class="select-all-container">
              <input type="checkbox" id="selectAllUserPrinters" class="mass-delete-checkbox">
              <label for="selectAllUserPrinters" class="select-all-label">Select All</label>
              <span class="selected-count" id="userPrinterSelectedCount">0 selected</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="btnDeleteSelectedUserPrinters" class="btn-mass-delete">Delete Selected</button>
              <button id="btnCancelUserPrinterMassDelete" class="btn-cancel-mass-delete">Cancel</button>
            </div>
          </div>
          
          <div id="userPrintersListContainer" style="display: none;">
            <div id="userPrintersMassDeleteList"></div>
          </div>
          <div id="userPrintersList"></div>
          <div id="userPrintersNoResults" class="no-results" style="display: none;">
            <div class="no-results-icon"></div>
            <p style="font-size: 16px; margin-bottom: 8px;">No printers found</p>
            <p style="font-size: 14px;">Try adjusting your search terms</p>
          </div>
        </div>

        <!-- Your Filaments Section -->
        <div class="card">
          <div class="section-header">
            <h3>Your Filaments Library</h3>
            <div style="display: flex; gap: 8px;">
              <button id="btnToggleUserFilamentMassDelete" class="btn btn-toggle-mass-delete" style="display:none;">Mass Delete</button>
              <button id="btnAddUserFilament" class="btn btn-primary btn-small" style="display:none;">+ Add Filament</button>
            </div>
          </div>
          <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
            Your personal filaments library. These are only visible to you and can be customized for your specific needs.
          </p>
          
          <!-- Brand Filter Section -->
          <div class="filter-section">
            <div class="filter-label">
              <span>Filter by Brand</span>
              <span class="filter-stats" id="userFilamentFilterStats">Showing all filaments</span>
            </div>
            <div id="userFilamentBrandFilters" class="brand-checkbox-grid">
              <!-- Checkboxes will be populated dynamically -->
            </div>
          </div>

          <!-- Mass Delete Controls -->
          <div id="userFilamentMassDeleteControls" class="mass-delete-controls">
            <div class="select-all-container">
              <input type="checkbox" id="selectAllUserFilaments" class="mass-delete-checkbox">
              <label for="selectAllUserFilaments" class="select-all-label">Select All</label>
              <span class="selected-count" id="userFilamentSelectedCount">0 selected</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="btnDeleteSelectedUserFilaments" class="btn-mass-delete">Delete Selected</button>
              <button id="btnCancelUserFilamentMassDelete" class="btn-cancel-mass-delete">Cancel</button>
            </div>
          </div>
          
          <div id="userFilamentsListContainer" style="display: none;">
            <div id="userFilamentsMassDeleteList"></div>
          </div>
          <div id="userFilamentsList"></div>
          <div id="userFilamentsNoResults" class="no-results" style="display: none;">
            <div class="no-results-icon"></div>
            <p style="font-size: 16px; margin-bottom: 8px;">No filaments found</p>
            <p style="font-size: 14px;">Try adjusting your search terms</p>
          </div>
        </div>
        
      </div>
    </div>

    <!-- Filaments Tab -->
    <div id="filamentsTab" class="tab-content">
      <div class="card">
        <div class="section-header">
          <h3>Filaments Library</h3>
          <div style="display: flex; gap: 8px;">
            <button id="btnToggleFilamentMassDelete" class="btn btn-toggle-mass-delete" style="display:none;">Mass Delete</button>
            <button id="btnAddFilament" class="btn btn-primary btn-small" style="display:none;">+ Add Filament</button>
          </div>
        </div>
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
          All available filaments with detailed pricing information per spool, kilogram, and gram.
        </p>
        
        <!-- Brand Filter Section -->
        <div class="filter-section">
          <div class="filter-label">
            <span>Filter by Brand</span>
            <span class="filter-stats" id="filamentFilterStats">Showing all filaments</span>
          </div>
          <div id="filamentBrandFilters" class="brand-checkbox-grid">
            <!-- Checkboxes will be populated dynamically -->
          </div>
        </div>

        <!-- Mass Delete Controls -->
        <div id="filamentMassDeleteControls" class="mass-delete-controls">
          <div class="select-all-container">
            <input type="checkbox" id="selectAllFilaments" class="mass-delete-checkbox">
            <label for="selectAllFilaments" class="select-all-label">Select All</label>
            <span class="selected-count" id="filamentSelectedCount">0 selected</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="btnDeleteSelectedFilaments" class="btn-mass-delete">Delete Selected</button>
            <button id="btnCancelFilamentMassDelete" class="btn-cancel-mass-delete">Cancel</button>
          </div>
        </div>
        
        <div id="filamentsListContainer">
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            Loading filaments...
          </div>
        </div>
        <div id="filamentsList"></div>
        <div id="filamentsNoResults" class="no-results" style="display: none;">
          <div class="no-results-icon"></div>
          <p style="font-size: 16px; margin-bottom: 8px;">No filaments found</p>
          <p style="font-size: 14px;">Try adjusting your search terms</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Login Modal -->
  <div id="overlay"></div>
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <h3>Login</h3>
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="your@email.com">
      <label>Password</label>
      <div style="position: relative;">
        <input id="loginPass" type="password" placeholder="••••••••" style="padding-right: 45px;">
        <button id="toggleLoginPassCalc" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-muted); padding: 4px 8px;">👁</button>
      </div>
      <div style="text-align: right; margin-top: 4px;">
        <a href="#" id="forgotPasswordLinkCalc" style="color: var(--purple-light); text-decoration: none; font-size: 13px;">Forgot Password?</a>
      </div>
      <div id="loginErr" class="err"></div>
      <div class="modal-buttons">
        <button id="doLogin" class="btn btn-primary">Login</button>
        <button id="closeLogin" class="btn btn-ghost">Cancel</button>
      </div>
      <div style="text-align: center; margin-top: 16px;">
        <span style="color: var(--text-muted); font-size: 14px;">Don't have an account? </span>
        <button id="switchToSignup" style="background: none; border: none; color: var(--purple-light); cursor: pointer; font-weight: 600; font-size: 14px;">Sign Up</button>
      </div>
    </div>
  </div>

  <!-- Signup Modal -->
  <div id="signupModal" class="modal">
    <div class="modal-card">
      <h3>Create Account</h3>
      <label>Username</label>
      <input id="signupUsername" type="text" placeholder="Choose a username">
      <label>Email</label>
      <input id="signupEmail" type="email" placeholder="your@email.com">
      <label>Password</label>
      <div style="position: relative;">
        <input id="signupPass" type="password" placeholder="••••••••" style="padding-right: 45px;">
        <button id="toggleSignupPassCalc" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-muted); padding: 4px 8px;">👁</button>
      </div>
      <label>Confirm Password</label>
      <div style="position: relative;">
        <input id="signupPassConfirm" type="password" placeholder="••••••••" style="padding-right: 45px;">
        <button id="toggleSignupPassConfirmCalc" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-muted); padding: 4px 8px;">👁</button>
      </div>
      <div id="signupErr" class="err"></div>
      <div class="modal-buttons">
        <button id="doSignup" class="btn btn-primary">Create Account</button>
        <button id="closeSignup" class="btn btn-ghost">Cancel</button>
      </div>
      <div style="text-align: center; margin-top: 16px;">
        <span style="color: var(--text-muted); font-size: 14px;">Already have an account? </span>
        <button id="switchToLogin" style="background: none; border: none; color: var(--purple-light); cursor: pointer; font-weight: 600; font-size: 14px;">Login</button>
      </div>
    </div>
  </div>

  <!-- Add Printer Modal -->
  <div id="printerModal" class="modal">
    <div class="modal-card">
      <h3 id="printerModalTitle">Add Printer</h3>
      
      <!-- Manual Input Section -->
      <label>Printer Name</label>
      <input id="printerName" type="text" placeholder="e.g., i3 MK3">
      <label>Brand</label>
      <input id="printerBrand" type="text" placeholder="e.g., Prusa">
      <label>Printer Price ($)</label>
      <input id="printerPrice" type="number" placeholder="e.g., 999" min="0" step="0.01">
      <label>Expected Lifespan (hours)</label>
      <input id="printerLifespan" type="number" placeholder="e.g., 5000" min="1" step="1" value="5000">
      <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
        Depreciation will be calculated as: Price ÷ Lifespan
      </div>
      
      <!-- Quick Add Section -->
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
        <label>Batch Add (paste multiple, separate with semicolon)</label>
        <textarea id="printerQuickAdd" 
          placeholder='["X-Smart 1", "QIDI", 299, 5000]; ["X-Smart 2", "QIDI", 299, 5000]; ["X-Smart 3", "QIDI", 299, 5000]' 
          style="width: 100%; padding: 12px; background: rgba(15, 11, 22, 0.6); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-family: 'Courier New', monospace; min-height: 80px; resize: vertical;"></textarea>
        <button id="btnParseQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; padding: 10px;">
          Add All Printers
        </button>
        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">
          <strong>Format:</strong> ["Name", "Brand", Price, Lifespan]; ["Name", "Brand", Price, Lifespan]<br>
          <strong>Example:</strong> ["i3 MK3S+", "Prusa", 1099, 5000]; ["Ender 3", "Creality", 259, 3000]
        </div>
      </div>
      
      <div id="printerErr" class="err"></div>
      <div class="modal-buttons">
        <button id="savePrinter" class="btn btn-primary">Save Printer</button>
        <button id="closePrinter" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add Filament Modal -->
  <div id="filamentModal" class="modal">
    <div class="modal-card">
      <h3 id="filamentModalTitle">Add Filament</h3>
      
      <!-- Manual Input Section -->
      <label>Filament Type</label>
      <input id="filamentType" type="text" placeholder="e.g., PLA">
      <label>Brand</label>
      <input id="filamentBrand" type="text" placeholder="e.g., Hatchbox">
      <label>Spool Weight (g)</label>
      <input id="filamentSpoolWeight" type="number" placeholder="1000" min="1" step="1" value="1000">
      <label>Cost Per Spool ($)</label>
      <input id="filamentCostSpool" type="number" placeholder="20.00" min="0" step="0.01">
      <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
        Cost per gram will be calculated as: Spool Cost ÷ Spool Weight
      </div>
      
      <!-- Quick Add Section -->
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
        <label>Batch Add (paste multiple, separate with semicolon)</label>
        <textarea id="filamentQuickAdd" 
          placeholder='["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]; ["ABS", "Prusament", 1000, 24.99]' 
          style="width: 100%; padding: 12px; background: rgba(15, 11, 22, 0.6); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-family: 'Courier New', monospace; min-height: 80px; resize: vertical;"></textarea>
        <button id="btnParseFilamentQuickAdd" class="btn btn-primary" style="width: 100%; margin-top: 8px; padding: 10px;">
          Add All Filaments
        </button>
        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">
          <strong>Format:</strong> ["Type", "Brand", Weight, Cost]; ["Type", "Brand", Weight, Cost]<br>
          <strong>Example:</strong> ["PLA", "Hatchbox", 1000, 19.99]; ["PETG", "eSUN", 1000, 22.50]
        </div>
      </div>
      
      <div id="filamentErr" class="err"></div>
      <div class="modal-buttons">
        <button id="saveFilament" class="btn btn-primary">Save Filament</button>
        <button id="closeFilament" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Custom Notification -->
  <div id="customNotification" class="notification">
    <div class="notification-icon">✓</div>
    <div class="notification-content">
      <div class="notification-title">Success!</div>
      <div class="notification-message"></div>
    </div>
    <button class="notification-close" onclick="hideNotification()">×</button>
  </div>

  <!-- Custom Confirm Dialog -->
  <div id="customConfirm" class="confirm-dialog">
    <div class="confirm-icon"></div>
    <div class="confirm-title">Are you sure?</div>
    <div class="confirm-message"></div>
    <div class="confirm-buttons">
      <button id="confirmYes" class="btn btn-danger">Confirm</button>
      <button id="confirmNo" class="btn btn-ghost">Cancel</button>
    </div>
  </div>

  <!-- Save Preset Modal -->
  <div id="savePresetModal" class="modal">
    <div class="modal-card">
      <h3>Save Preset</h3>
      <label>Preset Name</label>
      <input id="presetName" type="text" placeholder="e.g., Standard Mini Print" maxlength="30">
      <div id="presetSaveErr" class="err"></div>
      <div id="presetSaveInfo" style="font-size: 12px; color: var(--text-muted); margin-top: 8px;"></div>
      <div class="modal-buttons">
        <button id="doSavePreset" class="btn btn-primary">Save Preset</button>
        <button id="closeSavePreset" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Manage Presets Modal -->
  <div id="managePresetsModal" class="modal">
    <div class="modal-card" style="max-width: 600px;">
      <h3>Manage Presets</h3>
      <div id="presetsList" style="max-height: 400px; overflow-y: auto;"></div>
      <div id="noPresetsMessage" style="text-align: center; padding: 32px; color: var(--text-muted); display: none;">
        <p style="font-size: 16px; margin-bottom: 8px;">No presets saved yet</p>
        <p style="font-size: 13px;">Save your first preset to quickly load print settings!</p>
      </div>
      <div class="modal-buttons">
        <button id="closeManagePresets" class="btn btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Generic Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-card" style="max-width: 500px;">
      <h3 id="confirmTitle">Confirm Action</h3>
      <p id="confirmMessage" style="color: var(--text-muted); font-size: 15px; line-height: 1.6; margin: 16px 0 24px 0;">Are you sure?</p>
      <div class="modal-buttons">
        <button id="confirmOK" class="btn btn-primary">OK</button>
        <button id="confirmCancel" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

<script>
  /* Firebase Config */
  const firebaseConfig = {
    apiKey: "AIzaSyDwEDp5SfrxeEntOJg_XzbiBoGc9ADbX5g",
    authDomain: "vixvvowebsite.firebaseapp.com",
    projectId: "vixvvowebsite",
    storageBucket: "vixvvowebsite.appspot.com",
    messagingSenderId: "862620702799",
    appId: "1:862620702799:web:d06c0ec4e7b0f3010d323a",
    measurementId: "G-VX36JF6PTT",
    databaseURL: "https://vixvvowebsite-default-rtdb.firebaseio.com"
  };
  
  console.log('Initializing Firebase...');
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  
  // Shared database - all users can read, only admins can write
  const printersRef = db.ref('printers');
  const filamentsRef = db.ref('filaments');
  
  // User-specific database references (will be set when user logs in)
  let userPrintersRef = null;
  let userFilamentsRef = null;

  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  /* DOM Elements */
  const overlay = document.getElementById('overlay');
  const loginModal = document.getElementById('loginModal');
  const signupModal = document.getElementById('signupModal');
  const printerModal = document.getElementById('printerModal');
  const filamentModal = document.getElementById('filamentModal');

  /* Settings Dropdown - Wait for navbar to load */
  function initializeNavbarHandlers() {
    const btnSettings = document.getElementById('btnSettings');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const btnLoginSettings = document.getElementById('btnLoginSettings');
    const btnLogoutSettings = document.getElementById('btnLogoutSettings');
    const userInfoDisplay = document.getElementById('userInfoDisplay');
    const settingsUsername = document.getElementById('settingsUsername');
    const settingsRole = document.getElementById('settingsRole');
    const userAvatar = document.getElementById('userAvatar');
    const btnLoginNav = document.getElementById('btnLoginNav');
    const btnSettingsPage = document.getElementById('btnSettingsPage');

    if (!btnSettings || !settingsDropdown) {
      console.error('Navbar elements not found');
      return;
    }

    // Login button in nav (visible when logged out)
    btnLoginNav.addEventListener('click', () => {
      // Redirect to home page with login parameter
      window.location.href = '../index.html?login=true';
    });

    // Dropdown toggle functionality is now handled by settings-dropdown.js

  // Login button in settings
  btnLoginSettings.addEventListener('click', () => {
    settingsDropdown.classList.remove('active');
    btnSettings.classList.remove('active');
    // Redirect to home page with login parameter
    window.location.href = '../index.html?login=true';
  });

  // Logout button in settings
  btnLogoutSettings.addEventListener('click', () => {
    showConfirm('Are you sure you want to log out?', '', 'Logout', 'Logout').then((confirmed) => {
      if (confirmed) {
        settingsDropdown.classList.remove('active');
        btnSettings.classList.remove('active');
        auth.signOut().then(() => {
          showNotification('You have been logged out successfully.', '', 'Goodbye!');
          // Reload page to clear all user data
          window.location.reload();
        });
      }
    });
  });

    // Return references for auth state handler
    return {
      btnLoginSettings,
      btnLogoutSettings,
      userInfoDisplay,
      settingsUsername,
      settingsRole,
      userAvatar,
      btnLoginNav,
      btnSettingsPage
    };
  }

  // Wait for navbar to load before initializing handlers
  let navbarElements = null;
  document.addEventListener('navbarLoaded', function() {
    console.log('Navbar loaded, initializing handlers...');
    navbarElements = initializeNavbarHandlers();
  });

  /* Presets System */
  const savePresetModal = document.getElementById('savePresetModal');
  const managePresetsModal = document.getElementById('managePresetsModal');
  const btnSavePreset = document.getElementById('btnSavePreset');
  const btnManagePresets = document.getElementById('btnManagePresets');
  const btnCloseSavePreset = document.getElementById('closeSavePreset');
  const btnCloseManagePresets = document.getElementById('closeManagePresets');
  const btnDoSavePreset = document.getElementById('doSavePreset');
  const presetNameInput = document.getElementById('presetName');
  const presetSaveErr = document.getElementById('presetSaveErr');
  const presetSaveInfo = document.getElementById('presetSaveInfo');
  const presetsList = document.getElementById('presetsList');
  const noPresetsMessage = document.getElementById('noPresetsMessage');
  const presetLimitInfo = document.getElementById('presetLimitInfo');
  const presetQuickAccess = document.getElementById('presetQuickAccess');
  const presetButtons = document.getElementById('presetButtons');

  let userPresets = [];
  const MAX_PRESETS_MEMBER = 2;
  const MAX_PRESETS_ADMIN = 10;

  // Get current form data for saving as preset
  function getCurrentPrintDetails() {
    const getValueSafe = (id) => {
      const elem = document.getElementById(id);
      return elem ? elem.value : '';
    };
    
    const getCheckedSafe = (id) => {
      const elem = document.getElementById(id);
      return elem ? elem.checked : true;
    };
    
    return {
      selectedPrinter: getValueSafe('printerSelect'),
      selectedFilament: getValueSafe('filamentSelect'),
      filamentMarkup: getValueSafe('filamentMarkup'),
      generalMarkup: getValueSafe('generalMarkup'),
      failureRate: getValueSafe('failureRate'),
      postProcessingRate: getValueSafe('postProcessingRate'),
      preparationRate: getValueSafe('preparationRate'),
      jobRemoval: getValueSafe('jobRemoval'),
      supportRemoval: getValueSafe('supportRemoval'),
      additionalWork: getValueSafe('additionalWork'),
      modelPrep: getValueSafe('modelPrep'),
      slicing: getValueSafe('slicing'),
      materialChange: getValueSafe('materialChange'),
      transferStart: getValueSafe('transferStart'),
      includePrinterDepreciation: getCheckedSafe('includePrinterDepreciation')
    };
  }

  // Load preset data into form
  function loadPresetData(preset) {
    const setValueSafe = (id, value, defaultValue) => {
      const elem = document.getElementById(id);
      if (elem) {
        elem.value = value || defaultValue;
      }
    };
    
    if (preset.selectedPrinter) {
      setValueSafe('printerSelect', preset.selectedPrinter, '');
    }
    if (preset.selectedFilament) {
      setValueSafe('filamentSelect', preset.selectedFilament, '');
    }
    setValueSafe('filamentMarkup', preset.filamentMarkup, 0);
    setValueSafe('generalMarkup', preset.generalMarkup, 50);
    setValueSafe('failureRate', preset.failureRate, 10);
    setValueSafe('postProcessingRate', preset.postProcessingRate, 20);
    setValueSafe('preparationRate', preset.preparationRate, 20);
    setValueSafe('jobRemoval', preset.jobRemoval, 0);
    setValueSafe('supportRemoval', preset.supportRemoval, 0);
    setValueSafe('additionalWork', preset.additionalWork, 0);
    setValueSafe('modelPrep', preset.modelPrep, 0);
    setValueSafe('slicing', preset.slicing, 0);
    setValueSafe('materialChange', preset.materialChange, 0);
    setValueSafe('transferStart', preset.transferStart, 0);
    
    // Load checkbox state
    const includePrinterDepreciation = preset.includePrinterDepreciation !== undefined ? preset.includePrinterDepreciation : true;
    document.getElementById('includePrinterDepreciation').checked = includePrinterDepreciation;
    
    updatePriceInfo();
    calculateCost();
  }

  // Save preset button
  btnSavePreset.addEventListener('click', () => {
    const user = auth.currentUser;
    if (!user) {
      showNotification('Please login to save presets', '', 'Login Required');
      return;
    }
    
    const maxPresets = isAdmin ? MAX_PRESETS_ADMIN : MAX_PRESETS_MEMBER;
    presetSaveInfo.textContent = `You have ${userPresets.length} of ${maxPresets} presets saved`;
    
    if (userPresets.length >= maxPresets) {
      presetSaveErr.textContent = `You've reached the maximum of ${maxPresets} presets. Delete one to save a new preset.`;
    } else {
      presetSaveErr.textContent = '';
    }
    
    presetNameInput.value = '';
    showModal(savePresetModal);
  });

  // Reset calculator button
  const btnResetCalculator = document.getElementById('btnResetCalculator');
  btnResetCalculator.addEventListener('click', async () => {
    const confirmed = await showConfirmModal(
      'Reset Calculator', 
      'Are you sure you want to reset all fields to default values?'
    );
    
    if (confirmed) {
      // Define default values
      const defaults = {
        'printerSelect': '',
        'filamentSelect': '',
        'printTime': '0',
        'weight': '0',
        'printTimeDuplicate': '',
        'elec': '0.12',
        'jobRemoval': '0',
        'supportRemoval': '0',
        'additionalWork': '0',
        'postProcessingRate': '20',
        'modelPrep': '0',
        'slicing': '0',
        'materialChange': '0',
        'transferStart': '0',
        'preparationRate': '20',
        'filamentMarkup': '2.7',
        'generalMarkup': '50',
        'failureRate': '10'
      };
      
      // Reset all fields with defaults
      for (const [id, defaultValue] of Object.entries(defaults)) {
        const elem = document.getElementById(id);
        if (elem) {
          elem.value = defaultValue;
        }
      }
      
      // Also reset any additional number inputs that don't have explicit defaults
      const allInputs = document.querySelectorAll('input[type="number"]:not([readonly])');
      allInputs.forEach(input => {
        if (!defaults[input.id] && input.id) {
          // If not in defaults list, reset to placeholder or 0
          input.value = input.placeholder || '0';
        }
      });
      
      // Reset all selects that aren't in defaults
      const allSelects = document.querySelectorAll('select');
      allSelects.forEach(select => {
        if (!defaults[select.id] && select.id) {
          select.value = '';
        }
      });
      
      // Recompute with default values
      updatePriceInfo();
      calculateCost();
    }
  });

  // Close save preset modal
  btnCloseSavePreset.addEventListener('click', () => {
    hideModal(savePresetModal);
  });

  // Do save preset
  btnDoSavePreset.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return;
    
    const name = presetNameInput.value.trim();
    if (!name) {
      presetSaveErr.textContent = 'Please enter a preset name';
      return;
    }
    
    const maxPresets = isAdmin ? MAX_PRESETS_ADMIN : MAX_PRESETS_MEMBER;
    if (userPresets.length >= maxPresets) {
      presetSaveErr.textContent = `Maximum ${maxPresets} presets reached`;
      return;
    }
    
    const presetData = getCurrentPrintDetails();
    const presetId = Date.now().toString();
    
    try {
      await db.ref(`users/${user.uid}/presets/${presetId}`).set({
        name: name,
        data: presetData,
        createdAt: Date.now()
      });
      
      console.log('Preset saved successfully');
      hideModal(savePresetModal);
      loadUserPresets();
    } catch (error) {
      console.error('Error saving preset:', error);
      presetSaveErr.textContent = 'Error saving preset. Please try again.';
    }
  });

  // Manage presets button
  btnManagePresets.addEventListener('click', () => {
    const user = auth.currentUser;
    if (!user) {
      showNotification('Please login to manage presets', '', 'Login Required');
      return;
    }
    renderPresetsList();
    showModal(managePresetsModal);
  });

  // Close manage presets modal
  btnCloseManagePresets.addEventListener('click', () => {
    hideModal(managePresetsModal);
  });

  // Load user presets from Firebase
  async function loadUserPresets() {
    const user = auth.currentUser;
    if (!user) {
      userPresets = [];
      updatePresetsUI();
      return;
    }
    
    try {
      const snapshot = await db.ref(`users/${user.uid}/presets`).once('value');
      const data = snapshot.val();
      
      if (data) {
        userPresets = Object.keys(data).map(id => ({
          id: id,
          ...data[id]
        }));
      } else {
        userPresets = [];
      }
      
      updatePresetsUI();
    } catch (error) {
      console.error('Error loading presets:', error);
      userPresets = [];
      updatePresetsUI();
    }
  }

  // Update presets UI
  function updatePresetsUI() {
    const maxPresets = isAdmin ? MAX_PRESETS_ADMIN : MAX_PRESETS_MEMBER;
    presetLimitInfo.textContent = `${userPresets.length}/${maxPresets} presets`;
    
    // Update quick access buttons
    if (userPresets.length > 0) {
      presetQuickAccess.style.display = 'block';
      presetButtons.innerHTML = '';
      
      userPresets.forEach(preset => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-ghost';
        btn.style.fontSize = '12px';
        btn.style.padding = '6px 12px';
        btn.textContent = preset.name;
        btn.onclick = () => loadPresetData(preset.data);
        presetButtons.appendChild(btn);
      });
    } else {
      presetQuickAccess.style.display = 'none';
    }
  }

  // Render presets list in manage modal
  function renderPresetsList() {
    if (userPresets.length === 0) {
      presetsList.style.display = 'none';
      noPresetsMessage.style.display = 'block';
      return;
    }
    
    presetsList.style.display = 'block';
    noPresetsMessage.style.display = 'none';
    
    presetsList.innerHTML = userPresets.map(preset => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(168, 85, 247, 0.05); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">${preset.name}</div>
          <div style="font-size: 11px; color: var(--text-muted);">Saved ${new Date(preset.createdAt).toLocaleDateString()}</div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="loadPresetAndClose('${preset.id}')">Load</button>
          <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px;" onclick="deletePreset('${preset.id}')">Delete</button>
        </div>
      </div>
    `).join('');
  }

  // Load preset and close modal (global function for onclick)
  window.loadPresetAndClose = function(presetId) {
    const preset = userPresets.find(p => p.id === presetId);
    if (preset) {
      loadPresetData(preset.data);
      hideModal(managePresetsModal);
    }
  };

  // Delete preset (global function for onclick)
  window.deletePreset = async function(presetId) {
    const user = auth.currentUser;
    if (!user) return;
    
    const confirmed = await showConfirmModal(
      'Delete Preset',
      'Are you sure you want to delete this preset?'
    );
    if (!confirmed) return;
    
    try {
      await db.ref(`users/${user.uid}/presets/${presetId}`).remove();
      console.log('Preset deleted successfully');
      await loadUserPresets();
      renderPresetsList();
    } catch (error) {
      console.error('Error deleting preset:', error);
      await showConfirmModal('Error', 'Error deleting preset. Please try again.');
    }
  };

  /* Helpers */
  function money(n) { return `$${(Math.round(n * 100) / 100).toFixed(2)}`; }

  /* Currency System */
  let currentCurrency = 'USD';
  let exchangeRates = {};
  let lastSavedCurrency = 'USD';
  const currencySymbols = {
    USD: '$', EUR: '€', GBP: '£', JPY: '¥', CNY: '¥', CAD: '$', AUD: '$',
    CHF: 'Fr', INR: '₹', MXN: '$', BRL: 'R$', ZAR: 'R', KRW: '₩',
    SGD: '$', NZD: '$', SEK: 'kr', NOK: 'kr', DKK: 'kr', PLN: 'zł',
    THB: '฿', IDR: 'Rp', HUF: 'Ft', CZK: 'Kč', ILS: '₪', CLP: '$',
    PHP: '₱', AED: 'د.إ', SAR: '﷼', MYR: 'RM', RON: 'lei'
  };

  // Fetch exchange rates from API
  async function fetchExchangeRates() {
    try {
      const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
      const data = await response.json();
      exchangeRates = data.rates;
      console.log('Exchange rates loaded:', exchangeRates);
      return true;
    } catch (error) {
      console.error('Error fetching exchange rates:', error);
      // Fallback rates if API fails
      exchangeRates = {
        USD: 1, EUR: 0.92, GBP: 0.79, JPY: 149.50, CNY: 7.24, CAD: 1.36,
        AUD: 1.53, CHF: 0.88, INR: 83.12, MXN: 17.15, BRL: 4.97, ZAR: 18.65,
        KRW: 1319.50, SGD: 1.34, NZD: 1.65, SEK: 10.38, NOK: 10.68, DKK: 6.87,
        PLN: 3.98, THB: 35.15, IDR: 15625, HUF: 356.50, CZK: 22.85, ILS: 3.68,
        CLP: 973.50, PHP: 56.45, AED: 3.67, SAR: 3.75, MYR: 4.72, RON: 4.57
      };
      return false;
    }
  }

  // Convert USD to selected currency
  function convertCurrency(usdAmount) {
    if (!exchangeRates[currentCurrency]) return usdAmount;
    return usdAmount * exchangeRates[currentCurrency];
  }

  // Convert selected currency to USD (for storage)
  function convertToUSD(amount) {
    if (!exchangeRates[currentCurrency]) return amount;
    return amount / exchangeRates[currentCurrency];
  }

  // Convert between two currencies
  function convertBetweenCurrencies(amount, fromCurrency, toCurrency) {
    // If same currency, no conversion needed
    if (fromCurrency === toCurrency) return amount;
    
    // If exchange rates not available, return original
    if (!exchangeRates[fromCurrency] || !exchangeRates[toCurrency]) return amount;
    
    // Convert from -> USD -> to
    const usdAmount = amount / exchangeRates[fromCurrency];
    const convertedAmount = usdAmount * exchangeRates[toCurrency];
    
    return convertedAmount;
  }

  // Format money with current currency
  function formatMoney(usdAmount) {
    const amount = convertCurrency(usdAmount);
    const symbol = currencySymbols[currentCurrency] || currentCurrency + ' ';
    const decimals = ['JPY', 'KRW', 'IDR', 'CLP'].includes(currentCurrency) ? 0 : 2;
    
    // Currencies that share symbols - show code + symbol for clarity
    const dollarCurrencies = ['USD', 'CAD', 'AUD', 'MXN', 'SGD', 'NZD', 'CLP'];
    const kronaCurrencies = ['SEK', 'NOK', 'DKK'];
    const yenCurrencies = ['JPY', 'CNY'];
    
    const formattedAmount = amount.toFixed(decimals);
    
    // For currencies that share symbols, show code + symbol
    if (dollarCurrencies.includes(currentCurrency) || kronaCurrencies.includes(currentCurrency) || yenCurrencies.includes(currentCurrency)) {
      return `${currentCurrency} (${symbol}${formattedAmount})`;
    }
    
    // For unique symbols, just show symbol
    return `${symbol}${formattedAmount}`;
  }

  // Currency selector change handler - Wait for navbar to load
  function initializeCurrencyHandlers() {
    const currencySelect = document.getElementById('currencySelect');
    const btnSaveCurrency = document.getElementById('btnSaveCurrency');
    
    if (!currencySelect || !btnSaveCurrency) {
      console.error('Currency elements not found');
      return;
    }

    currencySelect.addEventListener('change', function() {
      currentCurrency = this.value;
      console.log('Currency changed to:', currentCurrency);
      updateAllPrices();
      updateSaveButton();
    });

    btnSaveCurrency.addEventListener('click', function() {
      saveCurrencyPreference();
    });
  }

  // Initialize currency handlers when navbar loads
  document.addEventListener('navbarLoaded', function() {
    initializeCurrencyHandlers();
  });

  // Update save button visibility and state
  function updateSaveButton() {
    const user = auth.currentUser;
    const saveBtn = document.getElementById('btnSaveCurrency');
    
    if (user) {
      // Show button only if logged in
      saveBtn.style.display = 'block';
      
      // Check if current currency is different from saved
      if (currentCurrency !== lastSavedCurrency) {
        saveBtn.textContent = 'Save';
        saveBtn.classList.remove('saved');
        saveBtn.disabled = false;
      } else {
        saveBtn.textContent = 'Saved';
        saveBtn.classList.add('saved');
        saveBtn.disabled = true;
      }
    } else {
      // Hide button if not logged in
      saveBtn.style.display = 'none';
    }
  }

  // Save currency preference to Firebase (only if logged in)
  function saveCurrencyPreference() {
    const user = auth.currentUser;
    const saveBtn = document.getElementById('btnSaveCurrency');
    
    if (!user) {
      console.log('⚠️ Not logged in, currency not saved');
      return;
    }
    
    console.log('Saving currency preference:', currentCurrency, 'User:', user.uid);
    console.log('User authenticated:', user.email);
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    
    // Try to save to Firebase
    const userCurrencyRef = db.ref(`users/${user.uid}/currency`);
    console.log('Attempting to write to path:', `users/${user.uid}/currency`);
    
    userCurrencyRef.set(currentCurrency).then(() => {
      console.log('✅ Currency preference saved to Firebase:', currentCurrency);
      lastSavedCurrency = currentCurrency;
      saveBtn.textContent = 'Saved';
      saveBtn.classList.add('saved');
      
      // Show notification
      showNotification('Currency preference saved!', 'success');
      
      // Reload page after 1 second to show new currency
      setTimeout(() => {
        location.reload();
      }, 1000);
    }).catch(error => {
      console.error('❌ Error saving currency to Firebase:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      // Check if it's a permission error
      if (error.code === 'PERMISSION_DENIED') {
        saveBtn.textContent = 'Permission Error';
        showNotification('Permission denied. Firebase security rules may need to be updated.', 'error', 'Permission Error');
      } else {
        saveBtn.textContent = 'Error';
        showNotification('Error saving currency: ' + error.message, 'error');
      }
      
      saveBtn.disabled = false;
      
      // Reset button after 3 seconds
      setTimeout(() => {
        updateSaveButton();
      }, 3000);
    });
  }

  // Listen for real-time currency changes from Firebase
  let currencyListener = null;

  function setupCurrencyListener(user) {
    // Remove old listener if exists
    if (currencyListener) {
      db.ref(`users/${user.uid}/currency`).off('value', currencyListener);
    }

    // Set up new listener
    currencyListener = db.ref(`users/${user.uid}/currency`).on('value', snapshot => {
      const savedCurrency = snapshot.val();
      console.log('Currency updated from Firebase:', savedCurrency);
      
      if (savedCurrency && exchangeRates[savedCurrency]) {
        currentCurrency = savedCurrency;
        lastSavedCurrency = savedCurrency;
        document.getElementById('currencySelect').value = savedCurrency;
        console.log('✅ Applied currency from Firebase:', savedCurrency);
        updateAllPrices();
        updateSaveButton();
      }
    });
  }

  // Setup printer depreciation preference listener
  let printerDepreciationListener = null;
  
  function setupPrinterDepreciationListener(user) {
    // Remove old listener if exists
    if (printerDepreciationListener) {
      db.ref(`users/${user.uid}/preferences/includePrinterDepreciation`).off('value', printerDepreciationListener);
    }

    // Set up new listener
    printerDepreciationListener = db.ref(`users/${user.uid}/preferences/includePrinterDepreciation`).on('value', snapshot => {
      const savedPreference = snapshot.val();
      console.log('Printer depreciation preference from Firebase:', savedPreference);
      
      // Default to true if not set
      const shouldInclude = savedPreference !== null ? savedPreference : true;
      document.getElementById('includePrinterDepreciation').checked = shouldInclude;
      calculateCost();
    });
  }

  // Save printer depreciation preference to Firebase
  async function savePrinterDepreciationPreference() {
    const user = auth.currentUser;
    if (!user) return;
    
    const isChecked = document.getElementById('includePrinterDepreciation').checked;
    try {
      await db.ref(`users/${user.uid}/preferences/includePrinterDepreciation`).set(isChecked);
      console.log('✅ Saved printer depreciation preference:', isChecked);
    } catch (error) {
      console.error('Error saving printer depreciation preference:', error);
    }
  }

  // Load currency preference from Firebase (only if logged in)
  async function loadCurrencyPreference() {
    const user = auth.currentUser;
    console.log('Loading currency preference. User:', user ? user.uid : 'not logged in');
    
    if (user) {
      // Set up real-time listener
      setupCurrencyListener(user);
    } else {
      // Not logged in - reset to USD
      console.log('Not logged in, resetting to USD');
      currentCurrency = 'USD';
      lastSavedCurrency = 'USD';
      document.getElementById('currencySelect').value = 'USD';
      updateAllPrices();
      updateSaveButton();
      
      // Remove listener if exists
      if (currencyListener) {
        db.ref().off('value', currencyListener);
        currencyListener = null;
      }
    }
  }

  // Convert all prices to the current currency
  function updateAllPrices() {
    console.log('Updating all prices with currency:', currentCurrency);
    renderPrinterSelect();
    renderPrintersList();
    renderFilamentSelect();
    renderFilamentsList();
    
    // Also refresh user preset lists
    if (auth.currentUser) {
      renderUserPrintersList();
      renderUserFilamentsList();
    }
    
    calculateCost();
  }

  /* Custom Notification System */
  function showNotification(message, type = 'success', title = '') {
    const notification = document.getElementById('customNotification');
    
    // Remove previous type classes
    notification.classList.remove('success', 'error', 'warning');
    
    // Set icon and title based on type
    let icon = '✓';
    let notificationTitle = title || 'Success!';
    
    if (type === 'error') {
      icon = '✕';
      notificationTitle = title || 'Error';
    } else if (type === 'warning') {
      icon = '⚠';
      notificationTitle = title || 'Warning';
    }
    
    // Update content
    notification.querySelector('.notification-icon').textContent = icon;
    notification.querySelector('.notification-title').textContent = notificationTitle;
    notification.querySelector('.notification-message').textContent = message;
    
    // Add type class and show
    notification.classList.add(type);
    notification.classList.add('show');
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
      hideNotification();
    }, 3000);
  }

  function hideNotification() {
    const notification = document.getElementById('customNotification');
    notification.classList.remove('show');
  }

  /* Custom Confirm Dialog */
  function showConfirm(message, icon = '', title = 'Are you sure?', buttonText = 'Confirm') {
    return new Promise((resolve) => {
      const confirmDialog = document.getElementById('customConfirm');
      const overlay = document.getElementById('overlay');
      const yesBtn = document.getElementById('confirmYes');
      const noBtn = document.getElementById('confirmNo');
      
      confirmDialog.querySelector('.confirm-icon').textContent = icon;
      confirmDialog.querySelector('.confirm-title').textContent = title;
      confirmDialog.querySelector('.confirm-message').textContent = message;
      yesBtn.textContent = buttonText;
      
      overlay.style.display = 'block';
      confirmDialog.classList.add('show');
      
      const cleanup = () => {
        confirmDialog.classList.remove('show');
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 300);
      };
      
      yesBtn.onclick = () => {
        cleanup();
        resolve(true);
      };
      
      noBtn.onclick = () => {
        cleanup();
        resolve(false);
      };
    });
  }

  /* Auth State */
  let isAdmin = false;
  let printersData = {};
  let filamentsData = {};
  let dataLoaded = false;
  let editingPrinterId = null;
  let editingFilamentId = null;

  // Check if user is admin
  async function checkAdminStatus(user) {
    if (!user) {
      return false;
    }
    
    try {
      const snapshot = await db.ref(`users/${user.uid}/role`).once('value');
      const role = snapshot.val();
      console.log('User role:', role);
      return role === 'admin';
    } catch (error) {
      console.error('Error checking admin status:', error);
      return false;
    }
  }

  auth.onAuthStateChanged(async user => {
    console.log('Auth state changed. User:', user ? user.uid : 'logged out');
    
    // Set up user-specific database references
    if (user) {
      userPrintersRef = db.ref(`userPrinters/${user.uid}`);
      userFilamentsRef = db.ref(`userFilaments/${user.uid}`);
      
      // Listen to user printers and filaments
      userPrintersRef.on('value', renderUserPrintersList);
      userFilamentsRef.on('value', renderUserFilamentsList);
    } else {
      // Clean up listeners when user logs out
      if (userPrintersRef) {
        userPrintersRef.off();
        userPrintersRef = null;
      }
      if (userFilamentsRef) {
        userFilamentsRef.off();
        userFilamentsRef = null;
      }
      // Re-render to show "Coming Soon" message
      renderUserPrintersList();
      renderUserFilamentsList();
    }
    
    // Wait for navbar elements to be available
    let retryCount = 0;
    const maxRetries = 50; // Max 5 seconds (50 * 100ms)
    
    async function updateAuthUI() {
      if (!navbarElements) {
        // Retry after a short delay if navbar isn't ready yet
        if (retryCount < maxRetries) {
          retryCount++;
          setTimeout(updateAuthUI, 100);
          return;
        } else {
          console.error('Navbar elements failed to load after max retries');
          return;
        }
      }

      const {
        btnLoginSettings,
        btnLogoutSettings,
        userInfoDisplay,
        settingsUsername,
        settingsRole,
        userAvatar,
        btnLoginNav,
        btnSettingsPage
      } = navbarElements;

      if (user) {
        // DEBUG: Show user info
        console.log('======================');
        console.log('USER DEBUG INFO:');
        console.log('Email:', user.email);
        console.log('UID:', user.uid);
        console.log('Display Name:', user.displayName);
        console.log('======================');
        
        // Check if user is admin
        isAdmin = await checkAdminStatus(user);
        console.log('User role returned:', isAdmin ? 'admin' : 'not admin');
        console.log('Is admin:', isAdmin);
        
        // Get username from displayName first, then from database, fallback to email
        let username = user.displayName;
        
        if (!username) {
          // Try to get username from database
          try {
            const userSnapshot = await db.ref(`users/${user.uid}/username`).once('value');
            username = userSnapshot.val();
          } catch (error) {
            console.error('Error fetching username from database:', error);
          }
        }
        
        // Fallback to email username if still no username
        if (!username) {
          username = user.email.split('@')[0];
        }
        
        // Fetch role from Firebase Database
        db.ref('users/' + user.uid + '/role').once('value')
          .then(snapshot => {
            const roleFromDb = snapshot.val() || 'member';
            console.log('User role from Firebase:', roleFromDb);
            
            // Display role with proper capitalization
            if (roleFromDb.toLowerCase() === 'admin' || roleFromDb.toLowerCase() === 'administrator') {
              settingsRole.textContent = 'Administrator';
            } else {
              settingsRole.textContent = 'Member';
            }
          })
          .catch(error => {
            console.error('Error fetching role:', error);
            settingsRole.textContent = isAdmin ? 'Administrator' : 'Member';
          });
        
        // Update settings dropdown UI
        userInfoDisplay.style.display = 'block';
        settingsUsername.textContent = username;
        
        // Set avatar initial (first letter of username)
        const avatarInitial = username.charAt(0).toUpperCase();
        userAvatar.textContent = avatarInitial;
        
        // Show/hide buttons
        btnLoginSettings.style.display = 'none';
        btnLogoutSettings.style.display = 'block';
        if (btnSettingsPage) btnSettingsPage.style.display = 'block';
        if (btnLoginNav) btnLoginNav.style.display = 'none';
        
      } else {
        isAdmin = false;
        
        // Update settings dropdown UI for logged out state
        userInfoDisplay.style.display = 'none';
        btnLoginSettings.style.display = 'block';
        btnLogoutSettings.style.display = 'none';
        if (btnSettingsPage) btnSettingsPage.style.display = 'none';
        if (btnLoginNav) btnLoginNav.style.display = 'block';
      }
    }

    await updateAuthUI();
    
    // Show/hide admin buttons
    document.getElementById('btnAddPrinter').style.display = isAdmin ? 'inline-block' : 'none';
    document.getElementById('btnAddFilament').style.display = isAdmin ? 'inline-block' : 'none';
    
    // Show/hide user preset buttons (for all logged-in users)
    document.getElementById('btnAddUserPrinter').style.display = user ? 'inline-block' : 'none';
    document.getElementById('btnAddUserFilament').style.display = user ? 'inline-block' : 'none';
    document.getElementById('btnToggleUserPrinterMassDelete').style.display = user ? 'inline-block' : 'none';
    document.getElementById('btnToggleUserFilamentMassDelete').style.display = user ? 'inline-block' : 'none';
    
    // Load currency preference when auth state changes
    if (Object.keys(exchangeRates).length > 0) {
      setTimeout(() => {
        loadCurrencyPreference();
      }, 150);
    }
    
    // Load printer depreciation preference
    if (user) {
      setupPrinterDepreciationListener(user);
    } else {
      // Reset to default when logged out
      document.getElementById('includePrinterDepreciation').checked = true;
      if (printerDepreciationListener) {
        db.ref().off('value', printerDepreciationListener);
        printerDepreciationListener = null;
      }
    }
    
    // Load user presets
    loadUserPresets();
    
    // Re-render lists after admin status is confirmed
    if (dataLoaded) {
      console.log('Re-rendering lists with admin status:', isAdmin);
      renderPrintersList();
      renderFilamentsList();
    }
  });

  /* Tab Switching */
  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });

    if (tabName === 'calculator') {
      document.getElementById('calculatorTab').classList.add('active');
      document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
    } else if (tabName === 'printers') {
      document.getElementById('printersTab').classList.add('active');
      document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
      console.log('Switched to Printer Presets tab');
      renderPrintersList();
    } else if (tabName === 'filaments') {
      document.getElementById('filamentsTab').classList.add('active');
      document.querySelector('.tabs .tab:nth-child(3)').classList.add('active');
      console.log('Switched to Filament Presets tab');
      renderFilamentsList();
    } else if (tabName === 'userPresets') {
      document.getElementById('userPresetsTab').classList.add('active');
      document.querySelector('.tabs .tab:nth-child(4)').classList.add('active');
      console.log('Switched to Your Presets tab');
      renderUserPrintersList();
      renderUserFilamentsList();
    }
  }

  /* User Presets - No longer using sub-tabs, both sections shown side by side */

  /* Modal Functions */
  function showModal(modal) {
    overlay.style.display = 'block';
    modal.style.display = 'grid';
  }

  function hideModal(modal) {
    overlay.style.display = 'none';
    modal.style.display = 'none';
  }

  /* Confirmation Modal Function */
  function showConfirmModal(title, message) {
    return new Promise((resolve) => {
      const confirmModal = document.getElementById('confirmModal');
      const confirmTitle = document.getElementById('confirmTitle');
      const confirmMessage = document.getElementById('confirmMessage');
      const confirmOK = document.getElementById('confirmOK');
      const confirmCancel = document.getElementById('confirmCancel');
      
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      
      showModal(confirmModal);
      
      const handleOK = () => {
        hideModal(confirmModal);
        confirmOK.removeEventListener('click', handleOK);
        confirmCancel.removeEventListener('click', handleCancel);
        resolve(true);
      };
      
      const handleCancel = () => {
        hideModal(confirmModal);
        confirmOK.removeEventListener('click', handleOK);
        confirmCancel.removeEventListener('click', handleCancel);
        resolve(false);
      };
      
      confirmOK.addEventListener('click', handleOK);
      confirmCancel.addEventListener('click', handleCancel);
    });
  }

  /* Login */
  document.getElementById('closeLogin').onclick = () => hideModal(loginModal);
  
  document.getElementById('doLogin').onclick = () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    
    if (!email || !pass) {
      document.getElementById('loginErr').textContent = 'Please enter both email and password.';
      return;
    }
    
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => {
        hideModal(loginModal);
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPass').value = '';
        document.getElementById('loginErr').textContent = '';
        console.log('User logged in successfully');
        
        // Reload page to fetch all user data (presets, settings, etc.)
        window.location.reload();
      })
      .catch((error) => {
        console.error('Login error:', error);
        if (error.code === 'auth/user-not-found') {
          document.getElementById('loginErr').textContent = 'No account found with this email.';
        } else if (error.code === 'auth/wrong-password') {
          document.getElementById('loginErr').textContent = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
          document.getElementById('loginErr').textContent = 'Invalid email address.';
        } else if (error.code === 'auth/invalid-credential') {
          document.getElementById('loginErr').textContent = 'Invalid credentials. Please check your email and password.';
        } else {
          document.getElementById('loginErr').textContent = 'Invalid credentials. Please check your email and password.';
        }
      });
  };

  /* Signup - DISABLED: Requires Email Verification */
  document.getElementById('closeSignup').onclick = () => hideModal(signupModal);
  
  // IMPORTANT: Account creation on calculator page is disabled
  // Users MUST sign up from the home page to ensure email verification
  document.getElementById('doSignup').onclick = async () => {
    // Automatically redirect to home page and open signup modal
    sessionStorage.setItem('openSignup', 'true');
    window.location.href = '../index.html';
  };

  /* Modal Switching */
  document.getElementById('switchToSignup').onclick = () => {
    hideModal(loginModal);
    // Redirect to home page for signup (requires email verification)
    // Store flag to auto-open signup modal
    sessionStorage.setItem('openSignup', 'true');
    window.location.href = '../index.html';
  };

  document.getElementById('switchToLogin').onclick = () => {
    hideModal(signupModal);
    document.getElementById('signupErr').textContent = '';
    showModal(loginModal);
  };

  /* Password Visibility Toggles */
  // Login password toggle
  document.getElementById('toggleLoginPassCalc').onclick = (e) => {
    e.preventDefault();
    const passInput = document.getElementById('loginPass');
    const toggleBtn = document.getElementById('toggleLoginPassCalc');
    if (passInput.type === 'password') {
      passInput.type = 'text';
      toggleBtn.textContent = '�‍🗨';
    } else {
      passInput.type = 'password';
      toggleBtn.textContent = '👁';
    }
  };

  // Signup password toggle
  document.getElementById('toggleSignupPassCalc').onclick = (e) => {
    e.preventDefault();
    const passInput = document.getElementById('signupPass');
    const toggleBtn = document.getElementById('toggleSignupPassCalc');
    if (passInput.type === 'password') {
      passInput.type = 'text';
      toggleBtn.textContent = '�‍🗨';
    } else {
      passInput.type = 'password';
      toggleBtn.textContent = '👁';
    }
  };

  // Signup confirm password toggle
  document.getElementById('toggleSignupPassConfirmCalc').onclick = (e) => {
    e.preventDefault();
    const passInput = document.getElementById('signupPassConfirm');
    const toggleBtn = document.getElementById('toggleSignupPassConfirmCalc');
    if (passInput.type === 'password') {
      passInput.type = 'text';
      toggleBtn.textContent = '👁‍�';
    } else {
      passInput.type = 'password';
      toggleBtn.textContent = '👁';
    }
  };

  /* Forgot Password */
  document.getElementById('forgotPasswordLinkCalc').onclick = (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    
    if (!email) {
      document.getElementById('loginErr').textContent = 'Please enter your email address first.';
      return;
    }

    showConfirm(`Send password reset email to ${email}?`, '', 'Reset Password', 'Send Email').then((confirmed) => {
      if (confirmed) {
        auth.sendPasswordResetEmail(email)
          .then(() => {
            showNotification('Password reset email sent! Check your inbox and spam folder.', '', 'Email Sent');
            document.getElementById('loginErr').textContent = '';
          })
          .catch((error) => {
          if (error.code === 'auth/user-not-found') {
            document.getElementById('loginErr').textContent = 'No account found with this email.';
          } else if (error.code === 'auth/invalid-email') {
            document.getElementById('loginErr').textContent = 'Invalid email address.';
          } else {
            document.getElementById('loginErr').textContent = 'Error: ' + error.message;
          }
          });
      }
    });
  };

  /* Brand Filter Functions */
  function populatePrinterBrandFilters() {
    const container = document.getElementById('printerBrandFilters');
    if (!container) return;
    
    // Get unique brands with counts
    const brandCounts = {};
    Object.values(printersData).forEach(printer => {
      const brand = printer.brand || 'Unknown';
      brandCounts[brand] = (brandCounts[brand] || 0) + 1;
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(brandCounts).sort();
    
    // Create checkbox for each brand
    container.innerHTML = '';
    sortedBrands.forEach(brand => {
      const item = document.createElement('label');
      item.className = 'brand-checkbox-item';
      item.innerHTML = `
        <input type="checkbox" value="${brand}" onchange="filterPrinters()">
        <span class="brand-checkbox-label">${brand}</span>
        <span class="brand-checkbox-count">${brandCounts[brand]}</span>
      `;
      
      // Add checked class when checkbox is checked
      const checkbox = item.querySelector('input');
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          item.classList.add('checked');
        } else {
          item.classList.remove('checked');
        }
      });
      
      container.appendChild(item);
    });
  }

  function filterPrinters() {
    const checkboxes = document.querySelectorAll('#printerBrandFilters input[type="checkbox"]');
    const selectedBrands = new Set();
    
    checkboxes.forEach(cb => {
      if (cb.checked) {
        selectedBrands.add(cb.value);
      }
    });
    
    const categories = document.querySelectorAll('#printersList .brand-category');
    let visibleCount = 0;
    let totalCount = 0;
    
    categories.forEach(category => {
      const brandTitle = category.querySelector('.brand-title').textContent;
      const items = category.querySelectorAll('.list-item');
      totalCount += items.length;
      
      // Show all if nothing is selected, otherwise only show selected brands
      if (selectedBrands.size === 0 || selectedBrands.has(brandTitle)) {
        category.style.display = 'block';
        visibleCount += items.length;
      } else {
        category.style.display = 'none';
      }
    });
    
    // Update stats
    const stats = document.getElementById('printerFilterStats');
    const noResults = document.getElementById('printersNoResults');
    const list = document.getElementById('printersList');
    
    if (visibleCount === 0 && totalCount > 0) {
      noResults.style.display = 'block';
      list.style.display = 'none';
      stats.textContent = `No printers match selected brands (0 of ${totalCount})`;
    } else {
      noResults.style.display = 'none';
      list.style.display = 'block';
      if (selectedBrands.size === 0) {
        stats.textContent = `Showing all ${totalCount} printers`;
      } else {
        stats.textContent = `Showing ${visibleCount} of ${totalCount} printers`;
      }
    }
  }

  function populateFilamentBrandFilters() {
    const container = document.getElementById('filamentBrandFilters');
    if (!container) return;
    
    // Get unique brands with counts
    const brandCounts = {};
    Object.values(filamentsData).forEach(filament => {
      const brand = filament.brand || 'Unknown';
      brandCounts[brand] = (brandCounts[brand] || 0) + 1;
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(brandCounts).sort();
    
    // Create checkbox for each brand
    container.innerHTML = '';
    sortedBrands.forEach(brand => {
      const item = document.createElement('label');
      item.className = 'brand-checkbox-item';
      item.innerHTML = `
        <input type="checkbox" value="${brand}" onchange="filterFilaments()">
        <span class="brand-checkbox-label">${brand}</span>
        <span class="brand-checkbox-count">${brandCounts[brand]}</span>
      `;
      
      // Add checked class when checkbox is checked
      const checkbox = item.querySelector('input');
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          item.classList.add('checked');
        } else {
          item.classList.remove('checked');
        }
      });
      
      container.appendChild(item);
    });
  }

  function filterFilaments() {
    const checkboxes = document.querySelectorAll('#filamentBrandFilters input[type="checkbox"]');
    const selectedBrands = new Set();
    
    checkboxes.forEach(cb => {
      if (cb.checked) {
        selectedBrands.add(cb.value);
      }
    });
    
    const categories = document.querySelectorAll('#filamentsList .brand-category');
    let visibleCount = 0;
    let totalCount = 0;
    
    categories.forEach(category => {
      const brandTitle = category.querySelector('.brand-title').textContent;
      const items = category.querySelectorAll('.list-item');
      totalCount += items.length;
      
      // Show all if nothing is selected, otherwise only show selected brands
      if (selectedBrands.size === 0 || selectedBrands.has(brandTitle)) {
        category.style.display = 'block';
        visibleCount += items.length;
      } else {
        category.style.display = 'none';
      }
    });
    
    // Update stats
    const stats = document.getElementById('filamentFilterStats');
    const noResults = document.getElementById('filamentsNoResults');
    const list = document.getElementById('filamentsList');
    
    if (visibleCount === 0 && totalCount > 0) {
      noResults.style.display = 'block';
      list.style.display = 'none';
      stats.textContent = `No filaments match selected brands (0 of ${totalCount})`;
    } else {
      noResults.style.display = 'none';
      list.style.display = 'block';
      if (selectedBrands.size === 0) {
        stats.textContent = `Showing all ${totalCount} filaments`;
      } else {
        stats.textContent = `Showing ${visibleCount} of ${totalCount} filaments`;
      }
    }
  }

  /* Printers - Load from Firebase with Brand */
  function loadPrinters() {
    console.log('Loading printers from Firebase...');
    printersRef.on('value', snapshot => {
      console.log('Printers snapshot received');
      const data = snapshot.val();
      console.log('Raw printers data:', data);
      
      printersData = {};
      
      if (!data) {
        console.log('No printers in database');
        renderPrinterSelect();
        renderPrintersList();
        return;
      }
      
      // Convert Firebase data structure
      Object.entries(data).forEach(([key, value]) => {
        console.log('Processing printer:', key, value);
        const name = value.name;
        const brand = value.brand || 'Unknown';
        const price = Number(value.price || 0);
        const lifespan = Number(value.lifespan || 5000);
        const costPerHour = price / lifespan;
        
        printersData[name] = {
          id: key,
          name: name,
          brand: brand,
          price: price,
          lifespan: lifespan,
          costPerHour: costPerHour
        };
      });
      
      console.log('Processed printers data:', printersData);
      console.log('Total printers:', Object.keys(printersData).length);
      
      dataLoaded = true;
      
      const container = document.getElementById('printersListContainer');
      if (container) container.style.display = 'none';
      
      renderPrinterSelect();
      renderPrintersList();
      updatePriceInfo();
      calculateCost();
      
      // Apply filter after rendering
      setTimeout(() => filterPrinters(), 100);
    }, error => {
      console.error('Error loading printers:', error);
      const container = document.getElementById('printersListContainer');
      if (container) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff7b7b;">Error loading printers: ' + error.message + '</div>';
      }
    });
  }

  function renderPrinterSelect() {
    const select = document.getElementById('printerSelect');
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">Choose a printer...</option>';
    
    // Add user printers first if logged in - grouped by brand
    if (auth.currentUser && Object.keys(userPrintersData).length > 0) {
      // Group user printers by brand
      const userBrandGroups = {};
      Object.entries(userPrintersData).forEach(([id, printer]) => {
        const brand = printer.brand || 'Unknown Brand';
        if (!userBrandGroups[brand]) {
          userBrandGroups[brand] = [];
        }
        userBrandGroups[brand].push({ id, ...printer });
      });
      
      // Sort brands alphabetically
      const sortedUserBrands = Object.keys(userBrandGroups).sort();
      
      sortedUserBrands.forEach(brand => {
        const brandGroup = document.createElement('optgroup');
        brandGroup.label = `Your Library - ${brand}`;
        
        // Sort printers within brand alphabetically
        userBrandGroups[brand].sort((a, b) => a.name.localeCompare(b.name)).forEach(printer => {
          const option = document.createElement('option');
          option.value = `user:${printer.id}`;
          option.textContent = printer.name;
          brandGroup.appendChild(option);
        });
        
        select.appendChild(brandGroup);
      });
    }
    
    // Add global printers second - grouped by brand
    if (Object.keys(printersData).length > 0) {
      // Group global printers by brand
      const globalBrandGroups = {};
      Object.entries(printersData).forEach(([name, printer]) => {
        const brand = printer.brand || 'Unknown Brand';
        if (!globalBrandGroups[brand]) {
          globalBrandGroups[brand] = [];
        }
        globalBrandGroups[brand].push({ name, ...printer });
      });
      
      // Sort brands alphabetically
      const sortedGlobalBrands = Object.keys(globalBrandGroups).sort();
      
      sortedGlobalBrands.forEach(brand => {
        const brandGroup = document.createElement('optgroup');
        brandGroup.label = `Global Library - ${brand}`;
        
        // Sort printers within brand alphabetically
        globalBrandGroups[brand].sort((a, b) => a.name.localeCompare(b.name)).forEach(printer => {
          const option = document.createElement('option');
          option.value = `global:${printer.name}`;
          option.textContent = printer.name;
          brandGroup.appendChild(option);
        });
        
        select.appendChild(brandGroup);
      });
    }
    
    // Restore previous selection
    if (currentValue) {
      select.value = currentValue;
    }
    
    updatePriceInfo();
    const totalOptions = Object.keys(printersData).length + Object.keys(userPrintersData).length;
    console.log('Printer select updated with', totalOptions, 'options (', Object.keys(printersData).length, 'global,', Object.keys(userPrintersData).length, 'user)');
  }
  
  // Helper function to populate printer dropdown (called from user preset functions)
  function populatePrinterDropdown() {
    renderPrinterSelect();
  }

  function renderPrintersList() {
    const list = document.getElementById('printersList');
    const toggleBtn = document.getElementById('btnTogglePrinterMassDelete');
    if (!list) {
      console.error('printersList element not found');
      return;
    }
    
    console.log('Rendering printers list. isAdmin:', isAdmin);
    
    list.innerHTML = '';
    
    const printerCount = Object.keys(printersData).length;
    console.log('Rendering', printerCount, 'printers');
    
    // Show/hide mass delete toggle button based on admin status and printer count
    if (isAdmin && printerCount > 0) {
      toggleBtn.style.display = 'block';
    } else {
      toggleBtn.style.display = 'none';
    }
    
    if (printerCount === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <p style="font-size: 16px; margin-bottom: 8px;">No printers in the library yet.</p>
          ${isAdmin ? '<p style="margin-top: 8px; font-size: 14px;">Click "Add Printer" above to add your first printer.</p>' : '<p style="margin-top: 8px; font-size: 14px;">Login as admin to add printers.</p>'}
        </div>
      `;
      document.getElementById('printerFilterStats').textContent = 'No printers available';
      return;
    }

    const countHeader = document.createElement('div');
    countHeader.style.cssText = 'font-size: 14px; color: var(--text-muted); margin-bottom: 24px; font-weight: 600;';
    countHeader.textContent = `Total: ${printerCount} printer${printerCount !== 1 ? 's' : ''}`;
    list.appendChild(countHeader);
    
    // Group printers by brand
    const printersByBrand = {};
    Object.entries(printersData).forEach(([name, printer]) => {
      if (!printersByBrand[printer.brand]) {
        printersByBrand[printer.brand] = [];
      }
      printersByBrand[printer.brand].push(printer);
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(printersByBrand).sort((a, b) => a.localeCompare(b));
    
    // Render each brand category
    sortedBrands.forEach(brand => {
      const printers = printersByBrand[brand].sort((a, b) => a.name.localeCompare(b.name));
      
      const brandCategory = document.createElement('div');
      brandCategory.className = 'brand-category';
      
      const brandHeader = document.createElement('div');
      brandHeader.className = 'brand-header';
      brandHeader.innerHTML = `
        <div class="brand-title">${brand}</div>
        <div class="brand-count">${printers.length} printer${printers.length !== 1 ? 's' : ''}</div>
      `;
      
      const brandItems = document.createElement('div');
      brandItems.className = 'brand-items';
      
      printers.forEach(printer => {
        const item = document.createElement('div');
        item.className = isAdmin ? 'list-item with-checkbox' : 'list-item';
        
        item.innerHTML = `
          ${isAdmin ? `<input type="checkbox" class="item-checkbox printer-checkbox" data-printer-id="${printer.id}" onchange="updatePrinterSelection()">` : ''}
          <div class="item-info">
            <div class="item-name">${printer.name}</div>
            <div class="item-details">
              <div class="detail-badge">
                <span class="detail-label">Purchase Price</span>
                <span class="detail-value">${formatMoney(printer.price)}</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Lifespan</span>
                <span class="detail-value">${printer.lifespan.toLocaleString()} hrs</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Depreciation</span>
                <span class="detail-value">${formatMoney(printer.costPerHour)}/hr</span>
              </div>
            </div>
          </div>
          ${isAdmin ? `
            <div class="btn-actions">
              <button class="btn btn-edit btn-small" onclick="editPrinter('${printer.id}')">Edit</button>
              <button class="btn btn-delete btn-small" onclick="deletePrinter('${printer.id}')">Delete</button>
            </div>
          ` : ''}
        `;
        brandItems.appendChild(item);
      });
      
      brandCategory.appendChild(brandHeader);
      brandCategory.appendChild(brandItems);
      list.appendChild(brandCategory);
    });
    
    // Reset mass delete mode when re-rendering
    if (isAdmin) {
      exitPrinterMassDeleteMode();
    }
    
    // Populate brand filters
    populatePrinterBrandFilters();
       
    console.log('Printers list rendered successfully');
  }

  document.getElementById('btnAddPrinter').onclick = () => {
    editingPrinterId = null;
    document.getElementById('printerModalTitle').textContent = 'Add Printer';
    document.getElementById('printerName').value = '';
    document.getElementById('printerName').readOnly = false;
    document.getElementById('printerBrand').value = '';
    document.getElementById('printerBrand').readOnly = false;
    document.getElementById('printerPrice').value = '';
    document.getElementById('printerLifespan').value = '5000';
    document.getElementById('printerQuickAdd').value = '';
    document.getElementById('printerErr').textContent = '';
    
    // Reset to global save handler
    document.getElementById('savePrinter').onclick = saveGlobalPrinter;
    
    showModal(printerModal);
  };
  
  // Global printer save function
  function saveGlobalPrinter() {
    const name = document.getElementById('printerName').value.trim();
    const brand = document.getElementById('printerBrand').value.trim();
    const price = parseFloat(document.getElementById('printerPrice').value);
    const lifespan = parseInt(document.getElementById('printerLifespan').value);
    
    if (!name || !brand || !price || price < 0 || !lifespan || lifespan < 1) {
      document.getElementById('printerErr').textContent = 'Please fill all fields correctly.';
      return;
    }
    
    if (editingPrinterId) {
      // Update existing printer
      printersRef.child(editingPrinterId).update({ name, brand, price, lifespan })
        .then(() => {
          editingPrinterId = null;
          hideModal(printerModal);
          document.getElementById('printerErr').textContent = '';
        })
        .catch((error) => {
          document.getElementById('printerErr').textContent = 'Error updating printer: ' + error.message;
        });
    } else {
      // Add new printer
      printersRef.push({ name, brand, price, lifespan })
        .then(() => {
          hideModal(printerModal);
          document.getElementById('printerErr').textContent = '';
        })
        .catch((error) => {
          document.getElementById('printerErr').textContent = 'Error saving printer: ' + error.message;
        });
    }
  }

  // Quick Add Parser for Printers - BATCH SAVE
  document.getElementById('btnParseQuickAdd').onclick = () => {
    const input = document.getElementById('printerQuickAdd').value.trim();
    
    if (!input) {
      document.getElementById('printerErr').textContent = 'Please enter printer data in array format.';
      return;
    }
    
    try {
      // Split by semicolon to handle multiple entries
      const entries = input.split(';').map(e => e.trim()).filter(e => e.length > 0);
      
      if (entries.length === 0) {
        throw new Error('No valid entries found');
      }
      
      console.log(`Found ${entries.length} printer entries to add`);
      
      const printersToAdd = [];
      
      // Parse and validate each entry
      entries.forEach((entry, index) => {
        const data = JSON.parse(entry);
        
        // Validate array structure
        if (!Array.isArray(data) || data.length !== 4) {
          throw new Error(`Entry ${index + 1}: Array must have exactly 4 elements: [Name, Brand, Price, Lifespan]`);
        }
        
        const [name, brand, price, lifespan] = data;
        
        // Validate data types
        if (typeof name !== 'string' || !name.trim()) {
          throw new Error(`Entry ${index + 1}: Name must be a non-empty string`);
        }
        if (typeof brand !== 'string' || !brand.trim()) {
          throw new Error(`Entry ${index + 1}: Brand must be a non-empty string`);
        }
        if (typeof price !== 'number' || price <= 0) {
          throw new Error(`Entry ${index + 1}: Price must be a positive number`);
        }
        if (typeof lifespan !== 'number' || lifespan <= 0) {
          throw new Error(`Entry ${index + 1}: Lifespan must be a positive number`);
        }
        
        printersToAdd.push({
          name: name.trim(),
          brand: brand.trim(),
          price: price,
          lifespan: lifespan
        });
      });
      
      // Show processing message
      document.getElementById('printerErr').style.color = '#c084fc';
      document.getElementById('printerErr').textContent = `Adding ${printersToAdd.length} printer${printersToAdd.length > 1 ? 's' : ''}...`;
      
      // Add all printers to Firebase
      let addedCount = 0;
      const addPromises = printersToAdd.map(printer => {
        return printersRef.push(printer).then(() => {
          addedCount++;
          console.log(`Added printer ${addedCount}/${printersToAdd.length}:`, printer.name);
        });
      });
      
      // Wait for all adds to complete
      Promise.all(addPromises)
        .then(() => {
          // Clear the input
          document.getElementById('printerQuickAdd').value = '';
          
          // Show success message
          document.getElementById('printerErr').style.color = '#10b981';
          document.getElementById('printerErr').textContent = `Successfully added ${addedCount} printer${addedCount > 1 ? 's' : ''}!`;
          
          setTimeout(() => {
            document.getElementById('printerErr').style.color = '#ff7b7b';
            document.getElementById('printerErr').textContent = '';
          }, 3000);
        })
        .catch(error => {
          document.getElementById('printerErr').style.color = '#ff7b7b';
          document.getElementById('printerErr').textContent = 'Error saving printers: ' + error.message;
          console.error('Error saving printers:', error);
        });
      
    } catch (error) {
      document.getElementById('printerErr').textContent = 'Parse error: ' + error.message;
      console.error('Parse error:', error);
    }
  };

  function editPrinter(id) {
    editingPrinterId = id;
    const printer = Object.values(printersData).find(p => p.id === id);
    if (!printer) return;
    
    document.getElementById('printerModalTitle').textContent = 'Edit Printer';
    document.getElementById('printerName').value = printer.name;
    document.getElementById('printerName').readOnly = false;
    document.getElementById('printerBrand').value = printer.brand;
    document.getElementById('printerBrand').readOnly = false;
    document.getElementById('printerPrice').value = printer.price;
    document.getElementById('printerLifespan').value = printer.lifespan;
    document.getElementById('printerQuickAdd').value = '';
    document.getElementById('printerErr').textContent = '';
    
    // Reset to global save handler
    document.getElementById('savePrinter').onclick = saveGlobalPrinter;
    
    showModal(printerModal);
  }

  document.getElementById('closePrinter').onclick = () => {
    editingPrinterId = null;
    editingUserPrinterId = null;
    hideModal(printerModal);
  };

  // Initial setup of save button (will be overridden when modals open)
  document.getElementById('savePrinter').onclick = saveGlobalPrinter;

  function deletePrinter(id) {
    const printer = Object.values(printersData).find(p => p.id === id);
    if (!printer) return;
    
    showConfirm(`Delete "${printer.brand} ${printer.name}"? This action cannot be undone.`, '', 'Delete Printer?', 'Delete').then((confirmed) => {
      if (confirmed) {
        console.log('Deleting printer:', id);
        printersRef.child(id).remove()
          .then(() => {
            console.log('Printer deleted successfully');
            showNotification(`"${printer.brand} ${printer.name}" has been deleted.`, '', 'Deleted');
          })
          .catch(error => {
            console.error('Error deleting printer:', error);
            showNotification('Error deleting printer: ' + error.message, '', 'Error');
          });
      }
    });
  }

  /* Filaments - Load from Firebase */
  function loadFilaments() {
    filamentsRef.on('value', snapshot => {
      filamentsData = {};
      const data = snapshot.val();
      
      if (!data) {
        renderFilamentSelect();
        renderFilamentsList();
        updatePriceInfo();
        calculateCost();
        return;
      }
      
      Object.entries(data).forEach(([key, value]) => {
        const type = value.type;
        const spoolWeight = Number(value.spoolWeight || 1000);
        const spoolCost = Number(value.spoolCost || 0);
        const costPerG = spoolCost / spoolWeight;
        
        filamentsData[type] = {
          id: key,
          type: type,
          brand: value.brand,
          spoolWeight: spoolWeight,
          spoolCost: spoolCost,
          costPerG: costPerG
        };
      });
      
      const container = document.getElementById('filamentsListContainer');
      if (container) container.style.display = 'none';
      
      renderFilamentSelect();
      renderFilamentsList();
      updatePriceInfo();
      calculateCost();
      
      // Apply filter after rendering
      setTimeout(() => filterFilaments(), 100);
    });
  }

  function renderFilamentSelect() {
    const select = document.getElementById('filamentSelect');
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">Choose filament...</option>';
    
    // Add user filaments first if logged in - grouped by brand
    if (auth.currentUser && Object.keys(userFilamentsData).length > 0) {
      // Group user filaments by brand
      const userBrandGroups = {};
      Object.entries(userFilamentsData).forEach(([id, filament]) => {
        const brand = filament.brand || 'Unknown Brand';
        if (!userBrandGroups[brand]) {
          userBrandGroups[brand] = [];
        }
        userBrandGroups[brand].push({ id, ...filament });
      });
      
      // Sort brands alphabetically
      const sortedUserBrands = Object.keys(userBrandGroups).sort();
      
      sortedUserBrands.forEach(brand => {
        const brandGroup = document.createElement('optgroup');
        brandGroup.label = `Your Library - ${brand}`;
        
        // Sort filaments within brand alphabetically
        userBrandGroups[brand].sort((a, b) => a.type.localeCompare(b.type)).forEach(filament => {
          const option = document.createElement('option');
          option.value = `user:${filament.id}`;
          option.textContent = filament.type;
          brandGroup.appendChild(option);
        });
        
        select.appendChild(brandGroup);
      });
    }
    
    // Add global filaments second - grouped by brand
    if (Object.keys(filamentsData).length > 0) {
      // Group global filaments by brand
      const globalBrandGroups = {};
      Object.entries(filamentsData).forEach(([type, filament]) => {
        const brand = filament.brand || 'Unknown Brand';
        if (!globalBrandGroups[brand]) {
          globalBrandGroups[brand] = [];
        }
        globalBrandGroups[brand].push({ type, ...filament });
      });
      
      // Sort brands alphabetically
      const sortedGlobalBrands = Object.keys(globalBrandGroups).sort();
      
      sortedGlobalBrands.forEach(brand => {
        const brandGroup = document.createElement('optgroup');
        brandGroup.label = `Global Library - ${brand}`;
        
        // Sort filaments within brand alphabetically
        globalBrandGroups[brand].sort((a, b) => a.type.localeCompare(b.type)).forEach(filament => {
          const option = document.createElement('option');
          option.value = `global:${filament.type}`;
          option.textContent = filament.type;
          brandGroup.appendChild(option);
        });
        
        select.appendChild(brandGroup);
      });
    }
    
    // Restore previous selection
    if (currentValue) {
      select.value = currentValue;
    }
    
    updatePriceInfo();
    const totalOptions = Object.keys(filamentsData).length + Object.keys(userFilamentsData).length;
    console.log('Filament select updated with', totalOptions, 'options (', Object.keys(filamentsData).length, 'global,', Object.keys(userFilamentsData).length, 'user)');
  }
  
  // Helper function to populate filament dropdown (called from user preset functions)
  function populateFilamentDropdown() {
    renderFilamentSelect();
  }

  // User Presets Functions
  let userPrintersData = {};
  let userFilamentsData = {};
  let editingUserPrinterId = null;
  let editingUserFilamentId = null;
  
  function renderUserPrintersList(snapshot) {
    const list = document.getElementById('userPrintersList');
    const container = document.getElementById('userPrintersListContainer');
    const toggleBtn = document.getElementById('btnToggleUserPrinterMassDelete');
    
    if (!list || !container) return;
    
    const user = auth.currentUser;
    
    // If no user, show message to log in
    if (!user) {
      container.style.display = 'none';
      list.style.display = 'block';
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Login to Add Your Printers</p>
          <p style="font-size: 14px; color: var(--text-muted); max-width: 400px; margin: 0 auto;">
            Create and manage your personal printer library, separate from the global presets.
          </p>
        </div>
      `;
      return;
    }
    
    // Get user printers data
    if (snapshot) {
      userPrintersData = {};
      snapshot.forEach(child => {
        const printer = child.val();
        printer.id = child.key;
        printer.costPerHour = printer.price / printer.lifespan;
        userPrintersData[child.key] = printer;
      });
    }
    
    container.style.display = 'none';
    list.style.display = 'block';
    list.innerHTML = '';
    
    const printerCount = Object.keys(userPrintersData).length;
    
    // Show/hide mass delete toggle button
    if (printerCount > 0) {
      toggleBtn.style.display = 'inline-block';
    } else {
      toggleBtn.style.display = 'none';
    }
    
    if (printerCount === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <p style="font-size: 16px; margin-bottom: 8px;">No personal printers yet</p>
          <p style="margin-top: 8px; font-size: 14px;">Click "Add Printer" above to create your first personal printer preset.</p>
        </div>
      `;
      document.getElementById('userPrinterFilterStats').textContent = 'No printers available';
      
      // Clear brand filters
      const brandFiltersContainer = document.getElementById('userPrinterBrandFilters');
      if (brandFiltersContainer) {
        brandFiltersContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No printers to filter</div>';
      }
      return;
    }
    
    const countHeader = document.createElement('div');
    countHeader.style.cssText = 'font-size: 14px; color: var(--text-muted); margin-bottom: 24px; font-weight: 600;';
    countHeader.textContent = `Total: ${printerCount} printer${printerCount !== 1 ? 's' : ''}`;
    list.appendChild(countHeader);
    
    // Group printers by brand
    const printersByBrand = {};
    Object.entries(userPrintersData).forEach(([id, printer]) => {
      if (!printersByBrand[printer.brand]) {
        printersByBrand[printer.brand] = [];
      }
      printersByBrand[printer.brand].push(printer);
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(printersByBrand).sort((a, b) => a.localeCompare(b));
    
    // Render each brand category
    sortedBrands.forEach(brand => {
      const printers = printersByBrand[brand].sort((a, b) => a.name.localeCompare(b.name));
      
      const brandCategory = document.createElement('div');
      brandCategory.className = 'brand-category';
      
      const brandHeader = document.createElement('div');
      brandHeader.className = 'brand-header';
      brandHeader.innerHTML = `
        <div class="brand-title">${brand}</div>
        <div class="brand-count">${printers.length} printer${printers.length !== 1 ? 's' : ''}</div>
      `;
      
      const brandItems = document.createElement('div');
      brandItems.className = 'brand-items';
      
      printers.forEach(printer => {
        const item = document.createElement('div');
        item.className = 'list-item';
        
        // Convert price from USD storage to current display currency
        const priceInUSD = printer.price;
        const convertedPrice = convertCurrency(priceInUSD);
        const convertedCostPerHour = convertedPrice / printer.lifespan;
        
        // Format money in the current currency
        const symbol = currencySymbols[currentCurrency] || currentCurrency + ' ';
        const decimals = ['JPY', 'KRW', 'IDR', 'CLP'].includes(currentCurrency) ? 0 : 2;
        const formattedPrice = `${symbol}${convertedPrice.toFixed(decimals)}`;
        const formattedCostPerHour = `${symbol}${convertedCostPerHour.toFixed(decimals)}`;
        
        const currencyNote = '';
        
        item.innerHTML = `
          <input type="checkbox" class="item-checkbox user-printer-checkbox" data-printer-id="${printer.id}" onchange="updateUserPrinterSelection()">
          <div class="item-info">
            <div class="item-name">${printer.name}</div>
            <div class="item-details">
              <div class="detail-badge">
                <span class="detail-label">Price${currencyNote}</span>
                <span class="detail-value">${formattedPrice}</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Lifespan</span>
                <span class="detail-value">${printer.lifespan.toLocaleString()} hrs</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Depreciation</span>
                <span class="detail-value">${formattedCostPerHour}/hr</span>
              </div>
            </div>
          </div>
          <div class="btn-actions">
            <button class="btn btn-edit btn-small" onclick="editUserPrinter('${printer.id}')">Edit</button>
            <button class="btn btn-delete btn-small" onclick="deleteUserPrinter('${printer.id}')">Delete</button>
          </div>
        `;
        brandItems.appendChild(item);
      });
      
      brandCategory.appendChild(brandHeader);
      brandCategory.appendChild(brandItems);
      list.appendChild(brandCategory);
    });
    
    // Populate brand filters
    populateUserPrinterBrandFilters();
    
    // Update calculator dropdowns
    populatePrinterDropdown();
  }

  function populateUserPrinterBrandFilters() {
    const container = document.getElementById('userPrinterBrandFilters');
    if (!container) return;
    
    if (Object.keys(userPrintersData).length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No printers to filter</div>';
      return;
    }
    
    // Get unique brands with counts
    const brandCounts = {};
    Object.values(userPrintersData).forEach(printer => {
      const brand = printer.brand || 'Unknown';
      brandCounts[brand] = (brandCounts[brand] || 0) + 1;
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(brandCounts).sort();
    
    // Create checkbox for each brand
    container.innerHTML = '';
    sortedBrands.forEach(brand => {
      const item = document.createElement('label');
      item.className = 'brand-checkbox-item';
      item.innerHTML = `
        <input type="checkbox" value="${brand}" onchange="filterUserPrinters()">
        <span class="brand-checkbox-label">${brand}</span>
        <span class="brand-checkbox-count">${brandCounts[brand]}</span>
      `;
      
      const checkbox = item.querySelector('input');
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          item.classList.add('checked');
        } else {
          item.classList.remove('checked');
        }
      });
      
      container.appendChild(item);
    });
  }

  function filterUserPrinters() {
    const checkboxes = document.querySelectorAll('#userPrinterBrandFilters input[type="checkbox"]');
    const selectedBrands = new Set();
    
    checkboxes.forEach(cb => {
      if (cb.checked) {
        selectedBrands.add(cb.value);
      }
    });
    
    const categories = document.querySelectorAll('#userPrintersList .brand-category');
    let visibleCount = 0;
    let totalCount = 0;
    
    categories.forEach(category => {
      const brandTitle = category.querySelector('.brand-title').textContent;
      const items = category.querySelectorAll('.list-item');
      totalCount += items.length;
      
      if (selectedBrands.size === 0 || selectedBrands.has(brandTitle)) {
        category.style.display = 'block';
        visibleCount += items.length;
      } else {
        category.style.display = 'none';
      }
    });
    
    // Update stats
    const stats = document.getElementById('userPrinterFilterStats');
    const noResults = document.getElementById('userPrintersNoResults');
    const list = document.getElementById('userPrintersList');
    
    if (visibleCount === 0 && totalCount > 0) {
      noResults.style.display = 'block';
      list.style.display = 'none';
      stats.textContent = `No printers match selected brands (0 of ${totalCount})`;
    } else {
      noResults.style.display = 'none';
      list.style.display = 'block';
      if (selectedBrands.size === 0) {
        stats.textContent = `Showing all ${totalCount} printers`;
      } else {
        stats.textContent = `Showing ${visibleCount} of ${totalCount} printers`;
      }
    }
  }

  function renderUserFilamentsList(snapshot) {
    const list = document.getElementById('userFilamentsList');
    const container = document.getElementById('userFilamentsListContainer');
    const toggleBtn = document.getElementById('btnToggleUserFilamentMassDelete');
    
    if (!list || !container) return;
    
    const user = auth.currentUser;
    
    // If no user, show message to log in
    if (!user) {
      container.style.display = 'none';
      list.style.display = 'block';
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Login to Add Your Filaments</p>
          <p style="font-size: 14px; color: var(--text-muted); max-width: 400px; margin: 0 auto;">
            Create and manage your personal filament library, separate from the global presets.
          </p>
        </div>
      `;
      return;
    }
    
    // Get user filaments data
    if (snapshot) {
      userFilamentsData = {};
      snapshot.forEach(child => {
        const filament = child.val();
        filament.id = child.key;
        filament.costPerG = filament.spoolCost / filament.spoolWeight;
        userFilamentsData[child.key] = filament;
      });
    }
    
    container.style.display = 'none';
    list.style.display = 'block';
    list.innerHTML = '';
    
    const filamentCount = Object.keys(userFilamentsData).length;
    
    // Show/hide mass delete toggle button
    if (filamentCount > 0) {
      toggleBtn.style.display = 'inline-block';
    } else {
      toggleBtn.style.display = 'none';
    }
    
    if (filamentCount === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <p style="font-size: 16px; margin-bottom: 8px;">No personal filaments yet</p>
          <p style="margin-top: 8px; font-size: 14px;">Click "Add Filament" above to create your first personal filament preset.</p>
        </div>
      `;
      document.getElementById('userFilamentFilterStats').textContent = 'No filaments available';
      
      // Clear brand filters
      const brandFiltersContainer = document.getElementById('userFilamentBrandFilters');
      if (brandFiltersContainer) {
        brandFiltersContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No filaments to filter</div>';
      }
      return;
    }
    
    const countHeader = document.createElement('div');
    countHeader.style.cssText = 'font-size: 14px; color: var(--text-muted); margin-bottom: 24px; font-weight: 600;';
    countHeader.textContent = `Total: ${filamentCount} filament${filamentCount !== 1 ? 's' : ''}`;
    list.appendChild(countHeader);
    
    // Group filaments by brand
    const filamentsByBrand = {};
    Object.entries(userFilamentsData).forEach(([id, filament]) => {
      if (!filamentsByBrand[filament.brand]) {
        filamentsByBrand[filament.brand] = [];
      }
      filamentsByBrand[filament.brand].push(filament);
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(filamentsByBrand).sort((a, b) => a.localeCompare(b));
    
    // Render each brand category
    sortedBrands.forEach(brand => {
      const filaments = filamentsByBrand[brand].sort((a, b) => a.type.localeCompare(b.type));
      
      const brandCategory = document.createElement('div');
      brandCategory.className = 'brand-category';
      
      const brandHeader = document.createElement('div');
      brandHeader.className = 'brand-header';
      brandHeader.innerHTML = `
        <div class="brand-title">${brand}</div>
        <div class="brand-count">${filaments.length} filament${filaments.length !== 1 ? 's' : ''}</div>
      `;
      
      const brandItems = document.createElement('div');
      brandItems.className = 'brand-items';
      
      filaments.forEach(filament => {
        const item = document.createElement('div');
        item.className = 'list-item';
        
        // Convert price from USD storage to current display currency
        const spoolCostInUSD = filament.spoolCost;
        const convertedSpoolCost = convertCurrency(spoolCostInUSD);
        const convertedCostPerG = convertedSpoolCost / filament.spoolWeight;
        const perKg = convertedCostPerG * 1000;
        const perG = convertedCostPerG;
        
        // Format money in the current currency
        const symbol = currencySymbols[currentCurrency] || currentCurrency + ' ';
        const decimals = ['JPY', 'KRW', 'IDR', 'CLP'].includes(currentCurrency) ? 0 : 2;
        const formattedSpoolCost = `${symbol}${convertedSpoolCost.toFixed(decimals)}`;
        const formattedPerKg = `${symbol}${perKg.toFixed(decimals)}`;
        const formattedPerG = `${symbol}${perG.toFixed(decimals + 1)}`;
        
        const currencyNote = '';
        
        item.innerHTML = `
          <input type="checkbox" class="item-checkbox user-filament-checkbox" data-filament-id="${filament.id}" onchange="updateUserFilamentSelection()">
          <div class="item-info">
            <div class="item-name">${filament.type}</div>
            <div class="item-details">
              <div class="detail-badge">
                <span class="detail-label">Spool Cost${currencyNote}</span>
                <span class="detail-value">${formattedSpoolCost} (${filament.spoolWeight}g)</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Per Kilogram</span>
                <span class="detail-value">${formattedPerKg}</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Per Gram</span>
                <span class="detail-value">${formattedPerG}</span>
              </div>
            </div>
          </div>
          <div class="btn-actions">
            <button class="btn btn-edit btn-small" onclick="editUserFilament('${filament.id}')">Edit</button>
            <button class="btn btn-delete btn-small" onclick="deleteUserFilament('${filament.id}')">Delete</button>
          </div>
        `;
        brandItems.appendChild(item);
      });
      
      brandCategory.appendChild(brandHeader);
      brandCategory.appendChild(brandItems);
      list.appendChild(brandCategory);
    });
    
    // Populate brand filters
    populateUserFilamentBrandFilters();
    
    // Update calculator dropdowns
    populateFilamentDropdown();
  }

  function populateUserFilamentBrandFilters() {
    const container = document.getElementById('userFilamentBrandFilters');
    if (!container) return;
    
    if (Object.keys(userFilamentsData).length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No filaments to filter</div>';
      return;
    }
    
    // Get unique brands with counts
    const brandCounts = {};
    Object.values(userFilamentsData).forEach(filament => {
      const brand = filament.brand || 'Unknown';
      brandCounts[brand] = (brandCounts[brand] || 0) + 1;
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(brandCounts).sort();
    
    // Create checkbox for each brand
    container.innerHTML = '';
    sortedBrands.forEach(brand => {
      const item = document.createElement('label');
      item.className = 'brand-checkbox-item';
      item.innerHTML = `
        <input type="checkbox" value="${brand}" onchange="filterUserFilaments()">
        <span class="brand-checkbox-label">${brand}</span>
        <span class="brand-checkbox-count">${brandCounts[brand]}</span>
      `;
      
      const checkbox = item.querySelector('input');
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          item.classList.add('checked');
        } else {
          item.classList.remove('checked');
        }
      });
      
      container.appendChild(item);
    });
  }

  function filterUserFilaments() {
    const checkboxes = document.querySelectorAll('#userFilamentBrandFilters input[type="checkbox"]');
    const selectedBrands = new Set();
    
    checkboxes.forEach(cb => {
      if (cb.checked) {
        selectedBrands.add(cb.value);
      }
    });
    
    const categories = document.querySelectorAll('#userFilamentsList .brand-category');
    let visibleCount = 0;
    let totalCount = 0;
    
    categories.forEach(category => {
      const brandTitle = category.querySelector('.brand-title').textContent;
      const items = category.querySelectorAll('.list-item');
      totalCount += items.length;
      
      if (selectedBrands.size === 0 || selectedBrands.has(brandTitle)) {
        category.style.display = 'block';
        visibleCount += items.length;
      } else {
        category.style.display = 'none';
      }
    });
    
    // Update stats
    const stats = document.getElementById('userFilamentFilterStats');
    const noResults = document.getElementById('userFilamentsNoResults');
    const list = document.getElementById('userFilamentsList');
    
    if (visibleCount === 0 && totalCount > 0) {
      noResults.style.display = 'block';
      list.style.display = 'none';
      stats.textContent = `No filaments match selected brands (0 of ${totalCount})`;
    } else {
      noResults.style.display = 'none';
      list.style.display = 'block';
      if (selectedBrands.size === 0) {
        stats.textContent = `Showing all ${totalCount} filaments`;
      } else {
        stats.textContent = `Showing ${visibleCount} of ${totalCount} filaments`;
      }
    }
  }

  function renderFilamentsList() {
    const list = document.getElementById('filamentsList');
    const toggleBtn = document.getElementById('btnToggleFilamentMassDelete');
    if (!list) return;
    
    console.log('Rendering filaments list. isAdmin:', isAdmin);
    
    list.innerHTML = '';
    
    const filamentCount = Object.keys(filamentsData).length;
    
    // Show/hide mass delete toggle button based on admin status and filament count
    if (isAdmin && filamentCount > 0) {
      toggleBtn.style.display = 'block';
    } else {
      toggleBtn.style.display = 'none';
    }
    
    if (filamentCount === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <p style="font-size: 16px; margin-bottom: 8px;">No filaments in the library yet.</p>
          ${isAdmin ? '<p style="margin-top: 8px; font-size: 14px;">Click "Add Filament" above to add your first filament.</p>' : '<p style="margin-top: 8px; font-size: 14px;">Login as admin to add filaments.</p>'}
        </div>
      `;
      document.getElementById('filamentFilterStats').textContent = 'No filaments available';
      return;
    }

    const countHeader = document.createElement('div');
    countHeader.style.cssText = 'font-size: 14px; color: var(--text-muted); margin-bottom: 24px; font-weight: 600;';
    countHeader.textContent = `Total: ${filamentCount} filament${filamentCount !== 1 ? 's' : ''}`;
    list.appendChild(countHeader);
    
    // Group filaments by brand
    const filamentsByBrand = {};
    Object.entries(filamentsData).forEach(([type, filament]) => {
      if (!filamentsByBrand[filament.brand]) {
        filamentsByBrand[filament.brand] = [];
      }
      filamentsByBrand[filament.brand].push(filament);
    });
    
    // Sort brands alphabetically
    const sortedBrands = Object.keys(filamentsByBrand).sort((a, b) => a.localeCompare(b));
    
    // Render each brand category
    sortedBrands.forEach(brand => {
      const filaments = filamentsByBrand[brand].sort((a, b) => a.type.localeCompare(b.type));
      
      const brandCategory = document.createElement('div');
      brandCategory.className = 'brand-category';
      
      const brandHeader = document.createElement('div');
      brandHeader.className = 'brand-header';
      brandHeader.innerHTML = `
        <div class="brand-title">${brand}</div>
        <div class="brand-count">${filaments.length} filament${filaments.length !== 1 ? 's' : ''}</div>
      `;
      
      const brandItems = document.createElement('div');
      brandItems.className = 'brand-items';
      
      filaments.forEach(filament => {
        const item = document.createElement('div');
        item.className = isAdmin ? 'list-item with-checkbox' : 'list-item';
        const perKg = filament.costPerG * 1000;
        const perG = filament.costPerG;
        
        item.innerHTML = `
          ${isAdmin ? `<input type="checkbox" class="item-checkbox filament-checkbox" data-filament-id="${filament.id}" onchange="updateFilamentSelection()">` : ''}
          <div class="item-info">
            <div class="item-name">${filament.type}</div>
            <div class="item-details">
              <div class="detail-badge">
                <span class="detail-label">Spool Cost</span>
                <span class="detail-value">${formatMoney(filament.spoolCost)} (${filament.spoolWeight}g)</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Per Kilogram</span>
                <span class="detail-value">${formatMoney(perKg)}</span>
              </div>
              <div class="detail-badge">
                <span class="detail-label">Per Gram</span>
                <span class="detail-value">${formatMoney(perG)}</span>
              </div>
            </div>
          </div>
          ${isAdmin ? `
            <div class="btn-actions">
              <button class="btn btn-edit btn-small" onclick="editFilament('${filament.id}')">Edit</button>
              <button class="btn btn-delete btn-small" onclick="deleteFilament('${filament.id}')">Delete</button>
            </div>
          ` : ''}
        `;
        brandItems.appendChild(item);
      });
      
      brandCategory.appendChild(brandHeader);
      brandCategory.appendChild(brandItems);
      list.appendChild(brandCategory);
    });

    // Reset mass delete mode when re-rendering
    if (isAdmin) {
      exitFilamentMassDeleteMode();
    }
    
    // Populate brand filters
    populateFilamentBrandFilters();
  }

  document.getElementById('btnAddFilament').onclick = () => {
    editingFilamentId = null;
    document.getElementById('filamentModalTitle').textContent = 'Add Filament';
    document.getElementById('filamentType').value = '';
    document.getElementById('filamentType').readOnly = false;
    document.getElementById('filamentBrand').value = '';
    document.getElementById('filamentBrand').readOnly = false;
    document.getElementById('filamentSpoolWeight').value = '1000';
    document.getElementById('filamentCostSpool').value = '';
    document.getElementById('filamentQuickAdd').value = '';
    document.getElementById('filamentErr').textContent = '';
    
    // Reset to global save handler
    document.getElementById('saveFilament').onclick = saveGlobalFilament;
    
    showModal(filamentModal);
  };
  
  // Global filament save function
  function saveGlobalFilament() {
    const type = document.getElementById('filamentType').value.trim();
    const brand = document.getElementById('filamentBrand').value.trim();
    const spoolWeight = parseInt(document.getElementById('filamentSpoolWeight').value);
    const spoolCost = parseFloat(document.getElementById('filamentCostSpool').value);
    
    if (!type || !brand || !spoolWeight || spoolWeight < 1 || !spoolCost || spoolCost < 0) {
      document.getElementById('filamentErr').textContent = 'Please fill all fields correctly.';
      return;
    }
    
    if (editingFilamentId) {
      // Update existing filament
      filamentsRef.child(editingFilamentId).update({ type, brand, spoolWeight, spoolCost })
        .then(() => {
          editingFilamentId = null;
          hideModal(filamentModal);
          document.getElementById('filamentErr').textContent = '';
        })
        .catch((error) => {
          document.getElementById('filamentErr').textContent = 'Error updating filament: ' + error.message;
        });
    } else {
      // Add new filament
      filamentsRef.push({ type, brand, spoolWeight, spoolCost })
        .then(() => {
          hideModal(filamentModal);
          document.getElementById('filamentErr').textContent = '';
        })
        .catch((error) => {
          document.getElementById('filamentErr').textContent = 'Error saving filament: ' + error.message;
        });
    }
  }

  // Quick Add Parser for Filaments - BATCH SAVE
  document.getElementById('btnParseFilamentQuickAdd').onclick = () => {
    const input = document.getElementById('filamentQuickAdd').value.trim();
    
    if (!input) {
      document.getElementById('filamentErr').textContent = 'Please enter filament data in array format.';
      return;
    }
    
    try {
      // Split by semicolon to handle multiple entries
      const entries = input.split(';').map(e => e.trim()).filter(e => e.length > 0);
      
      if (entries.length === 0) {
        throw new Error('No valid entries found');
      }
      
      console.log(`Found ${entries.length} filament entries to add`);
      
      const filamentsToAdd = [];
      
      // Parse and validate each entry
      entries.forEach((entry, index) => {
        const data = JSON.parse(entry);
        
        // Validate array structure
        if (!Array.isArray(data) || data.length !== 4) {
          throw new Error(`Entry ${index + 1}: Array must have exactly 4 elements: [Type, Brand, Weight, Cost]`);
        }
        
        const [type, brand, weight, cost] = data;
        
        // Validate data types
        if (typeof type !== 'string' || !type.trim()) {
          throw new Error(`Entry ${index + 1}: Type must be a non-empty string`);
        }
        if (typeof brand !== 'string' || !brand.trim()) {
          throw new Error(`Entry ${index + 1}: Brand must be a non-empty string`);
        }
        if (typeof weight !== 'number' || weight <= 0) {
          throw new Error(`Entry ${index + 1}: Weight must be a positive number`);
        }
        if (typeof cost !== 'number' || cost <= 0) {
          throw new Error(`Entry ${index + 1}: Cost must be a positive number`);
        }
        
        filamentsToAdd.push({
          type: type.trim(),
          brand: brand.trim(),
          spoolWeight: weight,
          spoolCost: cost
        });
      });
      
      // Show processing message
      document.getElementById('filamentErr').style.color = '#c084fc';
      document.getElementById('filamentErr').textContent = `Adding ${filamentsToAdd.length} filament${filamentsToAdd.length > 1 ? 's' : ''}...`;
      
      // Add all filaments to Firebase
      let addedCount = 0;
      const addPromises = filamentsToAdd.map(filament => {
        return filamentsRef.push(filament).then(() => {
          addedCount++;
          console.log(`Added filament ${addedCount}/${filamentsToAdd.length}:`, filament.type);
        });
      });
      
      // Wait for all adds to complete
      Promise.all(addPromises)
        .then(() => {
          // Clear the input
          document.getElementById('filamentQuickAdd').value = '';
          
          // Show success message
          document.getElementById('filamentErr').style.color = '#10b981';
          document.getElementById('filamentErr').textContent = `Successfully added ${addedCount} filament${addedCount > 1 ? 's' : ''}!`;
          
          setTimeout(() => {
            document.getElementById('filamentErr').style.color = '#ff7b7b';
            document.getElementById('filamentErr').textContent = '';
          }, 3000);
        })
        .catch(error => {
          document.getElementById('filamentErr').style.color = '#ff7b7b';
          document.getElementById('filamentErr').textContent = 'Error saving filaments: ' + error.message;
          console.error('Error saving filaments:', error);
        });
      
    } catch (error) {
      document.getElementById('filamentErr').textContent = 'Parse error: ' + error.message;
      console.error('Parse error:', error);
    }
  };

  function editFilament(id) {
    editingFilamentId = id;
    const filament = Object.values(filamentsData).find(f => f.id === id);
    if (!filament) return;
    
    document.getElementById('filamentModalTitle').textContent = 'Edit Filament';
    document.getElementById('filamentType').value = filament.type;
    document.getElementById('filamentType').readOnly = false;
    document.getElementById('filamentBrand').value = filament.brand;
    document.getElementById('filamentBrand').readOnly = false;
    document.getElementById('filamentSpoolWeight').value = filament.spoolWeight;
    document.getElementById('filamentCostSpool').value = filament.spoolCost;
    document.getElementById('filamentQuickAdd').value = '';
    document.getElementById('filamentErr').textContent = '';
    
    // Reset to global save handler
    document.getElementById('saveFilament').onclick = saveGlobalFilament;
    
    showModal(filamentModal);
  }

  document.getElementById('closeFilament').onclick = () => {
    editingFilamentId = null;
    editingUserFilamentId = null;
    hideModal(filamentModal);
  };

  // Initial setup of save button (will be overridden when modals open)
  document.getElementById('saveFilament').onclick = saveGlobalFilament;

  function deleteFilament(id) {
    const filament = Object.values(filamentsData).find(f => f.id === id);
    if (!filament) return;
    
    showConfirm(`Delete "${filament.type} - ${filament.brand}"? This action cannot be undone.`, '', 'Delete Filament?', 'Delete').then((confirmed) => {
      if (confirmed) {
        filamentsRef.child(id).remove()
          .then(() => {
            showNotification(`"${filament.type} - ${filament.brand}" has been deleted.`, '', 'Deleted');
          })
          .catch(error => {
            showNotification('Error deleting filament: ' + error.message, '', 'Error');
          });
      }
    });
  }

  /* Mass Delete Functions for Printers */
  function enterPrinterMassDeleteMode() {
    document.getElementById('printersList').classList.add('mass-delete-mode');
    document.getElementById('printerMassDeleteControls').classList.add('active');
    document.getElementById('btnTogglePrinterMassDelete').classList.add('active');
    document.getElementById('selectAllPrinters').checked = false;
    updatePrinterSelection();
  }

  function exitPrinterMassDeleteMode() {
    document.getElementById('printersList').classList.remove('mass-delete-mode');
    document.getElementById('printerMassDeleteControls').classList.remove('active');
    document.getElementById('btnTogglePrinterMassDelete').classList.remove('active');
    document.getElementById('selectAllPrinters').checked = false;
    // Uncheck all checkboxes
    document.querySelectorAll('.printer-checkbox').forEach(cb => cb.checked = false);
    updatePrinterSelection();
  }

  // Toggle mass delete mode button
  document.getElementById('btnTogglePrinterMassDelete').addEventListener('click', function() {
    if (this.classList.contains('active')) {
      exitPrinterMassDeleteMode();
    } else {
      enterPrinterMassDeleteMode();
    }
  });

  // Cancel button
  document.getElementById('btnCancelPrinterMassDelete').addEventListener('click', function() {
    exitPrinterMassDeleteMode();
  });

  function updatePrinterSelection() {
    const checkboxes = document.querySelectorAll('.printer-checkbox');
    const selectAll = document.getElementById('selectAllPrinters');
    const deleteBtn = document.getElementById('btnDeleteSelectedPrinters');
    const countDisplay = document.getElementById('printerSelectedCount');
    
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const totalCount = checkboxes.length;
    
    // Update select all checkbox
    if (checkedCount === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (checkedCount === totalCount) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
    
    // Update count display
    countDisplay.textContent = `${checkedCount} selected`;
    
    // Enable/disable delete button
    if (checkedCount > 0) {
      deleteBtn.classList.add('enabled');
    } else {
      deleteBtn.classList.remove('enabled');
    }
  }

  // Select all printers
  document.getElementById('selectAllPrinters').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.printer-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updatePrinterSelection();
  });

  // Mass delete printers
  document.getElementById('btnDeleteSelectedPrinters').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.printer-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.printerId);
    
    if (selectedIds.length === 0) return;
    
    const printerNames = selectedIds.map(id => {
      const printer = Object.values(printersData).find(p => p.id === id);
      return printer ? `${printer.brand} ${printer.name}` : 'Unknown';
    });
    
    const message = selectedIds.length === 1 
      ? `Delete "${printerNames[0]}"? This action cannot be undone.`
      : `Delete ${selectedIds.length} printers? This action cannot be undone.\n\nSelected printers:\n• ${printerNames.join('\n• ')}`;
    
    showConfirm(message, '', 'Delete Printers?', 'Delete').then((confirmed) => {
      if (confirmed) {
        let deletedCount = 0;
        const deletePromises = selectedIds.map(id => 
          printersRef.child(id).remove().then(() => {
            deletedCount++;
            console.log(`Deleted printer ${deletedCount}/${selectedIds.length}`);
          })
        );
        
        Promise.all(deletePromises)
          .then(() => {
            showNotification(`Successfully deleted ${deletedCount} printer${deletedCount > 1 ? 's' : ''}!`, '', 'Success');
            exitPrinterMassDeleteMode();
          })
          .catch(error => {
            showNotification('Error deleting printers: ' + error.message, '', 'Error');
          });
      }
    });
  });

  /* Mass Delete Functions for Filaments */
  function enterFilamentMassDeleteMode() {
    document.getElementById('filamentsList').classList.add('mass-delete-mode');
    document.getElementById('filamentMassDeleteControls').classList.add('active');
    document.getElementById('btnToggleFilamentMassDelete').classList.add('active');
    document.getElementById('selectAllFilaments').checked = false;
    updateFilamentSelection();
  }

  function exitFilamentMassDeleteMode() {
    document.getElementById('filamentsList').classList.remove('mass-delete-mode');
    document.getElementById('filamentMassDeleteControls').classList.remove('active');
    document.getElementById('btnToggleFilamentMassDelete').classList.remove('active');
    document.getElementById('selectAllFilaments').checked = false;
    // Uncheck all checkboxes
    document.querySelectorAll('.filament-checkbox').forEach(cb => cb.checked = false);
    updateFilamentSelection();
  }

  // Toggle mass delete mode button
  document.getElementById('btnToggleFilamentMassDelete').addEventListener('click', function() {
    if (this.classList.contains('active')) {
      exitFilamentMassDeleteMode();
    } else {
      enterFilamentMassDeleteMode();
    }
  });

  // Cancel button
  document.getElementById('btnCancelFilamentMassDelete').addEventListener('click', function() {
    exitFilamentMassDeleteMode();
  });

  function updateFilamentSelection() {
    const checkboxes = document.querySelectorAll('.filament-checkbox');
    const selectAll = document.getElementById('selectAllFilaments');
    const deleteBtn = document.getElementById('btnDeleteSelectedFilaments');
    const countDisplay = document.getElementById('filamentSelectedCount');
    
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const totalCount = checkboxes.length;
    
    // Update select all checkbox
    if (checkedCount === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (checkedCount === totalCount) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
    
    // Update count display
    countDisplay.textContent = `${checkedCount} selected`;
    
    // Enable/disable delete button
    if (checkedCount > 0) {
      deleteBtn.classList.add('enabled');
    } else {
      deleteBtn.classList.remove('enabled');
    }
  }

  // Select all filaments
  document.getElementById('selectAllFilaments').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.filament-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateFilamentSelection();
  });

  // Mass delete filaments
  document.getElementById('btnDeleteSelectedFilaments').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.filament-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.filamentId);
    
    if (selectedIds.length === 0) return;
    
    const filamentNames = selectedIds.map(id => {
      const filament = Object.values(filamentsData).find(f => f.id === id);
      return filament ? `${filament.type} - ${filament.brand}` : 'Unknown';
    });
    
    const message = selectedIds.length === 1 
      ? `Delete "${filamentNames[0]}"? This action cannot be undone.`
      : `Delete ${selectedIds.length} filaments? This action cannot be undone.\n\nSelected filaments:\n• ${filamentNames.join('\n• ')}`;
    
    showConfirm(message, '', 'Delete Filaments?', 'Delete').then((confirmed) => {
      if (confirmed) {
        let deletedCount = 0;
        const deletePromises = selectedIds.map(id => 
          filamentsRef.child(id).remove().then(() => {
            deletedCount++;
            console.log(`Deleted filament ${deletedCount}/${selectedIds.length}`);
          })
        );
        
        Promise.all(deletePromises)
          .then(() => {
            showNotification(`Successfully deleted ${deletedCount} filament${deletedCount > 1 ? 's' : ''}!`, '', 'Success');
            exitFilamentMassDeleteMode();
          })
          .catch(error => {
            showNotification('Error deleting filaments: ' + error.message, '', 'Error');
          });
      }
    });
  });

  /* User Presets Mass Delete functionality */
  function enterUserPrinterMassDeleteMode() {
    document.getElementById('userPrintersList').classList.add('mass-delete-mode');
    document.getElementById('userPrinterMassDeleteControls').classList.add('active');
    document.getElementById('btnToggleUserPrinterMassDelete').classList.add('active');
    document.getElementById('selectAllUserPrinters').checked = false;
    updateUserPrinterSelection();
  }

  function exitUserPrinterMassDeleteMode() {
    document.getElementById('userPrintersList').classList.remove('mass-delete-mode');
    document.getElementById('userPrinterMassDeleteControls').classList.remove('active');
    document.getElementById('btnToggleUserPrinterMassDelete').classList.remove('active');
    document.getElementById('selectAllUserPrinters').checked = false;
    document.querySelectorAll('.user-printer-checkbox').forEach(cb => cb.checked = false);
    updateUserPrinterSelection();
  }

  function updateUserPrinterSelection() {
    const checkboxes = document.querySelectorAll('.user-printer-checkbox');
    const selectAll = document.getElementById('selectAllUserPrinters');
    const deleteBtn = document.getElementById('btnDeleteSelectedUserPrinters');
    const countDisplay = document.getElementById('userPrinterSelectedCount');
    
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const totalCount = checkboxes.length;
    
    if (checkedCount === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (checkedCount === totalCount) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
    
    countDisplay.textContent = `${checkedCount} selected`;
    
    if (checkedCount > 0) {
      deleteBtn.classList.add('enabled');
    } else {
      deleteBtn.classList.remove('enabled');
    }
  }

  document.getElementById('btnToggleUserPrinterMassDelete').addEventListener('click', function() {
    if (this.classList.contains('active')) {
      exitUserPrinterMassDeleteMode();
    } else {
      enterUserPrinterMassDeleteMode();
    }
  });

  document.getElementById('btnCancelUserPrinterMassDelete').addEventListener('click', function() {
    exitUserPrinterMassDeleteMode();
  });

  document.getElementById('selectAllUserPrinters').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-printer-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateUserPrinterSelection();
  });

  document.getElementById('btnDeleteSelectedUserPrinters').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.user-printer-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.printerId);
    
    if (selectedIds.length === 0) return;
    
    const printerNames = selectedIds.map(id => {
      const printer = userPrintersData[id];
      return printer ? `${printer.brand} ${printer.name}` : 'Unknown';
    });
    
    const message = selectedIds.length === 1 
      ? `Delete "${printerNames[0]}"? This action cannot be undone.`
      : `Delete ${selectedIds.length} printers? This action cannot be undone.\n\nSelected printers:\n• ${printerNames.join('\n• ')}`;
    
    showConfirm(message, '', 'Delete Printers?', 'Delete').then((confirmed) => {
      if (confirmed) {
        let deletedCount = 0;
        const deletePromises = selectedIds.map(id => 
          userPrintersRef.child(id).remove().then(() => {
            deletedCount++;
          })
        );
        
        Promise.all(deletePromises)
          .then(() => {
            showNotification(`Successfully deleted ${deletedCount} printer${deletedCount > 1 ? 's' : ''}!`, '', 'Success');
            exitUserPrinterMassDeleteMode();
          })
          .catch(error => {
            showNotification('Error deleting printers: ' + error.message, '', 'Error');
          });
      }
    });
  });

  // User Filaments Mass Delete
  function enterUserFilamentMassDeleteMode() {
    document.getElementById('userFilamentsList').classList.add('mass-delete-mode');
    document.getElementById('userFilamentMassDeleteControls').classList.add('active');
    document.getElementById('btnToggleUserFilamentMassDelete').classList.add('active');
    document.getElementById('selectAllUserFilaments').checked = false;
    updateUserFilamentSelection();
  }

  function exitUserFilamentMassDeleteMode() {
    document.getElementById('userFilamentsList').classList.remove('mass-delete-mode');
    document.getElementById('userFilamentMassDeleteControls').classList.remove('active');
    document.getElementById('btnToggleUserFilamentMassDelete').classList.remove('active');
    document.getElementById('selectAllUserFilaments').checked = false;
    document.querySelectorAll('.user-filament-checkbox').forEach(cb => cb.checked = false);
    updateUserFilamentSelection();
  }

  function updateUserFilamentSelection() {
    const checkboxes = document.querySelectorAll('.user-filament-checkbox');
    const selectAll = document.getElementById('selectAllUserFilaments');
    const deleteBtn = document.getElementById('btnDeleteSelectedUserFilaments');
    const countDisplay = document.getElementById('userFilamentSelectedCount');
    
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const totalCount = checkboxes.length;
    
    if (checkedCount === 0) {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    } else if (checkedCount === totalCount) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    }
    
    countDisplay.textContent = `${checkedCount} selected`;
    
    if (checkedCount > 0) {
      deleteBtn.classList.add('enabled');
    } else {
      deleteBtn.classList.remove('enabled');
    }
  }

  document.getElementById('btnToggleUserFilamentMassDelete').addEventListener('click', function() {
    if (this.classList.contains('active')) {
      exitUserFilamentMassDeleteMode();
    } else {
      enterUserFilamentMassDeleteMode();
    }
  });

  document.getElementById('btnCancelUserFilamentMassDelete').addEventListener('click', function() {
    exitUserFilamentMassDeleteMode();
  });

  document.getElementById('selectAllUserFilaments').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-filament-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateUserFilamentSelection();
  });

  document.getElementById('btnDeleteSelectedUserFilaments').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.user-filament-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.filamentId);
    
    if (selectedIds.length === 0) return;
    
    const filamentNames = selectedIds.map(id => {
      const filament = userFilamentsData[id];
      return filament ? `${filament.brand} ${filament.type}` : 'Unknown';
    });
    
    const message = selectedIds.length === 1 
      ? `Delete "${filamentNames[0]}"? This action cannot be undone.`
      : `Delete ${selectedIds.length} filaments? This action cannot be undone.\n\nSelected filaments:\n• ${filamentNames.join('\n• ')}`;
    
    showConfirm(message, '', 'Delete Filaments?', 'Delete').then((confirmed) => {
      if (confirmed) {
        let deletedCount = 0;
        const deletePromises = selectedIds.map(id => 
          userFilamentsRef.child(id).remove().then(() => {
            deletedCount++;
          })
        );
        
        Promise.all(deletePromises)
          .then(() => {
            showNotification(`Successfully deleted ${deletedCount} filament${deletedCount > 1 ? 's' : ''}!`, '', 'Success');
            exitUserFilamentMassDeleteMode();
          })
          .catch(error => {
            showNotification('Error deleting filaments: ' + error.message, '', 'Error');
          });
      }
    });
  });

  /* Calculator functionality */
  const printTime = document.getElementById('printTime');
  const printTimeDuplicate = document.getElementById('printTimeDuplicate');
  
  // Sync print time fields
  printTime.addEventListener('input', () => {
    printTimeDuplicate.value = printTime.value || 0;
    calculateCost();
  });

  // Local storage for preferences
  const LS_KEY = 'calc.prefs.v1';
  
  function savePrefs() {
    localStorage.setItem(LS_KEY, JSON.stringify({
      printer: document.getElementById('printerSelect').value,
      filament: document.getElementById('filamentSelect').value
    }));
  }
  
  function loadPrefs() {
    try {
      const prefs = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      if (prefs.printer) document.getElementById('printerSelect').value = prefs.printer;
      if (prefs.filament) document.getElementById('filamentSelect').value = prefs.filament;
       } catch(e) {}
  }

  function updatePriceInfo() {
    const printerValue = document.getElementById('printerSelect').value;
    const filamentValue = document.getElementById('filamentSelect').value;
    const printerCostBox = document.getElementById('printerCostBox');
    const filamentCostBox = document.getElementById('filamentCostBox');
    const printerCostInfo = document.getElementById('printerCostInfo');
    const filamentCostInfo = document.getElementById('filamentCostInfo');
    
    // Get printer data (handle both global and user printers)
    let printer = null;
    if (printerValue) {
      if (printerValue.startsWith('global:')) {
        const name = printerValue.substring(7);
        printer = printersData[name];
      } else if (printerValue.startsWith('user:')) {
        const id = printerValue.substring(5);
        printer = userPrintersData[id];
      }
    }
    
    // Show/hide printer cost info
    if (printer) {
      printerCostInfo.textContent = `${formatMoney(printer.costPerHour)}/h`;
      printerCostBox.style.display = 'block';
    } else {
      printerCostBox.style.display = 'none';
    }
    
    // Get filament data (handle both global and user filaments)
    let filament = null;
    if (filamentValue) {
      if (filamentValue.startsWith('global:')) {
        const type = filamentValue.substring(7);
        filament = filamentsData[type];
      } else if (filamentValue.startsWith('user:')) {
        const id = filamentValue.substring(5);
        filament = userFilamentsData[id];
      }
    }
    
    // Show/hide filament cost info
    if (filament) {
      const perKg = filament.costPerG * 1000;
      filamentCostInfo.textContent = `${formatMoney(perKg)}/kg`;
      filamentCostBox.style.display = 'block';
    } else {
      filamentCostBox.style.display = 'none';
    }
  }

  document.getElementById('printerSelect').addEventListener('change', () => {
    savePrefs();
    updatePriceInfo();
    calculateCost();
  });
  
  document.getElementById('filamentSelect').addEventListener('change', () => {
    savePrefs();
    updatePriceInfo();
    calculateCost();
  });

  function calculateCost() {
    const printerValue = document.getElementById('printerSelect').value;
    const filamentValue = document.getElementById('filamentSelect').value;
    
    if (!printerValue || !filamentValue) {
      // Reset display
      document.getElementById('printerCost').textContent = formatMoney(0);
      document.getElementById('filamentCost').textContent = formatMoney(0);
      document.getElementById('electricityCost').textContent = formatMoney(0);
      document.getElementById('laborCost').textContent = formatMoney(0);
      document.getElementById('subtotal').textContent = formatMoney(0);
      document.getElementById('markupAmount').textContent = formatMoney(0);
      document.getElementById('failureCostDisplay').textContent = formatMoney(0);
      document.getElementById('totalCost').textContent = formatMoney(0);
      document.getElementById('filamentDetails').textContent = '';
      document.getElementById('electricityDetails').textContent = '';
      document.getElementById('laborDetails').textContent = '';
      document.getElementById('handTimeNote').textContent = 'Unbilled hand time: 0.00 hours';
      return;
    }

    // Get printer data (handle both global and user printers)
    let printer = null;
    if (printerValue.startsWith('global:')) {
      const name = printerValue.substring(7);
      printer = printersData[name];
    } else if (printerValue.startsWith('user:')) {
      const id = printerValue.substring(5);
      printer = userPrintersData[id];
    }
    
    // Get filament data (handle both global and user filaments)
    let filament = null;
    if (filamentValue.startsWith('global:')) {
      const type = filamentValue.substring(7);
      filament = filamentsData[type];
    } else if (filamentValue.startsWith('user:')) {
      const id = filamentValue.substring(5);
      filament = userFilamentsData[id];
    }
    
    if (!printer || !filament) return;

    // Get all values
    const pt = parseFloat(document.getElementById('printTime').value) || 0;
    const weight = parseFloat(document.getElementById('weight').value) || 0;
    const electricityPrice = parseFloat(document.getElementById('elec').value) || 0.12;
    const electricityUsagePerHour = 0.1; // kWh/h

    // Post-processing (minutes to hours)
    const jobRemoval = (parseFloat(document.getElementById('jobRemoval').value) || 0) / 60;
    const supportRemoval = (parseFloat(document.getElementById('supportRemoval').value) || 0) / 60;
    const additionalWork = (parseFloat(document.getElementById('additionalWork').value) || 0) / 60;
    const postProcessingTime = jobRemoval + supportRemoval + additionalWork;

    // Preparation (minutes to hours)
    const modelPrep = (parseFloat(document.getElementById('modelPrep').value) || 0) / 60;
    const slicing = (parseFloat(document.getElementById('slicing').value) || 0) / 60;
    const materialChange = (parseFloat(document.getElementById('materialChange').value) || 0) / 60;
    const transferStart = (parseFloat(document.getElementById('transferStart').value) || 0) / 60;
    const preparationTime = modelPrep + slicing + materialChange + transferStart;

    const totalHandTime = postProcessingTime + preparationTime;

    // Labor rates (convert from user's currency to USD for calculation)
    const postProcessingRateInput = parseFloat(document.getElementById('postProcessingRate').value) || 0;
    const preparationRateInput = parseFloat(document.getElementById('preparationRate').value) || 0;
    const postProcessingRate = convertToUSD(postProcessingRateInput);
    const preparationRate = convertToUSD(preparationRateInput);

    // Markups
    const filamentMarkup = parseFloat(document.getElementById('filamentMarkup').value) || 1;
    const generalMarkup = (parseFloat(document.getElementById('generalMarkup').value) || 0) / 100;
    const failureRate = (parseFloat(document.getElementById('failureRate').value) || 0) / 100;
    const includePrinterDepreciation = document.getElementById('includePrinterDepreciation').checked;

    // User presets are already stored in USD, so no conversion needed
    const printerCostPerHourUSD = printer.costPerHour;
    const filamentCostPerGUSD = filament.costPerG;

    // Calculate costs (in USD)
    const costPrinter = includePrinterDepreciation ? (printerCostPerHourUSD * pt) : 0;
    const costElectric = pt * electricityUsagePerHour * electricityPrice;
    const costFilament = filamentCostPerGUSD * weight * filamentMarkup;
    const costPostProcessing = postProcessingTime * postProcessingRate;
    const costPreparation = preparationTime * preparationRate;
    const costLabor = costPostProcessing + costPreparation;
    
    // Subtotal WITHOUT labor (labor is added after markup/failure rate)
    const subtotalBeforeLabor = costPrinter + costFilament + costElectric;
    const subtotalWithMarkup = subtotalBeforeLabor * (1 + generalMarkup);
    const priceAfterFailureRate = subtotalWithMarkup / (1 - failureRate);
    
    // Add labor AFTER markup and failure rate
    const finalPrice = priceAfterFailureRate + costLabor;
    
    const subtotal = subtotalBeforeLabor; // Display subtotal without labor
    const markupApplied = subtotalWithMarkup - subtotalBeforeLabor;
    const failureAdjustment = priceAfterFailureRate - subtotalWithMarkup;

    // Update UI with converted currency
    document.getElementById('printerCost').textContent = formatMoney(costPrinter);
    document.getElementById('filamentCost').textContent = formatMoney(costFilament);
    document.getElementById('filamentDetails').textContent = `${weight.toFixed(0)} g @ ${formatMoney(filamentCostPerGUSD)}/g × ${filamentMarkup.toFixed(2)}`;
    document.getElementById('electricityCost').textContent = formatMoney(costElectric);
    document.getElementById('electricityDetails').textContent = `${electricityUsagePerHour} kWh/h`;
    
    // Update labor cost display
    const laborCostElem = document.getElementById('laborCost');
    const laborDetailsElem = document.getElementById('laborDetails');
    if (laborCostElem && laborDetailsElem) {
      laborCostElem.textContent = formatMoney(costLabor);
      // Display the rates in user's current currency (the input values they entered)
      const symbol = currencySymbols[currentCurrency] || currentCurrency + ' ';
      const postProcText = postProcessingTime > 0 ? `Post-Proc: ${postProcessingTime.toFixed(2)}h @ ${symbol}${postProcessingRateInput.toFixed(2)}/h` : '';
      const prepText = preparationTime > 0 ? `Prep: ${preparationTime.toFixed(2)}h @ ${symbol}${preparationRateInput.toFixed(2)}/h` : '';
      const separator = postProcText && prepText ? ' | ' : '';
      laborDetailsElem.textContent = postProcText + separator + prepText || 'No labor time';
    }
    
    document.getElementById('subtotal').textContent = formatMoney(subtotal);
    document.getElementById('markupAmount').textContent = formatMoney(markupApplied);
    document.getElementById('failureCostDisplay').textContent = formatMoney(failureAdjustment);
    document.getElementById('totalCost').textContent = formatMoney(finalPrice);
    
    const hasLabor = (postProcessingRate > 0 && postProcessingTime > 0) || (preparationRate > 0 && preparationTime > 0);
    document.getElementById('handTimeNote').textContent = hasLabor ? `Total labor: ${totalHandTime.toFixed(2)} hours` : `Hand time: ${totalHandTime.toFixed(2)} hours (set labor rates to bill)`;
  }

  // Add event listeners for real-time calculation
  const calcInputs = [
    'printerSelect', 'filamentSelect', 'printTime', 'weight', 'elec',
    'jobRemoval', 'supportRemoval', 'additionalWork',
    'modelPrep', 'slicing', 'materialChange', 'transferStart',
    'filamentMarkup', 'generalMarkup', 'failureRate', 'postProcessingRate', 'preparationRate'
  ];
  
  calcInputs.forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener('input', calculateCost);
    el.addEventListener('change', calculateCost);
  });

  // Add listener for printer depreciation checkbox
  document.getElementById('includePrinterDepreciation').addEventListener('change', () => {
    savePrinterDepreciationPreference();
    calculateCost();
  });

  /* User Printer Handlers */
  document.getElementById('btnAddUserPrinter').onclick = () => {
    if (!auth.currentUser) {
      showNotification('Please login to add your own printers', '', 'Login Required');
      return;
    }
    editingUserPrinterId = null;
    document.getElementById('printerModalTitle').textContent = 'Add Your Printer';
    document.getElementById('printerName').value = '';
    document.getElementById('printerName').readOnly = false;
    document.getElementById('printerBrand').value = '';
    document.getElementById('printerBrand').readOnly = false;
    document.getElementById('printerPrice').value = '';
    document.getElementById('printerLifespan').value = '5000';
    document.getElementById('printerQuickAdd').value = '';
    
    // Show what currency will be saved
    const symbol = currencySymbols[currentCurrency] || currentCurrency;
    document.getElementById('printerErr').innerHTML = `<div style="color: var(--text-muted); font-size: 13px; margin-top: 8px;">Will be saved in ${currentCurrency} (${symbol}). Change currency in settings if needed.</div>`;
    
    // Modify save button behavior for user presets
    document.getElementById('savePrinter').onclick = saveUserPrinter;
    
    showModal(printerModal);
  };

  function saveUserPrinter() {
    if (!auth.currentUser || !userPrintersRef) {
      showNotification('Please login to save your printer', '', 'Login Required');
      return;
    }
    
    const name = document.getElementById('printerName').value.trim();
    const brand = document.getElementById('printerBrand').value.trim();
    const priceInCurrentCurrency = parseFloat(document.getElementById('printerPrice').value);
    const lifespan = parseInt(document.getElementById('printerLifespan').value);
    
    if (!name || !brand || !priceInCurrentCurrency || priceInCurrentCurrency < 0 || !lifespan || lifespan < 1) {
      document.getElementById('printerErr').textContent = 'Please fill all fields correctly.';
      return;
    }
    
    // Convert price from current currency to USD for storage
    const priceInUSD = convertToUSD(priceInCurrentCurrency);
    
    const printerData = { 
      name, 
      brand, 
      price: priceInUSD, // Always store in USD
      lifespan
      // No currency field needed - everything is stored in USD
    };
    
    if (editingUserPrinterId) {
      // Update existing user printer
      userPrintersRef.child(editingUserPrinterId).update(printerData)
        .then(() => {
          editingUserPrinterId = null;
          hideModal(printerModal);
          document.getElementById('printerErr').textContent = '';
          showNotification(`"${brand} ${name}" has been updated in your library.`, '', 'Updated');
        })
        .catch((error) => {
          document.getElementById('printerErr').textContent = 'Error updating printer: ' + error.message;
        });
    } else {
      // Add new user printer
      userPrintersRef.push(printerData)
        .then(() => {
          hideModal(printerModal);
          document.getElementById('printerErr').textContent = '';
          showNotification(`"${brand} ${name}" has been added to your library!`, '', 'Added');
        })
        .catch((error) => {
          document.getElementById('printerErr').textContent = 'Error saving printer: ' + error.message;
        });
    }
  }

  function editUserPrinter(id) {
    if (!auth.currentUser) return;
    
    editingUserPrinterId = id;
    const printer = userPrintersData[id];
    if (!printer) return;
    
    document.getElementById('printerModalTitle').textContent = 'Edit Your Printer';
    document.getElementById('printerName').value = printer.name;
    document.getElementById('printerName').readOnly = false;
    document.getElementById('printerBrand').value = printer.brand;
    document.getElementById('printerBrand').readOnly = false;
    
    // Convert price from USD storage to current currency for display
    const priceInUSD = printer.price;
    const priceInCurrentCurrency = convertCurrency(priceInUSD);
    document.getElementById('printerPrice').value = priceInCurrentCurrency.toFixed(2);
    document.getElementById('printerLifespan').value = printer.lifespan;
    document.getElementById('printerQuickAdd').value = '';
    
    // Show currency info
    const symbol = currencySymbols[currentCurrency] || currentCurrency;
    document.getElementById('printerErr').innerHTML = `<div style="color: var(--text-muted); font-size: 13px; margin-top: 8px;">This preset is stored in USD. Price shown in ${currentCurrency} (${symbol}).</div>`;
    
    // Modify save button behavior for user presets
    document.getElementById('savePrinter').onclick = saveUserPrinter;
    
    showModal(printerModal);
  }

  function deleteUserPrinter(id) {
    if (!auth.currentUser || !userPrintersRef) return;
    
    const printer = userPrintersData[id];
    if (!printer) return;
    
    showConfirm(`Delete "${printer.brand} ${printer.name}" from your library? This action cannot be undone.`, '', 'Delete Printer?', 'Delete').then((confirmed) => {
      if (confirmed) {
        userPrintersRef.child(id).remove()
          .then(() => {
            showNotification(`"${printer.brand} ${printer.name}" has been deleted from your library.`, '', 'Deleted');
          })
          .catch(error => {
            showNotification('Error deleting printer: ' + error.message, '', 'Error');
          });
      }
    });
  }

  /* User Filament Handlers */
  document.getElementById('btnAddUserFilament').onclick = () => {
    if (!auth.currentUser) {
      showNotification('Please login to add your own filaments', '', 'Login Required');
      return;
    }
    editingUserFilamentId = null;
    document.getElementById('filamentModalTitle').textContent = 'Add Your Filament';
    document.getElementById('filamentType').value = '';
    document.getElementById('filamentType').readOnly = false;
    document.getElementById('filamentBrand').value = '';
    document.getElementById('filamentBrand').readOnly = false;
    document.getElementById('filamentSpoolWeight').value = '1000';
    document.getElementById('filamentCostSpool').value = '';
    document.getElementById('filamentQuickAdd').value = '';
    
    // Show what currency will be saved
    const symbol = currencySymbols[currentCurrency] || currentCurrency;
    document.getElementById('filamentErr').innerHTML = `<div style="color: var(--text-muted); font-size: 13px; margin-top: 8px;">Will be saved in ${currentCurrency} (${symbol}). Change currency in settings if needed.</div>`;
    
    // Modify save button behavior for user presets
    document.getElementById('saveFilament').onclick = saveUserFilament;
    
    showModal(filamentModal);
  };

  function saveUserFilament() {
    if (!auth.currentUser || !userFilamentsRef) {
      showNotification('Please login to save your filament', '', 'Login Required');
      return;
    }
    
    const type = document.getElementById('filamentType').value.trim();
    const brand = document.getElementById('filamentBrand').value.trim();
    const spoolWeight = parseInt(document.getElementById('filamentSpoolWeight').value);
    const spoolCostInCurrentCurrency = parseFloat(document.getElementById('filamentCostSpool').value);
    
    if (!type || !brand || !spoolWeight || spoolWeight < 1 || !spoolCostInCurrentCurrency || spoolCostInCurrentCurrency < 0) {
      document.getElementById('filamentErr').textContent = 'Please fill all fields correctly.';
      return;
    }
    
    // Convert spool cost from current currency to USD for storage
    const spoolCostInUSD = convertToUSD(spoolCostInCurrentCurrency);
    
    const filamentData = {
      type,
      brand,
      spoolWeight,
      spoolCost: spoolCostInUSD // Always store in USD
      // No currency field needed - everything is stored in USD
    };
    
    if (editingUserFilamentId) {
      // Update existing user filament
      userFilamentsRef.child(editingUserFilamentId).update(filamentData)
        .then(() => {
          editingUserFilamentId = null;
          hideModal(filamentModal);
          document.getElementById('filamentErr').textContent = '';
          showNotification(`"${brand} ${type}" has been updated in your library.`, '', 'Updated');
        })
        .catch((error) => {
          document.getElementById('filamentErr').textContent = 'Error updating filament: ' + error.message;
        });
    } else {
      // Add new user filament
      userFilamentsRef.push(filamentData)
        .then(() => {
          hideModal(filamentModal);
          document.getElementById('filamentErr').textContent = '';
          showNotification(`"${brand} ${type}" has been added to your library!`, '', 'Added');
        })
        .catch((error) => {
          document.getElementById('filamentErr').textContent = 'Error saving filament: ' + error.message;
        });
    }
  }

  function editUserFilament(id) {
    if (!auth.currentUser) return;
    
    editingUserFilamentId = id;
    const filament = userFilamentsData[id];
    if (!filament) return;
    
    document.getElementById('filamentModalTitle').textContent = 'Edit Your Filament';
    document.getElementById('filamentType').value = filament.type;
    document.getElementById('filamentType').readOnly = false;
    document.getElementById('filamentBrand').value = filament.brand;
    document.getElementById('filamentBrand').readOnly = false;
    document.getElementById('filamentSpoolWeight').value = filament.spoolWeight;
    
    // Convert spool cost from USD storage to current currency for display
    const spoolCostInUSD = filament.spoolCost;
    const spoolCostInCurrentCurrency = convertCurrency(spoolCostInUSD);
    document.getElementById('filamentCostSpool').value = spoolCostInCurrentCurrency.toFixed(2);
    document.getElementById('filamentQuickAdd').value = '';
    
    // Show currency info
    const symbol = currencySymbols[currentCurrency] || currentCurrency;
    document.getElementById('filamentErr').innerHTML = `<div style="color: var(--text-muted); font-size: 13px; margin-top: 8px;">This preset is stored in USD. Cost shown in ${currentCurrency} (${symbol}).</div>`;
    
    // Modify save button behavior for user presets
    document.getElementById('saveFilament').onclick = saveUserFilament;
    
    showModal(filamentModal);
  }

  function deleteUserFilament(id) {
    if (!auth.currentUser || !userFilamentsRef) return;
    
    const filament = userFilamentsData[id];
    if (!filament) return;
    
    showConfirm(`Delete "${filament.brand} ${filament.type}" from your library? This action cannot be undone.`, '', 'Delete Filament?', 'Delete').then((confirmed) => {
      if (confirmed) {
        userFilamentsRef.child(id).remove()
          .then(() => {
            showNotification(`"${filament.brand} ${filament.type}" has been deleted from your library.`, '', 'Deleted');
          })
          .catch(error => {
            showNotification('Error deleting filament: ' + error.message, '', 'Error');
          });
      }
    });
  }

  /* Initialize - Load data from Firebase */
  console.log('Starting data load...');
  
  // Check Firebase connection
  db.ref('.info/connected').on('value', snapshot => {
    if (snapshot.val() === true) {
      console.log('✅ Connected to Firebase');
    } else {
      console.log('❌ Not connected to Firebase');
    }
  });

  // Initialize everything in correct order
  async function initializeApp() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    try {
      console.log('Initializing app...');
      
      // 1. Fetch exchange rates first (with timeout)
      const exchangeRatesPromise = Promise.race([
        fetchExchangeRates(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Exchange rates timeout')), 5000))
      ]);
      
      await exchangeRatesPromise.catch(err => {
        console.warn('Exchange rates failed, using defaults:', err);
      });
      console.log('Exchange rates ready');
      
      // 2. Load currency preference (works for both logged in and logged out users)
      await loadCurrencyPreference().catch(err => {
        console.warn('Currency preference load failed:', err);
      });
      console.log('Currency preference loaded:', currentCurrency);
      
      // 3. Load printers and filaments (shared database - available to all)
      const dataLoadPromise = Promise.race([
        Promise.all([
          new Promise(resolve => {
            loadPrinters();
            // Wait for at least one value event
            printersRef.once('value', () => resolve());
          }),
          new Promise(resolve => {
            loadFilaments();
            // Wait for at least one value event
            filamentsRef.once('value', () => resolve());
          })
        ]),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Data load timeout')), 8000))
      ]);
      
      await dataLoadPromise.catch(err => {
        console.warn('Data load had issues:', err);
        loadPrinters();
        loadFilaments();
      });
      
      console.log('App initialization complete');
      
      // Hide loading overlay with fade effect
      if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 300);
      }
      
    } catch (error) {
      console.error('Initialization error:', error);
      // Always hide loading overlay even on error
      if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 300);
      }
    }
  }

  // Start initialization
  initializeApp();
  
  // Fallback: Hide loading overlay after max 10 seconds no matter what
  setTimeout(() => {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay && loadingOverlay.style.display !== 'none') {
      console.warn('Force hiding loading overlay after timeout');
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
      }, 300);
    }
  }, 10000);
  
  // Prevent page reload scroll
  history.scrollRestoration = 'manual';
  window.scrollTo(0, 0);
</script>
</body>


</html></body>
</html>
‹