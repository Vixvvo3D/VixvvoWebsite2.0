<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vixvvo Tools - 3D Printing Calculator</title>

<!-- Add Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Load shared styles -->
<link rel="stylesheet" href="css/shared-styles.css">

<!-- Load shared navbar -->
<script src="js/navbar-helper.js"></script>
<script src="js/navbar-loader.js"></script>
<script src="js/settings-dropdown.js"></script>
<script src="js/navbar-auth.js"></script>
<script src="js/currency.js"></script>
<style>
  /* Hero Section */
  .hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 60px;
        padding: 40px 60px 80px 60px;
    max-width: 1400px;

    margin: 0 auto;
    align-items: center;
    position: relative;
    width: 100%;
  }
  
  .hero-content h1 {
    font-size: 64px;
    font-weight: 800;
    line-height: 1.1;
    margin-bottom: 24px;
  }
  
  .hero-content h1 .highlight {
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .hero-subtitle {
    color: var(--text-muted);
    font-size: 18px;
    line-height: 1.6;
    margin-bottom: 32px;
  }
  
  .hero-buttons {
    display: flex;
    gap: 16px;
  }
  
  .btn-large {
    padding: 16px 36px;
    font-size: 16px;
  }
  
  .btn-outline {
    background: transparent;
    border: 2px solid var(--border);
    color: var(--text);
  }
  
  .btn-outline:hover {
    background: rgba(168, 85, 247, .1);
    border-color: var(--purple);
  }
  
  /* Hero Visual */
  .hero-visual {
    position: relative;
    height: 600px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .visual-card {
    position: absolute;
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,.4);
    animation: float 6s ease-in-out infinite;
  }
  
  .card-1 {
    top: 50px;
    left: 0;
    width: 260px;
    animation-delay: 0s;
  }
  
  .card-2 {
    top: 150px;
    right: 40px;
    width: 280px;
    animation-delay: 1s;
  }
  
  .card-3 {
    bottom: 100px;
    left: 60px;
    width: 240px;
    animation-delay: 2s;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }
  
  .card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-bottom: 16px;
  }
  
  .card-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  
  .card-text {
    color: var(--text-muted);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .card-stat {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--purple-light);
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--text-muted);
  }
  
  /* Decorative elements */
  .bg-decoration {
    position: absolute;
    border-radius: 50%;
    filter: blur(120px);
    opacity: .2;
    z-index: -1;
  }
  
  .decoration-1 {
    width: 400px;
    height: 400px;
    background: #a855f7;
    top: -100px;
    right: -100px;
  }
  
  .decoration-2 {
    width: 350px;
    height: 350px;
    background: #7c3aed;
    bottom: -50px;
    left: -50px;
  }
  
  /* Features Section */
  .features {
    padding: 80px 60px;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
  }
  
  .features-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 32px;
    margin-top: 48px;
  }
  
  .feature-card {
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    transition: transform .3s, box-shadow .3s, border-color .3s;
  }
  
  .feature-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(168, 85, 247, .2);
    border-color: var(--purple);
  }
  
  .feature-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    margin-bottom: 20px;
  }
  
  .feature-card h3 {
    font-size: 20px;
    margin-bottom: 12px;
  }
  
  .feature-card p {
    color: var(--text-muted);
    line-height: 1.6;
  }
  
  .section-title {
    text-align: center;
    font-size: 42px;
    font-weight: 700;
    margin-bottom: 16px;
  }
  
  .section-subtitle {
    text-align: center;
    color: var(--text-muted);
  }

  /* Memberships Section */
  .memberships {
    padding: 80px 60px;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
  }

  .pricing-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
    margin-top: 48px;
  }

  .pricing-card {
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px 32px;
    transition: transform .3s, box-shadow .3s, border-color .3s;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .pricing-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(168, 85, 247, .2);
    border-color: var(--purple);
  }

  .pricing-card.featured {
    border: 2px solid var(--purple);
    box-shadow: 0 20px 40px rgba(168, 85, 247, .3);
  }

  .plan-badge {
    display: inline-block;
    padding: 6px 14px;
    background: rgba(168, 85, 247, .15);
    border: 1px solid var(--purple);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--purple);
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .plan-badge.popular {
    background: linear-gradient(135deg, var(--purple), var(--purple-light));
    color: white;
    border: none;
  }

  .pricing-card h3 {
    font-size: 28px;
    margin-bottom: 16px;
  }

  .price {
    margin-bottom: 32px;
  }

  .price .amount {
    font-size: 48px;
    font-weight: 700;
    background: linear-gradient(135deg, #a855f7, #c084fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .price .period {
    font-size: 16px;
    color: var(--text-muted);
  }

  .features-list {
    list-style: none;
    margin-bottom: 32px;
    flex-grow: 1;
  }

  .features-list li {
    padding: 12px 0;
    color: var(--text-muted);
    font-size: 15px;
    line-height: 1.6;
    border-bottom: 1px solid rgba(255,255,255,.05);
  }

  .features-list li:last-child {
    border-bottom: none;
  }

  .pricing-card .btn {
    width: 100%;
    padding: 16px;
    font-size: 16px;
    font-size: 18px;
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .hero {
      grid-template-columns: 1fr;
      text-align: center;
    }
    
    .hero-visual {
      height: 400px;
    }
    
    .hero-buttons {
      justify-content: center;
    }
    
    .features-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 768px) {
    .hero {
      padding: 40px 24px;
    }
    
    .hero-content h1 {
      font-size: 42px;
    }
    
    .features {
      padding: 60px 24px;
    }

    .memberships {
      padding: 60px 24px;
    }

    .pricing-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
  }
  
  @media (max-width: 600px) {
    .pricing-grid {
      grid-template-columns: 1fr;
      gap: 24px;
    }
  }

  /* Modern Toast Notification */
  .notification {
    position: fixed;
    top: 24px;
    right: 24px;
    transform: translateX(400px);
    background: #1e172e;
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 12px;
    padding: 20px 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(168, 85, 247, 0.1);
    z-index: 9999;
    min-width: 320px;
    max-width: 420px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .notification.show {
    opacity: 1;
    transform: translateX(0);
    pointer-events: all;
  }

  .notification-icon {
    font-size: 28px;
    min-width: 28px;
    text-align: center;
    filter: drop-shadow(0 0 8px currentColor);
  }

  .notification-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .notification-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }

  .notification-message {
    font-size: 14px;
    color: var(--text-muted);
    line-height: 1.4;
  }

  .notification-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    line-height: 1;
    opacity: 0.6;
  }

  .notification-close:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    opacity: 1;
  }

  /* Success variant */
  .notification.success {
    border-color: rgba(16, 185, 129, 0.4);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.success .notification-icon {
    color: #10b981;
  }

  /* Error variant */
  .notification.error {
    border-color: rgba(239, 68, 68, 0.4);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.error .notification-icon {
    color: #ef4444;
  }

  /* Warning variant */
  .notification.warning {
    border-color: rgba(245, 158, 11, 0.4);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(30, 23, 46, 0.95) 50%);
  }

  .notification.warning .notification-icon {
    color: #f59e0b;
  }

  /* Progress bar animation */
  .notification::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--purple), var(--purple-light));
    border-radius: 0 0 12px 12px;
    animation: notificationProgress 3s linear forwards;
  }

  .notification.success::after {
    background: linear-gradient(90deg, #10b981, #34d399);
  }

  .notification.error::after {
    background: linear-gradient(90deg, #ef4444, #f87171);
  }

  .notification.warning::after {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
  }

  @keyframes notificationProgress {
    from {
      width: 100%;
    }
    to {
      width: 0%;
    }
  }

  @media (max-width: 768px) {
    .notification {
      top: 12px;
      right: 12px;
      left: 12px;
      min-width: auto;
      max-width: none;
    }
  }

  /* Confirmation Dialog Styles */
  .confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.7);
    background: linear-gradient(135deg, #241d35, #1d1530);
    border: 2px solid var(--purple);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,.8);
    z-index: 400;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    max-width: 420px;
    width: 90%;
    display: block;
  }

  .confirm-dialog.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  .confirm-icon {
    font-size: 56px;
    text-align: center;
    margin-bottom: 16px;
    display: block;
  }

  .confirm-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
    text-align: center;
  }

  .confirm-message {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 24px;
    line-height: 1.6;
    text-align: center;
  }

  .confirm-buttons {
    display: flex;
    gap: 12px;
  }

  .confirm-buttons .btn {
    flex: 1;
    padding: 14px;
  }

  .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, .4);
  }
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--dark-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.3s ease;
  ">
    <div style="
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">Going home...</p>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>

  <!-- Navbar will be loaded here dynamically -->
  <div id="navbar-container"></div>

  <section class="hero" id="home">
    <div class="bg-decoration decoration-1"></div>
    <div class="bg-decoration decoration-2"></div>
    
    <div class="hero-content">
      <h1>
        Calculate <span class="highlight">3D Printing Costs</span> with Precision
      </h1>
      <p class="hero-subtitle">
        Professional cost calculator for 3D printing projects. Track filament usage, printer depreciation, electricity costs, and apply custom markups with cloud sync.
      </p>
      <div class="hero-buttons">
        <a href="pages/calculator.html" class="btn btn-primary btn-large">Launch Calculator →</a>
        <button class="btn btn-outline btn-large">▶ Watch Demo</button>
      </div>
    </div>
    
    <div class="hero-visual">
      <div class="visual-card card-1">
        <div class="card-icon">💰</div>
        <div class="card-title">Cost Breakdown</div>
        <div class="card-text">Detailed analysis of filament, electricity, and printer costs</div>
        <div class="card-stat">
          <div>
            <div class="stat-value">$24.50</div>
            <div class="stat-label">Total Cost</div>
          </div>
        </div>
      </div>
      
      <div class="visual-card card-2">
        <div class="card-icon">📊</div>
        <div class="card-title">Live Tracking</div>
        <div class="card-text">Real-time calculations with markup and failure rates</div>
        <div class="card-stat">
          <div>
            <div class="stat-value">25%</div>
            <div class="stat-label">Profit Margin</div>
          </div>
        </div>
      </div>
      
      <div class="visual-card card-3">
        <div class="card-icon">☁️</div>
        <div class="card-title">Cloud Sync</div>
        <div class="card-text">Your printers and filaments synced across devices</div>
      </div>
    </div>
  </section>

  <section class="features" id="features">
    <h2 class="section-title reveal">Powerful Features</h2>
    <p class="section-subtitle reveal">Everything you need to calculate and manage 3D printing costs</p>
    
    <div class="features-grid">
      <div class="feature-card">
        <div class="feature-icon">🧮</div>
        <h3>Advanced Calculator</h3>
        <p>Calculate costs including filament, electricity, post-processing time, markups, and failure rates with precision.</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">🖨️</div>
        <h3>Printer Management</h3>
        <p>Add and manage multiple printers with custom cost-per-hour rates. Switch between printers instantly.</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">🎨</div>
        <h3>Filament Library</h3>
        <p>Store unlimited filament types with brand names and costs. Automatically calculate material expenses.</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">☁️</div>
        <h3>Cloud Storage</h3>
        <p>All your data synced securely with Firebase. Access from any device, anytime.</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">🔐</div>
        <h3>Admin Controls</h3>
        <p>Secure login system for managing printers and filaments. Public calculator access for everyone.</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">📱</div>
        <h3>Responsive Design</h3>
        <p>Works perfectly on desktop, tablet, and mobile. Calculate costs on the go.</p>
      </div>
    </div>
  </section>

  <!-- Login Modal -->
  <div id="overlay" style="display: none;"></div>
  <div id="modal" style="background: rgba(0,0,0,.7);">
    <div class="modal-card">
      <h3>Login</h3>
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="your@email.com">
      <label>Password</label>
      <div style="position: relative;">
        <input id="loginPass" type="password" placeholder="••••••••" style="padding-right: 45px;">
        <button id="toggleLoginPass" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-muted); padding: 4px 8px;">👁</button>
      </div>
      <div style="text-align: right; margin-top: 4px;">
        <a href="#" id="forgotPasswordLink" style="color: var(--purple); text-decoration: none; font-size: 13px;">Forgot Password?</a>
      </div>
      <div id="loginErr" class="err"></div>
      <div class="modal-buttons">
        <button id="doLogin" class="btn btn-primary">Login</button>
        <button id="doClose" class="btn btn-ghost">Cancel</button>
      </div>
      <div style="text-align: center; margin-top: 16px; color: var(--text-muted); font-size: 14px;">
        Don't have an account? <a href="#" id="signUpLink" style="color: var(--purple); text-decoration: none; font-weight: 600;">Sign Up</a>
      </div>
    </div>
  </div>

  <!-- Sign Up Modal -->
  <div id="signupModal" style="display: none; background: rgba(0,0,0,.7);">
    <div class="modal-card">
      <h3>Sign Up</h3>
      <label>Username</label>
      <input id="signupUsername" type="text" placeholder="Choose a username">
      <label>Email</label>
      <input id="signupEmail" type="email" placeholder="your@email.com">
      <label>Password</label>
      <div style="position: relative;">
        <input id="signupPass" type="password" placeholder="••••••••" style="padding-right: 45px;">
        <button id="toggleSignupPass" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-muted); padding: 4px 8px;">👁</button>
      </div>
      <label>Confirm Password</label>
      <div style="position: relative;">
        <input id="signupPassConfirm" type="password" placeholder="••••••••" style="padding-right: 45px;">
        <button id="toggleSignupPassConfirm" type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-muted); padding: 4px 8px;">👁</button>
      </div>
      <div id="signupErr" class="err"></div>
      <div class="modal-buttons">
        <button id="doSignup" class="btn btn-primary">Continue</button>
        <button id="doSignupClose" class="btn btn-ghost">Cancel</button>
      </div>
      <div style="text-align: center; margin-top: 16px; color: var(--text-muted); font-size: 14px;">
        Already have an account? <a href="#" id="backToLoginLink" style="color: var(--purple); text-decoration: none; font-weight: 600;">Login</a>
      </div>
    </div>
  </div>

  <!-- Email Verification Modal -->
  <div id="verificationModal" style="display: none; position: fixed; inset: 0; z-index: 300; place-items: center; background: rgba(0,0,0,.7);">
    <div class="modal-card" style="max-width: 500px;">
      <h3>Verify Your Email</h3>
      <p style="color: var(--text-muted); margin-bottom: 24px;">
        Enter the 6-digit code we sent to <strong id="verifyEmailDisplay"></strong>
      </p>
      
      <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 16px;">
        <input id="code1" type="text" maxlength="1" class="code-input" style="width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: bold;">
        <input id="code2" type="text" maxlength="1" class="code-input" style="width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: bold;">
        <input id="code3" type="text" maxlength="1" class="code-input" style="width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: bold;">
        <input id="code4" type="text" maxlength="1" class="code-input" style="width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: bold;">
        <input id="code5" type="text" maxlength="1" class="code-input" style="width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: bold;">
        <input id="code6" type="text" maxlength="1" class="code-input" style="width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: bold;">
      </div>
      
      <div style="text-align: center; margin-bottom: 16px;">
        <span id="codeTimer" style="color: var(--text-muted); font-size: 14px;">Expires in 10:00</span>
      </div>
      
      <div id="verifyErr" class="err"></div>
      
      <div class="modal-buttons">
        <button id="doVerify" class="btn btn-primary">Verify & Create Account</button>
        <button id="resendCode" class="btn btn-ghost">Resend Code</button>
      </div>
      
      <div style="text-align: center; margin-top: 16px;">
        <a href="#" id="backToSignup" style="color: var(--purple); text-decoration: none; font-size: 14px;">← Back to Sign Up</a>
      </div>
    </div>
  </div>

<script>
  /* Firebase Config */
  const firebaseConfig = {
    apiKey: "AIzaSyDwEDp5SfrxeEntOJg_XzbiBoGc9ADbX5g",
    authDomain: "vixvvowebsite.firebaseapp.com",
    projectId: "vixvvowebsite",
    storageBucket: "vixvvowebsite.appspot.com",
    messagingSenderId: "862620702799",
    appId: "1:862620702799:web:d06c0ec4e7b0f3010d323a",
    measurementId: "G-VX36JF6PTT",
    databaseURL: "https://vixvvowebsite-default-rtdb.firebaseio.com"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const functions = firebase.functions();
  
  // Set the region for Cloud Functions (us-central1 is default)
  functions.useEmulator = false;

  // Enable auth persistence
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  /* Login Modal */
  const modal = document.getElementById('modal');
  const signupModal = document.getElementById('signupModal');
  
  document.getElementById('doClose').onclick = () => {
    modal.style.display = 'none';
  };

  // Click outside modal to close
  modal.onclick = (e) => {
    if (e.target.id === 'modal') {
      modal.style.display = 'none';
    }
  };

  document.getElementById('signUpLink').onclick = (e) => {
    e.preventDefault();
    modal.style.display = 'none';
    signupModal.style.display = 'grid';
    document.getElementById('signupErr').textContent = '';
    document.getElementById('signupUsername').value = '';
    document.getElementById('signupEmail').value = '';
    document.getElementById('signupPass').value = '';
    document.getElementById('signupPassConfirm').value = '';
  };

  document.getElementById('backToLoginLink').onclick = (e) => {
    e.preventDefault();
    signupModal.style.display = 'none';
    modal.style.display = 'grid';
    document.getElementById('loginErr').textContent = '';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPass').value = '';
  };

  document.getElementById('doSignupClose').onclick = () => {
    signupModal.style.display = 'none';
  };

  // Click outside signup modal to close
  signupModal.onclick = (e) => {
    if (e.target.id === 'signupModal') {
      signupModal.style.display = 'none';
    }
  };

  /* Password Visibility Toggles */
  // Login password toggle
  document.getElementById('toggleLoginPass').onclick = (e) => {
    e.preventDefault();
    const passInput = document.getElementById('loginPass');
    const toggleBtn = document.getElementById('toggleLoginPass');
    if (passInput.type === 'password') {
      passInput.type = 'text';
      toggleBtn.textContent = '�‍🗨';
    } else {
      passInput.type = 'password';
      toggleBtn.textContent = '👁';
    }
  };

  // Signup password toggle
  document.getElementById('toggleSignupPass').onclick = (e) => {
    e.preventDefault();
    const passInput = document.getElementById('signupPass');
    const toggleBtn = document.getElementById('toggleSignupPass');
    if (passInput.type === 'password') {
      passInput.type = 'text';
      toggleBtn.textContent = '�‍🗨';
    } else {
      passInput.type = 'password';
      toggleBtn.textContent = '👁';
    }
  };

  // Signup confirm password toggle
  document.getElementById('toggleSignupPassConfirm').onclick = (e) => {
    e.preventDefault();
    const passInput = document.getElementById('signupPassConfirm');
    const toggleBtn = document.getElementById('toggleSignupPassConfirm');
    if (passInput.type === 'password') {
      passInput.type = 'text';
      toggleBtn.textContent = '👁‍�';
    } else {
      passInput.type = 'password';
      toggleBtn.textContent = '👁';
    }
  };

  /* Forgot Password */
  document.getElementById('forgotPasswordLink').onclick = (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    
    if (!email) {
      document.getElementById('loginErr').textContent = 'Please enter your email address first.';
      return;
    }

    showConfirm(`Send password reset email to ${email}?`, '', 'Reset Password').then((confirmed) => {
      if (confirmed) {
        auth.sendPasswordResetEmail(email)
          .then(() => {
            showNotification('Password reset email sent! Check your inbox.', '', 'Email Sent');
            document.getElementById('loginErr').textContent = '';
          })
          .catch((error) => {
            if (error.code === 'auth/user-not-found') {
              document.getElementById('loginErr').textContent = 'No account found with this email.';
            } else if (error.code === 'auth/invalid-email') {
              document.getElementById('loginErr').textContent = 'Invalid email address.';
            } else {
              document.getElementById('loginErr').textContent = 'Error: ' + error.message;
            }
          });
      }
    });
  };

  // Store signup data temporarily
  let pendingSignupData = null;
  let verificationTimer = null;
  let timeRemaining = 600; // 10 minutes in seconds

  document.getElementById('doSignup').onclick = async () => {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const pass = document.getElementById('signupPass').value;
    const passConfirm = document.getElementById('signupPassConfirm').value;
    const errDiv = document.getElementById('signupErr');

    if (!username || !email || !pass || !passConfirm) {
      errDiv.textContent = 'Please fill in all fields.';
      return;
    }

    if (username.length < 3) {
      errDiv.textContent = 'Username must be at least 3 characters.';
      return;
    }

    if (username.length > 20) {
      errDiv.textContent = 'Username must be less than 20 characters.';
      return;
    }

    // Check if username contains only valid characters
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      errDiv.textContent = 'Username can only contain letters, numbers, and underscores.';
      return;
    }

    if (pass.length < 6) {
      errDiv.textContent = 'Password must be at least 6 characters.';
      return;
    }

    if (pass !== passConfirm) {
      errDiv.textContent = 'Passwords do not match.';
      return;
    }

    try {
      // Check if username already exists
      const usernamesSnapshot = await db.ref('usernames').once('value');
      const usernames = usernamesSnapshot.val() || {};
      
      // Check if username is taken (case-insensitive)
      const usernameLower = username.toLowerCase();
      const usernameExists = Object.values(usernames).some(
        existingUsername => existingUsername.toLowerCase() === usernameLower
      );
      
      if (usernameExists) {
        errDiv.textContent = 'This username is already taken. Please choose another.';
        return;
      }

      // Check if email is already registered BEFORE sending verification code
      errDiv.textContent = 'Checking if email is available...';
      errDiv.style.color = '#888';
      
      try {
        // Use Firebase Auth methods to check if email exists
        const signInMethods = await auth.fetchSignInMethodsForEmail(email);
        
        if (signInMethods && signInMethods.length > 0) {
          // Email is already registered
          errDiv.textContent = 'This email is already registered. Please login instead.';
          errDiv.style.color = '#ff4444';
          return;
        }
      } catch (emailCheckError) {
        // If error checking email, log it but continue (better UX)
        console.warn('Error checking email availability:', emailCheckError);
      }

      // Store data for later account creation
      pendingSignupData = { username, email, pass };
      
      // Send verification code
      errDiv.textContent = 'Sending verification code...';
      errDiv.style.color = '#888';
      
      try {
        const sendCode = functions.httpsCallable('sendVerificationCode');
        const result = await sendCode({ email });
        
        console.log('Verification code sent successfully:', result);
        
        showNotification('Verification code sent to your email!', 'success', 'Check Your Email');
        
        // Show verification modal
        signupModal.style.display = 'none';
        document.getElementById('verificationModal').style.display = 'grid';
        document.getElementById('verifyEmailDisplay').textContent = email;
        errDiv.textContent = '';
        errDiv.style.color = '#ff4444';
        
        // Clear code inputs
        for (let i = 1; i <= 6; i++) {
          document.getElementById(`code${i}`).value = '';
        }
        document.getElementById('code1').focus();
        
        // Start countdown timer
        startVerificationTimer();
        
      } catch (codeError) {
        console.error('Failed to send verification code:', codeError);
        errDiv.style.color = '#ff4444';
        
        // Check both error.code and error.message for "already exists" scenarios
        if (codeError.code === 'already-exists' || 
            (codeError.message && codeError.message.includes('already registered'))) {
          errDiv.textContent = 'This email is already registered. Please login instead.';
        } else if (codeError.code === 'unauthenticated') {
          errDiv.textContent = 'Email service authentication failed. Please contact support.';
        } else if (codeError.code === 'failed-precondition') {
          errDiv.textContent = 'Email verification is not configured. Please contact support.';
        } else if (codeError.message && codeError.message.includes('already')) {
          // Catch any other "already" related errors
          errDiv.textContent = 'This email is already registered. Please login instead.';
        } else {
          errDiv.textContent = 'Failed to send verification code. Please try again.';
        }
        
        // Clear pending data since verification failed
        pendingSignupData = null;
        return;
      }
      
    } catch (error) {
      if (error.code === 'auth/email-already-in-use') {
        errDiv.textContent = 'This email is already registered.';
      } else if (error.code === 'auth/invalid-email') {
        errDiv.textContent = 'Invalid email address.';
      } else {
        errDiv.textContent = 'Error: ' + error.message;
      }
    }
  };

  // Verification timer
  function startVerificationTimer() {
    timeRemaining = 600; // Reset to 10 minutes
    updateTimerDisplay();
    
    if (verificationTimer) clearInterval(verificationTimer);
    
    verificationTimer = setInterval(() => {
      timeRemaining--;
      updateTimerDisplay();
      
      if (timeRemaining <= 0) {
        clearInterval(verificationTimer);
        document.getElementById('verifyErr').textContent = 'Code expired. Please request a new one.';
      }
    }, 1000);
  }
  
  function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    document.getElementById('codeTimer').textContent = 
      `Expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  // Code input auto-focus
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById(`code${i}`);
    input.addEventListener('input', (e) => {
      if (e.target.value.length === 1 && i < 6) {
        document.getElementById(`code${i + 1}`).focus();
      }
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && e.target.value === '' && i > 1) {
        document.getElementById(`code${i - 1}`).focus();
      }
    });
  }

  // Verify code and create account
  document.getElementById('doVerify').onclick = async () => {
    const code = Array.from({length: 6}, (_, i) => 
      document.getElementById(`code${i + 1}`).value
    ).join('');
    
    const errDiv = document.getElementById('verifyErr');
    
    if (code.length !== 6) {
      errDiv.textContent = 'Please enter the complete 6-digit code.';
      return;
    }
    
    if (!pendingSignupData) {
      errDiv.textContent = 'Session expired. Please start over.';
      return;
    }
    
    try {
      // Verify the code first - CRITICAL: Don't create account without verification
      errDiv.textContent = 'Verifying code...';
      const verifyCode = functions.httpsCallable('verifyCode');
      const verifyResult = await verifyCode({ email: pendingSignupData.email, code });
      
      if (!verifyResult.data.success) {
        errDiv.textContent = 'Verification failed. Please try again.';
        return;
      }
      
      showNotification('Email verified successfully!', 'success', 'Verified!');
      console.log('Code verified successfully, creating account...');
      
      // Double-check email availability before account creation (prevents race condition)
      errDiv.textContent = 'Creating account...';
      try {
        const signInMethods = await auth.fetchSignInMethodsForEmail(pendingSignupData.email);
        if (signInMethods && signInMethods.length > 0) {
          // Email is already registered (either by this user or someone else)
          errDiv.textContent = 'This email is already registered. If this is your account, please login instead.';
          // Clean up verification code
          const emailKey = pendingSignupData.email.replace(/\./g, ",");
          await db.ref('verificationCodes/' + emailKey).remove();
          return;
        }
      } catch (emailCheckError) {
        console.warn('Could not verify email availability:', emailCheckError);
        // Continue anyway - Firebase will throw error if email is taken
      }
      
      // Code is valid and email still available, create the account
      const userCredential = await auth.createUserWithEmailAndPassword(
        pendingSignupData.email, 
        pendingSignupData.pass
      );
      const user = userCredential.user;

      // Update Firebase Auth display name
      await user.updateProfile({
        displayName: pendingSignupData.username
      });

      // Save user data to database
      await db.ref('users/' + user.uid).set({
        username: pendingSignupData.username,
        email: pendingSignupData.email,
        role: 'user',
        createdAt: new Date().toISOString(),
        emailVerified: true
      });

      // Save username to usernames list
      await db.ref('usernames/' + user.uid).set(pendingSignupData.username);
      
      // Delete the verification code from database
      const emailKey = pendingSignupData.email.replace(/\./g, ",");
      await db.ref('verificationCodes/' + emailKey).remove();
      
      // Clean up
      clearInterval(verificationTimer);
      pendingSignupData = null;
      document.getElementById('verificationModal').style.display = 'none';
      
      // Clear all form fields
      document.getElementById('signupUsername').value = '';
      document.getElementById('signupEmail').value = '';
      document.getElementById('signupPass').value = '';
      document.getElementById('signupPassConfirm').value = '';
      
      showNotification('Account created successfully! Welcome to Vixvvo Tools.', '', 'Welcome!');
      console.log('Account created successfully for:', pendingSignupData.email);
      
    } catch (error) {
      console.error('Account creation error:', error);
      
      if (error.code === 'deadline-exceeded') {
        errDiv.textContent = 'Code has expired. Please request a new one.';
      } else if (error.code === 'invalid-argument') {
        errDiv.textContent = 'Invalid verification code. Please try again.';
      } else if (error.code === 'not-found') {
        errDiv.textContent = 'Verification code not found. Please request a new one.';
      } else if (error.code === 'auth/email-already-in-use') {
        errDiv.textContent = 'This email is already registered. If this is your account, please login instead.';
        // Clean up verification code
        const emailKey = pendingSignupData.email.replace(/\./g, ",");
        db.ref('verificationCodes/' + emailKey).remove().catch(e => console.warn('Could not remove verification code:', e));
        // Clean up and close modal after a delay
        setTimeout(() => {
          clearInterval(verificationTimer);
          pendingSignupData = null;
          document.getElementById('verificationModal').style.display = 'none';
        }, 3000);
      } else {
        errDiv.textContent = 'Error: ' + (error.message || 'Account creation failed');
      }
    }
  };

  // Resend code
  document.getElementById('resendCode').onclick = async () => {
    if (!pendingSignupData) {
      document.getElementById('verifyErr').textContent = 'Session expired. Please start over.';
      return;
    }
    
    const errDiv = document.getElementById('verifyErr');
    errDiv.textContent = 'Sending new code...';
    errDiv.style.color = '#888';
    
    try {
      const sendCode = functions.httpsCallable('sendVerificationCode');
      const result = await sendCode({ email: pendingSignupData.email });
      
      console.log('New verification code sent:', result);
      errDiv.textContent = '';
      startVerificationTimer();
      showNotification('New verification code sent!', '', 'Check your email');
    } catch (error) {
      console.error('Failed to resend code:', error);
      errDiv.style.color = '#ff4444';
      
      if (error.code === 'unauthenticated' || error.code === 'failed-precondition') {
        errDiv.textContent = 'Email service is not available. Please contact support.';
      } else {
        errDiv.textContent = 'Failed to resend code: ' + (error.message || 'Please try again');
      }
    }
  };

  // Back to signup
  document.getElementById('backToSignup').onclick = (e) => {
    e.preventDefault();
    clearInterval(verificationTimer);
    document.getElementById('verificationModal').style.display = 'none';
    signupModal.style.display = 'grid';
  };

  // Click outside verification modal to close
  document.getElementById('verificationModal').onclick = (e) => {
    if (e.target.id === 'verificationModal') {
      clearInterval(verificationTimer);
      document.getElementById('verificationModal').style.display = 'none';
      signupModal.style.display = 'grid';
    }
  };

  document.getElementById('doLogin').onclick = () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    const errDiv = document.getElementById('loginErr');

    if (!email || !pass) {
      errDiv.textContent = 'Please enter both email and password.';
      return;
    }
    
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => {
        modal.style.display = 'none';
        errDiv.textContent = '';
        showNotification('Login successful! Welcome back.', 'success', 'Welcome!');
        // Reload page to fetch all user data
        setTimeout(() => window.location.reload(), 1000);
      })
      .catch((error) => {
        if (error.code === 'auth/user-not-found') {
          errDiv.textContent = 'No account found with this email.';
        } else if (error.code === 'auth/wrong-password') {
          errDiv.textContent = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
          errDiv.textContent = 'Invalid email address.';
        } else if (error.code === 'auth/invalid-credential') {
          errDiv.textContent = 'Invalid credentials. Please check your email and password.';
        } else {
          errDiv.textContent = 'Invalid credentials. Please check your email and password.';
        }
      });
  };

  /* Settings Dropdown - Wait for navbar to load */
  function initializeNavbarHandlers() {
    const btnSettings = document.getElementById('btnSettings');
    const settingsDropdown = document.getElementById('settingsDropdown');
    const btnLoginSettings = document.getElementById('btnLoginSettings');
    const btnLogoutSettings = document.getElementById('btnLogoutSettings');
    const userInfoDisplay = document.getElementById('userInfoDisplay');
    const settingsUsername = document.getElementById('settingsUsername');
    const settingsRole = document.getElementById('settingsRole');
    const userAvatar = document.getElementById('userAvatar');
    const btnLoginNav = document.getElementById('btnLoginNav');
    const btnSettingsPage = document.getElementById('btnSettingsPage');

    if (!btnSettings || !settingsDropdown) {
      console.error('Navbar elements not found');
      return;
    }

    // Login button in nav (visible when logged out)
    if (btnLoginNav) {
      btnLoginNav.addEventListener('click', () => {
        // On index.html, just open the modal directly
        document.getElementById('loginErr').textContent = '';
        modal.style.display = 'grid';
      });
    }

    // Dropdown toggle functionality is now handled by settings-dropdown.js

  // Login button in settings
  btnLoginSettings.addEventListener('click', () => {
    settingsDropdown.classList.remove('active');
    btnSettings.classList.remove('active');
    // On index.html, just open the modal directly
    document.getElementById('loginErr').textContent = '';
    modal.style.display = 'grid';
  });

  // Logout button in settings
  btnLogoutSettings.addEventListener('click', () => {
    showConfirm('Are you sure you want to log out?', '', 'Logout', 'Logout').then((confirmed) => {
      if (confirmed) {
        settingsDropdown.classList.remove('active');
        btnSettings.classList.remove('active');
        auth.signOut().then(() => {
          console.log('User logged out');
          showNotification('You have been logged out successfully.', 'success', 'Goodbye!');
          // Reload page to clear all user data
          window.location.reload();
        });
      }
    });
  });

  // Currency handling
  const currencySelect = document.getElementById('currencySelect');
  const btnSaveCurrency = document.getElementById('btnSaveCurrency');
  window.currentCurrency = 'USD';
  window.lastSavedCurrency = 'USD';

  // Function to update the save button state
  function updateSaveButton() {
    if (currencySelect.value !== window.lastSavedCurrency) {
      btnSaveCurrency.disabled = false;
      btnSaveCurrency.style.opacity = '1';
    } else {
      btnSaveCurrency.disabled = true;
      btnSaveCurrency.style.opacity = '0.5';
    }
  }

  // Update save button when currency changes
  currencySelect.addEventListener('change', updateSaveButton);

  // Save currency to Firebase
  btnSaveCurrency.addEventListener('click', () => {
    const user = auth.currentUser;
    if (!user) {
      console.log('No user logged in');
      return;
    }

    window.currentCurrency = currencySelect.value;
    
    // Save to Firebase
    db.ref('users/' + user.uid + '/currency').set(window.currentCurrency)
      .then(() => {
        console.log('Currency saved to Firebase:', window.currentCurrency);
        window.lastSavedCurrency = window.currentCurrency;
        
        // Show success feedback
        btnSaveCurrency.textContent = 'Saved';
        btnSaveCurrency.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        
        // Show notification
        showNotification('Currency preference saved!', 'success');
        
        // Reload page after 1 second to show new currency
        setTimeout(() => {
          location.reload();
        }, 1000);
      })
      .catch(error => {
        console.error('Error saving currency:', error);
        showNotification('Failed to save currency. Please try again.', '', 'Error');
      });
  });

    // Return references for auth state handler
    return {
      btnLoginSettings,
      btnLogoutSettings,
      userInfoDisplay,
      settingsUsername,
      settingsRole,
      userAvatar,
      btnLoginNav,
      btnSettingsPage,
      currencySelect,
      updateSaveButton
    };
  }

  // Wait for navbar to load before initializing handlers
  let navbarElements = null;
  document.addEventListener('navbarLoaded', function() {
    console.log('Navbar loaded, initializing handlers...');
    navbarElements = initializeNavbarHandlers();
  });

  // Hide loading overlay
  function hideLoadingOverlay() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
      }, 300);
    }
  }

  // Track initialization
  let authInitialized = false;
  let firebaseConnected = false;

  function checkInitComplete() {
    if (authInitialized && firebaseConnected) {
      hideLoadingOverlay();
    }
  }

  // Check Firebase connection
  db.ref('.info/connected').on('value', snapshot => {
    if (snapshot.val() === true) {
      console.log('✅ Connected to Firebase');
      firebaseConnected = true;
      checkInitComplete();
    }
  });

  // Handle auth state changes (persists across page refreshes)
  auth.onAuthStateChanged(user => {
    authInitialized = true;
    checkInitComplete();
    
    // Wait for navbar elements to be available
    let retryCount = 0;
    const maxRetries = 50; // Max 5 seconds (50 * 100ms)
    
    function updateAuthUI() {
      if (!navbarElements) {
        // Retry after a short delay if navbar isn't ready yet
        if (retryCount < maxRetries) {
          retryCount++;
          setTimeout(updateAuthUI, 100);
          return;
        } else {
          console.error('Navbar elements failed to load after max retries');
          return;
        }
      }

      const {
        btnLoginSettings,
        btnLogoutSettings,
        userInfoDisplay,
        settingsUsername,
        settingsRole,
        userAvatar,
        btnLoginNav,
        btnSettingsPage,
        currencySelect,
        updateSaveButton
      } = navbarElements;

      if (user) {
        // Update settings dropdown
        btnLoginSettings.style.display = 'none';
        btnLogoutSettings.style.display = 'block';
        if (btnSettingsPage) btnSettingsPage.style.display = 'block';
        userInfoDisplay.style.display = 'block';
        
        // Set user info
        const email = user.email || 'User';
        const username = user.displayName || email.split('@')[0];
        
        // Fetch role and membership tier from Firebase Database
        Promise.all([
          db.ref('users/' + user.uid + '/role').once('value'),
          db.ref('users/' + user.uid + '/membership/tier').once('value')
        ])
          .then(([roleSnapshot, tierSnapshot]) => {
            const roleFromDb = roleSnapshot.val() || 'member';
            const tier = tierSnapshot.val() || 'free';
            console.log('User role from Firebase:', roleFromDb);
            console.log('User tier from Firebase:', tier);
            
            // Display role with proper capitalization
            if (roleFromDb.toLowerCase() === 'admin' || roleFromDb.toLowerCase() === 'administrator') {
              settingsRole.textContent = 'Administrator';
            } else {
              // Display membership tier
              const tierInfo = typeof TIER_INFO !== 'undefined' ? TIER_INFO[tier] : null;
              settingsRole.textContent = tierInfo ? tierInfo.name : tier.charAt(0).toUpperCase() + tier.slice(1);
            }
          })
          .catch(error => {
            console.error('Error fetching role/tier:', error);
            settingsRole.textContent = 'Free';
          });
        
        // Listen for real-time currency changes from Firebase
        db.ref('users/' + user.uid + '/currency').on('value', snapshot => {
          const savedCurrency = snapshot.val();
          if (savedCurrency && currencySelect && updateSaveButton) {
            window.currentCurrency = savedCurrency;
            window.lastSavedCurrency = savedCurrency;
            currencySelect.value = savedCurrency;
            console.log('Currency updated from Firebase:', savedCurrency);
            updateSaveButton();
          }
        });
        
        settingsUsername.textContent = username;
        userAvatar.textContent = username.charAt(0).toUpperCase();
        
        // Hide nav login button when logged in
        if (btnLoginNav) btnLoginNav.style.display = 'none';
      } else {
        // Update settings dropdown
        btnLoginSettings.style.display = 'block';
        btnLogoutSettings.style.display = 'none';
        if (btnSettingsPage) btnSettingsPage.style.display = 'none';
        userInfoDisplay.style.display = 'none';
        
        // Show nav login button when logged out
        if (btnLoginNav) btnLoginNav.style.display = 'block';
      }
    }

    updateAuthUI();
  });

  // Fallback: Hide loading overlay after max 5 seconds
  setTimeout(() => {
    hideLoadingOverlay();
  }, 5000);

  // Force scroll to top and prevent auto-scroll (unless there's a hash)
  history.scrollRestoration = 'manual';
  if (!window.location.hash) {
    window.scrollTo(0, 0);
  }

  // Helper function to scroll to center of element
  function scrollToCenter(element) {
    const elementRect = element.getBoundingClientRect();
    const absoluteElementTop = elementRect.top + window.pageYOffset;
    const elementHeight = elementRect.height;
    const windowHeight = window.innerHeight;
    
    // Calculate position to center the element
    const offsetPosition = absoluteElementTop - (windowHeight / 2) + (elementHeight / 2);
    
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }

  // Smooth scroll for nav links - use event delegation for dynamically loaded navbar
  document.addEventListener('click', function(e) {
    const anchor = e.target.closest('a[href^="#"]');
    if (!anchor) return;
    
    const href = anchor.getAttribute('href');
    
    // Skip modal trigger links (signUpLink, backToLoginLink, etc.)
    if (href === '#' || anchor.id === 'signUpLink' || anchor.id === 'backToLoginLink') {
      return;
    }
    
    e.preventDefault();
    const target = document.querySelector(href);
    if (target) {
      scrollToCenter(target);
    }
  });

  // Handle hash navigation on page load
  window.addEventListener('load', () => {
    // Check URL parameters for login/signup modal
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('login') === 'true') {
      // Open login modal
      setTimeout(() => {
        const modal = document.getElementById('modal');
        if (modal) {
          const loginErr = document.getElementById('loginErr');
          if (loginErr) loginErr.textContent = '';
          modal.style.display = 'grid';
        }
        // Remove the parameter from URL without refreshing
        window.history.replaceState({}, document.title, window.location.pathname + window.location.hash);
      }, 500);
    } else if (urlParams.get('signup') === 'true') {
      // Open signup modal
      setTimeout(() => {
        const signupModal = document.getElementById('signupModal');
        if (signupModal) {
          const signupErr = document.getElementById('signupErr');
          if (signupErr) signupErr.textContent = '';
          signupModal.style.display = 'grid';
        }
        // Remove the parameter from URL without refreshing
        window.history.replaceState({}, document.title, window.location.pathname + window.location.hash);
      }, 500);
    }

    // Check if there's a hash in the URL
    if (window.location.hash) {
      const hash = window.location.hash;
      const target = document.querySelector(hash);
      
      if (target) {
        // Wait for page to fully render, then scroll
        setTimeout(() => {
          scrollToCenter(target);
        }, 100);
      }
    }
    
    // Auto-open signup modal if redirected from another page
    const shouldOpenSignup = sessionStorage.getItem('openSignup');
    if (shouldOpenSignup === 'true') {
      // Clear the flag
      sessionStorage.removeItem('openSignup');
      
      // Wait a moment for the page to fully load, then open signup modal
      setTimeout(() => {
        document.getElementById('signupModal').style.display = 'grid';
        document.getElementById('signupUsername').focus();
      }, 300);
    }
  });
</script>

<!-- Modern Toast Notification -->
<div id="customNotification" class="notification">
  <div class="notification-icon">✓</div>
  <div class="notification-content">
    <div class="notification-title">Success!</div>
    <div class="notification-message"></div>
  </div>
  <button class="notification-close" onclick="hideNotification()">×</button>
</div>

<!-- Custom Confirm Dialog -->
<div id="customConfirm" class="confirm-dialog">
  <div class="confirm-icon"></div>
  <div class="confirm-title">Are you sure?</div>
  <div class="confirm-message"></div>
  <div class="confirm-buttons">
    <button id="confirmYes" class="btn btn-danger">Confirm</button>
    <button id="confirmNo" class="btn btn-ghost">Cancel</button>
  </div>
</div>

<script>
/* Modern Toast Notification System */
function showNotification(message, type = 'success', title = '') {
  const notification = document.getElementById('customNotification');
  
  // Remove previous type classes
  notification.classList.remove('success', 'error', 'warning');
  
  // Set icon and title based on type
  let icon = '✓';
  let notificationTitle = title || 'Success!';
  
  if (type === 'error') {
    icon = '✕';
    notificationTitle = title || 'Error';
  } else if (type === 'warning') {
    icon = '⚠';
    notificationTitle = title || 'Warning';
  }
  
  // Update content
  notification.querySelector('.notification-icon').textContent = icon;
  notification.querySelector('.notification-title').textContent = notificationTitle;
  notification.querySelector('.notification-message').textContent = message;
  
  // Add type class and show
  notification.classList.add(type);
  notification.classList.add('show');
  
  // Auto-hide after 3 seconds
  setTimeout(() => {
    hideNotification();
  }, 3000);
}

function hideNotification() {
  const notification = document.getElementById('customNotification');
  notification.classList.remove('show');
}

/* Custom Confirm Dialog */
function showConfirm(message, icon = '', title = 'Are you sure?', buttonText = 'Confirm') {
  return new Promise((resolve) => {
    const confirmDialog = document.getElementById('customConfirm');
    const overlay = document.getElementById('overlay');
    const yesBtn = document.getElementById('confirmYes');
    const noBtn = document.getElementById('confirmNo');
    
    confirmDialog.querySelector('.confirm-icon').textContent = icon;
    confirmDialog.querySelector('.confirm-title').textContent = title;
    confirmDialog.querySelector('.confirm-message').textContent = message;
    yesBtn.textContent = buttonText;
    
    overlay.style.display = 'block';
    confirmDialog.classList.add('show');
    
    const cleanup = () => {
      confirmDialog.classList.remove('show');
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    };
    
    yesBtn.onclick = () => {
      cleanup();
      resolve(true);
    };
    
    noBtn.onclick = () => {
      cleanup();
      resolve(false);
    };
  });
}

// Smooth scroll function
function scrollToHero() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

</body>
</html>
